<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>All R code in this book | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="All R code in this book | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="All R code in this book | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2021-03-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sp-and-raster.html"/>
<link rel="next" href="r-basics.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#raster-and-vector-data"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#proj-and-mapping-accuracy"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt-2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simple-feature-geometries"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tesselations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and Summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-2"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="raster.html"><a href="raster.html"><i class="fa fa-check"></i><b>6</b> Time, Data Cubes</a><ul>
<li class="chapter" data-level="6.1" data-path="raster.html"><a href="raster.html#cube-dimensions"><i class="fa fa-check"></i><b>6.1</b> Cube dimensions</a></li>
<li class="chapter" data-level="6.2" data-path="raster.html"><a href="raster.html#support-of-the-time-dimensions"><i class="fa fa-check"></i><b>6.2</b> Support of the time dimensions</a></li>
<li class="chapter" data-level="6.3" data-path="raster.html"><a href="raster.html#raster-data-cubes"><i class="fa fa-check"></i><b>6.3</b> Raster data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="raster.html"><a href="raster.html#datacubes"><i class="fa fa-check"></i><b>6.4</b> Vector data cubes</a></li>
<li class="chapter" data-level="6.5" data-path="raster.html"><a href="raster.html#exercises-3"><i class="fa fa-check"></i><b>6.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#stars-basics"><i class="fa fa-check"></i><b>7.3</b> <code>stars</code> basics</a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.6</b> transforming and warping rasters</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#exercises-4"><i class="fa fa-check"></i><b>7.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>8</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="8.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>8.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="8.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>8.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="8.3" data-path="plotting.html"><a href="plotting.html#classintervals"><i class="fa fa-check"></i><b>8.3</b> Color palettes and class intervals</a></li>
<li class="chapter" data-level="8.4" data-path="plotting.html"><a href="plotting.html#poles-and-datelines"><i class="fa fa-check"></i><b>8.4</b> Poles and datelines</a></li>
<li class="chapter" data-level="8.5" data-path="plotting.html"><a href="plotting.html#graticule"><i class="fa fa-check"></i><b>8.5</b> Graticules and other navigation aids</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plot.html"><a href="plot.html"><i class="fa fa-check"></i><b>9</b> Base and grid plots</a><ul>
<li class="chapter" data-level="9.1" data-path="plot.html"><a href="plot.html#base-plots"><i class="fa fa-check"></i><b>9.1</b> Base plots</a></li>
<li class="chapter" data-level="9.2" data-path="plot.html"><a href="plot.html#combining-base-plots"><i class="fa fa-check"></i><b>9.2</b> Combining base plots</a></li>
<li class="chapter" data-level="9.3" data-path="plot.html"><a href="plot.html#grid-plots-and-viewports"><i class="fa fa-check"></i><b>9.3</b> Grid plots and viewports</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ggplot2.html"><a href="ggplot2.html"><i class="fa fa-check"></i><b>10</b> ggplot2</a><ul>
<li class="chapter" data-level="10.1" data-path="ggplot2.html"><a href="ggplot2.html#geom_sf"><i class="fa fa-check"></i><b>10.1</b> <code>geom_sf</code></a></li>
<li class="chapter" data-level="10.2" data-path="ggplot2.html"><a href="ggplot2.html#geom_stars"><i class="fa fa-check"></i><b>10.2</b> <code>geom_stars</code></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="interactive.html"><a href="interactive.html"><i class="fa fa-check"></i><b>11</b> Interactive Maps</a></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="12" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>12</b> Point Pattern Analysis</a></li>
<li class="chapter" data-level="13" data-path="manipulating-attributes-summarise-aggregate-union-sample.html"><a href="manipulating-attributes-summarise-aggregate-union-sample.html"><i class="fa fa-check"></i><b>13</b> Manipulating attributes: summarise, aggregate, union, sample</a></li>
<li class="chapter" data-level="14" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>14</b> Interpolation and Geostatistics</a><ul>
<li class="chapter" data-level="14.1" data-path="interpolation.html"><a href="interpolation.html#preparing-the-air-quality-dataset"><i class="fa fa-check"></i><b>14.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="14.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>14.2</b> Sample variogram</a></li>
<li class="chapter" data-level="14.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>14.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="14.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>14.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="14.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>14.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="14.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>14.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="14.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>14.7</b> Trend models</a></li>
<li class="chapter" data-level="14.8" data-path="interpolation.html"><a href="interpolation.html#multivariable-geostatistics"><i class="fa fa-check"></i><b>14.8</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="14.9" data-path="interpolation.html"><a href="interpolation.html#spatiotemporal-interpolation"><i class="fa fa-check"></i><b>14.9</b> Spatiotemporal interpolation</a></li>
<li class="chapter" data-level="14.10" data-path="interpolation.html"><a href="interpolation.html#atpk"><i class="fa fa-check"></i><b>14.10</b> Area-to-point kriging</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html"><i class="fa fa-check"></i><b>15</b> Area Data and Spatial Autocorrelation</a><ul>
<li class="chapter" data-level="15.1" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#spatial-autocorrelation"><i class="fa fa-check"></i><b>15.1</b> Spatial autocorrelation</a></li>
<li class="chapter" data-level="15.2" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#spatial-weight-matrices"><i class="fa fa-check"></i><b>15.2</b> Spatial weight matrices</a></li>
<li class="chapter" data-level="15.3" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#measures-of-spatial-autocorrelation"><i class="fa fa-check"></i><b>15.3</b> Measures of spatial autocorrelation</a></li>
<li class="chapter" data-level="15.4" data-path="area-data-and-spatial-autocorrelation.html"><a href="area-data-and-spatial-autocorrelation.html#spatial-heterogeneity"><i class="fa fa-check"></i><b>15.4</b> Spatial heterogeneity</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatial-regression.html"><a href="spatial-regression.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a><ul>
<li class="chapter" data-level="16.1" data-path="spatial-regression.html"><a href="spatial-regression.html#spatial-regression-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Spatial regression with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatial-regression.html"><a href="spatial-regression.html#estimators"><i class="fa fa-check"></i><b>16.2</b> Estimators</a></li>
<li class="chapter" data-level="16.3" data-path="spatial-regression.html"><a href="spatial-regression.html#implementation-details"><i class="fa fa-check"></i><b>16.3</b> Implementation details</a></li>
<li class="chapter" data-level="16.4" data-path="spatial-regression.html"><a href="spatial-regression.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.4</b> Markov random field and multilevel models with spatial weights</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="statistical-modelling-of-spatiotemporal-data.html"><a href="statistical-modelling-of-spatiotemporal-data.html"><i class="fa fa-check"></i><b>17</b> Statistical modelling of spatiotemporal data</a></li>
<li class="chapter" data-level="18" data-path="sp-and-raster.html"><a href="sp-and-raster.html"><i class="fa fa-check"></i><b>18</b> sp and raster</a><ul>
<li class="chapter" data-level="18.1" data-path="sp-and-raster.html"><a href="sp-and-raster.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.1</b> links and differences between sf and sp</a></li>
<li class="chapter" data-level="18.2" data-path="sp-and-raster.html"><a href="sp-and-raster.html#migration-packages"><i class="fa fa-check"></i><b>18.2</b> migration packages</a></li>
<li class="chapter" data-level="18.3" data-path="sp-and-raster.html"><a href="sp-and-raster.html#raster-stars-and-sf"><i class="fa fa-check"></i><b>18.3</b> raster, stars and sf</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="18.4" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i><b>18.4</b> Data structures</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="all-r-code-in-this-book" class="section level1 unnumbered">
<h1>All R code in this book</h1>
<div class="sourceCode" id="cb698"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb698-1" title="1"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-2" title="2"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-3" title="3"></a>
<a class="sourceLine" id="cb698-4" title="4">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-5" title="5">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-6" title="6"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-7" title="7">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-8" title="8"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-9" title="9">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-10" title="10"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-11" title="11"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-12" title="12"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-13" title="13">)</a>
<a class="sourceLine" id="cb698-14" title="14"></a>
<a class="sourceLine" id="cb698-15" title="15"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-16" title="16">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-17" title="17"></a>
<a class="sourceLine" id="cb698-18" title="18"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-19" title="19"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-20" title="20"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-21" title="21">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-22" title="22">knitr<span class="op">::</span><span class="kw">write_bib</span>(<span class="kw">c</span>(</a>
<a class="sourceLine" id="cb698-23" title="23">  <span class="st">&quot;classInt&quot;</span>,</a>
<a class="sourceLine" id="cb698-24" title="24">  <span class="st">&quot;gstat&quot;</span>,</a>
<a class="sourceLine" id="cb698-25" title="25">  <span class="st">&quot;lwgeom&quot;</span>,</a>
<a class="sourceLine" id="cb698-26" title="26">  <span class="st">&quot;osmar&quot;</span>, </a>
<a class="sourceLine" id="cb698-27" title="27">  <span class="st">&quot;raster&quot;</span>,</a>
<a class="sourceLine" id="cb698-28" title="28">  <span class="st">&quot;rnaturalearth&quot;</span>,</a>
<a class="sourceLine" id="cb698-29" title="29">  <span class="st">&quot;sf&quot;</span>, </a>
<a class="sourceLine" id="cb698-30" title="30">  <span class="st">&quot;sp&quot;</span>,</a>
<a class="sourceLine" id="cb698-31" title="31">  <span class="st">&quot;spacetime&quot;</span>,</a>
<a class="sourceLine" id="cb698-32" title="32">  <span class="co"># &quot;spatstat&quot;, --&gt;&gt; generates too many authors!! </span><span class="al">FIXME</span><span class="co">: update before submit!</span></a>
<a class="sourceLine" id="cb698-33" title="33">  <span class="st">&quot;spdep&quot;</span>,</a>
<a class="sourceLine" id="cb698-34" title="34">  <span class="st">&quot;splm&quot;</span>,</a>
<a class="sourceLine" id="cb698-35" title="35">  <span class="st">&quot;stars&quot;</span>,</a>
<a class="sourceLine" id="cb698-36" title="36">  <span class="st">&quot;stplanr&quot;</span>, </a>
<a class="sourceLine" id="cb698-37" title="37">  <span class="st">&quot;tidyverse&quot;</span>,</a>
<a class="sourceLine" id="cb698-38" title="38">  <span class="st">&quot;tsibble&quot;</span>,</a>
<a class="sourceLine" id="cb698-39" title="39">  <span class="st">&quot;units&quot;</span>,</a>
<a class="sourceLine" id="cb698-40" title="40">  <span class="st">&quot;xts&quot;</span>,</a>
<a class="sourceLine" id="cb698-41" title="41">  <span class="st">&quot;s2&quot;</span>,</a>
<a class="sourceLine" id="cb698-42" title="42">  <span class="st">&quot;tmap&quot;</span>,</a>
<a class="sourceLine" id="cb698-43" title="43">  <span class="st">&quot;mapview&quot;</span></a>
<a class="sourceLine" id="cb698-44" title="44">  ), <span class="st">&quot;packages.bib&quot;</span>, <span class="dt">width =</span> <span class="dv">60</span>)</a>
<a class="sourceLine" id="cb698-45" title="45">The first part of this book introduces concepts of spatial data science,</a>
<a class="sourceLine" id="cb698-46" title="46">and uses R only to generate text output or figures. The R code used <span class="cf">for</span></a>
<a class="sourceLine" id="cb698-47" title="47">this is not shown, as it would distract from the message. The online</a>
<a class="sourceLine" id="cb698-48" title="48">version of this book contains the R sections, which can be unfolded</a>
<a class="sourceLine" id="cb698-49" title="49">on demand and copied into the clipboard <span class="cf">for</span> execution and experimenting.</a>
<a class="sourceLine" id="cb698-50" title="50">The second part of this book explains how the concepts introduced <span class="cf">in</span></a>
<a class="sourceLine" id="cb698-51" title="51">part I are dealt with using R, and deals with basic handling and plotting</a>
<a class="sourceLine" id="cb698-52" title="52">of spatial and spatiotemporal data. Part III is dedicated to statistical</a>
<a class="sourceLine" id="cb698-53" title="53">modelling of spatial data.</a>
<a class="sourceLine" id="cb698-54" title="54">This work is licensed under the</a>
<a class="sourceLine" id="cb698-55" title="55">[Attribution<span class="op">-</span>NonCommercial<span class="op">-</span>NoDerivatives</a>
<a class="sourceLine" id="cb698-56" title="56"><span class="fl">4.0</span>](https<span class="op">:</span><span class="er">//</span>creativecommons.org<span class="op">/</span>licenses<span class="op">/</span>by<span class="op">-</span>nc<span class="op">-</span>nd<span class="op">/</span><span class="fl">4.0</span><span class="op">/</span>legalcode)</a>
<a class="sourceLine" id="cb698-57" title="57">International License.</a>
<a class="sourceLine" id="cb698-58" title="58"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-59" title="59"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-60" title="60"></a>
<a class="sourceLine" id="cb698-61" title="61">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-62" title="62">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-63" title="63"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-64" title="64">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-65" title="65"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-66" title="66">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-67" title="67"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-68" title="68"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-69" title="69"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-70" title="70">)</a>
<a class="sourceLine" id="cb698-71" title="71"></a>
<a class="sourceLine" id="cb698-72" title="72"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-73" title="73">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-74" title="74"></a>
<a class="sourceLine" id="cb698-75" title="75"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-76" title="76"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-77" title="77"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-78" title="78">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-79" title="79"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb698-80" title="80"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-81" title="81"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-82" title="82"><span class="st">    </span><span class="kw">read_sf</span>() -&gt;<span class="st"> </span>nc</a>
<a class="sourceLine" id="cb698-83" title="83">nc<span class="fl">.32119</span> &lt;-<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">32119</span>)</a>
<a class="sourceLine" id="cb698-84" title="84">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-85" title="85"><span class="st">    </span><span class="kw">select</span>(BIR74) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-86" title="86"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">graticule =</span> <span class="ot">TRUE</span>, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-87" title="87">nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(AREA, BIR74, SID74) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-88" title="88">year_labels =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span> =<span class="st"> &quot;1974 - 1978&quot;</span>, <span class="st">&quot;SID79&quot;</span> =<span class="st"> &quot;1979 - 1984&quot;</span>)</a>
<a class="sourceLine" id="cb698-89" title="89">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(VAR, SID, <span class="op">-</span>geom) -&gt;<span class="st"> </span>nc2</a>
<a class="sourceLine" id="cb698-90" title="90"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc2, <span class="kw">aes</span>(<span class="dt">fill =</span> SID)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-91" title="91"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>VAR, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> <span class="kw">labeller</span>(<span class="dt">VAR =</span> year_labels)) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-92" title="92"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">34</span><span class="op">:</span><span class="dv">36</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-93" title="93"><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-94" title="94"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>))</a>
<a class="sourceLine" id="cb698-95" title="95"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(mapview))</a>
<a class="sourceLine" id="cb698-96" title="96">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mapview</span>(<span class="dt">zcol =</span> <span class="st">&quot;BIR74&quot;</span>, <span class="dt">legend =</span> <span class="ot">TRUE</span>, <span class="dt">col.regions =</span> sf.colors)</a>
<a class="sourceLine" id="cb698-97" title="97"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-98" title="98"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-99" title="99"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-100" title="100">tif &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb698-101" title="101">x &lt;-<span class="st"> </span><span class="kw">read_stars</span>(tif)[,,,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb698-102" title="102"><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(a)&quot;</span>)</a>
<a class="sourceLine" id="cb698-103" title="103"><span class="kw">image</span>(x[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>], <span class="dt">text_values =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>, <span class="dt">main =</span> <span class="st">&quot;(b)&quot;</span>)</a>
<a class="sourceLine" id="cb698-104" title="104"><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(c)&quot;</span>)</a>
<a class="sourceLine" id="cb698-105" title="105"><span class="kw">set.seed</span>(<span class="dv">131</span>)</a>
<a class="sourceLine" id="cb698-106" title="106">pts =<span class="st"> </span><span class="kw">st_sample</span>(<span class="kw">st_as_sfc</span>(<span class="kw">st_bbox</span>(x)), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-107" title="107"><span class="kw">plot</span>(pts, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb698-108" title="108"><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(d)&quot;</span>)</a>
<a class="sourceLine" id="cb698-109" title="109"><span class="kw">plot</span>(<span class="kw">st_buffer</span>(pts, <span class="dv">500</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-110" title="110"><span class="kw">st_extract</span>(x, pts)</a>
<a class="sourceLine" id="cb698-111" title="111"><span class="kw">aggregate</span>(x, <span class="kw">st_buffer</span>(pts, <span class="dv">500</span>), <span class="dt">FUN =</span> mean) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sf</span>()</a>
<a class="sourceLine" id="cb698-112" title="112"><span class="kw">plot</span>(<span class="kw">st_rasterize</span>(nc[<span class="st">&quot;BIR74&quot;</span>], <span class="dt">dx =</span> <span class="fl">0.1</span>), <span class="dt">col =</span><span class="kw">sf.colors</span>(), <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>)</a>
<a class="sourceLine" id="cb698-113" title="113">x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span></a>
<a class="sourceLine" id="cb698-114" title="114">y =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span></a>
<a class="sourceLine" id="cb698-115" title="115">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">.raster =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</a>
<a class="sourceLine" id="cb698-116" title="116">m =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">20</span>),<span class="dv">5</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb698-117" title="117">r1 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb698-118" title="118"></a>
<a class="sourceLine" id="cb698-119" title="119">r =<span class="st"> </span><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>)</a>
<a class="sourceLine" id="cb698-120" title="120">r<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">-0.2</span>)</a>
<a class="sourceLine" id="cb698-121" title="121"><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>) =<span class="st"> </span>r</a>
<a class="sourceLine" id="cb698-122" title="122">r2 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb698-123" title="123"></a>
<a class="sourceLine" id="cb698-124" title="124">r =<span class="st"> </span><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>)</a>
<a class="sourceLine" id="cb698-125" title="125">r<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">-0.3</span>)</a>
<a class="sourceLine" id="cb698-126" title="126"><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>) =<span class="st"> </span>r</a>
<a class="sourceLine" id="cb698-127" title="127">r3 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb698-128" title="128"></a>
<a class="sourceLine" id="cb698-129" title="129">x =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="fl">3.5</span>, <span class="dv">5</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-130" title="130">y =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">3</span>, <span class="fl">3.5</span>)</a>
<a class="sourceLine" id="cb698-131" title="131">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">.raster =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</a>
<a class="sourceLine" id="cb698-132" title="132">r4 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb698-133" title="133"></a>
<a class="sourceLine" id="cb698-134" title="134">grd =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>), <span class="dt">offset =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">130</span>,<span class="dv">10</span>), <span class="dt">n=</span> <span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">5</span>), <span class="dt">crs=</span><span class="kw">st_crs</span>(<span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb698-135" title="135">r5 =<span class="st"> </span><span class="kw">st_transform</span>(grd, <span class="st">&quot;+proj=laea +lon_0=-70 +lat_0=35&quot;</span>)</a>
<a class="sourceLine" id="cb698-136" title="136"></a>
<a class="sourceLine" id="cb698-137" title="137"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="fl">1.1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-138" title="138">r1 =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>), <span class="dt">offset =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-139" title="139"><span class="kw">plot</span>(r1, <span class="dt">main =</span> <span class="st">&quot;regular&quot;</span>)</a>
<a class="sourceLine" id="cb698-140" title="140"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r2)), <span class="dt">main =</span> <span class="st">&quot;rotated&quot;</span>)</a>
<a class="sourceLine" id="cb698-141" title="141"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r3)), <span class="dt">main =</span> <span class="st">&quot;sheared&quot;</span>)</a>
<a class="sourceLine" id="cb698-142" title="142"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r4, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)), <span class="dt">main =</span> <span class="st">&quot;rectilinear&quot;</span>)</a>
<a class="sourceLine" id="cb698-143" title="143"><span class="kw">plot</span>(<span class="kw">st_geometry</span>((r5)), <span class="dt">main =</span> <span class="st">&quot;curvilinear&quot;</span>)</a>
<a class="sourceLine" id="cb698-144" title="144">knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/sf_deps.png&quot;</span>)</a>
<a class="sourceLine" id="cb698-145" title="145"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-146" title="146"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-147" title="147"></a>
<a class="sourceLine" id="cb698-148" title="148">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-149" title="149">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-150" title="150"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-151" title="151">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-152" title="152"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-153" title="153">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-154" title="154"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-155" title="155"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-156" title="156"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-157" title="157">)</a>
<a class="sourceLine" id="cb698-158" title="158"></a>
<a class="sourceLine" id="cb698-159" title="159"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-160" title="160">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-161" title="161"></a>
<a class="sourceLine" id="cb698-162" title="162"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-163" title="163"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-164" title="164"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-165" title="165">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-166" title="166"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-167" title="167"><span class="kw">plot</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-168" title="168"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-169" title="169"><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">-6</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-170" title="170">xd =<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb698-171" title="171"><span class="kw">lines</span>(xd, <span class="kw">sqrt</span>(<span class="dv">25</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-172" title="172"><span class="kw">lines</span>(xd, <span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">25</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-173" title="173"><span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb698-174" title="174"><span class="kw">text</span>(<span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="dt">label =</span> <span class="st">&quot;r&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-175" title="175">xd =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">5</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb698-176" title="176"><span class="kw">lines</span>(xd, <span class="kw">sqrt</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-177" title="177"><span class="kw">text</span>(<span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;phi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-178" title="178"><span class="kw">lines</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb698-179" title="179"><span class="kw">lines</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb698-180" title="180"><span class="kw">text</span>(<span class="fl">3.3</span>, <span class="fl">0.3</span>, <span class="dt">label =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb698-181" title="181"><span class="kw">text</span>(<span class="fl">0.3</span>, <span class="fl">4.3</span>, <span class="dt">label =</span> <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb698-182" title="182"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(sf))</a>
<a class="sourceLine" id="cb698-183" title="183">e =<span class="st"> </span><span class="kw">cbind</span>(<span class="op">-</span><span class="dv">90</span><span class="op">:</span><span class="dv">90</span>,<span class="dv">0</span>) <span class="co"># equator</span></a>
<a class="sourceLine" id="cb698-184" title="184">f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">0</span>, <span class="dv">-90</span><span class="op">:</span><span class="dv">90</span>)) <span class="co"># 0/antimerid.</span></a>
<a class="sourceLine" id="cb698-185" title="185">f2 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">90</span>, <span class="dv">-90</span><span class="op">:</span><span class="dv">90</span>), <span class="kw">cbind</span>(<span class="dv">270</span>, <span class="dv">90</span><span class="op">:-</span><span class="dv">90</span>))<span class="co"># +/- 90</span></a>
<a class="sourceLine" id="cb698-186" title="186">eq =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(e), <span class="kw">st_linestring</span>(f1), <span class="kw">st_linestring</span>(f2), <span class="dt">crs=</span><span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-187" title="187"></a>
<a class="sourceLine" id="cb698-188" title="188">geoc =<span class="st"> </span><span class="kw">st_transform</span>(eq, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-189" title="189">cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]], <span class="ot">NA</span>, geoc[[<span class="dv">2</span>]], <span class="ot">NA</span>, geoc[[<span class="dv">3</span>]])</a>
<a class="sourceLine" id="cb698-190" title="190">from3d =<span class="st"> </span><span class="cf">function</span>(x, offset, maxz, minz) {</a>
<a class="sourceLine" id="cb698-191" title="191">    x =<span class="st"> </span>x[,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>)] <span class="op">+</span><span class="st"> </span>offset <span class="co"># move to y right, x up, z backw</span></a>
<a class="sourceLine" id="cb698-192" title="192">    x[,<span class="dv">2</span>] =<span class="st"> </span>x[,<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>maxz      <span class="co"># shift y to left</span></a>
<a class="sourceLine" id="cb698-193" title="193">    d =<span class="st"> </span>maxz</a>
<a class="sourceLine" id="cb698-194" title="194">    z =<span class="st"> </span>x[,<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>minz <span class="op">+</span><span class="st"> </span>offset</a>
<a class="sourceLine" id="cb698-195" title="195">    x[,<span class="dv">1</span>] =<span class="st"> </span>x[,<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>(d<span class="op">/</span>z)</a>
<a class="sourceLine" id="cb698-196" title="196">    x[,<span class="dv">2</span>] =<span class="st"> </span>x[,<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>(d<span class="op">/</span>z)</a>
<a class="sourceLine" id="cb698-197" title="197">    x[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb698-198" title="198">}</a>
<a class="sourceLine" id="cb698-199" title="199">maxz =<span class="st"> </span><span class="kw">max</span>(cc[,<span class="dv">3</span>], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-200" title="200">minz =<span class="st"> </span><span class="kw">min</span>(cc[,<span class="dv">3</span>], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-201" title="201">offset =<span class="st"> </span><span class="fl">3e7</span></a>
<a class="sourceLine" id="cb698-202" title="202">circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-203" title="203">mx =<span class="st"> </span><span class="kw">max</span>(cc, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.1</span></a>
<a class="sourceLine" id="cb698-204" title="204">x =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(mx, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-205" title="205">y =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, mx, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-206" title="206">z =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, mx))</a>
<a class="sourceLine" id="cb698-207" title="207">ll =<span class="st"> </span><span class="kw">rbind</span>(x, <span class="ot">NA</span>, y, <span class="ot">NA</span>, z)</a>
<a class="sourceLine" id="cb698-208" title="208">l0 =<span class="st">  </span><span class="kw">from3d</span>(ll, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-209" title="209">mx =<span class="st"> </span><span class="kw">max</span>(cc, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.2</span></a>
<a class="sourceLine" id="cb698-210" title="210">x =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(mx, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-211" title="211">y =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, mx, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-212" title="212">z =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, mx))</a>
<a class="sourceLine" id="cb698-213" title="213">ll =<span class="st"> </span><span class="kw">rbind</span>(x, <span class="ot">NA</span>, y, <span class="ot">NA</span>, z)</a>
<a class="sourceLine" id="cb698-214" title="214">l =<span class="st">  </span><span class="kw">from3d</span>(ll, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-215" title="215"></a>
<a class="sourceLine" id="cb698-216" title="216"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-217" title="217"><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-218" title="218"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb698-219" title="219"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">1</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">3607103</span><span class="op">*</span><span class="fl">1.02</span>), </a>
<a class="sourceLine" id="cb698-220" title="220">                        <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">2</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2873898</span><span class="op">*</span><span class="fl">1.1</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-221" title="221"><span class="kw">lines</span>(circ)</a>
<a class="sourceLine" id="cb698-222" title="222"><span class="kw">lines</span>(l0)</a>
<a class="sourceLine" id="cb698-223" title="223"><span class="kw">text</span>(l[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">8</span>),], <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;z&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-224" title="224"><span class="co"># add POINT(60 47)</span></a>
<a class="sourceLine" id="cb698-225" title="225">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-226" title="226">p =<span class="st"> </span>p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-227" title="227">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],p[<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb698-228" title="228">ptsl =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-229" title="229"><span class="kw">lines</span>(ptsl, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-230" title="230"><span class="kw">points</span>(ptsl[<span class="dv">4</span>,<span class="dv">1</span>], ptsl[<span class="dv">4</span>,<span class="dv">2</span>], <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-231" title="231"></a>
<a class="sourceLine" id="cb698-232" title="232"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb698-233" title="233"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">1</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">3607103</span><span class="op">*</span><span class="fl">1.02</span>), </a>
<a class="sourceLine" id="cb698-234" title="234">                        <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">2</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2873898</span><span class="op">*</span><span class="fl">1.1</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-235" title="235"><span class="kw">lines</span>(circ)</a>
<a class="sourceLine" id="cb698-236" title="236"></a>
<a class="sourceLine" id="cb698-237" title="237">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-238" title="238">p =<span class="st"> </span>p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-239" title="239">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],p[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb698-240" title="240">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-241" title="241"><span class="kw">lines</span>(pt)</a>
<a class="sourceLine" id="cb698-242" title="242"><span class="kw">points</span>(pt[<span class="dv">2</span>,<span class="dv">1</span>], pt[<span class="dv">2</span>,<span class="dv">2</span>], <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-243" title="243"></a>
<a class="sourceLine" id="cb698-244" title="244">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-245" title="245">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-246" title="246">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb698-247" title="247">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-248" title="248"><span class="kw">lines</span>(pt)</a>
<a class="sourceLine" id="cb698-249" title="249"></a>
<a class="sourceLine" id="cb698-250" title="250">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(0 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-251" title="251">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-252" title="252">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb698-253" title="253">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-254" title="254"><span class="kw">lines</span>(pt)</a>
<a class="sourceLine" id="cb698-255" title="255"></a>
<a class="sourceLine" id="cb698-256" title="256">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(0 90)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-257" title="257">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-258" title="258">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb698-259" title="259">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-260" title="260"><span class="kw">lines</span>(pt, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-261" title="261"></a>
<a class="sourceLine" id="cb698-262" title="262">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(90 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-263" title="263">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-264" title="264">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb698-265" title="265">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-266" title="266"><span class="kw">lines</span>(pt, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-267" title="267"></a>
<a class="sourceLine" id="cb698-268" title="268">f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">60</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-269" title="269">arc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(f1), <span class="dt">crs=</span><span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-270" title="270">geoc =<span class="st"> </span><span class="kw">st_transform</span>(arc, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-271" title="271">cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb698-272" title="272">circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-273" title="273"><span class="kw">lines</span>(circ, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-274" title="274"></a>
<a class="sourceLine" id="cb698-275" title="275">f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">60</span>, <span class="dv">0</span><span class="op">:</span><span class="dv">47</span>))</a>
<a class="sourceLine" id="cb698-276" title="276">arc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(f1), <span class="dt">crs=</span><span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-277" title="277">geoc =<span class="st"> </span><span class="kw">st_transform</span>(arc, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-278" title="278">cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb698-279" title="279">circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</a>
<a class="sourceLine" id="cb698-280" title="280"><span class="kw">lines</span>(circ, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-281" title="281"></a>
<a class="sourceLine" id="cb698-282" title="282"><span class="kw">text</span>(pt[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span><span class="dv">100000</span>, pt[<span class="dv">1</span>,<span class="dv">2</span>]<span class="op">+</span><span class="dv">50000</span>, <span class="dt">labels =</span> <span class="kw">expression</span>(phi), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>) <span class="co"># lat</span></a>
<a class="sourceLine" id="cb698-283" title="283"><span class="kw">text</span>(pt[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span><span class="dv">20000</span>, pt[<span class="dv">1</span>,<span class="dv">2</span>]<span class="op">-</span><span class="dv">50000</span>, <span class="dt">labels =</span> <span class="kw">expression</span>(lambda), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>) <span class="co"># lng</span></a>
<a class="sourceLine" id="cb698-284" title="284">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-285" title="285">p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-286" title="286">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-287" title="287">p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-288" title="288"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-289" title="289">x =<span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb698-290" title="290">y =<span class="st"> </span><span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">48</span>)</a>
<a class="sourceLine" id="cb698-291" title="291"><span class="kw">plot</span>(x, y, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>,<span class="dv">8</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-292" title="292"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">9</span>)</a>
<a class="sourceLine" id="cb698-293" title="293"><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">-5</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb698-294" title="294">xd =<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">8</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb698-295" title="295"><span class="kw">lines</span>(xd, <span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">64</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-296" title="296"><span class="kw">lines</span>(xd, <span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">64</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-297" title="297"><span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, x, y, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb698-298" title="298">b =<span class="st"> </span>(x <span class="op">*</span><span class="st"> </span><span class="dv">25</span>) <span class="op">/</span><span class="st"> </span>(<span class="op">-</span>y <span class="op">*</span><span class="st"> </span><span class="dv">64</span>)</a>
<a class="sourceLine" id="cb698-299" title="299">a =<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb698-300" title="300"><span class="kw">abline</span>(a, b, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-301" title="301">b =<span class="st"> </span><span class="dv">-1</span><span class="op">/</span>b</a>
<a class="sourceLine" id="cb698-302" title="302">x0 =<span class="st"> </span>x <span class="op">-</span><span class="st"> </span>y <span class="op">/</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb698-303" title="303"><span class="kw">arrows</span>(x0, <span class="dv">0</span>, x, y, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb698-304" title="304"><span class="kw">text</span>(<span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;psi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-305" title="305"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;phi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb698-306" title="306">pts =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">13.4050</span>, <span class="fl">52.5200</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">2.3522</span>, <span class="fl">48.8566</span>)), <span class="dt">crs =</span> <span class="st">&#39;EPSG:4326&#39;</span>)</a>
<a class="sourceLine" id="cb698-307" title="307"><span class="kw">sf_use_s2</span>(<span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-308" title="308">d1 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gc_ellipse =</span> <span class="kw">st_distance</span>(pts)[<span class="dv">1</span>,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb698-309" title="309"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-310" title="310"><span class="co"># or, without using s2, use st_distance(st_transform(pts, &quot;+proj=longlat +ellps=sphere&quot;))</span></a>
<a class="sourceLine" id="cb698-311" title="311">d2 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gc_sphere =</span> <span class="kw">st_distance</span>(pts)[<span class="dv">1</span>,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb698-312" title="312">p =<span class="st"> </span><span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-313" title="313">d3 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">straight_ellipse =</span> units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">apply</span>(<span class="kw">do.call</span>(cbind, p), <span class="dv">1</span>, diff)<span class="op">^</span><span class="dv">2</span>)), m))</a>
<a class="sourceLine" id="cb698-314" title="314">p2 =<span class="st"> </span><span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=longlat +ellps=sphere&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb698-315" title="315">d4 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">straight_sphere =</span> units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">apply</span>(<span class="kw">do.call</span>(cbind, p2), <span class="dv">1</span>, diff)<span class="op">^</span><span class="dv">2</span>)), m))</a>
<a class="sourceLine" id="cb698-316" title="316">res =<span class="st"> </span><span class="kw">c</span>(d1,d3,d2,d4)</a>
<a class="sourceLine" id="cb698-317" title="317"><span class="co"># print as km, re-add names:</span></a>
<a class="sourceLine" id="cb698-318" title="318">res <span class="op">%&gt;%</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(km) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">setNames</span>(<span class="kw">names</span>(res)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">digits =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb698-319" title="319"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-320" title="320"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb698-321" title="321">countries110 =<span class="st"> </span><span class="kw">st_as_sf</span>(countries110)</a>
<a class="sourceLine" id="cb698-322" title="322">uk =<span class="st"> </span>countries110[countries110<span class="op">$</span>admin <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;United Kingdom&quot;</span>),]</a>
<a class="sourceLine" id="cb698-323" title="323">r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/uk_os_OSTN15_NTv2_OSGBtoETRS.tif&quot;</span>)[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb698-324" title="324"><span class="co"># r = read_stars(&quot;/vsicurl/https://cdn.proj.org/uk_os_OSTN15_NTv2_OSGBtoETRS.tif&quot;)[,,,1:2]</span></a>
<a class="sourceLine" id="cb698-325" title="325">hook =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb698-326" title="326">        <span class="kw">plot</span>(uk, <span class="dt">border =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-327" title="327">}</a>
<a class="sourceLine" id="cb698-328" title="328"><span class="kw">plot</span>(r, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">hook =</span> hook)</a>
<a class="sourceLine" id="cb698-329" title="329">h =<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/uk_os_OSGM15_GB.tif&quot;</span>)</a>
<a class="sourceLine" id="cb698-330" title="330"><span class="co"># h = read_stars(&quot;/vsicurl/https://cdn.proj.org/uk_os_OSGM15_GB.tif&quot;)</span></a>
<a class="sourceLine" id="cb698-331" title="331"><span class="kw">plot</span>(h, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-332" title="332"><span class="kw">plot</span>(uk, <span class="dt">border =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-333" title="333"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-334" title="334"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-335" title="335"></a>
<a class="sourceLine" id="cb698-336" title="336">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-337" title="337">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-338" title="338"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-339" title="339">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-340" title="340"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-341" title="341">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-342" title="342"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-343" title="343"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-344" title="344"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-345" title="345">)</a>
<a class="sourceLine" id="cb698-346" title="346"></a>
<a class="sourceLine" id="cb698-347" title="347"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-348" title="348">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-349" title="349"></a>
<a class="sourceLine" id="cb698-350" title="350"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-351" title="351"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-352" title="352"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-353" title="353">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-354" title="354"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-355" title="355"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-356" title="356"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-357" title="357"></a>
<a class="sourceLine" id="cb698-358" title="358"><span class="co"># 1</span></a>
<a class="sourceLine" id="cb698-359" title="359">p =<span class="st"> </span><span class="kw">st_point</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-360" title="360"><span class="kw">plot</span>(p, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-361" title="361"><span class="kw">title</span>(<span class="st">&quot;point&quot;</span>)</a>
<a class="sourceLine" id="cb698-362" title="362"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-363" title="363"></a>
<a class="sourceLine" id="cb698-364" title="364"><span class="co"># 2</span></a>
<a class="sourceLine" id="cb698-365" title="365">mp =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)))</a>
<a class="sourceLine" id="cb698-366" title="366"><span class="kw">plot</span>(mp, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-367" title="367"><span class="kw">title</span>(<span class="st">&quot;multipoint&quot;</span>)</a>
<a class="sourceLine" id="cb698-368" title="368"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-369" title="369"></a>
<a class="sourceLine" id="cb698-370" title="370"><span class="co"># 3</span></a>
<a class="sourceLine" id="cb698-371" title="371">ls =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb698-372" title="372"><span class="kw">plot</span>(ls, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-373" title="373"><span class="kw">title</span>(<span class="st">&quot;linestring&quot;</span>)</a>
<a class="sourceLine" id="cb698-374" title="374"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-375" title="375"></a>
<a class="sourceLine" id="cb698-376" title="376"><span class="co"># 4</span></a>
<a class="sourceLine" id="cb698-377" title="377">mls =<span class="st"> </span><span class="kw">st_multilinestring</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb698-378" title="378">  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)),</a>
<a class="sourceLine" id="cb698-379" title="379">  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb698-380" title="380"><span class="kw">plot</span>(mls, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-381" title="381"><span class="kw">title</span>(<span class="st">&quot;multilinestring&quot;</span>)</a>
<a class="sourceLine" id="cb698-382" title="382"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-383" title="383"></a>
<a class="sourceLine" id="cb698-384" title="384"><span class="co"># 5 polygon</span></a>
<a class="sourceLine" id="cb698-385" title="385">po =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb698-386" title="386">    <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))))</a>
<a class="sourceLine" id="cb698-387" title="387"><span class="kw">plot</span>(po, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-388" title="388"><span class="kw">title</span>(<span class="st">&quot;polygon&quot;</span>)</a>
<a class="sourceLine" id="cb698-389" title="389"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-390" title="390"></a>
<a class="sourceLine" id="cb698-391" title="391"><span class="co"># 6 multipolygon</span></a>
<a class="sourceLine" id="cb698-392" title="392">mpo =<span class="st"> </span><span class="kw">st_multipolygon</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb698-393" title="393">    <span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb698-394" title="394">        <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))),</a>
<a class="sourceLine" id="cb698-395" title="395">    <span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">8</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">9</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">8</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)))))</a>
<a class="sourceLine" id="cb698-396" title="396"><span class="kw">plot</span>(mpo, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-397" title="397"><span class="kw">title</span>(<span class="st">&quot;multipolygon&quot;</span>)</a>
<a class="sourceLine" id="cb698-398" title="398"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-399" title="399"></a>
<a class="sourceLine" id="cb698-400" title="400"><span class="co"># 7 geometrycollection</span></a>
<a class="sourceLine" id="cb698-401" title="401">gc =<span class="st"> </span><span class="kw">st_geometrycollection</span>(<span class="kw">list</span>(po, ls <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">5</span>), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>))))</a>
<a class="sourceLine" id="cb698-402" title="402"><span class="kw">plot</span>(gc, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff6666&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-403" title="403"><span class="kw">title</span>(<span class="st">&quot;geometrycollection&quot;</span>)</a>
<a class="sourceLine" id="cb698-404" title="404"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-405" title="405">p</a>
<a class="sourceLine" id="cb698-406" title="406">mp</a>
<a class="sourceLine" id="cb698-407" title="407">ls</a>
<a class="sourceLine" id="cb698-408" title="408">mls</a>
<a class="sourceLine" id="cb698-409" title="409">po</a>
<a class="sourceLine" id="cb698-410" title="410">mpo</a>
<a class="sourceLine" id="cb698-411" title="411">gc</a>
<a class="sourceLine" id="cb698-412" title="412">(<span class="dt">ls =</span> <span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">0</span>))))</a>
<a class="sourceLine" id="cb698-413" title="413"><span class="kw">c</span>(<span class="dt">is_simple =</span> <span class="kw">st_is_simple</span>(ls))</a>
<a class="sourceLine" id="cb698-414" title="414"><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-415" title="415"><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">dim =</span> <span class="st">&quot;XYM&quot;</span>)</a>
<a class="sourceLine" id="cb698-416" title="416"><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb698-417" title="417">(<span class="dt">e =</span> <span class="kw">st_intersection</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb698-418" title="418"><span class="kw">st_point</span>()</a>
<a class="sourceLine" id="cb698-419" title="419"><span class="kw">st_linestring</span>(<span class="kw">matrix</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>)[<span class="dv">0</span>,], <span class="dt">dim =</span> <span class="st">&quot;XYM&quot;</span>)</a>
<a class="sourceLine" id="cb698-420" title="420"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-421" title="421">polygon =<span class="st"> </span>po =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))))</a>
<a class="sourceLine" id="cb698-422" title="422">p0 =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb698-423" title="423">line =<span class="st"> </span>li =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb698-424" title="424">s =<span class="st"> </span><span class="kw">st_sfc</span>(po, li)</a>
<a class="sourceLine" id="cb698-425" title="425"></a>
<a class="sourceLine" id="cb698-426" title="426"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb698-427" title="427"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-428" title="428"></a>
<a class="sourceLine" id="cb698-429" title="429"><span class="co"># &quot;1020F1102&quot;</span></a>
<a class="sourceLine" id="cb698-430" title="430"><span class="co"># 1: 1</span></a>
<a class="sourceLine" id="cb698-431" title="431"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 1&quot;</span>)))</a>
<a class="sourceLine" id="cb698-432" title="432"><span class="kw">lines</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>,<span class="dv">0</span>), <span class="kw">c</span>(.<span class="dv">5</span>,.<span class="dv">495</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-433" title="433"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">pch =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-434" title="434"></a>
<a class="sourceLine" id="cb698-435" title="435"><span class="co"># 2: 0</span></a>
<a class="sourceLine" id="cb698-436" title="436"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = 0&quot;</span>)))</a>
<a class="sourceLine" id="cb698-437" title="437"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-438" title="438"></a>
<a class="sourceLine" id="cb698-439" title="439"><span class="co"># 3: 2</span></a>
<a class="sourceLine" id="cb698-440" title="440"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 2&quot;</span>)))</a>
<a class="sourceLine" id="cb698-441" title="441"><span class="kw">plot</span>(po, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-442" title="442"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-443" title="443"></a>
<a class="sourceLine" id="cb698-444" title="444"><span class="co"># 4: 0</span></a>
<a class="sourceLine" id="cb698-445" title="445"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 0&quot;</span>)))</a>
<a class="sourceLine" id="cb698-446" title="446"><span class="kw">points</span>(.<span class="dv">5</span>, <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-447" title="447"></a>
<a class="sourceLine" id="cb698-448" title="448"><span class="co"># 5: F</span></a>
<a class="sourceLine" id="cb698-449" title="449"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = F&quot;</span>)))</a>
<a class="sourceLine" id="cb698-450" title="450"></a>
<a class="sourceLine" id="cb698-451" title="451"><span class="co"># 6: 1</span></a>
<a class="sourceLine" id="cb698-452" title="452"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 1&quot;</span>)))</a>
<a class="sourceLine" id="cb698-453" title="453"><span class="kw">plot</span>(po, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-454" title="454"></a>
<a class="sourceLine" id="cb698-455" title="455"><span class="co"># 7: 1</span></a>
<a class="sourceLine" id="cb698-456" title="456"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 1&quot;</span>)))</a>
<a class="sourceLine" id="cb698-457" title="457"><span class="kw">lines</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="dv">0</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-458" title="458"></a>
<a class="sourceLine" id="cb698-459" title="459"><span class="co"># 8: 0</span></a>
<a class="sourceLine" id="cb698-460" title="460"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = 0&quot;</span>)))</a>
<a class="sourceLine" id="cb698-461" title="461"><span class="kw">points</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb698-462" title="462"></a>
<a class="sourceLine" id="cb698-463" title="463"><span class="co"># 9: 2</span></a>
<a class="sourceLine" id="cb698-464" title="464"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 2&quot;</span>)))</a>
<a class="sourceLine" id="cb698-465" title="465"><span class="kw">plot</span>(p0 <span class="op">/</span><span class="st"> </span>po, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-466" title="466"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-467" title="467"><span class="kw">st_relate</span>(polygon, line)</a>
<a class="sourceLine" id="cb698-468" title="468"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-469" title="469"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc)[<span class="dv">1</span>], <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb698-470" title="470"><span class="kw">plot</span>(<span class="kw">st_convex_hull</span>(<span class="kw">st_geometry</span>(nc)[<span class="dv">1</span>]), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-471" title="471"><span class="kw">box</span>()</a>
<a class="sourceLine" id="cb698-472" title="472"><span class="kw">set.seed</span>(<span class="dv">131</span>)</a>
<a class="sourceLine" id="cb698-473" title="473">mp =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">20</span>), <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb698-474" title="474"><span class="kw">plot</span>(mp)</a>
<a class="sourceLine" id="cb698-475" title="475"><span class="kw">plot</span>(<span class="kw">st_voronoi</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb698-476" title="476"><span class="kw">box</span>()</a>
<a class="sourceLine" id="cb698-477" title="477"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-478" title="478">sq =<span class="st"> </span><span class="cf">function</span>(pt, <span class="dt">sz =</span> <span class="dv">1</span>) <span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(pt <span class="op">-</span><span class="st"> </span>sz), </a>
<a class="sourceLine" id="cb698-479" title="479">  <span class="kw">c</span>(pt[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>sz, pt[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>sz), <span class="kw">c</span>(pt <span class="op">+</span><span class="st"> </span>sz), <span class="kw">c</span>(pt[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>sz, pt[<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>sz), <span class="kw">c</span>(pt <span class="op">-</span><span class="st"> </span>sz))))</a>
<a class="sourceLine" id="cb698-480" title="480">x =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">box =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="kw">st_sfc</span>(<span class="kw">sq</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="kw">sq</span>(<span class="kw">c</span>(<span class="fl">1.7</span>, <span class="fl">-0.5</span>)), <span class="kw">sq</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb698-481" title="481"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(x), <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>), <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-482" title="482"><span class="kw">plot</span>(<span class="kw">st_intersection</span>(<span class="kw">st_geometry</span>(x)), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">7</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb698-483" title="483"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) </a>
<a class="sourceLine" id="cb698-484" title="484">xg =<span class="st"> </span><span class="kw">st_geometry</span>(x)</a>
<a class="sourceLine" id="cb698-485" title="485"><span class="kw">plot</span>(<span class="kw">st_difference</span>(xg), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-486" title="486"><span class="kw">plot</span>(<span class="kw">st_difference</span>(xg[<span class="dv">3</span><span class="op">:</span><span class="dv">1</span>]), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-487" title="487"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-488" title="488"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-489" title="489"></a>
<a class="sourceLine" id="cb698-490" title="490">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-491" title="491">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-492" title="492"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-493" title="493">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-494" title="494"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-495" title="495">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-496" title="496"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-497" title="497"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-498" title="498"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-499" title="499">)</a>
<a class="sourceLine" id="cb698-500" title="500"></a>
<a class="sourceLine" id="cb698-501" title="501"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-502" title="502">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-503" title="503"></a>
<a class="sourceLine" id="cb698-504" title="504"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-505" title="505"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-506" title="506"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-507" title="507">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-508" title="508"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-509" title="509"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(maps))</a>
<a class="sourceLine" id="cb698-510" title="510"><span class="co"># maps:</span></a>
<a class="sourceLine" id="cb698-511" title="511"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-512" title="512"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-513" title="513">m =<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb698-514" title="514">a =<span class="st"> </span>m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, ]</a>
<a class="sourceLine" id="cb698-515" title="515"><span class="kw">st_bbox</span>(a)</a>
<a class="sourceLine" id="cb698-516" title="516"><span class="kw">library</span>(s2)</a>
<a class="sourceLine" id="cb698-517" title="517"><span class="kw">s2_bounds_cap</span>(a)</a>
<a class="sourceLine" id="cb698-518" title="518"><span class="kw">s2_bounds_rect</span>(a)</a>
<a class="sourceLine" id="cb698-519" title="519"><span class="kw">st_bbox</span>(m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Fiji&quot;</span>,])</a>
<a class="sourceLine" id="cb698-520" title="520"><span class="kw">s2_bounds_rect</span>(m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Fiji&quot;</span>,])</a>
<a class="sourceLine" id="cb698-521" title="521"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-522" title="522"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(maps))</a>
<a class="sourceLine" id="cb698-523" title="523"><span class="co"># maps:</span></a>
<a class="sourceLine" id="cb698-524" title="524"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-525" title="525"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-526" title="526">m =<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb698-527" title="527">m =<span class="st"> </span>m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, ]</a>
<a class="sourceLine" id="cb698-528" title="528"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(m), <span class="dt">asp =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-529" title="529"><span class="kw">title</span>(<span class="st">&quot;a (not valid)&quot;</span>)</a>
<a class="sourceLine" id="cb698-530" title="530"><span class="co"># ne:</span></a>
<a class="sourceLine" id="cb698-531" title="531"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb698-532" title="532">ne =<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb698-533" title="533">ne =<span class="st"> </span>ne[ne<span class="op">$</span>region_un <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, <span class="st">&quot;region_un&quot;</span>]</a>
<a class="sourceLine" id="cb698-534" title="534"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(ne), <span class="dt">asp =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-535" title="535"><span class="kw">title</span>(<span class="st">&quot;b (valid)&quot;</span>)</a>
<a class="sourceLine" id="cb698-536" title="536"><span class="co"># 3031</span></a>
<a class="sourceLine" id="cb698-537" title="537">m <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-538" title="538"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-539" title="539"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3031</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-540" title="540"><span class="st">  </span><span class="kw">plot</span>()</a>
<a class="sourceLine" id="cb698-541" title="541"><span class="kw">title</span>(<span class="st">&quot;c (valid)&quot;</span>)</a>
<a class="sourceLine" id="cb698-542" title="542">ne <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-543" title="543"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-544" title="544"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3031</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-545" title="545"><span class="st">  </span><span class="kw">plot</span>()</a>
<a class="sourceLine" id="cb698-546" title="546"><span class="kw">title</span>(<span class="st">&quot;d (not valid)&quot;</span>)</a>
<a class="sourceLine" id="cb698-547" title="547"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-548" title="548"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-549" title="549"></a>
<a class="sourceLine" id="cb698-550" title="550">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-551" title="551">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-552" title="552"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-553" title="553">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-554" title="554"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-555" title="555">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-556" title="556"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-557" title="557"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-558" title="558"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-559" title="559">)</a>
<a class="sourceLine" id="cb698-560" title="560"></a>
<a class="sourceLine" id="cb698-561" title="561"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-562" title="562">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-563" title="563"></a>
<a class="sourceLine" id="cb698-564" title="564"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-565" title="565"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-566" title="566"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-567" title="567">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-568" title="568"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-569" title="569"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb698-570" title="570"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-571" title="571"><span class="st">    </span><span class="kw">read_sf</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-572" title="572"><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">32119</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-573" title="573"><span class="st">    </span><span class="kw">select</span>(BIR74, SID74, NAME) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-574" title="574"><span class="st">    </span><span class="kw">st_centroid</span>() -&gt;<span class="st"> </span>x</a>
<a class="sourceLine" id="cb698-575" title="575">nc &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb698-576" title="576"><span class="kw">plot</span>(nc[<span class="st">&quot;SID74&quot;</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-577" title="577"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-578" title="578"><span class="co"># encode quadrant by two logicals:</span></a>
<a class="sourceLine" id="cb698-579" title="579">nc<span class="op">$</span>lng =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc)))[,<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">-79</span></a>
<a class="sourceLine" id="cb698-580" title="580">nc<span class="op">$</span>lat =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc)))[,<span class="dv">2</span>] <span class="op">&gt;</span><span class="st"> </span><span class="fl">35.5</span></a>
<a class="sourceLine" id="cb698-581" title="581">nc.grp =<span class="st"> </span><span class="kw">aggregate</span>(nc[<span class="st">&quot;SID74&quot;</span>], <span class="kw">list</span>(nc<span class="op">$</span>lng, nc<span class="op">$</span>lat), sum)</a>
<a class="sourceLine" id="cb698-582" title="582"><span class="kw">plot</span>(nc.grp[<span class="st">&quot;SID74&quot;</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-583" title="583">nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">2264</span>)</a>
<a class="sourceLine" id="cb698-584" title="584">gr =<span class="st"> </span><span class="kw">st_sf</span>(</a>
<a class="sourceLine" id="cb698-585" title="585">         <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</a>
<a class="sourceLine" id="cb698-586" title="586">         <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</a>
<a class="sourceLine" id="cb698-587" title="587">gr =<span class="st"> </span>gr[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>),]</a>
<a class="sourceLine" id="cb698-588" title="588">a =<span class="st"> </span><span class="kw">aggregate</span>(nc[<span class="st">&quot;SID74&quot;</span>], gr, sum)</a>
<a class="sourceLine" id="cb698-589" title="589"><span class="kw">c</span>(<span class="dt">sid74_sum_counties =</span> <span class="kw">sum</span>(nc<span class="op">$</span>SID74), <span class="dt">sid74_sum_rectangles =</span> <span class="kw">sum</span>(a<span class="op">$</span>SID74, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-590" title="590"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-591" title="591"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-592" title="592"></a>
<a class="sourceLine" id="cb698-593" title="593">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-594" title="594">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-595" title="595"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-596" title="596">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-597" title="597"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-598" title="598">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-599" title="599"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-600" title="600"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-601" title="601"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-602" title="602">)</a>
<a class="sourceLine" id="cb698-603" title="603"></a>
<a class="sourceLine" id="cb698-604" title="604"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-605" title="605">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-606" title="606"></a>
<a class="sourceLine" id="cb698-607" title="607"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-608" title="608"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-609" title="609"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-610" title="610">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-611" title="611"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-612" title="612"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-613" title="613"></a>
<a class="sourceLine" id="cb698-614" title="614">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-615" title="615">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-616" title="616"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-617" title="617">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-618" title="618"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-619" title="619">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-620" title="620"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-621" title="621"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-622" title="622"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-623" title="623">)</a>
<a class="sourceLine" id="cb698-624" title="624"></a>
<a class="sourceLine" id="cb698-625" title="625"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-626" title="626">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-627" title="627"></a>
<a class="sourceLine" id="cb698-628" title="628"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-629" title="629"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-630" title="630"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-631" title="631">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-632" title="632"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-633" title="633">p1 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.35</span>, <span class="fl">52.42</span>)); p2 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.22</span>, <span class="fl">52.18</span>)); p3 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.44</span>, <span class="fl">52.19</span>))</a>
<a class="sourceLine" id="cb698-634" title="634">sfc =<span class="st"> </span><span class="kw">st_sfc</span>(p1, p2, p3, <span class="dt">crs =</span> <span class="st">&#39;EPSG:4326&#39;</span>)</a>
<a class="sourceLine" id="cb698-635" title="635"><span class="kw">st_sf</span>(<span class="dt">elev =</span> <span class="kw">c</span>(<span class="fl">33.2</span>, <span class="fl">52.1</span>, <span class="fl">81.2</span>), <span class="dt">marker =</span> <span class="kw">c</span>(<span class="st">&quot;Id01&quot;</span>, <span class="st">&quot;Id02&quot;</span>, <span class="st">&quot;Id03&quot;</span>), <span class="dt">geom =</span> sfc)</a>
<a class="sourceLine" id="cb698-636" title="636">knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/sf_obj.png&quot;</span>)</a>
<a class="sourceLine" id="cb698-637" title="637"><span class="co"># example of largest = TRUE:</span></a>
<a class="sourceLine" id="cb698-638" title="638">nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;shape/nc.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>)), <span class="dv">2264</span>)</a>
<a class="sourceLine" id="cb698-639" title="639">gr =<span class="st"> </span><span class="kw">st_sf</span>(</a>
<a class="sourceLine" id="cb698-640" title="640">         <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</a>
<a class="sourceLine" id="cb698-641" title="641">         <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</a>
<a class="sourceLine" id="cb698-642" title="642">gr<span class="op">$</span>col =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>, <span class="dt">categorical =</span> <span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.3</span>)</a>
<a class="sourceLine" id="cb698-643" title="643"><span class="co"># cut, to check, NA&#39;s work out:</span></a>
<a class="sourceLine" id="cb698-644" title="644">gr =<span class="st"> </span>gr[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>),]</a>
<a class="sourceLine" id="cb698-645" title="645"><span class="kw">suppressWarnings</span>(nc_j &lt;-<span class="st"> </span><span class="kw">st_join</span>(nc, gr, <span class="dt">largest =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-646" title="646"><span class="co"># the two datasets:</span></a>
<a class="sourceLine" id="cb698-647" title="647">opar =<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-648" title="648"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j))</a>
<a class="sourceLine" id="cb698-649" title="649"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> gr<span class="op">$</span>col)</a>
<a class="sourceLine" id="cb698-650" title="650"><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(gr))), <span class="dt">labels =</span> gr<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb698-651" title="651"><span class="co"># the joined dataset:</span></a>
<a class="sourceLine" id="cb698-652" title="652"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j), <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> nc_j<span class="op">$</span>col)</a>
<a class="sourceLine" id="cb698-653" title="653"><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc_j))), <span class="dt">labels =</span> nc_j<span class="op">$</span>label, <span class="dt">cex =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb698-654" title="654"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">border =</span> <span class="st">&#39;green&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-655" title="655"><span class="kw">par</span>(opar)</a>
<a class="sourceLine" id="cb698-656" title="656">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb698-657" title="657"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-658" title="658">x =<span class="st"> </span><span class="kw">read_stars</span>(tif)</a>
<a class="sourceLine" id="cb698-659" title="659">x</a>
<a class="sourceLine" id="cb698-660" title="660"><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb698-661" title="661"><span class="kw">class</span>(x[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb698-662" title="662"><span class="kw">dim</span>(x[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb698-663" title="663"><span class="kw">st_dimensions</span>(x)</a>
<a class="sourceLine" id="cb698-664" title="664"><span class="kw">st_bbox</span>(x)</a>
<a class="sourceLine" id="cb698-665" title="665">tf =<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext=</span><span class="st">&quot;.tif&quot;</span>)</a>
<a class="sourceLine" id="cb698-666" title="666"><span class="kw">write_stars</span>(x, tf)</a>
<a class="sourceLine" id="cb698-667" title="667"><span class="kw">st_drivers</span>(<span class="st">&quot;raster&quot;</span>)</a>
<a class="sourceLine" id="cb698-668" title="668"><span class="kw">plot</span>(x)</a>
<a class="sourceLine" id="cb698-669" title="669"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-670" title="670"><span class="kw">plot</span>(x, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">&quot;RGB&quot;</span>)    <span class="co"># rgb</span></a>
<a class="sourceLine" id="cb698-671" title="671"><span class="kw">plot</span>(x, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">main =</span> <span class="st">&quot;False color (NIR-R-G)&quot;</span>) <span class="co"># false color</span></a>
<a class="sourceLine" id="cb698-672" title="672"><span class="kw">log</span>(x)</a>
<a class="sourceLine" id="cb698-673" title="673">x <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(x)</a>
<a class="sourceLine" id="cb698-674" title="674">x2 =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb698-675" title="675">x2[x <span class="op">&lt;</span><span class="st"> </span><span class="dv">50</span>] =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb698-676" title="676">x2</a>
<a class="sourceLine" id="cb698-677" title="677">x2[<span class="kw">is.na</span>(x2)] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb698-678" title="678">x2</a>
<a class="sourceLine" id="cb698-679" title="679"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), mean)</a>
<a class="sourceLine" id="cb698-680" title="680">ndvi =<span class="st"> </span><span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="op">-</span>x[<span class="dv">3</span>])<span class="op">/</span>(x[<span class="dv">4</span>]<span class="op">+</span>x[<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb698-681" title="681"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), ndvi)</a>
<a class="sourceLine" id="cb698-682" title="682"><span class="kw">as.data.frame</span>(<span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), mean))</a>
<a class="sourceLine" id="cb698-683" title="683"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</a>
<a class="sourceLine" id="cb698-684" title="684"><span class="kw">st_apply</span>(x, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</a>
<a class="sourceLine" id="cb698-685" title="685"><span class="kw">install.packages</span>(<span class="st">&quot;starsdata&quot;</span>, <span class="dt">repos =</span> <span class="st">&quot;http://pebesma.staff.ifgi.de&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;source&quot;</span>)</a>
<a class="sourceLine" id="cb698-686" title="686">granule =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;starsdata&quot;</span>)</a>
<a class="sourceLine" id="cb698-687" title="687"><span class="kw">file.size</span>(granule)</a>
<a class="sourceLine" id="cb698-688" title="688">base_name =<span class="st"> </span><span class="kw">strsplit</span>(<span class="kw">basename</span>(granule), <span class="st">&quot;.zip&quot;</span>)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-689" title="689">s2 =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;SENTINEL2_L1C:/vsizip/&quot;</span>, granule, <span class="st">&quot;/&quot;</span>, base_name, <span class="st">&quot;.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632&quot;</span>)</a>
<a class="sourceLine" id="cb698-690" title="690">(<span class="dt">p =</span> <span class="kw">read_stars</span>(s2, <span class="dt">proxy =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-691" title="691"><span class="kw">object.size</span>(p)</a>
<a class="sourceLine" id="cb698-692" title="692">p2 =<span class="st"> </span>p <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb698-693" title="693"><span class="kw">plot</span>(p)</a>
<a class="sourceLine" id="cb698-694" title="694"><span class="kw">floor</span>(<span class="kw">sqrt</span>(<span class="kw">prod</span>(<span class="kw">dim</span>(p)) <span class="op">/</span><span class="st"> </span><span class="kw">prod</span>(<span class="kw">dev.size</span>(<span class="st">&quot;px&quot;</span>))))</a>
<a class="sourceLine" id="cb698-695" title="695"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;stars_proxy&quot;</span>)</a>
<a class="sourceLine" id="cb698-696" title="696"><span class="kw">library</span>(spacetime)</a>
<a class="sourceLine" id="cb698-697" title="697"><span class="kw">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span></a>
<a class="sourceLine" id="cb698-698" title="698"><span class="kw">dim</span>(air)</a>
<a class="sourceLine" id="cb698-699" title="699">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">station =</span> <span class="kw">st_as_sfc</span>(stations), <span class="dt">time =</span> dates)</a>
<a class="sourceLine" id="cb698-700" title="700">(<span class="dt">aq =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">PM10 =</span> air), <span class="dt">dimensions =</span> d))</a>
<a class="sourceLine" id="cb698-701" title="701"><span class="kw">image</span>(<span class="kw">aperm</span>(<span class="kw">log</span>(aq), <span class="dv">2</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">main =</span> <span class="st">&quot;NA pattern (white) in PM10 station time series&quot;</span>)</a>
<a class="sourceLine" id="cb698-702" title="702"><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(<span class="kw">st_apply</span>(aq, <span class="dv">1</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">pch =</span> <span class="dv">16</span>,</a>
<a class="sourceLine" id="cb698-703" title="703">    <span class="dt">ylim =</span> <span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)])</a>
<a class="sourceLine" id="cb698-704" title="704"><span class="kw">plot</span>(DE, <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-705" title="705">(<span class="dt">a =</span> <span class="kw">aggregate</span>(aq, <span class="kw">st_as_sf</span>(DE_NUTS1), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-706" title="706"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb698-707" title="707">a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(time <span class="op">&gt;=</span><span class="st"> &quot;2008-01-01&quot;</span>, time <span class="op">&lt;</span><span class="st"> &quot;2008-01-07&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot</span>(<span class="dt">key.pos =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb698-708" title="708"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(xts))</a>
<a class="sourceLine" id="cb698-709" title="709"><span class="kw">plot</span>(<span class="kw">as.xts</span>(a)[,<span class="dv">4</span>], <span class="dt">main =</span> DE_NUTS1<span class="op">$</span>NAME_<span class="dv">1</span>[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb698-710" title="710"><span class="kw">library</span>(spDataLarge)</a>
<a class="sourceLine" id="cb698-711" title="711"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-712" title="712"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones)[<span class="dv">33</span>], <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-713" title="713"><span class="kw">head</span>(bristol_od)</a>
<a class="sourceLine" id="cb698-714" title="714"><span class="kw">nrow</span>(bristol_zones)<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb698-715" title="715"><span class="kw">nrow</span>(bristol_od)</a>
<a class="sourceLine" id="cb698-716" title="716"><span class="co"># create O-D-mode array:</span></a>
<a class="sourceLine" id="cb698-717" title="717">bristol_tidy &lt;-<span class="st"> </span>bristol_od <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>all) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(<span class="st">&quot;mode&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="op">-</span>o, <span class="op">-</span>d)</a>
<a class="sourceLine" id="cb698-718" title="718"><span class="kw">head</span>(bristol_tidy)</a>
<a class="sourceLine" id="cb698-719" title="719">od =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;o&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>unique</a>
<a class="sourceLine" id="cb698-720" title="720">nod =<span class="st"> </span><span class="kw">length</span>(od)</a>
<a class="sourceLine" id="cb698-721" title="721">mode =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;mode&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>unique</a>
<a class="sourceLine" id="cb698-722" title="722">nmode =<span class="st"> </span><span class="kw">length</span>(mode)</a>
<a class="sourceLine" id="cb698-723" title="723">a =<span class="st"> </span><span class="kw">array</span>(0L,  <span class="kw">c</span>(nod, nod, nmode), </a>
<a class="sourceLine" id="cb698-724" title="724">    <span class="dt">dimnames =</span> <span class="kw">list</span>(<span class="dt">o =</span> od, <span class="dt">d =</span> od, <span class="dt">mode =</span> mode))</a>
<a class="sourceLine" id="cb698-725" title="725">a[<span class="kw">as.matrix</span>(bristol_tidy[<span class="kw">c</span>(<span class="st">&quot;o&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;mode&quot;</span>)])] =<span class="st"> </span>bristol_tidy<span class="op">$</span>n</a>
<a class="sourceLine" id="cb698-726" title="726">order =<span class="st"> </span><span class="kw">match</span>(od, bristol_zones<span class="op">$</span>geo_code) <span class="co"># it happens this equals 1:102</span></a>
<a class="sourceLine" id="cb698-727" title="727">zones =<span class="st"> </span><span class="kw">st_geometry</span>(bristol_zones)[order]</a>
<a class="sourceLine" id="cb698-728" title="728"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-729" title="729">(<span class="dt">d =</span> <span class="kw">st_dimensions</span>(<span class="dt">o =</span> zones, <span class="dt">d =</span> zones, <span class="dt">mode =</span> mode))</a>
<a class="sourceLine" id="cb698-730" title="730">(<span class="dt">odm =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">N =</span> a), <span class="dt">dimensions =</span> d))</a>
<a class="sourceLine" id="cb698-731" title="731"><span class="kw">plot</span>(odm[,,<span class="dv">33</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-732" title="732">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb698-733" title="733"><span class="kw">which.max</span>(d[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb698-734" title="734"><span class="kw">st_apply</span>(odm, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb698-735" title="735"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</a>
<a class="sourceLine" id="cb698-736" title="736"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</a>
<a class="sourceLine" id="cb698-737" title="737">o =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">1</span>, sum)</a>
<a class="sourceLine" id="cb698-738" title="738">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb698-739" title="739">x =<span class="st"> </span>(<span class="kw">c</span>(o, d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))))</a>
<a class="sourceLine" id="cb698-740" title="740"><span class="kw">plot</span>(x, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-741" title="741"><span class="kw">library</span>(units)</a>
<a class="sourceLine" id="cb698-742" title="742">a =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">set_units</span>(<span class="kw">st_area</span>(<span class="kw">st_as_sf</span>(o)), km<span class="op">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-743" title="743">dens_o =<span class="st"> </span>o <span class="op">/</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb698-744" title="744">dens_d =<span class="st"> </span>d <span class="op">/</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb698-745" title="745"><span class="kw">plot</span>(<span class="kw">c</span>(dens_o, dens_d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))), <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-746" title="746"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-747" title="747"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-748" title="748"></a>
<a class="sourceLine" id="cb698-749" title="749">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-750" title="750">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-751" title="751"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-752" title="752">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-753" title="753"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-754" title="754">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-755" title="755"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-756" title="756"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-757" title="757"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-758" title="758">)</a>
<a class="sourceLine" id="cb698-759" title="759"></a>
<a class="sourceLine" id="cb698-760" title="760"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-761" title="761">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-762" title="762"></a>
<a class="sourceLine" id="cb698-763" title="763"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-764" title="764"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-765" title="765"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-766" title="766">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-767" title="767"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-768" title="768"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb698-769" title="769"><span class="kw">sf_use_s2</span>(<span class="ot">FALSE</span>) <span class="co"># </span><span class="al">FIXME</span><span class="co">:</span></a>
<a class="sourceLine" id="cb698-770" title="770">w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb698-771" title="771"><span class="kw">suppressWarnings</span>(<span class="kw">st_crs</span>(w) &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb698-772" title="772"><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-773" title="773"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</a>
<a class="sourceLine" id="cb698-774" title="774"></a>
<a class="sourceLine" id="cb698-775" title="775">circ =<span class="st"> </span><span class="cf">function</span>(<span class="dt">l =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">180</span><span class="op">:</span><span class="dv">180</span>), <span class="dt">lon0 =</span> <span class="dv">0</span>, <span class="dt">lat0 =</span> <span class="dv">30</span>) {</a>
<a class="sourceLine" id="cb698-776" title="776">    deg2rad =<span class="st"> </span>pi <span class="op">/</span><span class="st"> </span><span class="dv">180</span></a>
<a class="sourceLine" id="cb698-777" title="777">    lat =<span class="st"> </span><span class="kw">atan</span>(<span class="op">-</span><span class="kw">cos</span>((l <span class="op">-</span><span class="st"> </span>lon0) <span class="op">*</span><span class="st"> </span>deg2rad)<span class="op">/</span><span class="kw">tan</span>(lat0 <span class="op">*</span><span class="st"> </span>deg2rad)) <span class="op">/</span><span class="st"> </span>deg2rad</a>
<a class="sourceLine" id="cb698-778" title="778">    xy =<span class="st"> </span><span class="cf">if</span> (lat0 <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb698-779" title="779">        l1 =<span class="st"> </span>lon0 <span class="op">-</span><span class="st"> </span><span class="dv">90</span></a>
<a class="sourceLine" id="cb698-780" title="780">        l2 =<span class="st"> </span>lon0 <span class="op">+</span><span class="st"> </span><span class="dv">90</span></a>
<a class="sourceLine" id="cb698-781" title="781">        <span class="kw">rbind</span>(<span class="kw">c</span>(l1,<span class="op">-</span><span class="dv">90</span>), <span class="kw">c</span>(l2,<span class="op">-</span><span class="dv">90</span>), <span class="kw">c</span>(l2,<span class="dv">0</span>), <span class="kw">c</span>(l2,<span class="dv">90</span>), <span class="kw">c</span>(l1,<span class="dv">90</span>), <span class="kw">c</span>(l1,<span class="dv">0</span>), <span class="kw">c</span>(l1,<span class="op">-</span><span class="dv">90</span>))</a>
<a class="sourceLine" id="cb698-782" title="782">    } <span class="cf">else</span> <span class="cf">if</span> (lat0 <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb698-783" title="783">        xy =<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">lon =</span> l, <span class="dt">lat =</span> lat)</a>
<a class="sourceLine" id="cb698-784" title="784">        <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">180</span>,<span class="dv">90</span>),xy,<span class="kw">c</span>(<span class="dv">180</span>,<span class="dv">90</span>),<span class="kw">c</span>(<span class="op">-</span><span class="dv">180</span>,<span class="dv">90</span>))</a>
<a class="sourceLine" id="cb698-785" title="785">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb698-786" title="786">        xy =<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">lon =</span> l, <span class="dt">lat =</span> lat)[<span class="kw">length</span>(l)<span class="op">:</span><span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb698-787" title="787">        <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">180</span>,<span class="op">-</span><span class="dv">90</span>), xy, <span class="kw">c</span>(<span class="op">-</span><span class="dv">180</span>,<span class="op">-</span><span class="dv">90</span>),<span class="kw">c</span>(<span class="dv">180</span>,<span class="op">-</span><span class="dv">90</span>))</a>
<a class="sourceLine" id="cb698-788" title="788">    }</a>
<a class="sourceLine" id="cb698-789" title="789">    <span class="kw">st_sfc</span>(<span class="kw">st_polygon</span>(<span class="kw">list</span>(xy)), <span class="dt">crs =</span> <span class="kw">st_crs</span>(<span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb698-790" title="790">    <span class="co"># </span><span class="al">TODO</span><span class="co">: break at dateline, guarantee within -180,180</span></a>
<a class="sourceLine" id="cb698-791" title="791">}</a>
<a class="sourceLine" id="cb698-792" title="792"></a>
<a class="sourceLine" id="cb698-793" title="793">m =<span class="st"> </span><span class="kw">st_make_grid</span>()</a>
<a class="sourceLine" id="cb698-794" title="794">m =<span class="st"> </span><span class="kw">st_segmentize</span>(m, <span class="fl">4e5</span>)</a>
<a class="sourceLine" id="cb698-795" title="795"></a>
<a class="sourceLine" id="cb698-796" title="796">i =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb698-797" title="797"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb698-798" title="798">lat=<span class="dv">30</span><span class="op">+</span>(i<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-799" title="799">lon=<span class="op">-</span><span class="dv">10</span><span class="op">-</span>(i<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-800" title="800">p4s=<span class="kw">paste0</span>(<span class="st">&quot;+proj=ortho +lat_0=&quot;</span>, lat, <span class="st">&quot; +lon_0=&quot;</span>, lon)</a>
<a class="sourceLine" id="cb698-801" title="801"><span class="kw">plot</span>(<span class="kw">st_transform</span>(m, <span class="kw">st_crs</span>(p4s), <span class="dt">check =</span> <span class="ot">TRUE</span>), <span class="dt">col =</span> <span class="st">&#39;lightblue&#39;</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb698-802" title="802">crc =<span class="st"> </span><span class="kw">circ</span>(<span class="dt">lat0 =</span> lat, <span class="dt">lon0 =</span> lon)</a>
<a class="sourceLine" id="cb698-803" title="803"><span class="kw">st_crs</span>(w) &lt;-<span class="st"> </span><span class="dv">4326</span> <span class="co"># added RSB to handle use of PROJ 6.1.0</span></a>
<a class="sourceLine" id="cb698-804" title="804">w0 =<span class="st"> </span><span class="kw">suppressWarnings</span>(<span class="kw">st_intersection</span>(<span class="kw">st_make_valid</span>(w), crc))</a>
<a class="sourceLine" id="cb698-805" title="805">w0 =<span class="st"> </span><span class="kw">st_cast</span>(w0, <span class="st">&quot;MULTIPOLYGON&quot;</span>)</a>
<a class="sourceLine" id="cb698-806" title="806"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_geometry</span>(w0), <span class="kw">st_crs</span>(p4s), <span class="dt">check =</span> <span class="ot">TRUE</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-807" title="807"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-808" title="808"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb698-809" title="809">w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb698-810" title="810"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</a>
<a class="sourceLine" id="cb698-811" title="811"><span class="kw">st_crs</span>(w)</a>
<a class="sourceLine" id="cb698-812" title="812">DE =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">ne_countries</span>(<span class="dt">country =</span> <span class="st">&quot;germany&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb698-813" title="813">DE.eqc =<span class="st"> </span><span class="kw">st_transform</span>(DE, <span class="st">&quot;+proj=eqc +lat_ts=51.14 +lon_0=90w&quot;</span>)</a>
<a class="sourceLine" id="cb698-814" title="814"><span class="kw">mean</span>(<span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="st">&quot;ymin&quot;</span>, <span class="st">&quot;ymax&quot;</span>)])</a>
<a class="sourceLine" id="cb698-815" title="815"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-816" title="816"><span class="kw">plot</span>(DE, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-817" title="817"><span class="kw">plot</span>(DE.eqc, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-818" title="818">sq =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">89</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">89</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">91</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">91</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">89</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-819" title="819">pol =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_polygon</span>(<span class="kw">list</span>(sq)), <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-820" title="820">(<span class="dt">pol.o =</span> <span class="kw">st_transform</span>(pol, <span class="st">&quot;+proj=ortho +lat_0=0 +lon_0=0&quot;</span>))[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-821" title="821"><span class="kw">st_is_valid</span>(pol.o, <span class="dt">NA_on_exception=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-822" title="822"><span class="kw">library</span>(classInt)</a>
<a class="sourceLine" id="cb698-823" title="823"><span class="co"># set.seed(1) needed ?</span></a>
<a class="sourceLine" id="cb698-824" title="824">r =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb698-825" title="825">(cI &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(r))</a>
<a class="sourceLine" id="cb698-826" title="826">cI<span class="op">$</span>brks</a>
<a class="sourceLine" id="cb698-827" title="827">(<span class="dt">ls =</span> <span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">179.5</span>, <span class="dv">52</span>), <span class="kw">c</span>(<span class="fl">179.5</span>, <span class="dv">52</span>))), <span class="dt">crs =</span> <span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb698-828" title="828"><span class="kw">st_length</span>(ls)</a>
<a class="sourceLine" id="cb698-829" title="829">dateline =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">180</span>, <span class="dv">51</span>), <span class="kw">c</span>(<span class="dv">180</span>, <span class="dv">53</span>))), <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-830" title="830"><span class="kw">st_intersects</span>(ls, dateline)</a>
<a class="sourceLine" id="cb698-831" title="831">(<span class="dt">ls.w =</span> <span class="kw">st_wrap_dateline</span>(ls))[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-832" title="832">(<span class="dt">ls.w2 =</span> <span class="kw">st_wrap_dateline</span>(<span class="kw">st_segmentize</span>(ls, units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">30</span>, km))))[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-833" title="833"><span class="kw">st_bbox</span>(ls.w)</a>
<a class="sourceLine" id="cb698-834" title="834">pole =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">80</span>), <span class="kw">c</span>(<span class="dv">120</span>,<span class="dv">80</span>), <span class="kw">c</span>(<span class="dv">240</span>,<span class="dv">80</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">80</span>)))), <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-835" title="835"><span class="kw">st_intersects</span>(pole, <span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">90</span>)), <span class="dt">crs =</span> <span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb698-836" title="836"><span class="kw">st_area</span>(pole)</a>
<a class="sourceLine" id="cb698-837" title="837"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-838" title="838"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-839" title="839"></a>
<a class="sourceLine" id="cb698-840" title="840">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-841" title="841">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-842" title="842"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-843" title="843">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-844" title="844"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-845" title="845">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-846" title="846"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-847" title="847"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-848" title="848"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-849" title="849">)</a>
<a class="sourceLine" id="cb698-850" title="850"></a>
<a class="sourceLine" id="cb698-851" title="851"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-852" title="852">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-853" title="853"></a>
<a class="sourceLine" id="cb698-854" title="854"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-855" title="855"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-856" title="856"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-857" title="857">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-858" title="858"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>read_sf -&gt;<span class="st"> </span>nc</a>
<a class="sourceLine" id="cb698-859" title="859"><span class="kw">plot</span>(nc)</a>
<a class="sourceLine" id="cb698-860" title="860"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(dplyr))</a>
<a class="sourceLine" id="cb698-861" title="861">nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">plot</span>(<span class="dt">key.pos =</span> <span class="dv">4</span>) <span class="co"># 1: below; 4: right</span></a>
<a class="sourceLine" id="cb698-862" title="862"><span class="kw">plot</span>(nc[<span class="st">&quot;SID74&quot;</span>], <span class="dt">logz =</span> <span class="ot">TRUE</span>, <span class="dt">pal =</span> viridis<span class="op">::</span>viridis,</a>
<a class="sourceLine" id="cb698-863" title="863">    <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>,.<span class="dv">5</span>,<span class="dv">1</span>,<span class="fl">1.5</span>,<span class="dv">2</span>,<span class="fl">2.5</span>), <span class="dt">at =</span> <span class="kw">c</span>(<span class="dv">0</span>,.<span class="dv">5</span>,<span class="dv">1</span>,<span class="fl">1.5</span>,<span class="dv">2</span>,<span class="fl">2.5</span>),</a>
<a class="sourceLine" id="cb698-864" title="864">    <span class="dt">key.width =</span> <span class="kw">lcm</span>(<span class="fl">1.3</span>), <span class="dt">key.length =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-865" title="865"><span class="kw">plot</span>(nc[<span class="st">&quot;SID74&quot;</span>], <span class="dt">pal =</span> viridis<span class="op">::</span>viridis, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-866" title="866"><span class="kw">plot</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">81.498</span>,<span class="fl">36.434</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">1</span>, <span class="dt">cex =</span> <span class="dv">4</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-867" title="867"><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span>)) <span class="co"># manually reset the plotting region split-up</span></a>
<a class="sourceLine" id="cb698-868" title="868">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb698-869" title="869"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-870" title="870">x =<span class="st"> </span><span class="kw">read_stars</span>(tif)</a>
<a class="sourceLine" id="cb698-871" title="871"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-872" title="872"><span class="kw">plot</span>(x[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span>], <span class="dt">text_values=</span><span class="ot">TRUE</span>, <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw">viridis</span>(<span class="dv">10</span>), </a>
<a class="sourceLine" id="cb698-873" title="873">    <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-874" title="874"><span class="kw">plot</span>(x[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>], <span class="dt">rgb=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">interpolate =</span> <span class="ot">TRUE</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-875" title="875"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb698-876" title="876">xs =<span class="st"> </span><span class="kw">adrop</span>(x[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb698-877" title="877"><span class="kw">attr</span>(<span class="kw">attr</span>(xs, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-878" title="878"><span class="kw">plot</span>(xs, <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw">viridis</span>(<span class="dv">10</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-879" title="879"><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(xs, <span class="dt">as_points =</span> <span class="ot">FALSE</span>, <span class="dt">merge =</span> <span class="ot">FALSE</span>), <span class="dt">pal =</span> viridis<span class="op">::</span>viridis, </a>
<a class="sourceLine" id="cb698-880" title="880">    <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-881" title="881"><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(xs, <span class="dt">as_points =</span> <span class="ot">TRUE</span>, <span class="dt">merge =</span> <span class="ot">FALSE</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb698-882" title="882">    <span class="dt">pal =</span> viridis<span class="op">::</span>viridis, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-883" title="883"><span class="kw">library</span>(grid)</a>
<a class="sourceLine" id="cb698-884" title="884"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>read_sf -&gt;<span class="st"> </span>nc</a>
<a class="sourceLine" id="cb698-885" title="885"><span class="kw">st_viewport</span>(nc) <span class="op">%&gt;%</span><span class="st"> </span>pushViewport</a>
<a class="sourceLine" id="cb698-886" title="886"><span class="kw">st_geometry</span>(nc) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">lapply</span>(st_as_grob) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">lapply</span>(grid.draw) -&gt;<span class="st"> </span>x</a>
<a class="sourceLine" id="cb698-887" title="887"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-888" title="888"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-889" title="889"></a>
<a class="sourceLine" id="cb698-890" title="890">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-891" title="891">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-892" title="892"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-893" title="893">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-894" title="894"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-895" title="895">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-896" title="896"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-897" title="897"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-898" title="898"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-899" title="899">)</a>
<a class="sourceLine" id="cb698-900" title="900"></a>
<a class="sourceLine" id="cb698-901" title="901"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-902" title="902">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-903" title="903"></a>
<a class="sourceLine" id="cb698-904" title="904"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-905" title="905"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-906" title="906"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-907" title="907">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-908" title="908"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb698-909" title="909"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-910" title="910"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">read_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-911" title="911"><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">32119</span>) -&gt;<span class="st"> </span>nc<span class="fl">.32119</span></a>
<a class="sourceLine" id="cb698-912" title="912"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc<span class="fl">.32119</span>) </a>
<a class="sourceLine" id="cb698-913" title="913"><span class="kw">ggplot</span>(nc<span class="fl">.32119</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>()</a>
<a class="sourceLine" id="cb698-914" title="914"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc<span class="fl">.32119</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb698-915" title="915"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>))</a>
<a class="sourceLine" id="cb698-916" title="916"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc<span class="fl">.32119</span>) <span class="op">+</span><span class="st"> </span><span class="kw">aes</span>(<span class="dt">fill =</span> BIR74) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-917" title="917"><span class="st">    </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> viridis<span class="op">::</span><span class="kw">viridis</span>(<span class="dv">20</span>))</a>
<a class="sourceLine" id="cb698-918" title="918"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc<span class="fl">.32119</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_centroid</span>(nc<span class="fl">.32119</span>))</a>
<a class="sourceLine" id="cb698-919" title="919">nc &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>), <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-920" title="920">nc_<span class="dv">3857</span> &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_transform</span>(nc, <span class="st">&quot;+init=epsg:3857&quot;</span>)</a>
<a class="sourceLine" id="cb698-921" title="921"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-922" title="922"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc_<span class="dv">3857</span>[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, ], <span class="kw">aes</span>(<span class="dt">fill =</span> AREA)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-923" title="923"><span class="st">    </span><span class="kw">geom_sf_label</span>(<span class="dt">data =</span> nc_<span class="dv">3857</span>[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, ], <span class="kw">aes</span>(<span class="dt">label =</span> NAME))</a>
<a class="sourceLine" id="cb698-924" title="924"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-925" title="925"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb698-926" title="926"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb698-927" title="927"><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">read_stars</span>() -&gt;<span class="st"> </span>x</a>
<a class="sourceLine" id="cb698-928" title="928">g =<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-929" title="929"><span class="st">    </span><span class="kw">coord_equal</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-930" title="930"><span class="st">    </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-931" title="931"><span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb698-932" title="932"><span class="st">    </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-933" title="933"><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-934" title="934">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> x) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-935" title="935"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>band)</a>
<a class="sourceLine" id="cb698-936" title="936">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> x, <span class="dt">downsample =</span> <span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-937" title="937"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>band)</a>
<a class="sourceLine" id="cb698-938" title="938"><span class="kw">library</span>(spacetime)</a>
<a class="sourceLine" id="cb698-939" title="939"><span class="kw">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span></a>
<a class="sourceLine" id="cb698-940" title="940">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">station =</span> <span class="kw">st_as_sfc</span>(stations), <span class="dt">time =</span> dates)</a>
<a class="sourceLine" id="cb698-941" title="941">aq =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">PM10 =</span> air), <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb698-942" title="942"><span class="co"># ggplot() + geom_stars(data = aq[,,3000])</span></a>
<a class="sourceLine" id="cb698-943" title="943">aq.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(aq[,,<span class="dv">3000</span>], <span class="dt">long=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-944" title="944"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-945" title="945"><span class="st">   </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_as_sf</span>(DE_NUTS1)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-946" title="946"><span class="st">   </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> aq.sf, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">col =</span> PM10)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-947" title="947"><span class="st">   </span><span class="kw">ggtitle</span>(aq.sf<span class="op">$</span>time[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb698-948" title="948"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-949" title="949"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-950" title="950"></a>
<a class="sourceLine" id="cb698-951" title="951">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-952" title="952">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-953" title="953"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-954" title="954">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-955" title="955"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-956" title="956">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-957" title="957"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-958" title="958"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-959" title="959"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-960" title="960">)</a>
<a class="sourceLine" id="cb698-961" title="961"></a>
<a class="sourceLine" id="cb698-962" title="962"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-963" title="963">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-964" title="964"></a>
<a class="sourceLine" id="cb698-965" title="965"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-966" title="966"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-967" title="967"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-968" title="968">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-969" title="969"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-970" title="970"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-971" title="971"></a>
<a class="sourceLine" id="cb698-972" title="972">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-973" title="973">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-974" title="974"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-975" title="975">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-976" title="976"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-977" title="977">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-978" title="978"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-979" title="979"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-980" title="980"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-981" title="981">)</a>
<a class="sourceLine" id="cb698-982" title="982"></a>
<a class="sourceLine" id="cb698-983" title="983"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-984" title="984">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-985" title="985"></a>
<a class="sourceLine" id="cb698-986" title="986"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-987" title="987"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-988" title="988"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-989" title="989">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-990" title="990"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-991" title="991"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-992" title="992"></a>
<a class="sourceLine" id="cb698-993" title="993">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-994" title="994">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-995" title="995"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-996" title="996">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-997" title="997"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-998" title="998">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-999" title="999"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1000" title="1000"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1001" title="1001"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1002" title="1002">)</a>
<a class="sourceLine" id="cb698-1003" title="1003"></a>
<a class="sourceLine" id="cb698-1004" title="1004"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1005" title="1005">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1006" title="1006"></a>
<a class="sourceLine" id="cb698-1007" title="1007"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1008" title="1008"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1009" title="1009"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1010" title="1010">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1011" title="1011"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1012" title="1012"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1013" title="1013"></a>
<a class="sourceLine" id="cb698-1014" title="1014">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1015" title="1015">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1016" title="1016"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1017" title="1017">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1018" title="1018"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1019" title="1019">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1020" title="1020"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1021" title="1021"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1022" title="1022"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1023" title="1023">)</a>
<a class="sourceLine" id="cb698-1024" title="1024"></a>
<a class="sourceLine" id="cb698-1025" title="1025"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1026" title="1026">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1027" title="1027"></a>
<a class="sourceLine" id="cb698-1028" title="1028"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1029" title="1029"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1030" title="1030"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1031" title="1031">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1032" title="1032">files =<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;aq&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;*.csv&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1033" title="1033">r =<span class="st"> </span><span class="kw">lapply</span>(files[<span class="op">-</span><span class="dv">1</span>], <span class="cf">function</span>(f) <span class="kw">read.csv</span>(f))</a>
<a class="sourceLine" id="cb698-1034" title="1034"><span class="kw">Sys.setenv</span>(<span class="dt">TZ =</span> <span class="st">&quot;UTC&quot;</span>) <span class="co"># make sure times are not interpreted as DST</span></a>
<a class="sourceLine" id="cb698-1035" title="1035">r =<span class="st"> </span><span class="kw">lapply</span>(r, <span class="cf">function</span>(f) {</a>
<a class="sourceLine" id="cb698-1036" title="1036">        f<span class="op">$</span>t =<span class="st"> </span><span class="kw">as.POSIXct</span>(f<span class="op">$</span>DatetimeBegin) </a>
<a class="sourceLine" id="cb698-1037" title="1037">        f[<span class="kw">order</span>(f<span class="op">$</span>t), ] </a>
<a class="sourceLine" id="cb698-1038" title="1038">    }</a>
<a class="sourceLine" id="cb698-1039" title="1039">) </a>
<a class="sourceLine" id="cb698-1040" title="1040">r =<span class="st"> </span>r[<span class="kw">sapply</span>(r, nrow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span>]</a>
<a class="sourceLine" id="cb698-1041" title="1041"><span class="kw">names</span>(r) =<span class="st">  </span><span class="kw">sapply</span>(r, <span class="cf">function</span>(f) <span class="kw">unique</span>(f<span class="op">$</span>AirQualityStationEoICode))</a>
<a class="sourceLine" id="cb698-1042" title="1042"><span class="kw">length</span>(r) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(<span class="kw">names</span>(r)))</a>
<a class="sourceLine" id="cb698-1043" title="1043"><span class="kw">library</span>(xts)</a>
<a class="sourceLine" id="cb698-1044" title="1044">r =<span class="st"> </span><span class="kw">lapply</span>(r, <span class="cf">function</span>(f) <span class="kw">xts</span>(f<span class="op">$</span>Concentration, f<span class="op">$</span>t))</a>
<a class="sourceLine" id="cb698-1045" title="1045">aq =<span class="st"> </span><span class="kw">do.call</span>(cbind, r)</a>
<a class="sourceLine" id="cb698-1046" title="1046"><span class="co"># remove stations with more than 75% missing values:</span></a>
<a class="sourceLine" id="cb698-1047" title="1047">sel =<span class="st"> </span><span class="kw">apply</span>(aq, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="kw">is.na</span>(x)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.75</span> <span class="op">*</span><span class="st"> </span><span class="dv">365</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span>)</a>
<a class="sourceLine" id="cb698-1048" title="1048">aqsel =<span class="st"> </span>aq[, sel] <span class="co"># stations are in columns</span></a>
<a class="sourceLine" id="cb698-1049" title="1049"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb698-1050" title="1050"><span class="kw">read.csv</span>(<span class="st">&quot;aq/AirBase_v8_stations.csv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1051" title="1051"><span class="st">    </span>as_tibble  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1052" title="1052"><span class="st">    </span><span class="kw">filter</span>(country_iso_code <span class="op">==</span><span class="st"> &quot;DE&quot;</span>, station_type_of_area <span class="op">==</span><span class="st"> &quot;rural&quot;</span>, </a>
<a class="sourceLine" id="cb698-1053" title="1053">                 type_of_station <span class="op">==</span><span class="st"> &quot;Background&quot;</span>) -&gt;<span class="st"> </span>a2</a>
<a class="sourceLine" id="cb698-1054" title="1054"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-1055" title="1055"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb698-1056" title="1056">a2.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(a2, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;station_longitude_deg&quot;</span>, <span class="st">&quot;station_latitude_deg&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb698-1057" title="1057">sel =<span class="st">  </span><span class="kw">colnames</span>(aqsel) <span class="op">%in%</span><span class="st"> </span>a2<span class="op">$</span>station_european_code</a>
<a class="sourceLine" id="cb698-1058" title="1058">aqsel =<span class="st"> </span>aqsel[, sel]</a>
<a class="sourceLine" id="cb698-1059" title="1059">tb =<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">NO2 =</span> <span class="kw">apply</span>(aqsel, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">station_european_code =</span> <span class="kw">colnames</span>(aqsel))</a>
<a class="sourceLine" id="cb698-1060" title="1060">crs =<span class="st"> </span><span class="dv">32632</span></a>
<a class="sourceLine" id="cb698-1061" title="1061"><span class="kw">right_join</span>(a2.sf, tb) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(crs) -&gt;<span class="st"> </span>no2.sf </a>
<a class="sourceLine" id="cb698-1062" title="1062"><span class="co"># load German boundaries</span></a>
<a class="sourceLine" id="cb698-1063" title="1063"><span class="kw">data</span>(air, <span class="dt">package =</span> <span class="st">&quot;spacetime&quot;</span>)</a>
<a class="sourceLine" id="cb698-1064" title="1064">de &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(DE_NUTS1), crs)</a>
<a class="sourceLine" id="cb698-1065" title="1065"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> de) <span class="op">+</span><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">col =</span> NO2))</a>
<a class="sourceLine" id="cb698-1066" title="1066"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb698-1067" title="1067">v =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf)</a>
<a class="sourceLine" id="cb698-1068" title="1068"><span class="kw">plot</span>(v, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1069" title="1069"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb698-1070" title="1070">v0 =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, <span class="dt">cutoff =</span> <span class="dv">100000</span>, <span class="dt">width =</span> <span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb698-1071" title="1071"><span class="kw">plot</span>(v0, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1072" title="1072">v.m =<span class="st"> </span><span class="kw">fit.variogram</span>(v, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-1073" title="1073"><span class="kw">plot</span>(v, v.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1074" title="1074"><span class="co"># build a grid over Germany:</span></a>
<a class="sourceLine" id="cb698-1075" title="1075"><span class="kw">st_bbox</span>(de) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1076" title="1076"><span class="st">  </span><span class="kw">st_as_stars</span>(<span class="dt">dx =</span> <span class="dv">10000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1077" title="1077"><span class="st">  </span><span class="kw">st_set_crs</span>(crs) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1078" title="1078"><span class="st">  </span><span class="kw">st_crop</span>(de) -&gt;<span class="st"> </span>grd</a>
<a class="sourceLine" id="cb698-1079" title="1079">grd</a>
<a class="sourceLine" id="cb698-1080" title="1080">k =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m)</a>
<a class="sourceLine" id="cb698-1081" title="1081"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> k, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1082" title="1082"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1083" title="1083"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf)</a>
<a class="sourceLine" id="cb698-1084" title="1084">a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], <span class="dt">by =</span> de, <span class="dt">FUN =</span> mean)</a>
<a class="sourceLine" id="cb698-1085" title="1085">b =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, de, v.m)</a>
<a class="sourceLine" id="cb698-1086" title="1086">b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</a>
<a class="sourceLine" id="cb698-1087" title="1087">b<span class="op">$</span>kriging =<span class="st"> </span>b<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb698-1088" title="1088">b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(var, NO2, <span class="op">-</span>geometry) -&gt;<span class="st"> </span>b2</a>
<a class="sourceLine" id="cb698-1089" title="1089"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> NO2)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1090" title="1090"><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</a>
<a class="sourceLine" id="cb698-1091" title="1091">SE =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sqrt</span>(<span class="kw">var</span>(x)<span class="op">/</span><span class="kw">length</span>(x))</a>
<a class="sourceLine" id="cb698-1092" title="1092">a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], de, SE)</a>
<a class="sourceLine" id="cb698-1093" title="1093">b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</a>
<a class="sourceLine" id="cb698-1094" title="1094">b<span class="op">$</span>kriging =<span class="st"> </span><span class="kw">sqrt</span>(b<span class="op">$</span>var1.var)</a>
<a class="sourceLine" id="cb698-1095" title="1095">b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(var, NO2, <span class="op">-</span>geometry) -&gt;<span class="st"> </span>b2</a>
<a class="sourceLine" id="cb698-1096" title="1096"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> NO2)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1097" title="1097"><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</a>
<a class="sourceLine" id="cb698-1098" title="1098"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb698-1099" title="1099">s =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m, <span class="dt">nmax =</span> <span class="dv">30</span>, <span class="dt">nsim =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb698-1100" title="1100">g =<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1101" title="1101"><span class="st">    </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1102" title="1102"><span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1103" title="1103"><span class="st">    </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1104" title="1104"><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb698-1105" title="1105">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> s[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sample)</a>
<a class="sourceLine" id="cb698-1106" title="1106"><span class="kw">library</span>(vroom)</a>
<a class="sourceLine" id="cb698-1107" title="1107">v =<span class="st"> </span><span class="kw">vroom</span>(<span class="st">&quot;aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv&quot;</span>)</a>
<a class="sourceLine" id="cb698-1108" title="1108">v <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Einwohner <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1109" title="1109"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>Gitter_ID_100m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1110" title="1110"><span class="st">    </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x_mp_100m&quot;</span>, <span class="st">&quot;y_mp_100m&quot;</span>), <span class="dt">crs =</span> <span class="dv">3035</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1111" title="1111"><span class="st">    </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(grd)) -&gt;<span class="st"> </span>b</a>
<a class="sourceLine" id="cb698-1112" title="1112">a =<span class="st"> </span><span class="kw">aggregate</span>(b, <span class="kw">st_as_sf</span>(grd, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), sum)</a>
<a class="sourceLine" id="cb698-1113" title="1113">grd<span class="op">$</span>ID =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">prod</span>(<span class="kw">dim</span>(grd)) <span class="co"># so we can find out later which grid cell we have</span></a>
<a class="sourceLine" id="cb698-1114" title="1114">ii =<span class="st"> </span><span class="kw">st_intersects</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="kw">st_cast</span>(<span class="kw">st_union</span>(de), <span class="st">&quot;MULTILINESTRING&quot;</span>))</a>
<a class="sourceLine" id="cb698-1115" title="1115">grd_sf =<span class="st"> </span><span class="kw">st_as_sf</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)[<span class="kw">lengths</span>(ii) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb698-1116" title="1116">iii =<span class="st"> </span><span class="kw">st_intersection</span>(grd_sf, <span class="kw">st_union</span>(de))</a>
<a class="sourceLine" id="cb698-1117" title="1117">grd<span class="op">$</span>area =<span class="st"> </span><span class="kw">st_area</span>(grd)[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(grd<span class="op">$</span>values, m<span class="op">^</span><span class="dv">2</span>) <span class="co"># NA&#39;s</span></a>
<a class="sourceLine" id="cb698-1118" title="1118">grd<span class="op">$</span>area[iii<span class="op">$</span>ID] =<span class="st"> </span><span class="kw">st_area</span>(iii)</a>
<a class="sourceLine" id="cb698-1119" title="1119">grd<span class="op">$</span>pop_dens =<span class="st"> </span>a<span class="op">$</span>Einwohner <span class="op">/</span><span class="st"> </span>grd<span class="op">$</span>area</a>
<a class="sourceLine" id="cb698-1120" title="1120"><span class="kw">sum</span>(grd<span class="op">$</span>pop_dens <span class="op">*</span><span class="st"> </span>grd<span class="op">$</span>area, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># verify</span></a>
<a class="sourceLine" id="cb698-1121" title="1121"><span class="kw">sum</span>(b<span class="op">$</span>Einwohner)</a>
<a class="sourceLine" id="cb698-1122" title="1122">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> grd, <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">sqrt</span>(pop_dens), <span class="dt">x =</span> x, <span class="dt">y =</span> y))</a>
<a class="sourceLine" id="cb698-1123" title="1123">(<span class="dt">a =</span> <span class="kw">aggregate</span>(grd[<span class="st">&quot;pop_dens&quot;</span>], no2.sf, mean))</a>
<a class="sourceLine" id="cb698-1124" title="1124">no2.sf<span class="op">$</span>pop_dens =<span class="st"> </span><span class="kw">st_as_sf</span>(a)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-1125" title="1125"><span class="kw">summary</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</a>
<a class="sourceLine" id="cb698-1126" title="1126"><span class="kw">plot</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</a>
<a class="sourceLine" id="cb698-1127" title="1127"><span class="kw">abline</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</a>
<a class="sourceLine" id="cb698-1128" title="1128">no2.sf =<span class="st"> </span>no2.sf[<span class="op">!</span><span class="kw">is.na</span>(no2.sf<span class="op">$</span>pop_dens),]</a>
<a class="sourceLine" id="cb698-1129" title="1129">vr =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</a>
<a class="sourceLine" id="cb698-1130" title="1130">vr.m =<span class="st"> </span><span class="kw">fit.variogram</span>(vr, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-1131" title="1131"><span class="kw">plot</span>(vr, vr.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1132" title="1132">kr =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf, grd[<span class="st">&quot;pop_dens&quot;</span>], vr.m)</a>
<a class="sourceLine" id="cb698-1133" title="1133">k<span class="op">$</span>kr1 =<span class="st"> </span>k<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb698-1134" title="1134">k<span class="op">$</span>kr2 =<span class="st"> </span>kr<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb698-1135" title="1135"><span class="kw">st_redimension</span>(k[<span class="kw">c</span>(<span class="st">&quot;kr1&quot;</span>, <span class="st">&quot;kr2&quot;</span>)], </a>
<a class="sourceLine" id="cb698-1136" title="1136">    <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">what =</span> <span class="kw">c</span>(<span class="st">&quot;kriging&quot;</span>, <span class="st">&quot;residual kriging&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1137" title="1137"><span class="st">    </span><span class="kw">setNames</span>(<span class="st">&quot;NO2&quot;</span>) -&gt;<span class="st"> </span>km</a>
<a class="sourceLine" id="cb698-1138" title="1138">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> km, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1139" title="1139"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1140" title="1140"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>what)</a>
<a class="sourceLine" id="cb698-1141" title="1141"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb698-1142" title="1142"><span class="kw">demo</span>(cokriging)</a>
<a class="sourceLine" id="cb698-1143" title="1143"><span class="kw">demo</span>(cosimulation)</a>
<a class="sourceLine" id="cb698-1144" title="1144">aqx =<span class="st"> </span>aq[ , <span class="kw">colnames</span>(aq) <span class="op">%in%</span><span class="st"> </span>a2<span class="op">$</span>station_european_code]</a>
<a class="sourceLine" id="cb698-1145" title="1145">sfc =<span class="st"> </span><span class="kw">st_geometry</span>(a2.sf)[<span class="kw">match</span>(<span class="kw">colnames</span>(aqx), a2.sf<span class="op">$</span>station_european_code)]</a>
<a class="sourceLine" id="cb698-1146" title="1146"><span class="kw">st_as_stars</span>(<span class="dt">NO2 =</span> <span class="kw">as.matrix</span>(aqx)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1147" title="1147"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;station&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1148" title="1148"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="kw">index</span>(aqx)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1149" title="1149"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;station&quot;</span>, sfc) -&gt;<span class="st"> </span>no2.st</a>
<a class="sourceLine" id="cb698-1150" title="1150">v.st =<span class="st"> </span><span class="kw">variogramST</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.st[,<span class="dv">1</span><span class="op">:</span>(<span class="dv">24</span><span class="op">*</span><span class="dv">31</span>)], <span class="dt">tlags =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">48</span>, </a>
<a class="sourceLine" id="cb698-1151" title="1151">    <span class="dt">cores =</span> <span class="kw">getOption</span>(<span class="st">&quot;mc.cores&quot;</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-1152" title="1152">v1 =<span class="st"> </span><span class="kw">plot</span>(v.st)</a>
<a class="sourceLine" id="cb698-1153" title="1153">v2 =<span class="st"> </span><span class="kw">plot</span>(v.st, <span class="dt">map =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1154" title="1154"><span class="kw">print</span>(v1, <span class="dt">split =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">more =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1155" title="1155"><span class="kw">print</span>(v2, <span class="dt">split =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">more =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1156" title="1156"><span class="co"># product-sum</span></a>
<a class="sourceLine" id="cb698-1157" title="1157">prodSumModel &lt;-<span class="st"> </span><span class="kw">vgmST</span>(<span class="st">&quot;productSum&quot;</span>,</a>
<a class="sourceLine" id="cb698-1158" title="1158">    <span class="dt">space=</span><span class="kw">vgm</span>(<span class="dv">150</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">200</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb698-1159" title="1159">    <span class="dt">time=</span> <span class="kw">vgm</span>(<span class="dv">20</span>, <span class="st">&quot;Sph&quot;</span>,   <span class="dv">40</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb698-1160" title="1160">    <span class="dt">k=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-1161" title="1161">StAni =<span class="st"> </span><span class="kw">estiStAni</span>(v.st, <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">200000</span>))</a>
<a class="sourceLine" id="cb698-1162" title="1162">(fitProdSumModel &lt;-<span class="st"> </span><span class="kw">fit.StVariogram</span>(v.st, prodSumModel, <span class="dt">fit.method =</span> <span class="dv">7</span>,</a>
<a class="sourceLine" id="cb698-1163" title="1163">    <span class="dt">stAni =</span> StAni, <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>,</a>
<a class="sourceLine" id="cb698-1164" title="1164">    <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">parscale =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">10</span>)),</a>
<a class="sourceLine" id="cb698-1165" title="1165">    <span class="dt">lower =</span> <span class="kw">rep</span>(<span class="fl">0.0001</span>, <span class="dv">7</span>)))</a>
<a class="sourceLine" id="cb698-1166" title="1166"><span class="kw">plot</span>(v.st, fitProdSumModel, <span class="dt">wireframe=</span><span class="ot">FALSE</span>, <span class="dt">all=</span><span class="ot">TRUE</span>, <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">arrows=</span><span class="ot">FALSE</span>), <span class="dt">zlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">150</span>))</a>
<a class="sourceLine" id="cb698-1167" title="1167"><span class="kw">plot</span>(v.st, <span class="dt">model=</span>fitProdSumModel, <span class="dt">wireframe=</span><span class="ot">TRUE</span>, <span class="dt">all=</span><span class="ot">TRUE</span>, <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">arrows=</span><span class="ot">FALSE</span>), <span class="dt">zlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">185</span>))</a>
<a class="sourceLine" id="cb698-1168" title="1168"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb698-1169" title="1169">pt =<span class="st"> </span><span class="kw">st_sample</span>(de, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-1170" title="1170">t =<span class="st"> </span><span class="kw">st_get_dimension_values</span>(no2.st, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1171" title="1171"><span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">pts =</span> <span class="kw">matrix</span>(<span class="dv">1</span>, <span class="kw">length</span>(t), <span class="kw">length</span>(pt)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1172" title="1172"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;station&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1173" title="1173"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, t) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1174" title="1174"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;station&quot;</span>, pt) -&gt;<span class="st"> </span>new_pt</a>
<a class="sourceLine" id="cb698-1175" title="1175">no2.st &lt;-<span class="st"> </span><span class="kw">st_transform</span>(no2.st, crs)</a>
<a class="sourceLine" id="cb698-1176" title="1176">new_ts &lt;-<span class="st"> </span><span class="kw">krigeST</span>(NO2<span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> no2.st[<span class="st">&quot;NO2&quot;</span>], <span class="dt">newdata =</span> new_pt,</a>
<a class="sourceLine" id="cb698-1177" title="1177">         <span class="dt">nmax =</span> <span class="dv">50</span>, <span class="dt">stAni =</span> StAni, <span class="dt">modelList =</span> fitProdSumModel,</a>
<a class="sourceLine" id="cb698-1178" title="1178">         <span class="dt">progress =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1179" title="1179"><span class="kw">plot</span>(<span class="kw">as.xts</span>(new_ts[<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb698-1180" title="1180">t4 =<span class="st"> </span>t[(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">*</span><span class="st"> </span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">*</span><span class="dv">30</span>)]</a>
<a class="sourceLine" id="cb698-1181" title="1181"></a>
<a class="sourceLine" id="cb698-1182" title="1182">d =<span class="st"> </span><span class="kw">dim</span>(grd)</a>
<a class="sourceLine" id="cb698-1183" title="1183"><span class="kw">st_as_stars</span>(<span class="dt">pts =</span> <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(d[<span class="dv">1</span>], d[<span class="dv">2</span>], <span class="dt">time=</span><span class="kw">length</span>(t4)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1184" title="1184"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, t4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1185" title="1185"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;x&quot;</span>, <span class="kw">st_get_dimension_values</span>(grd, <span class="st">&quot;x&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1186" title="1186"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;y&quot;</span>, <span class="kw">st_get_dimension_values</span>(grd, <span class="st">&quot;y&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb698-1187" title="1187"><span class="st">    </span><span class="kw">st_set_crs</span>(crs) -&gt;<span class="st"> </span>grd.st</a>
<a class="sourceLine" id="cb698-1188" title="1188">new_int &lt;-<span class="st"> </span><span class="kw">krigeST</span>(NO2<span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> no2.st[<span class="st">&quot;NO2&quot;</span>], <span class="dt">newdata =</span> grd.st,</a>
<a class="sourceLine" id="cb698-1189" title="1189">         <span class="dt">nmax =</span> <span class="dv">200</span>, <span class="dt">stAni =</span> StAni, <span class="dt">modelList =</span> fitProdSumModel,</a>
<a class="sourceLine" id="cb698-1190" title="1190">         <span class="dt">progress =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1191" title="1191"><span class="kw">names</span>(new_int)[<span class="dv">2</span>] =<span class="st"> &quot;NO2&quot;</span></a>
<a class="sourceLine" id="cb698-1192" title="1192">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> new_int, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1193" title="1193"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>time) <span class="op">+</span></a>
<a class="sourceLine" id="cb698-1194" title="1194"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1195" title="1195"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>, <span class="dt">cex =</span> <span class="fl">.5</span>)</a>
<a class="sourceLine" id="cb698-1196" title="1196"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1197" title="1197"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1198" title="1198"></a>
<a class="sourceLine" id="cb698-1199" title="1199">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1200" title="1200">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1201" title="1201"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1202" title="1202">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1203" title="1203"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1204" title="1204">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1205" title="1205"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1206" title="1206"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1207" title="1207"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1208" title="1208">)</a>
<a class="sourceLine" id="cb698-1209" title="1209"></a>
<a class="sourceLine" id="cb698-1210" title="1210"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1211" title="1211">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1212" title="1212"></a>
<a class="sourceLine" id="cb698-1213" title="1213"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1214" title="1214"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1215" title="1215"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1216" title="1216">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1217" title="1217"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-1218" title="1218"><span class="kw">data</span>(pol_pres15, <span class="dt">package=</span><span class="st">&quot;spDataLarge&quot;</span>)</a>
<a class="sourceLine" id="cb698-1219" title="1219"><span class="kw">head</span>(pol_pres15[, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>)])</a>
<a class="sourceLine" id="cb698-1220" title="1220"><span class="kw">library</span>(tmap)</a>
<a class="sourceLine" id="cb698-1221" title="1221"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;types&quot;</span>)</a>
<a class="sourceLine" id="cb698-1222" title="1222"><span class="kw">library</span>(spdep)</a>
<a class="sourceLine" id="cb698-1223" title="1223"><span class="kw">args</span>(poly2nb)</a>
<a class="sourceLine" id="cb698-1224" title="1224"><span class="kw">class</span>(<span class="kw">st_geometry</span>(pol_pres15))</a>
<a class="sourceLine" id="cb698-1225" title="1225"><span class="kw">table</span>(<span class="kw">sapply</span>(<span class="kw">st_geometry</span>(pol_pres15), <span class="cf">function</span>(x) <span class="kw">class</span>(x)[<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb698-1226" title="1226"><span class="kw">system.time</span>(nb_q &lt;-<span class="st"> </span><span class="kw">poly2nb</span>(pol_pres15, <span class="dt">queen=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-1227" title="1227">nb_q</a>
<a class="sourceLine" id="cb698-1228" title="1228"><span class="kw">system.time</span>({</a>
<a class="sourceLine" id="cb698-1229" title="1229">  fB &lt;-<span class="st"> </span>rgeos<span class="op">::</span><span class="kw">gUnarySTRtreeQuery</span>(<span class="kw">as</span>(pol_pres15, <span class="st">&quot;Spatial&quot;</span>))</a>
<a class="sourceLine" id="cb698-1230" title="1230">  nb_q1 &lt;-<span class="st"> </span><span class="kw">poly2nb</span>(pol_pres15, <span class="dt">queen=</span><span class="ot">TRUE</span>, <span class="dt">foundInBox=</span>fB)</a>
<a class="sourceLine" id="cb698-1231" title="1231">})</a>
<a class="sourceLine" id="cb698-1232" title="1232"><span class="kw">all.equal</span>(nb_q, nb_q1, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1233" title="1233">st_queen &lt;-<span class="st"> </span><span class="cf">function</span>(a, <span class="dt">b =</span> a) <span class="kw">st_relate</span>(a, b, <span class="dt">pattern =</span> <span class="st">&quot;F***T****&quot;</span>)</a>
<a class="sourceLine" id="cb698-1234" title="1234">as.nb.sgbp &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb698-1235" title="1235">  attrs &lt;-<span class="st"> </span><span class="kw">attributes</span>(x)</a>
<a class="sourceLine" id="cb698-1236" title="1236">  x &lt;-<span class="st"> </span><span class="kw">lapply</span>(x, <span class="cf">function</span>(i) { <span class="cf">if</span>(<span class="kw">length</span>(i) <span class="op">==</span><span class="st"> </span>0L) 0L <span class="cf">else</span> i } )</a>
<a class="sourceLine" id="cb698-1237" title="1237">  <span class="kw">attributes</span>(x) &lt;-<span class="st"> </span>attrs</a>
<a class="sourceLine" id="cb698-1238" title="1238">  <span class="kw">class</span>(x) &lt;-<span class="st"> &quot;nb&quot;</span></a>
<a class="sourceLine" id="cb698-1239" title="1239">  x</a>
<a class="sourceLine" id="cb698-1240" title="1240">}</a>
<a class="sourceLine" id="cb698-1241" title="1241"><span class="kw">system.time</span>(nb_sf_q &lt;-<span class="st"> </span><span class="kw">as.nb.sgbp</span>(<span class="kw">st_queen</span>(pol_pres15)))</a>
<a class="sourceLine" id="cb698-1242" title="1242"><span class="kw">all.equal</span>(nb_q, nb_sf_q, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1243" title="1243"><span class="kw">system.time</span>({</a>
<a class="sourceLine" id="cb698-1244" title="1244">  fB1 &lt;-<span class="st"> </span><span class="kw">st_intersects</span>(<span class="kw">st_as_sfc</span>(<span class="kw">lapply</span>(<span class="kw">st_geometry</span>(pol_pres15), <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb698-1245" title="1245">    <span class="kw">st_as_sfc</span>(<span class="kw">st_bbox</span>(x))[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-1246" title="1246">  })))</a>
<a class="sourceLine" id="cb698-1247" title="1247">  fB1a &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(fB1), <span class="cf">function</span>(i) fB1[[i]][fB1[[i]] <span class="op">&gt;</span><span class="st"> </span>i])</a>
<a class="sourceLine" id="cb698-1248" title="1248">  fB1a &lt;-<span class="st"> </span>fB1a[<span class="op">-</span><span class="kw">length</span>(fB1a)]</a>
<a class="sourceLine" id="cb698-1249" title="1249">  nb_sf_q1 &lt;-<span class="st"> </span><span class="kw">poly2nb</span>(pol_pres15, <span class="dt">queen=</span><span class="ot">TRUE</span>, <span class="dt">foundInBox=</span>fB1a)</a>
<a class="sourceLine" id="cb698-1250" title="1250">})</a>
<a class="sourceLine" id="cb698-1251" title="1251"><span class="kw">all.equal</span>(nb_q, nb_sf_q1, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1252" title="1252"><span class="kw">n.comp.nb</span>(nb_q)<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb698-1253" title="1253">tf &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext=</span><span class="st">&quot;.gal&quot;</span>)</a>
<a class="sourceLine" id="cb698-1254" title="1254"><span class="kw">write.nb.gal</span>(nb_q, tf)</a>
<a class="sourceLine" id="cb698-1255" title="1255"><span class="kw">library</span>(reticulate)</a>
<a class="sourceLine" id="cb698-1256" title="1256"><span class="kw">use_python</span>(<span class="dt">python=</span><span class="st">&#39;/usr/bin/python3&#39;</span>)</a>
<a class="sourceLine" id="cb698-1257" title="1257">np &lt;-<span class="st"> </span><span class="kw">import</span>(<span class="st">&quot;numpy&quot;</span>)</a>
<a class="sourceLine" id="cb698-1258" title="1258">libpysal &lt;-<span class="st"> </span><span class="kw">import</span>(<span class="st">&quot;libpysal&quot;</span>)</a>
<a class="sourceLine" id="cb698-1259" title="1259">nb_gal_ps &lt;-<span class="st"> </span>libpysal<span class="op">$</span>io<span class="op">$</span><span class="kw">open</span>(tf)<span class="op">$</span><span class="kw">read</span>()</a>
<a class="sourceLine" id="cb698-1260" title="1260">nb_gal_ps<span class="op">$</span>pct_nonzero</a>
<a class="sourceLine" id="cb698-1261" title="1261"><span class="kw">args</span>(tri2nb)</a>
<a class="sourceLine" id="cb698-1262" title="1262"><span class="kw">args</span>(soi.graph)</a>
<a class="sourceLine" id="cb698-1263" title="1263"><span class="kw">args</span>(graph2nb)</a>
<a class="sourceLine" id="cb698-1264" title="1264">coords &lt;-<span class="st"> </span><span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(pol_pres15), <span class="dt">of_largest_polygon=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1265" title="1265"><span class="kw">suppressMessages</span>(nb_tri &lt;-<span class="st"> </span><span class="kw">tri2nb</span>(coords))</a>
<a class="sourceLine" id="cb698-1266" title="1266">nb_tri</a>
<a class="sourceLine" id="cb698-1267" title="1267"><span class="kw">summary</span>(<span class="kw">unlist</span>(<span class="kw">nbdists</span>(nb_tri, coords)))</a>
<a class="sourceLine" id="cb698-1268" title="1268"><span class="kw">table</span>(pol_pres15<span class="op">$</span>types, <span class="kw">card</span>(nb_q))</a>
<a class="sourceLine" id="cb698-1269" title="1269"><span class="kw">table</span>(pol_pres15<span class="op">$</span>types, <span class="kw">card</span>(nb_tri))</a>
<a class="sourceLine" id="cb698-1270" title="1270"><span class="kw">n.comp.nb</span>(nb_tri)<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb698-1271" title="1271">nb_soi &lt;-<span class="st"> </span><span class="kw">graph2nb</span>(<span class="kw">soi.graph</span>(nb_tri, coords))</a>
<a class="sourceLine" id="cb698-1272" title="1272">nb_soi</a>
<a class="sourceLine" id="cb698-1273" title="1273">n_comp &lt;-<span class="st"> </span><span class="kw">n.comp.nb</span>(nb_soi)</a>
<a class="sourceLine" id="cb698-1274" title="1274">n_comp<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb698-1275" title="1275"><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</a>
<a class="sourceLine" id="cb698-1276" title="1276"><span class="kw">summary</span>(<span class="kw">unlist</span>(<span class="kw">nbdists</span>(nb_soi, coords)))</a>
<a class="sourceLine" id="cb698-1277" title="1277">opar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)<span class="op">+</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb698-1278" title="1278"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(pol_pres15), <span class="dt">border=</span><span class="st">&quot;grey&quot;</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb698-1279" title="1279"><span class="kw">plot</span>(nb_soi, <span class="dt">coords=</span><span class="kw">st_coordinates</span>(coords), <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">points=</span><span class="ot">FALSE</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb698-1280" title="1280"><span class="kw">plot</span>(<span class="kw">diffnb</span>(nb_tri, nb_soi), <span class="dt">coords=</span><span class="kw">st_coordinates</span>(coords), <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>,</a>
<a class="sourceLine" id="cb698-1281" title="1281">     <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">points=</span><span class="ot">FALSE</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb698-1282" title="1282"><span class="kw">par</span>(opar)</a>
<a class="sourceLine" id="cb698-1283" title="1283"><span class="kw">args</span>(dnearneigh)</a>
<a class="sourceLine" id="cb698-1284" title="1284"><span class="kw">args</span>(knearneigh)</a>
<a class="sourceLine" id="cb698-1285" title="1285"><span class="kw">args</span>(knn2nb)</a>
<a class="sourceLine" id="cb698-1286" title="1286"><span class="kw">args</span>(nbdists)</a>
<a class="sourceLine" id="cb698-1287" title="1287">k1 &lt;-<span class="st"> </span><span class="kw">knn2nb</span>(<span class="kw">knearneigh</span>(coords))</a>
<a class="sourceLine" id="cb698-1288" title="1288">k1dists &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">nbdists</span>(k1, coords))</a>
<a class="sourceLine" id="cb698-1289" title="1289"><span class="kw">summary</span>(k1dists)</a>
<a class="sourceLine" id="cb698-1290" title="1290">nb_d18 &lt;-<span class="st"> </span><span class="kw">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">18000</span>)</a>
<a class="sourceLine" id="cb698-1291" title="1291">nb_d18</a>
<a class="sourceLine" id="cb698-1292" title="1292">n_comp &lt;-<span class="st"> </span><span class="kw">n.comp.nb</span>(nb_d18)</a>
<a class="sourceLine" id="cb698-1293" title="1293">n_comp<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb698-1294" title="1294"><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</a>
<a class="sourceLine" id="cb698-1295" title="1295">nb_d183 &lt;-<span class="st"> </span><span class="kw">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">18300</span>)</a>
<a class="sourceLine" id="cb698-1296" title="1296">nb_d183</a>
<a class="sourceLine" id="cb698-1297" title="1297">n_comp &lt;-<span class="st"> </span><span class="kw">n.comp.nb</span>(nb_d183)</a>
<a class="sourceLine" id="cb698-1298" title="1298">n_comp<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb698-1299" title="1299"><span class="kw">table</span>(pol_pres15<span class="op">$</span>types, <span class="kw">card</span>(nb_d183))</a>
<a class="sourceLine" id="cb698-1300" title="1300">arha &lt;-<span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">st_area</span>(pol_pres15), hectare)</a>
<a class="sourceLine" id="cb698-1301" title="1301"><span class="kw">aggregate</span>(arha, <span class="kw">list</span>(pol_pres15<span class="op">$</span>types), mean)</a>
<a class="sourceLine" id="cb698-1302" title="1302">nb_d16 &lt;-<span class="st"> </span><span class="kw">dnearneigh</span>(coords, <span class="dv">0</span>, <span class="dv">16000</span>)</a>
<a class="sourceLine" id="cb698-1303" title="1303">nb_d16</a>
<a class="sourceLine" id="cb698-1304" title="1304">knn_k6 &lt;-<span class="st"> </span><span class="kw">knearneigh</span>(coords, <span class="dt">k=</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1305" title="1305"><span class="kw">knn2nb</span>(knn_k6)</a>
<a class="sourceLine" id="cb698-1306" title="1306">nb_k6s &lt;-<span class="st"> </span><span class="kw">knn2nb</span>(knn_k6, <span class="dt">sym=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1307" title="1307">nb_k6s</a>
<a class="sourceLine" id="cb698-1308" title="1308">n_comp &lt;-<span class="st"> </span><span class="kw">n.comp.nb</span>(nb_k6s)</a>
<a class="sourceLine" id="cb698-1309" title="1309">n_comp<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb698-1310" title="1310"><span class="kw">args</span>(nb2listw)</a>
<a class="sourceLine" id="cb698-1311" title="1311"><span class="kw">args</span>(spweights.constants)</a>
<a class="sourceLine" id="cb698-1312" title="1312">lw_q_B &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>)</a>
<a class="sourceLine" id="cb698-1313" title="1313"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_q_B))</a>
<a class="sourceLine" id="cb698-1314" title="1314">lw_q_W &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb698-1315" title="1315"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_q_W))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)]</a>
<a class="sourceLine" id="cb698-1316" title="1316">lw_q_S &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style=</span><span class="st">&quot;S&quot;</span>)</a>
<a class="sourceLine" id="cb698-1317" title="1317"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_q_S))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)]</a>
<a class="sourceLine" id="cb698-1318" title="1318">gwts &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">nbdists</span>(nb_d183, coords), <span class="cf">function</span>(x) <span class="dv">1</span><span class="op">/</span>(x<span class="op">/</span><span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb698-1319" title="1319">lw_d183_idw_B &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_d183, <span class="dt">glist=</span>gwts, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>)</a>
<a class="sourceLine" id="cb698-1320" title="1320"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_d183_idw_B))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)]</a>
<a class="sourceLine" id="cb698-1321" title="1321"><span class="kw">try</span>(lw_d16_B &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_d16, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>))</a>
<a class="sourceLine" id="cb698-1322" title="1322">lw_d16_B &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_d16, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1323" title="1323"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_d16_B,  <span class="dt">zero.policy=</span><span class="ot">TRUE</span>))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)]</a>
<a class="sourceLine" id="cb698-1324" title="1324">zO &lt;-<span class="st"> </span><span class="kw">set.ZeroPolicyOption</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1325" title="1325">lw_d16_B &lt;-<span class="st"> </span><span class="kw">nb2listw</span>(nb_d16, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>)</a>
<a class="sourceLine" id="cb698-1326" title="1326"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_d16_B))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)]</a>
<a class="sourceLine" id="cb698-1327" title="1327"><span class="kw">invisible</span>(<span class="kw">set.ZeroPolicyOption</span>(zO))</a>
<a class="sourceLine" id="cb698-1328" title="1328"><span class="kw">unlist</span>(<span class="kw">spweights.constants</span>(lw_d16_B,  <span class="dt">zero.policy=</span><span class="ot">TRUE</span>, <span class="dt">adjust.n=</span><span class="ot">FALSE</span>))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)]</a>
<a class="sourceLine" id="cb698-1329" title="1329"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1330" title="1330">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(pol_pres15))</a>
<a class="sourceLine" id="cb698-1331" title="1331">mt &lt;-<span class="st"> </span><span class="kw">moran.test</span>(x, lw_q_B, <span class="dt">randomisation=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1332" title="1332">glance_htest &lt;-<span class="st"> </span><span class="cf">function</span>(ht) <span class="kw">c</span>(ht<span class="op">$</span>estimate, <span class="st">&quot;Std deviate&quot;</span>=<span class="kw">unname</span>(ht<span class="op">$</span>statistic), <span class="st">&quot;p.value=&quot;</span>=<span class="kw">unname</span>(ht<span class="op">$</span>p.value))</a>
<a class="sourceLine" id="cb698-1333" title="1333">broom_ok &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb698-1334" title="1334"><span class="cf">if</span> (<span class="kw">names</span>(broom<span class="op">::</span><span class="kw">tidy</span>(mt))[<span class="dv">1</span>] <span class="op">==</span><span class="st"> &quot;Moran I statistic&quot;</span>) broom_ok &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb698-1335" title="1335"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(mt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(mt)</a>
<a class="sourceLine" id="cb698-1336" title="1336">beta &lt;-<span class="st"> </span><span class="fl">0.5e-02</span></a>
<a class="sourceLine" id="cb698-1337" title="1337">t &lt;-<span class="st"> </span><span class="kw">st_coordinates</span>(coords)[,<span class="dv">1</span>]<span class="op">/</span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb698-1338" title="1338">x_t &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span>beta<span class="op">*</span>t</a>
<a class="sourceLine" id="cb698-1339" title="1339">mt &lt;-<span class="st"> </span><span class="kw">moran.test</span>(x_t, lw_q_B, <span class="dt">randomisation=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1340" title="1340"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(mt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(mt)</a>
<a class="sourceLine" id="cb698-1341" title="1341">lmt &lt;-<span class="st"> </span><span class="kw">lm.morantest</span>(<span class="kw">lm</span>(x_t <span class="op">~</span><span class="st"> </span>t), lw_q_B)</a>
<a class="sourceLine" id="cb698-1342" title="1342"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(lmt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(lmt)</a>
<a class="sourceLine" id="cb698-1343" title="1343"><span class="kw">args</span>(joincount.test)</a>
<a class="sourceLine" id="cb698-1344" title="1344"><span class="kw">table</span>(pol_pres15<span class="op">$</span>types)</a>
<a class="sourceLine" id="cb698-1345" title="1345">jcl &lt;-<span class="st"> </span><span class="kw">joincount.test</span>(pol_pres15<span class="op">$</span>types, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1346" title="1346"><span class="cf">if</span> (broom_ok) {</a>
<a class="sourceLine" id="cb698-1347" title="1347">nm &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw">enframe</span>(<span class="kw">sapply</span>(jcl, <span class="cf">function</span>(t) {</a>
<a class="sourceLine" id="cb698-1348" title="1348">  nm &lt;-<span class="st"> </span><span class="kw">substring</span>(<span class="kw">names</span>(t<span class="op">$</span>statistic), <span class="dv">18</span>)</a>
<a class="sourceLine" id="cb698-1349" title="1349">  <span class="kw">paste0</span>(nm, <span class="st">&quot;:&quot;</span>, nm)</a>
<a class="sourceLine" id="cb698-1350" title="1350">}))</a>
<a class="sourceLine" id="cb698-1351" title="1351">mat &lt;-<span class="st"> </span><span class="kw">cbind</span>(nm, <span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, (<span class="kw">lapply</span>(jcl, broom<span class="op">::</span>tidy))))</a>
<a class="sourceLine" id="cb698-1352" title="1352"><span class="kw">names</span>(mat)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;Joincount&quot;</span></a>
<a class="sourceLine" id="cb698-1353" title="1353"><span class="kw">names</span>(mat)[<span class="dv">6</span>] &lt;-<span class="st"> &quot;Std.deviate&quot;</span></a>
<a class="sourceLine" id="cb698-1354" title="1354"><span class="kw">names</span>(mat)[<span class="dv">2</span>] &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb698-1355" title="1355">mat[,<span class="dv">2</span><span class="op">:</span><span class="dv">6</span>]</a>
<a class="sourceLine" id="cb698-1356" title="1356">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb698-1357" title="1357">mat &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(jcl, glance_htest))</a>
<a class="sourceLine" id="cb698-1358" title="1358"><span class="kw">colnames</span>(mat)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;Joincount&quot;</span></a>
<a class="sourceLine" id="cb698-1359" title="1359"><span class="kw">rownames</span>(mat) &lt;-<span class="st"> </span><span class="kw">sapply</span>(jcl, <span class="cf">function</span>(t) {  </a>
<a class="sourceLine" id="cb698-1360" title="1360">  nm &lt;-<span class="st"> </span><span class="kw">substring</span>(<span class="kw">names</span>(t<span class="op">$</span>statistic), <span class="dv">18</span>)</a>
<a class="sourceLine" id="cb698-1361" title="1361">  <span class="kw">paste0</span>(nm, <span class="st">&quot;:&quot;</span>, nm)</a>
<a class="sourceLine" id="cb698-1362" title="1362">})</a>
<a class="sourceLine" id="cb698-1363" title="1363">mat</a>
<a class="sourceLine" id="cb698-1364" title="1364">}</a>
<a class="sourceLine" id="cb698-1365" title="1365"><span class="kw">args</span>(joincount.multi)</a>
<a class="sourceLine" id="cb698-1366" title="1366"><span class="kw">joincount.multi</span>(pol_pres15<span class="op">$</span>types, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1367" title="1367"><span class="kw">joincount.multi</span>(pol_pres15<span class="op">$</span>types, <span class="dt">listw=</span>lw_q_W)</a>
<a class="sourceLine" id="cb698-1368" title="1368"><span class="kw">joincount.multi</span>(pol_pres15<span class="op">$</span>types, <span class="dt">listw=</span>lw_d183_idw_B)</a>
<a class="sourceLine" id="cb698-1369" title="1369"><span class="kw">args</span>(moran.test)</a>
<a class="sourceLine" id="cb698-1370" title="1370">mt &lt;-<span class="st"> </span><span class="kw">moran.test</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B, <span class="dt">randomisation=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1371" title="1371"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(mt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(mt)</a>
<a class="sourceLine" id="cb698-1372" title="1372"><span class="kw">args</span>(lm.morantest)</a>
<a class="sourceLine" id="cb698-1373" title="1373">ols &lt;-<span class="st"> </span><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, pol_pres15)</a>
<a class="sourceLine" id="cb698-1374" title="1374">lmt &lt;-<span class="st"> </span><span class="kw">lm.morantest</span>(ols, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1375" title="1375"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(lmt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(lmt)</a>
<a class="sourceLine" id="cb698-1376" title="1376"><span class="kw">args</span>(lm.morantest.exact)</a>
<a class="sourceLine" id="cb698-1377" title="1377"><span class="kw">load</span>(<span class="st">&quot;rsb_rda/globalmoran_exact.rda&quot;</span>)</a>
<a class="sourceLine" id="cb698-1378" title="1378"><span class="kw">suppressWarnings</span>(lmte &lt;-<span class="st"> </span><span class="kw">lm.morantest.exact</span>(ols, <span class="dt">listw=</span>lw_q_B))</a>
<a class="sourceLine" id="cb698-1379" title="1379"><span class="kw">names</span>(lmte<span class="op">$</span>estimate) &lt;-<span class="st"> &quot;Moran I statistic&quot;</span></a>
<a class="sourceLine" id="cb698-1380" title="1380"><span class="kw">class</span>(lmte) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">class</span>(lmte), <span class="st">&quot;htest&quot;</span>)</a>
<a class="sourceLine" id="cb698-1381" title="1381"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(lmte)[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(lmte)</a>
<a class="sourceLine" id="cb698-1382" title="1382"><span class="kw">all.equal</span>(<span class="dv">3</span><span class="op">+</span>e1071<span class="op">::</span><span class="kw">kurtosis</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">type=</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb698-1383" title="1383">          <span class="kw">moran</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B, <span class="dt">n=</span><span class="kw">nrow</span>(pol_pres15),</a>
<a class="sourceLine" id="cb698-1384" title="1384">                <span class="dt">S0=</span><span class="kw">Szero</span>(lw_q_B))<span class="op">$</span>K)</a>
<a class="sourceLine" id="cb698-1385" title="1385">mtr &lt;-<span class="st"> </span><span class="kw">moran.test</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1386" title="1386"><span class="cf">if</span> (broom_ok) (tmtr &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw">tidy</span>(mtr)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]) <span class="cf">else</span> (tmtr &lt;-<span class="st"> </span><span class="kw">glance_htest</span>(mtr))</a>
<a class="sourceLine" id="cb698-1387" title="1387">esda &lt;-<span class="st"> </span><span class="kw">import</span>(<span class="st">&quot;esda&quot;</span>)</a>
<a class="sourceLine" id="cb698-1388" title="1388">np<span class="op">$</span>random<span class="op">$</span><span class="kw">seed</span>(1L)</a>
<a class="sourceLine" id="cb698-1389" title="1389">mi &lt;-<span class="st"> </span>esda<span class="op">$</span><span class="kw">Moran</span>(pol_pres15<span class="op">$</span>I_turnout, nb_gal_ps, <span class="dt">transformation=</span><span class="st">&quot;B&quot;</span>,</a>
<a class="sourceLine" id="cb698-1390" title="1390">                 <span class="dt">permutations=</span>999L, <span class="dt">two_tailed=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1391" title="1391"><span class="kw">all.equal</span>(<span class="kw">c</span>(mi<span class="op">$</span>I, mi<span class="op">$</span>EI, mi<span class="op">$</span>VI_rand, mi<span class="op">$</span>z_rand, mi<span class="op">$</span>p_rand), <span class="kw">unname</span>(<span class="kw">unlist</span>(<span class="kw">c</span>(tmtr))))</a>
<a class="sourceLine" id="cb698-1392" title="1392"><span class="kw">args</span>(moran.mc)</a>
<a class="sourceLine" id="cb698-1393" title="1393"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1394" title="1394">mmc &lt;-<span class="st"> </span><span class="kw">moran.mc</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B, <span class="dt">nsim=</span><span class="dv">999</span>, <span class="dt">return_boot =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1395" title="1395">glance_boot &lt;-<span class="st"> </span><span class="cf">function</span>(bt) <span class="kw">c</span>(<span class="dt">original=</span>bt<span class="op">$</span>t0, <span class="dt">bias=</span><span class="kw">mean</span>(bt<span class="op">$</span>t)<span class="op">-</span>bt<span class="op">$</span>t0,</a>
<a class="sourceLine" id="cb698-1396" title="1396">                              <span class="dt">std.error=</span><span class="kw">sd</span>(bt<span class="op">$</span>t),</a>
<a class="sourceLine" id="cb698-1397" title="1397">                              <span class="dt">zvalue=</span>(bt<span class="op">$</span>t0<span class="op">-</span><span class="kw">mean</span>(bt<span class="op">$</span>t))<span class="op">/</span><span class="kw">sd</span>(bt<span class="op">$</span>t))</a>
<a class="sourceLine" id="cb698-1398" title="1398"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(mmc) <span class="cf">else</span> <span class="kw">glance_boot</span>(mmc)</a>
<a class="sourceLine" id="cb698-1399" title="1399"><span class="kw">c</span>(<span class="dt">statistic=</span>mi<span class="op">$</span>I, <span class="dt">bias=</span>mi<span class="op">$</span>EI_sim<span class="op">-</span>mi<span class="op">$</span>I, <span class="dt">std.error=</span>mi<span class="op">$</span>seI_sim)</a>
<a class="sourceLine" id="cb698-1400" title="1400"><span class="kw">c</span>(<span class="st">&quot;Permutation bootstrap&quot;</span>=<span class="kw">var</span>(mmc<span class="op">$</span>t), </a>
<a class="sourceLine" id="cb698-1401" title="1401">  <span class="st">&quot;Analytical randomisation&quot;</span>=<span class="kw">unname</span>(mtr<span class="op">$</span>estimate[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb698-1402" title="1402">apmc &lt;-<span class="st"> </span><span class="kw">aple.mc</span>(<span class="kw">c</span>(<span class="kw">scale</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">scale=</span><span class="ot">FALSE</span>)), <span class="dt">listw=</span>lw_q_W,</a>
<a class="sourceLine" id="cb698-1403" title="1403">                <span class="dt">nsim=</span><span class="dv">999</span>)</a>
<a class="sourceLine" id="cb698-1404" title="1404"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(apmc) <span class="cf">else</span> <span class="kw">glance_boot</span>(apmc)</a>
<a class="sourceLine" id="cb698-1405" title="1405"><span class="kw">args</span>(geary.test)</a>
<a class="sourceLine" id="cb698-1406" title="1406">gt &lt;-<span class="st"> </span><span class="kw">geary.test</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1407" title="1407"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(gt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(gt)</a>
<a class="sourceLine" id="cb698-1408" title="1408"><span class="kw">args</span>(globalG.test)</a>
<a class="sourceLine" id="cb698-1409" title="1409">ggt &lt;-<span class="st"> </span><span class="kw">globalG.test</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1410" title="1410"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(ggt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(ggt)</a>
<a class="sourceLine" id="cb698-1411" title="1411">ggt &lt;-<span class="st"> </span><span class="kw">globalG.test</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_d16_B, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1412" title="1412"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(ggt)[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="cf">else</span> <span class="kw">glance_htest</span>(ggt)</a>
<a class="sourceLine" id="cb698-1413" title="1413"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1414" title="1414">mamc &lt;-<span class="st"> </span><span class="kw">sp.mantel.mc</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B, <span class="dt">nsim=</span><span class="dv">999</span>, </a>
<a class="sourceLine" id="cb698-1415" title="1415">                     <span class="dt">type=</span><span class="st">&quot;moran&quot;</span>, <span class="dt">return_boot =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1416" title="1416"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(mamc) <span class="cf">else</span> <span class="kw">glance_boot</span>(mamc)</a>
<a class="sourceLine" id="cb698-1417" title="1417"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1418" title="1418"><span class="kw">suppressMessages</span>(ebimc &lt;-<span class="st"> </span><span class="kw">EBImoran.mc</span>(<span class="dt">n=</span>pol_pres15<span class="op">$</span>I_valid_votes,</a>
<a class="sourceLine" id="cb698-1419" title="1419">                                      <span class="dt">x=</span>pol_pres15<span class="op">$</span>I_entitled_to_vote,</a>
<a class="sourceLine" id="cb698-1420" title="1420">                                      <span class="dt">listw=</span>lw_q_B, <span class="dt">nsim=</span><span class="dv">999</span>, <span class="dt">return_boot=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-1421" title="1421"><span class="cf">if</span> (broom_ok) broom<span class="op">::</span><span class="kw">tidy</span>(ebimc) <span class="cf">else</span> <span class="kw">glance_boot</span>(ebimc)</a>
<a class="sourceLine" id="cb698-1422" title="1422">infl_W &lt;-<span class="st"> </span><span class="kw">moran.plot</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_W, </a>
<a class="sourceLine" id="cb698-1423" title="1423">                     <span class="dt">labels=</span>pol_pres15<span class="op">$</span>TERYT, <span class="dt">cex=</span><span class="dv">1</span>, <span class="dt">pch=</span><span class="st">&quot;.&quot;</span>, </a>
<a class="sourceLine" id="cb698-1424" title="1424">                     <span class="dt">xlab=</span><span class="st">&quot;I round turnout&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;lagged turnout&quot;</span>,</a>
<a class="sourceLine" id="cb698-1425" title="1425">                     <span class="dt">return_df =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1426" title="1426">pol_pres15<span class="op">$</span>hat_value &lt;-<span class="st"> </span>infl_W<span class="op">$</span>infmat[,<span class="dv">6</span>]</a>
<a class="sourceLine" id="cb698-1427" title="1427"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hat_value&quot;</span>)</a>
<a class="sourceLine" id="cb698-1428" title="1428"><span class="kw">args</span>(localmoran)</a>
<a class="sourceLine" id="cb698-1429" title="1429"><span class="kw">load</span>(<span class="st">&quot;rsb_rda/localmoran_ch17.rda&quot;</span>)</a>
<a class="sourceLine" id="cb698-1430" title="1430">locm &lt;-<span class="st"> </span><span class="kw">localmoran</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>)</a>
<a class="sourceLine" id="cb698-1431" title="1431"><span class="kw">all.equal</span>(<span class="kw">sum</span>(locm[,<span class="dv">1</span>])<span class="op">/</span><span class="kw">Szero</span>(lw_q_B), </a>
<a class="sourceLine" id="cb698-1432" title="1432">          <span class="kw">unname</span>(<span class="kw">moran.test</span>(pol_pres15<span class="op">$</span>I_turnout, lw_q_B)<span class="op">$</span>estimate[<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb698-1433" title="1433">pvs &lt;-<span class="st"> </span><span class="kw">cbind</span>(locm[,<span class="dv">5</span>], <span class="kw">p.adjust</span>(locm[,<span class="dv">5</span>], <span class="st">&quot;bonferroni&quot;</span>), </a>
<a class="sourceLine" id="cb698-1434" title="1434">             <span class="kw">p.adjust</span>(locm[,<span class="dv">5</span>],<span class="st">&quot;fdr&quot;</span>), <span class="kw">p.adjust</span>(locm[,<span class="dv">5</span>], <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1435" title="1435"><span class="kw">colnames</span>(pvs) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1436" title="1436"><span class="kw">apply</span>(pvs, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1437" title="1437"><span class="kw">args</span>(localmoran.sad)</a>
<a class="sourceLine" id="cb698-1438" title="1438">locms &lt;-<span class="st"> </span><span class="kw">localmoran.sad</span>(ols, <span class="dt">nb=</span>nb_q, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>)</a>
<a class="sourceLine" id="cb698-1439" title="1439">locms &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(locms)</a>
<a class="sourceLine" id="cb698-1440" title="1440">pvss &lt;-<span class="st"> </span><span class="kw">cbind</span>(locms[,<span class="dv">5</span>], <span class="kw">p.adjust</span>(locms[,<span class="dv">5</span>], <span class="st">&quot;bonferroni&quot;</span>), </a>
<a class="sourceLine" id="cb698-1441" title="1441">              <span class="kw">p.adjust</span>(locms[,<span class="dv">5</span>], <span class="st">&quot;fdr&quot;</span>), <span class="kw">p.adjust</span>(locms[,<span class="dv">5</span>], <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1442" title="1442"><span class="kw">colnames</span>(pvss) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1443" title="1443"><span class="kw">apply</span>(pvss, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1444" title="1444">ints &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="kw">c</span>(spatialreg<span class="op">::</span><span class="kw">lextrB</span>(lw_q_B))</a>
<a class="sourceLine" id="cb698-1445" title="1445">ints</a>
<a class="sourceLine" id="cb698-1446" title="1446">SEM &lt;-<span class="st"> </span>spatialreg<span class="op">::</span><span class="kw">errorsarlm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data=</span>pol_pres15, <span class="dt">listw=</span>lw_q_B,</a>
<a class="sourceLine" id="cb698-1447" title="1447">                              <span class="dt">method=</span><span class="st">&quot;Matrix&quot;</span>, <span class="dt">interval=</span>ints)</a>
<a class="sourceLine" id="cb698-1448" title="1448">spatialreg<span class="op">::</span><span class="kw">coef.sarlm</span>(SEM)</a>
<a class="sourceLine" id="cb698-1449" title="1449">spatialreg<span class="op">::</span><span class="kw">LR1.sarlm</span>(SEM)</a>
<a class="sourceLine" id="cb698-1450" title="1450">lm.target &lt;-<span class="st"> </span><span class="kw">lm</span>(SEM<span class="op">$</span>tary <span class="op">~</span><span class="st"> </span>SEM<span class="op">$</span>tarX <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1451" title="1451">Omega &lt;-<span class="st"> </span><span class="kw">invIrW</span>(lw_q_B, <span class="dt">rho=</span>SEM<span class="op">$</span>lambda)</a>
<a class="sourceLine" id="cb698-1452" title="1452">locmsO &lt;-<span class="st"> </span><span class="kw">localmoran.sad</span>(lm.target, <span class="dt">nb=</span>nb_q, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>,</a>
<a class="sourceLine" id="cb698-1453" title="1453">                         <span class="dt">Omega=</span>Omega)</a>
<a class="sourceLine" id="cb698-1454" title="1454">locmsO &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(locmsO)</a>
<a class="sourceLine" id="cb698-1455" title="1455">pvssO &lt;-<span class="st"> </span><span class="kw">cbind</span>(locmsO[,<span class="dv">5</span>], <span class="kw">p.adjust</span>(locmsO[,<span class="dv">5</span>], <span class="st">&quot;bonferroni&quot;</span>),</a>
<a class="sourceLine" id="cb698-1456" title="1456">               <span class="kw">p.adjust</span>(locmsO[,<span class="dv">5</span>], <span class="st">&quot;fdr&quot;</span>), <span class="kw">p.adjust</span>(locmsO[,<span class="dv">5</span>], <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1457" title="1457"><span class="kw">colnames</span>(pvssO) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1458" title="1458"><span class="kw">apply</span>(pvssO, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1459" title="1459"><span class="kw">load</span>(<span class="st">&quot;rsb_rda/localmoran_perm.rda&quot;</span>)</a>
<a class="sourceLine" id="cb698-1460" title="1460">x &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>I_turnout</a>
<a class="sourceLine" id="cb698-1461" title="1461">lw &lt;-<span class="st"> </span>lw_q_B</a>
<a class="sourceLine" id="cb698-1462" title="1462">xx &lt;-<span class="st"> </span><span class="kw">mean</span>(x)</a>
<a class="sourceLine" id="cb698-1463" title="1463">z &lt;-<span class="st"> </span>x <span class="op">-</span><span class="st"> </span>xx</a>
<a class="sourceLine" id="cb698-1464" title="1464">s2 &lt;-<span class="st"> </span><span class="kw">sum</span>(z<span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb698-1465" title="1465">crd &lt;-<span class="st"> </span><span class="kw">card</span>(lw<span class="op">$</span>neighbours)</a>
<a class="sourceLine" id="cb698-1466" title="1466">nsim &lt;-<span class="st"> </span><span class="dv">999</span></a>
<a class="sourceLine" id="cb698-1467" title="1467">res_p &lt;-<span class="st"> </span><span class="kw">numeric</span>(nsim)</a>
<a class="sourceLine" id="cb698-1468" title="1468">mns &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(x))</a>
<a class="sourceLine" id="cb698-1469" title="1469">sds &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(x))</a>
<a class="sourceLine" id="cb698-1470" title="1470"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1471" title="1471"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq</span>(<span class="dt">along=</span>x)) {</a>
<a class="sourceLine" id="cb698-1472" title="1472">  wtsi &lt;-<span class="st"> </span>lw<span class="op">$</span>weights[[i]]</a>
<a class="sourceLine" id="cb698-1473" title="1473">  zi &lt;-<span class="st"> </span>z[i]</a>
<a class="sourceLine" id="cb698-1474" title="1474">  z_i &lt;-<span class="st"> </span>z[<span class="op">-</span>i]</a>
<a class="sourceLine" id="cb698-1475" title="1475">  crdi &lt;-<span class="st"> </span>crd[i]</a>
<a class="sourceLine" id="cb698-1476" title="1476">  <span class="cf">if</span> (crdi <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb698-1477" title="1477">    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsim) {</a>
<a class="sourceLine" id="cb698-1478" title="1478">      sz_i &lt;-<span class="st"> </span><span class="kw">sample</span>(z_i, <span class="dt">size=</span>crdi)</a>
<a class="sourceLine" id="cb698-1479" title="1479">      lz_i &lt;-<span class="st"> </span><span class="kw">sum</span>(sz_i<span class="op">*</span>wtsi)</a>
<a class="sourceLine" id="cb698-1480" title="1480">      res_p[j] &lt;-<span class="st"> </span>(zi<span class="op">/</span>s2)<span class="op">*</span>lz_i</a>
<a class="sourceLine" id="cb698-1481" title="1481">    }</a>
<a class="sourceLine" id="cb698-1482" title="1482">    mns[i] &lt;-<span class="st"> </span><span class="kw">mean</span>(res_p)</a>
<a class="sourceLine" id="cb698-1483" title="1483">    sds[i] &lt;-<span class="st"> </span><span class="kw">sd</span>(res_p)</a>
<a class="sourceLine" id="cb698-1484" title="1484">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb698-1485" title="1485">    mns[i] &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb698-1486" title="1486">    sds[i] &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb698-1487" title="1487">  }</a>
<a class="sourceLine" id="cb698-1488" title="1488">}</a>
<a class="sourceLine" id="cb698-1489" title="1489">perm_Zi &lt;-<span class="st"> </span>(locm[,<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>mns)<span class="op">/</span>sds</a>
<a class="sourceLine" id="cb698-1490" title="1490">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(perm_Zi), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1491" title="1491">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1492" title="1492">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1493" title="1493"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1494" title="1494"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1495" title="1495">locm_nml &lt;-<span class="st"> </span><span class="kw">localmoran</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B, </a>
<a class="sourceLine" id="cb698-1496" title="1496">                       <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>, <span class="dt">mlvar=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1497" title="1497">np<span class="op">$</span>random<span class="op">$</span><span class="kw">seed</span>(1L)</a>
<a class="sourceLine" id="cb698-1498" title="1498">loc_I_ps &lt;-<span class="st"> </span>esda<span class="op">$</span><span class="kw">Moran_Local</span>(pol_pres15<span class="op">$</span>I_turnout, nb_gal_ps, <span class="dt">transformation=</span><span class="st">&quot;B&quot;</span>, <span class="dt">permutations=</span>999L)</a>
<a class="sourceLine" id="cb698-1499" title="1499"><span class="kw">all.equal</span>(<span class="kw">unname</span>(locm_nml[,<span class="dv">1</span>]), <span class="kw">c</span>(loc_I_ps<span class="op">$</span>Is))</a>
<a class="sourceLine" id="cb698-1500" title="1500">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(loc_I_ps<span class="op">$</span>z_sim), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1501" title="1501">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1502" title="1502">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1503" title="1503"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1504" title="1504"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1505" title="1505">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">std_deviate=</span><span class="kw">c</span>(locm[,<span class="dv">4</span>], locms[,<span class="dv">4</span>], locmsO[,<span class="dv">4</span>], perm_Zi,</a>
<a class="sourceLine" id="cb698-1506" title="1506">        loc_I_ps<span class="op">$</span>z_sim), <span class="dt">method=</span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Analytical randomisation&quot;</span>, </a>
<a class="sourceLine" id="cb698-1507" title="1507">        <span class="st">&quot;Saddlepoint approximation&quot;</span>, <span class="st">&quot;Saddlepoint approximation (Omega)&quot;</span>, </a>
<a class="sourceLine" id="cb698-1508" title="1508">        <span class="st">&quot;Conditional permutation&quot;</span>, <span class="st">&quot;Conditional permutation (PySAL)&quot;</span>), <span class="dt">each=</span><span class="dv">2495</span>))</a>
<a class="sourceLine" id="cb698-1509" title="1509"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb698-1510" title="1510"><span class="kw">ggplot</span>(df) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="dt">x=</span>std_deviate, <span class="dt">fill=</span>method), <span class="dt">alpha=</span><span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1511" title="1511"><span class="st">  </span><span class="kw">xlim</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>, <span class="dv">12</span>))</a>
<a class="sourceLine" id="cb698-1512" title="1512"><span class="kw">print</span>(<span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, <span class="kw">tapply</span>(df<span class="op">$</span>std_deviate, <span class="kw">list</span>(df<span class="op">$</span>method), summary)), </a>
<a class="sourceLine" id="cb698-1513" title="1513">      <span class="dt">digits=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1514" title="1514">pol_pres15<span class="op">$</span>loc_I_SA &lt;-<span class="st"> </span>locms[,<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb698-1515" title="1515">pol_pres15<span class="op">$</span>loc_I_Omega &lt;-<span class="st"> </span>locmsO[,<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb698-1516" title="1516"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;loc_I_SA&quot;</span>, <span class="st">&quot;loc_I_Omega&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;Std. deviate&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;Saddlepoint approximation&quot;</span>, <span class="st">&quot;Omega&quot;</span>))</a>
<a class="sourceLine" id="cb698-1517" title="1517"><span class="kw">args</span>(localG)</a>
<a class="sourceLine" id="cb698-1518" title="1518"><span class="kw">load</span>(<span class="st">&quot;rsb_rda/localG_perm.rda&quot;</span>)</a>
<a class="sourceLine" id="cb698-1519" title="1519">locG &lt;-<span class="st"> </span><span class="kw">localG</span>(pol_pres15<span class="op">$</span>I_turnout, lw_q_B, <span class="dt">return_internals=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1520" title="1520">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(<span class="kw">c</span>(locG)), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1521" title="1521">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1522" title="1522">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1523" title="1523"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1524" title="1524"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1525" title="1525">np<span class="op">$</span>random<span class="op">$</span><span class="kw">seed</span>(1L)</a>
<a class="sourceLine" id="cb698-1526" title="1526">loc_G_ps &lt;-<span class="st"> </span>esda<span class="op">$</span><span class="kw">G_Local</span>(pol_pres15<span class="op">$</span>I_turnout, nb_gal_ps, <span class="dt">transform=</span><span class="st">&quot;B&quot;</span>, <span class="dt">permutations=</span>999L)</a>
<a class="sourceLine" id="cb698-1527" title="1527"><span class="kw">all.equal</span>(<span class="kw">c</span>(locG), <span class="kw">c</span>(loc_G_ps<span class="op">$</span>Zs))</a>
<a class="sourceLine" id="cb698-1528" title="1528">x &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>I_turnout</a>
<a class="sourceLine" id="cb698-1529" title="1529">lw &lt;-<span class="st"> </span>lw_q_B</a>
<a class="sourceLine" id="cb698-1530" title="1530">crd &lt;-<span class="st"> </span><span class="kw">card</span>(lw<span class="op">$</span>neighbours)</a>
<a class="sourceLine" id="cb698-1531" title="1531">nsim &lt;-<span class="st"> </span><span class="dv">999</span></a>
<a class="sourceLine" id="cb698-1532" title="1532">res &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow=</span><span class="kw">length</span>(x), <span class="dt">ncol=</span>nsim)</a>
<a class="sourceLine" id="cb698-1533" title="1533"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb698-1534" title="1534">x_star &lt;-<span class="st"> </span><span class="kw">sum</span>(x[crd <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>])</a>
<a class="sourceLine" id="cb698-1535" title="1535"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq</span>(<span class="dt">along=</span>x)) {</a>
<a class="sourceLine" id="cb698-1536" title="1536">  wtsi &lt;-<span class="st"> </span>lw<span class="op">$</span>weights[[i]]</a>
<a class="sourceLine" id="cb698-1537" title="1537">  xi &lt;-<span class="st"> </span>x[i]</a>
<a class="sourceLine" id="cb698-1538" title="1538">  x_i &lt;-<span class="st"> </span>x[<span class="op">-</span>i]</a>
<a class="sourceLine" id="cb698-1539" title="1539">  crdi &lt;-<span class="st"> </span>crd[i]</a>
<a class="sourceLine" id="cb698-1540" title="1540">  <span class="cf">if</span> (crdi <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb698-1541" title="1541">    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsim) {</a>
<a class="sourceLine" id="cb698-1542" title="1542">      sx_i &lt;-<span class="st"> </span><span class="kw">sample</span>(x_i, <span class="dt">size=</span>crdi)</a>
<a class="sourceLine" id="cb698-1543" title="1543">      lx_i &lt;-<span class="st"> </span><span class="kw">sum</span>(sx_i<span class="op">*</span>wtsi)</a>
<a class="sourceLine" id="cb698-1544" title="1544">      res[i, j] &lt;-<span class="st"> </span>lx_i<span class="op">/</span>(x_star<span class="op">-</span>xi)</a>
<a class="sourceLine" id="cb698-1545" title="1545">    }</a>
<a class="sourceLine" id="cb698-1546" title="1546">  }</a>
<a class="sourceLine" id="cb698-1547" title="1547">}</a>
<a class="sourceLine" id="cb698-1548" title="1548">G_obs &lt;-<span class="st"> </span><span class="kw">attr</span>(locG, <span class="st">&quot;internals&quot;</span>)[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb698-1549" title="1549">G_Zi &lt;-<span class="st"> </span>(G_obs <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(res))<span class="op">/</span><span class="kw">sd</span>(res) <span class="co"># code follows PySAL esda$G_Local()</span></a>
<a class="sourceLine" id="cb698-1550" title="1550">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(<span class="kw">c</span>(G_Zi)), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1551" title="1551">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1552" title="1552">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1553" title="1553"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1554" title="1554"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1555" title="1555">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(<span class="kw">c</span>(loc_G_ps<span class="op">$</span>z_sim)), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1556" title="1556">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1557" title="1557">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1558" title="1558"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1559" title="1559"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1560" title="1560">G_Zi_<span class="dv">1</span> &lt;-<span class="st"> </span>(G_obs <span class="op">-</span><span class="st"> </span><span class="kw">apply</span>(res, <span class="dv">1</span>, mean))<span class="op">/</span><span class="kw">apply</span>(res, <span class="dv">1</span>, sd)</a>
<a class="sourceLine" id="cb698-1561" title="1561">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(<span class="kw">c</span>(G_Zi_<span class="dv">1</span>)), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1562" title="1562">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1563" title="1563">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1564" title="1564"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1565" title="1565"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1566" title="1566">mns_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">apply</span>(loc_G_ps<span class="op">$</span>rGs, <span class="dv">1</span>, mean)</a>
<a class="sourceLine" id="cb698-1567" title="1567">sds_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">apply</span>(loc_G_ps<span class="op">$</span>rGs, <span class="dv">1</span>, sd)</a>
<a class="sourceLine" id="cb698-1568" title="1568">z_sim_<span class="dv">1</span> &lt;-<span class="st"> </span>(loc_G_ps<span class="op">$</span>Gs <span class="op">-</span><span class="st"> </span>mns_<span class="dv">1</span>) <span class="op">/</span><span class="st"> </span>sds_<span class="dv">1</span></a>
<a class="sourceLine" id="cb698-1569" title="1569">pv &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">pnorm</span>(<span class="kw">abs</span>(z_sim_<span class="dv">1</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1570" title="1570">pvsp &lt;-<span class="st"> </span><span class="kw">cbind</span>(pv, <span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>), <span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), </a>
<a class="sourceLine" id="cb698-1571" title="1571">              <span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb698-1572" title="1572"><span class="kw">colnames</span>(pvsp) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;none&quot;</span>, <span class="st">&quot;bonferroni&quot;</span>, <span class="st">&quot;fdr&quot;</span>, <span class="st">&quot;BY&quot;</span>)</a>
<a class="sourceLine" id="cb698-1573" title="1573"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb698-1574" title="1574">pol_pres15<span class="op">$</span>loc_G_Zi_perm &lt;-<span class="st"> </span>G_Zi_<span class="dv">1</span></a>
<a class="sourceLine" id="cb698-1575" title="1575">pol_pres15<span class="op">$</span>loc_G_Zi &lt;-<span class="st"> </span><span class="kw">c</span>(locG)</a>
<a class="sourceLine" id="cb698-1576" title="1576"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;loc_G_Zi&quot;</span>, <span class="st">&quot;loc_G_Zi_perm&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;Std. deviate&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;Analytical&quot;</span>, <span class="st">&quot;Permutation&quot;</span>))</a>
<a class="sourceLine" id="cb698-1577" title="1577"><span class="kw">args</span>(LOSH)</a>
<a class="sourceLine" id="cb698-1578" title="1578">lh &lt;-<span class="st"> </span><span class="kw">LOSH</span>(pol_pres15<span class="op">$</span>I_turnout, <span class="dt">listw=</span>lw_q_B)</a>
<a class="sourceLine" id="cb698-1579" title="1579">pol_pres15<span class="op">$</span>x_bar_i &lt;-<span class="st"> </span>lh[,<span class="dv">5</span>]</a>
<a class="sourceLine" id="cb698-1580" title="1580"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;I_turnout&quot;</span>, <span class="st">&quot;x_bar_i&quot;</span>), <span class="dt">title=</span><span class="st">&quot;Turnout&quot;</span>, <span class="dt">n=</span><span class="dv">6</span>, <span class="dt">style=</span><span class="st">&quot;fisher&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;Turnout&quot;</span>, <span class="st">&quot;Weighted means&quot;</span>))</a>
<a class="sourceLine" id="cb698-1581" title="1581">n &lt;-<span class="st"> </span><span class="kw">nrow</span>(pol_pres15)</a>
<a class="sourceLine" id="cb698-1582" title="1582">ones &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, n)</a>
<a class="sourceLine" id="cb698-1583" title="1583">hat &lt;-<span class="st"> </span>(<span class="kw">diag</span>(n) <span class="op">-</span><span class="st"> </span><span class="kw">tcrossprod</span>(ones) <span class="op">/</span><span class="st"> </span>n)</a>
<a class="sourceLine" id="cb698-1584" title="1584">Cmat &lt;-<span class="st"> </span>hat <span class="op">%*%</span><span class="st"> </span><span class="kw">listw2mat</span>(lw_q_B) <span class="op">%*%</span><span class="st"> </span>hat</a>
<a class="sourceLine" id="cb698-1585" title="1585">x &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>I_turnout</a>
<a class="sourceLine" id="cb698-1586" title="1586">I_MCM &lt;-<span class="st"> </span><span class="kw">c</span>((n<span class="op">/</span><span class="kw">Szero</span>(lw_q_B) <span class="op">*</span><span class="st"> </span><span class="kw">crossprod</span>(x, Cmat <span class="op">%*%</span><span class="st"> </span>x)<span class="op">/</span><span class="kw">crossprod</span>(x, hat <span class="op">%*%</span><span class="st"> </span>x)))</a>
<a class="sourceLine" id="cb698-1587" title="1587"><span class="kw">load</span>(<span class="st">&quot;rsb_rda/EVa.rda&quot;</span>)</a>
<a class="sourceLine" id="cb698-1588" title="1588">I_MCM</a>
<a class="sourceLine" id="cb698-1589" title="1589">EV &lt;-<span class="st"> </span><span class="kw">eigen</span>(Cmat)<span class="op">$</span>vectors</a>
<a class="sourceLine" id="cb698-1590" title="1590">pol_pres15<span class="op">$</span>EV1 &lt;-<span class="st"> </span>EVa[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb698-1591" title="1591">pol_pres15<span class="op">$</span>EV2 &lt;-<span class="st"> </span>EVa[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb698-1592" title="1592">pol_pres15<span class="op">$</span>EV3 &lt;-<span class="st"> </span>EVa[,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb698-1593" title="1593">pol_pres15<span class="op">$</span>EV4 &lt;-<span class="st"> </span>EVa[,<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb698-1594" title="1594"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;EV1&quot;</span>, <span class="st">&quot;EV2&quot;</span>, <span class="st">&quot;EV3&quot;</span>, <span class="st">&quot;EV4&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;Eigenvectors&quot;</span>, <span class="dt">n=</span><span class="dv">6</span>, <span class="dt">style=</span><span class="st">&quot;fisher&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;EV 1&quot;</span>, <span class="st">&quot;EV 2&quot;</span>, <span class="st">&quot;EV 3&quot;</span>, <span class="st">&quot;EV 4&quot;</span>))</a>
<a class="sourceLine" id="cb698-1595" title="1595"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1596" title="1596"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1597" title="1597"></a>
<a class="sourceLine" id="cb698-1598" title="1598">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1599" title="1599">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1600" title="1600"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1601" title="1601">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1602" title="1602"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1603" title="1603">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1604" title="1604"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1605" title="1605"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1606" title="1606"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1607" title="1607">)</a>
<a class="sourceLine" id="cb698-1608" title="1608"></a>
<a class="sourceLine" id="cb698-1609" title="1609"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1610" title="1610">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1611" title="1611"></a>
<a class="sourceLine" id="cb698-1612" title="1612"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1613" title="1613"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1614" title="1614"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1615" title="1615">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1616" title="1616"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-1617" title="1617">boston_<span class="dv">506</span> &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;shapes/boston_tracts.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;spData&quot;</span>)[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb698-1618" title="1618">nb_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">506</span>)</a>
<a class="sourceLine" id="cb698-1619" title="1619">lw_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb698-1620" title="1620"><span class="kw">table</span>(boston_<span class="dv">506</span><span class="op">$</span>censored)</a>
<a class="sourceLine" id="cb698-1621" title="1621"><span class="kw">summary</span>(boston_<span class="dv">506</span><span class="op">$</span>median)</a>
<a class="sourceLine" id="cb698-1622" title="1622">boston_<span class="dv">489</span> &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb698-1623" title="1623">nb_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1624" title="1624">lw_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">489</span>, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1625" title="1625">agg_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.character</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX_ID))</a>
<a class="sourceLine" id="cb698-1626" title="1626">boston_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="dt">by=</span>agg_<span class="dv">96</span>, unique)</a>
<a class="sourceLine" id="cb698-1627" title="1627">nb_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb698-1628" title="1628">lw_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb698-1629" title="1629">boston_<span class="dv">96</span><span class="op">$</span>NOX &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX, agg_<span class="dv">96</span>, mean)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb698-1630" title="1630">boston_<span class="dv">96</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">aggregate</span>(<span class="kw">as.integer</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)<span class="op">-</span><span class="dv">1</span>, agg_<span class="dv">96</span>, max)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb698-1631" title="1631">nms &lt;-<span class="st"> </span><span class="kw">names</span>(boston_<span class="dv">506</span>)</a>
<a class="sourceLine" id="cb698-1632" title="1632">ccounts &lt;-<span class="st"> </span><span class="dv">23</span><span class="op">:</span><span class="dv">31</span></a>
<a class="sourceLine" id="cb698-1633" title="1633"><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">22</span>, ccounts, <span class="dv">36</span>)]) {</a>
<a class="sourceLine" id="cb698-1634" title="1634">  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[[nm]], agg_<span class="dv">96</span>, sum)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb698-1635" title="1635">}</a>
<a class="sourceLine" id="cb698-1636" title="1636">br2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">3.50</span>,  <span class="fl">6.25</span>,  <span class="fl">8.75</span>, <span class="fl">12.50</span>, <span class="fl">17.50</span>, <span class="fl">22.50</span>, <span class="fl">30.00</span>, <span class="fl">42.50</span>, <span class="fl">60.00</span>)<span class="op">*</span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb698-1637" title="1637">counts &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(boston_<span class="dv">96</span>)[, nms[ccounts]]</a>
<a class="sourceLine" id="cb698-1638" title="1638">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMedian</span>(<span class="dt">x=</span>br2, <span class="dt">w=</span>x, <span class="dt">interpolate=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1639" title="1639">boston_<span class="dv">96</span><span class="op">$</span>median &lt;-<span class="st"> </span><span class="kw">apply</span>(counts, <span class="dv">1</span>, f)</a>
<a class="sourceLine" id="cb698-1640" title="1640"><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median) &lt;-<span class="st"> </span>boston_<span class="dv">96</span><span class="op">$</span>median <span class="op">&gt;</span><span class="st"> </span><span class="dv">50000</span></a>
<a class="sourceLine" id="cb698-1641" title="1641"><span class="kw">summary</span>(boston_<span class="dv">96</span><span class="op">$</span>median)</a>
<a class="sourceLine" id="cb698-1642" title="1642">POP &lt;-<span class="st"> </span>boston_<span class="dv">506</span><span class="op">$</span>POP</a>
<a class="sourceLine" id="cb698-1643" title="1643">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMean</span>(x[,<span class="dv">1</span>], x[,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb698-1644" title="1644"><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">9</span><span class="op">:</span><span class="dv">11</span>, <span class="dv">14</span><span class="op">:</span><span class="dv">19</span>, <span class="dv">21</span>, <span class="dv">33</span>)]) {</a>
<a class="sourceLine" id="cb698-1645" title="1645">  s0 &lt;-<span class="st"> </span><span class="kw">split</span>(<span class="kw">data.frame</span>(boston_<span class="dv">506</span>[[nm]], POP), agg_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb698-1646" title="1646">  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">sapply</span>(s0, f)</a>
<a class="sourceLine" id="cb698-1647" title="1647">}</a>
<a class="sourceLine" id="cb698-1648" title="1648">boston_<span class="dv">94</span> &lt;-<span class="st"> </span>boston_<span class="dv">96</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb698-1649" title="1649">nb_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">subset.nb</span>(nb_q_<span class="dv">96</span>, <span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median))</a>
<a class="sourceLine" id="cb698-1650" title="1650">lw_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">94</span>, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb698-1651" title="1651">form &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="kw">log</span>(median) <span class="op">~</span><span class="st"> </span>CRIM <span class="op">+</span><span class="st"> </span>ZN <span class="op">+</span><span class="st"> </span>INDUS <span class="op">+</span><span class="st"> </span>CHAS <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((NOX<span class="op">*</span><span class="dv">10</span>)<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(RM<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1652" title="1652"><span class="st">                  </span>AGE <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(DIS) <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(RAD) <span class="op">+</span><span class="st"> </span>TAX <span class="op">+</span><span class="st"> </span>PTRATIO <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(BB<span class="op">/</span><span class="dv">100</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb698-1653" title="1653"><span class="st">                  </span><span class="kw">log</span>(<span class="kw">I</span>(LSTAT<span class="op">/</span><span class="dv">100</span>)))</a>
<a class="sourceLine" id="cb698-1654" title="1654"><span class="kw">library</span>(spatialreg)</a>
<a class="sourceLine" id="cb698-1655" title="1655"><span class="kw">args</span>(errorsarlm)</a>
<a class="sourceLine" id="cb698-1656" title="1656"><span class="kw">args</span>(lagsarlm)</a>
<a class="sourceLine" id="cb698-1657" title="1657"><span class="kw">args</span>(spautolm)</a>
<a class="sourceLine" id="cb698-1658" title="1658"><span class="kw">args</span>(sacsarlm)</a>
<a class="sourceLine" id="cb698-1659" title="1659"><span class="kw">args</span>(summary.sarlm)</a>
<a class="sourceLine" id="cb698-1660" title="1660">eigs_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1661" title="1661">SDEM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb698-1662" title="1662">                       <span class="dt">zero.policy=</span><span class="ot">TRUE</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb698-1663" title="1663">SEM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, </a>
<a class="sourceLine" id="cb698-1664" title="1664">                      <span class="dt">zero.policy=</span><span class="ot">TRUE</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb698-1665" title="1665"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </a>
<a class="sourceLine" id="cb698-1666" title="1666">      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SEM_<span class="dv">489</span>)), </a>
<a class="sourceLine" id="cb698-1667" title="1667">            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SDEM_<span class="dv">489</span>))))[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb698-1668" title="1668"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </a>
<a class="sourceLine" id="cb698-1669" title="1669">      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.sarlm</span>(SEM_<span class="dv">489</span>)), </a>
<a class="sourceLine" id="cb698-1670" title="1670">            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.sarlm</span>(SDEM_<span class="dv">489</span>))))[,<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>)]</a>
<a class="sourceLine" id="cb698-1671" title="1671">eigs_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q_<span class="dv">94</span>)</a>
<a class="sourceLine" id="cb698-1672" title="1672">SDEM_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1673" title="1673">                      <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1674" title="1674">SEM_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1675" title="1675"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </a>
<a class="sourceLine" id="cb698-1676" title="1676">      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SEM_<span class="dv">94</span>)), </a>
<a class="sourceLine" id="cb698-1677" title="1677">            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SDEM_<span class="dv">94</span>))))[, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb698-1678" title="1678"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.sarlm</span>(SEM_<span class="dv">94</span>)), broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.sarlm</span>(SDEM_<span class="dv">94</span>))))[,<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>)]</a>
<a class="sourceLine" id="cb698-1679" title="1679">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SEM_<span class="dv">489</span>, SDEM_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb698-1680" title="1680">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SEM_<span class="dv">94</span>, SDEM_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1681" title="1681"><span class="kw">args</span>(lmSLX)</a>
<a class="sourceLine" id="cb698-1682" title="1682">SLX_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1683" title="1683">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_<span class="dv">489</span>, SDEM_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb698-1684" title="1684">SLX_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>)</a>
<a class="sourceLine" id="cb698-1685" title="1685">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_<span class="dv">94</span>, SDEM_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1686" title="1686">SLX_94w &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">weights=</span>units)</a>
<a class="sourceLine" id="cb698-1687" title="1687">SDEM_94w &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>, <span class="dt">weights=</span>units,</a>
<a class="sourceLine" id="cb698-1688" title="1688">                       <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1689" title="1689">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_94w, SDEM_94w))</a>
<a class="sourceLine" id="cb698-1690" title="1690"><span class="kw">library</span>(sphet)</a>
<a class="sourceLine" id="cb698-1691" title="1691">SEM1_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">spreg</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">model=</span><span class="st">&quot;error&quot;</span>)</a>
<a class="sourceLine" id="cb698-1692" title="1692">res &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">summary</span>(SEM_<span class="dv">94</span>)<span class="op">$</span>Coef[<span class="st">&quot;I((NOX * 10)^2)&quot;</span>,], </a>
<a class="sourceLine" id="cb698-1693" title="1693">             <span class="kw">summary</span>(SEM1_<span class="dv">94</span>)<span class="op">$</span>CoefTable[<span class="st">&quot;I((NOX * 10)^2)&quot;</span>,])</a>
<a class="sourceLine" id="cb698-1694" title="1694"><span class="kw">rownames</span>(res) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ML&quot;</span>, <span class="st">&quot;GMM&quot;</span>)</a>
<a class="sourceLine" id="cb698-1695" title="1695">res</a>
<a class="sourceLine" id="cb698-1696" title="1696">formiv &lt;-<span class="st"> </span><span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span><span class="kw">I</span>((NOX<span class="op">*</span><span class="dv">10</span>)<span class="op">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb698-1697" title="1697">boston_<span class="dv">94</span><span class="op">$</span>NOX2 &lt;-<span class="st"> </span>(boston_<span class="dv">94</span><span class="op">$</span>NOX<span class="op">*</span><span class="dv">10</span>)<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb698-1698" title="1698"><span class="kw">suppressWarnings</span>(ccoords &lt;-<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(boston_<span class="dv">94</span>))))</a>
<a class="sourceLine" id="cb698-1699" title="1699">iform &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="op">~</span><span class="kw">poly</span>(ccoords, <span class="dt">degree=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>DIS <span class="op">+</span><span class="st"> </span>RAD)</a>
<a class="sourceLine" id="cb698-1700" title="1700">SEM1_94iv &lt;-<span class="st"> </span><span class="kw">spreg</span>(formiv, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">endog =</span> <span class="op">~</span>NOX2, </a>
<a class="sourceLine" id="cb698-1701" title="1701">                   <span class="dt">instruments=</span>iform, <span class="dt">model=</span><span class="st">&quot;error&quot;</span>)</a>
<a class="sourceLine" id="cb698-1702" title="1702"><span class="kw">summary</span>(SEM1_94iv)<span class="op">$</span>CoefTable[<span class="st">&quot;NOX2&quot;</span>,]</a>
<a class="sourceLine" id="cb698-1703" title="1703"><span class="kw">system.time</span>(SDEM_94B &lt;-<span class="st"> </span><span class="kw">spBreg_err</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-1704" title="1704"><span class="kw">system.time</span>(SDEM_489B &lt;-<span class="st"> </span><span class="kw">spBreg_err</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-1705" title="1705"><span class="kw">t</span>(<span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>)<span class="op">$</span>timings[,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb698-1706" title="1706"><span class="kw">t</span>(<span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)<span class="op">$</span>timings[,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb698-1707" title="1707"><span class="kw">t</span>(<span class="kw">attr</span>(SDEM_94B, <span class="st">&quot;timings&quot;</span>)[ , <span class="dv">3</span>])</a>
<a class="sourceLine" id="cb698-1708" title="1708"><span class="kw">t</span>(<span class="kw">attr</span>(SDEM_489B, <span class="st">&quot;timings&quot;</span>)[ , <span class="dv">3</span>])</a>
<a class="sourceLine" id="cb698-1709" title="1709">SEM_<span class="dv">94</span><span class="op">$</span>interval</a>
<a class="sourceLine" id="cb698-1710" title="1710"><span class="dv">1</span><span class="op">/</span><span class="kw">range</span>(eigs_<span class="dv">94</span>)</a>
<a class="sourceLine" id="cb698-1711" title="1711"><span class="dv">1</span><span class="op">/</span><span class="kw">c</span>(<span class="kw">lextrW</span>(lw_q_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1712" title="1712">W &lt;-<span class="st"> </span><span class="kw">as</span>(lw_q_<span class="dv">94</span>, <span class="st">&quot;CsparseMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb698-1713" title="1713"><span class="dv">1</span><span class="op">/</span><span class="kw">Re</span>(<span class="kw">c</span>(RSpectra<span class="op">::</span><span class="kw">eigs</span>(W, <span class="dt">k=</span><span class="dv">1</span>, <span class="dt">which=</span><span class="st">&quot;SR&quot;</span>)<span class="op">$</span>values, </a>
<a class="sourceLine" id="cb698-1714" title="1714">       RSpectra<span class="op">::</span><span class="kw">eigs</span>(W, <span class="dt">k=</span><span class="dv">1</span>, <span class="dt">which=</span><span class="st">&quot;LR&quot;</span>)<span class="op">$</span>values))</a>
<a class="sourceLine" id="cb698-1715" title="1715">coef &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb698-1716" title="1716"><span class="kw">sum</span>(<span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>coef <span class="op">*</span><span class="st"> </span>eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1717" title="1717">I &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(boston_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1718" title="1718">LU &lt;-<span class="st"> </span><span class="kw">lu</span>(I <span class="op">-</span><span class="st"> </span>coef <span class="op">*</span><span class="st"> </span>W)</a>
<a class="sourceLine" id="cb698-1719" title="1719">dU &lt;-<span class="st"> </span><span class="kw">abs</span>(<span class="kw">diag</span>(<span class="kw">slot</span>(LU, <span class="st">&quot;U&quot;</span>)))</a>
<a class="sourceLine" id="cb698-1720" title="1720"><span class="kw">sum</span>(<span class="kw">log</span>(dU))</a>
<a class="sourceLine" id="cb698-1721" title="1721">W &lt;-<span class="st"> </span><span class="kw">as</span>(<span class="kw">similar.listw</span>(lw_q_<span class="dv">94</span>), <span class="st">&quot;CsparseMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb698-1722" title="1722">super &lt;-<span class="st"> </span><span class="kw">as.logical</span>(<span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb698-1723" title="1723">cch &lt;-<span class="st"> </span><span class="kw">Cholesky</span>((I <span class="op">-</span><span class="st"> </span>coef <span class="op">*</span><span class="st"> </span>W), <span class="dt">super=</span>super)</a>
<a class="sourceLine" id="cb698-1724" title="1724"><span class="kw">c</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">determinant</span>(cch, <span class="dt">logarithm =</span> <span class="ot">TRUE</span>)<span class="op">$</span>modulus)</a>
<a class="sourceLine" id="cb698-1725" title="1725"><span class="kw">args</span>(jacobianSetup)</a>
<a class="sourceLine" id="cb698-1726" title="1726"><span class="kw">args</span>(do_ldet)</a>
<a class="sourceLine" id="cb698-1727" title="1727"><span class="kw">args</span>(impacts.sarlm)</a>
<a class="sourceLine" id="cb698-1728" title="1728"><span class="kw">args</span>(summary.lagImpact)</a>
<a class="sourceLine" id="cb698-1729" title="1729">sum_imp_<span class="dv">94</span>_SDEM &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SDEM_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1730" title="1730"><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SDEM<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SDEM<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb698-1731" title="1731">sum_imp_<span class="dv">94</span>_SDEM_B &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SDEM_94B))</a>
<a class="sourceLine" id="cb698-1732" title="1732"><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SDEM_B<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SDEM_B<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb698-1733" title="1733">sum_imp_<span class="dv">94</span>_SLX &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SLX_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb698-1734" title="1734"><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SLX<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SLX<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb698-1735" title="1735">SLM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">lagsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1736" title="1736"><span class="kw">args</span>(trW)</a>
<a class="sourceLine" id="cb698-1737" title="1737">W &lt;-<span class="st"> </span><span class="kw">as</span>(lw_q_<span class="dv">489</span>, <span class="st">&quot;CsparseMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb698-1738" title="1738">tr_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">trW</span>(W)</a>
<a class="sourceLine" id="cb698-1739" title="1739"><span class="kw">str</span>(tr_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1740" title="1740">SLM_<span class="dv">489</span>_imp &lt;-<span class="st"> </span><span class="kw">impacts</span>(SLM_<span class="dv">489</span>, <span class="dt">tr=</span>tr_<span class="dv">489</span>, <span class="dt">R=</span><span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb698-1741" title="1741">SLM_<span class="dv">489</span>_imp_sum &lt;-<span class="st"> </span><span class="kw">summary</span>(SLM_<span class="dv">489</span>_imp, <span class="dt">short=</span><span class="ot">TRUE</span>, <span class="dt">zstats=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1742" title="1742">res &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="dt">Impacts=</span><span class="kw">sapply</span>(SLM_<span class="dv">489</span>_imp<span class="op">$</span>res, <span class="st">&quot;[&quot;</span>, <span class="dv">5</span>), <span class="dt">SE=</span>SLM_<span class="dv">489</span>_imp_sum<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb698-1743" title="1743"><span class="kw">colnames</span>(res) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Direct&quot;</span>, <span class="st">&quot;Indirect&quot;</span>, <span class="st">&quot;Total&quot;</span>)</a>
<a class="sourceLine" id="cb698-1744" title="1744">res</a>
<a class="sourceLine" id="cb698-1745" title="1745">coef_SLM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">coef</span>(SLM_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1746" title="1746">IrW &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="dv">489</span>) <span class="op">-</span><span class="st"> </span>coef_SLM_<span class="dv">489</span>[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>W</a>
<a class="sourceLine" id="cb698-1747" title="1747">S_W &lt;-<span class="st"> </span><span class="kw">solve</span>(IrW)</a>
<a class="sourceLine" id="cb698-1748" title="1748">S_NOX_W &lt;-<span class="st"> </span>S_W <span class="op">%*%</span><span class="st"> </span>(<span class="kw">diag</span>(<span class="dv">489</span>) <span class="op">*</span><span class="st"> </span>coef_SLM_<span class="dv">489</span>[<span class="dv">7</span>])</a>
<a class="sourceLine" id="cb698-1749" title="1749"><span class="kw">c</span>(<span class="dt">Direct=</span><span class="kw">mean</span>(<span class="kw">diag</span>(S_NOX_W)), <span class="dt">Total=</span><span class="kw">sum</span>(S_NOX_W)<span class="op">/</span><span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1750" title="1750"><span class="kw">sapply</span>(<span class="kw">impacts</span>(SLM_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>), <span class="st">&quot;[&quot;</span>, <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb698-1751" title="1751"><span class="kw">sapply</span>(<span class="kw">impacts</span>(SLM_<span class="dv">489</span>, <span class="dt">evalues=</span>eigs_<span class="dv">489</span>), <span class="st">&quot;[&quot;</span>, <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb698-1752" title="1752"><span class="kw">args</span>(predict.sarlm)</a>
<a class="sourceLine" id="cb698-1753" title="1753">nd_<span class="dv">489</span> &lt;-<span class="st"> </span>boston_<span class="dv">489</span></a>
<a class="sourceLine" id="cb698-1754" title="1754">nd_<span class="dv">489</span><span class="op">$</span>PTRATIO &lt;-<span class="st"> </span>nd_<span class="dv">489</span><span class="op">$</span>PTRATIO <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb698-1755" title="1755">OLS_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">lm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1756" title="1756">fitted &lt;-<span class="st"> </span><span class="kw">predict</span>(OLS_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1757" title="1757">nd_fitted &lt;-<span class="st"> </span><span class="kw">predict</span>(OLS_<span class="dv">489</span>, <span class="dt">newdata=</span>nd_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1758" title="1758"><span class="kw">all.equal</span>(<span class="kw">unname</span>(<span class="kw">coef</span>(OLS_<span class="dv">489</span>)[<span class="dv">12</span>]), <span class="kw">mean</span>(nd_fitted <span class="op">-</span><span class="st"> </span>fitted))</a>
<a class="sourceLine" id="cb698-1759" title="1759">fitted &lt;-<span class="st"> </span><span class="kw">predict</span>(SLM_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb698-1760" title="1760">nd_fitted &lt;-<span class="st"> </span><span class="kw">predict</span>(SLM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">pred.type=</span><span class="st">&quot;TS&quot;</span>,</a>
<a class="sourceLine" id="cb698-1761" title="1761">                     <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb698-1762" title="1762"><span class="kw">all.equal</span>(<span class="kw">unname</span>(coef_SLM_<span class="dv">489</span>[<span class="dv">13</span>]), <span class="kw">mean</span>(nd_fitted <span class="op">-</span><span class="st"> </span>fitted))</a>
<a class="sourceLine" id="cb698-1763" title="1763">nd &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb698-1764" title="1764">t0 &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd, <span class="dt">listw=</span>lw_q, <span class="dt">pred.type=</span><span class="st">&quot;TS&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-1765" title="1765"><span class="kw">suppressWarnings</span>(t1  &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd, <span class="dt">listw=</span>lw_q, <span class="dt">pred.type=</span><span class="st">&quot;KP2&quot;</span>,</a>
<a class="sourceLine" id="cb698-1766" title="1766">                                    <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb698-1767" title="1767"><span class="kw">suppressWarnings</span>(t2  &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd, <span class="dt">listw=</span>lw_q, <span class="dt">pred.type=</span><span class="st">&quot;KP5&quot;</span>,</a>
<a class="sourceLine" id="cb698-1768" title="1768">                                    <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb698-1769" title="1769"><span class="kw">data.frame</span>(<span class="dt">fit_TS=</span>t0[,<span class="dv">1</span>], <span class="dt">fit_KP2=</span><span class="kw">c</span>(t1), <span class="dt">fit_KP5=</span><span class="kw">c</span>(t2),</a>
<a class="sourceLine" id="cb698-1770" title="1770">           <span class="dt">censored=</span>boston_<span class="dv">506</span><span class="op">$</span>censored[<span class="kw">as.integer</span>(<span class="kw">attr</span>(t0, <span class="st">&quot;region.id&quot;</span>))])</a>
<a class="sourceLine" id="cb698-1771" title="1771">boston_94a &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">489</span>[,<span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID), unique)</a>
<a class="sourceLine" id="cb698-1772" title="1772">nb_q_94a &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_94a)</a>
<a class="sourceLine" id="cb698-1773" title="1773">NOX_ID_no_neighs &lt;-<span class="st"> </span>boston_94a<span class="op">$</span>NOX_ID[<span class="kw">which</span>(spdep<span class="op">::</span><span class="kw">card</span>(nb_q_94a) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)]</a>
<a class="sourceLine" id="cb698-1774" title="1774">boston_<span class="dv">487</span> &lt;-<span class="st"> </span>boston_<span class="dv">489</span>[<span class="kw">is.na</span>(<span class="kw">match</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID, NOX_ID_no_neighs)),]</a>
<a class="sourceLine" id="cb698-1775" title="1775">boston_<span class="dv">93</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">487</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(<span class="dt">ids =</span> boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), unique)</a>
<a class="sourceLine" id="cb698-1776" title="1776"><span class="kw">row.names</span>(boston_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)</a>
<a class="sourceLine" id="cb698-1777" title="1777">nb_q_<span class="dv">93</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">93</span>, <span class="dt">row.names=</span><span class="kw">unique</span>(<span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)))</a>
<a class="sourceLine" id="cb698-1778" title="1778"><span class="kw">library</span>(lme4)</a>
<a class="sourceLine" id="cb698-1779" title="1779">MLM &lt;-<span class="st"> </span><span class="kw">lmer</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID)), <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">REML=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1780" title="1780">boston_<span class="dv">93</span><span class="op">$</span>MLM_re &lt;-<span class="st"> </span><span class="kw">ranef</span>(MLM)[[<span class="dv">1</span>]][,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb698-1781" title="1781"><span class="kw">library</span>(Matrix)</a>
<a class="sourceLine" id="cb698-1782" title="1782"><span class="kw">suppressMessages</span>(<span class="kw">library</span>(MatrixModels))</a>
<a class="sourceLine" id="cb698-1783" title="1783">Delta &lt;-<span class="st"> </span><span class="kw">as</span>(<span class="kw">model.Matrix</span>(<span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span><span class="kw">as.factor</span>(NOX_ID), <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">sparse=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb698-1784" title="1784">            <span class="st">&quot;dgCMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb698-1785" title="1785">M &lt;-<span class="st"> </span><span class="kw">as</span>(spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">93</span>, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>), <span class="st">&quot;CsparseMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb698-1786" title="1786"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(hglm))</a>
<a class="sourceLine" id="cb698-1787" title="1787">y_hglm &lt;-<span class="st"> </span><span class="kw">log</span>(boston_<span class="dv">487</span><span class="op">$</span>median)</a>
<a class="sourceLine" id="cb698-1788" title="1788">X_hglm &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="kw">lm</span>(form, <span class="dt">data=</span>boston_<span class="dv">487</span>))</a>
<a class="sourceLine" id="cb698-1789" title="1789"><span class="kw">suppressWarnings</span>(HGLM_iid &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">y=</span>y_hglm, <span class="dt">X=</span>X_hglm, <span class="dt">Z=</span>Delta))</a>
<a class="sourceLine" id="cb698-1790" title="1790"><span class="kw">suppressWarnings</span>(HGLM_sar &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">y=</span>y_hglm, <span class="dt">X=</span>X_hglm, <span class="dt">Z=</span>Delta, <span class="dt">rand.family=</span><span class="kw">SAR</span>(<span class="dt">D=</span>M)))</a>
<a class="sourceLine" id="cb698-1791" title="1791">boston_<span class="dv">93</span><span class="op">$</span>HGLM_re &lt;-<span class="st"> </span><span class="kw">unname</span>(HGLM_iid<span class="op">$</span>ranef)</a>
<a class="sourceLine" id="cb698-1792" title="1792">boston_<span class="dv">93</span><span class="op">$</span>HGLM_ss &lt;-<span class="st"> </span>HGLM_sar<span class="op">$</span>ranef[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb698-1793" title="1793"><span class="kw">library</span>(HSAR)</a>
<a class="sourceLine" id="cb698-1794" title="1794"><span class="kw">suppressWarnings</span>(HSAR &lt;-<span class="st"> </span><span class="kw">hsar</span>(form, <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">W=</span><span class="ot">NULL</span>, <span class="dt">M=</span>M, <span class="dt">Delta=</span>Delta, </a>
<a class="sourceLine" id="cb698-1795" title="1795">                              <span class="dt">burnin=</span><span class="dv">500</span>, <span class="dt">Nsim=</span><span class="dv">2500</span>, <span class="dt">thinning=</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb698-1796" title="1796">boston_<span class="dv">93</span><span class="op">$</span>HSAR_ss &lt;-<span class="st"> </span>HSAR<span class="op">$</span>Mus[<span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb698-1797" title="1797"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(R2BayesX))</a>
<a class="sourceLine" id="cb698-1798" title="1798">BX_iid &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs=</span><span class="st">&quot;re&quot;</span>)), <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb698-1799" title="1799"><span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">method=</span><span class="st">&quot;MCMC&quot;</span>, <span class="dt">iterations=</span><span class="dv">12000</span>, <span class="dt">burnin=</span><span class="dv">2000</span>, <span class="dt">step=</span><span class="dv">2</span>, <span class="dt">seed=</span><span class="dv">123</span>)</a>
<a class="sourceLine" id="cb698-1800" title="1800">boston_<span class="dv">93</span><span class="op">$</span>BX_re &lt;-<span class="st"> </span>BX_iid<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):re&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</a>
<a class="sourceLine" id="cb698-1801" title="1801">RBX_gra &lt;-<span class="st"> </span><span class="kw">nb2gra</span>(nb_q_<span class="dv">93</span>)</a>
<a class="sourceLine" id="cb698-1802" title="1802">BX_mrf &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs=</span><span class="st">&quot;mrf&quot;</span>, <span class="dt">map=</span>RBX_gra)), </a>
<a class="sourceLine" id="cb698-1803" title="1803">                 <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">method=</span><span class="st">&quot;MCMC&quot;</span>, </a>
<a class="sourceLine" id="cb698-1804" title="1804">                 <span class="dt">iterations=</span><span class="dv">12000</span>, <span class="dt">burnin=</span><span class="dv">2000</span>,<span class="dt">step=</span><span class="dv">2</span>, <span class="dt">seed=</span><span class="dv">123</span>)</a>
<a class="sourceLine" id="cb698-1805" title="1805">boston_<span class="dv">93</span><span class="op">$</span>BX_ss &lt;-<span class="st"> </span>BX_mrf<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):mrf&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</a>
<a class="sourceLine" id="cb698-1806" title="1806"><span class="kw">library</span>(mgcv)</a>
<a class="sourceLine" id="cb698-1807" title="1807"><span class="kw">names</span>(nb_q_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>)</a>
<a class="sourceLine" id="cb698-1808" title="1808">boston_<span class="dv">487</span><span class="op">$</span>NOX_ID &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID)</a>
<a class="sourceLine" id="cb698-1809" title="1809">GAM_MRF &lt;-<span class="st"> </span><span class="kw">gam</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(NOX_ID, <span class="dt">bs=</span><span class="st">&quot;mrf&quot;</span>, <span class="dt">xt=</span><span class="kw">list</span>(<span class="dt">nb=</span>nb_q_<span class="dv">93</span>))),</a>
<a class="sourceLine" id="cb698-1810" title="1810">               <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">method=</span><span class="st">&quot;REML&quot;</span>)</a>
<a class="sourceLine" id="cb698-1811" title="1811">boston_<span class="dv">93</span><span class="op">$</span>GAM_ss &lt;-<span class="st"> </span><span class="kw">aggregate</span>(<span class="kw">predict</span>(GAM_MRF, <span class="dt">type=</span><span class="st">&quot;terms&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>)[,<span class="dv">14</span>],</a>
<a class="sourceLine" id="cb698-1812" title="1812">                              <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), mean)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb698-1813" title="1813">res &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="dt">iid_lmer=</span><span class="kw">summary</span>(MLM)<span class="op">$</span>coefficients[<span class="dv">6</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>],</a>
<a class="sourceLine" id="cb698-1814" title="1814">             <span class="dt">iid_hglm=</span><span class="kw">summary</span>(HGLM_iid)<span class="op">$</span>FixCoefMat[<span class="dv">6</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], </a>
<a class="sourceLine" id="cb698-1815" title="1815">             <span class="dt">iid_BX=</span>BX_iid<span class="op">$</span>fixed.effects[<span class="dv">6</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], </a>
<a class="sourceLine" id="cb698-1816" title="1816">             <span class="dt">sar_hsar=</span><span class="kw">c</span>(HSAR<span class="op">$</span>Mbetas[<span class="dv">1</span>, <span class="dv">6</span>], HSAR<span class="op">$</span>SDbetas[<span class="dv">1</span>, <span class="dv">6</span>]),</a>
<a class="sourceLine" id="cb698-1817" title="1817">             <span class="dt">mrf_BX=</span>BX_mrf<span class="op">$</span>fixed.effects[<span class="dv">6</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], </a>
<a class="sourceLine" id="cb698-1818" title="1818">             <span class="dt">mrf_GAM=</span><span class="kw">c</span>(<span class="kw">summary</span>(GAM_MRF)<span class="op">$</span>p.coeff[<span class="dv">6</span>], <span class="kw">summary</span>(GAM_MRF)<span class="op">$</span>se[<span class="dv">6</span>]))</a>
<a class="sourceLine" id="cb698-1819" title="1819"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(ggplot2))</a>
<a class="sourceLine" id="cb698-1820" title="1820">df_res &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(res)</a>
<a class="sourceLine" id="cb698-1821" title="1821"><span class="kw">names</span>(df_res) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;sd&quot;</span>)</a>
<a class="sourceLine" id="cb698-1822" title="1822">limits &lt;-<span class="st"> </span><span class="kw">aes</span>(<span class="dt">ymax =</span> mean <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.975</span>)<span class="op">*</span>sd, <span class="dt">ymin=</span>mean <span class="op">+</span><span class="st"> </span><span class="kw">qnorm</span>(<span class="fl">0.025</span>)<span class="op">*</span>sd)</a>
<a class="sourceLine" id="cb698-1823" title="1823">df_res<span class="op">$</span>model &lt;-<span class="st"> </span><span class="kw">row.names</span>(df_res)</a>
<a class="sourceLine" id="cb698-1824" title="1824">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df_res, <span class="kw">aes</span>(<span class="dt">y=</span>mean, <span class="dt">x=</span>model)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_errorbar</span>(limits) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">col=</span><span class="st">&quot;#EB811B&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_flip</span>()</a>
<a class="sourceLine" id="cb698-1825" title="1825">p <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;NOX coefficients and error bars&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;transparent&quot;</span>,<span class="dt">colour =</span> <span class="ot">NA</span>), <span class="dt">legend.background =</span> <span class="kw">element_rect</span>(<span class="dt">colour =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">&quot;transparent&quot;</span>))</a>
<a class="sourceLine" id="cb698-1826" title="1826"><span class="kw">library</span>(tmap)</a>
<a class="sourceLine" id="cb698-1827" title="1827"><span class="co"># </span><span class="al">FIXME</span><span class="co">: uncommented BX_re</span></a>
<a class="sourceLine" id="cb698-1828" title="1828"><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;MLM_re&quot;</span>, <span class="st">&quot;HGLM_re&quot;</span> <span class="co">#, &quot;BX_re&quot;</span></a>
<a class="sourceLine" id="cb698-1829" title="1829">                                ), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;IID&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;MLM&quot;</span>, <span class="st">&quot;HGLM&quot;</span>, <span class="st">&quot;BX&quot;</span>))</a>
<a class="sourceLine" id="cb698-1830" title="1830"><span class="co"># </span><span class="al">FIXME</span><span class="co">: uncommented BX_ss</span></a>
<a class="sourceLine" id="cb698-1831" title="1831"><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;HGLM_ss&quot;</span>, <span class="st">&quot;HSAR_ss&quot;</span>, <span class="co"># &quot;BX_ss&quot;, </span></a>
<a class="sourceLine" id="cb698-1832" title="1832">  <span class="st">&quot;GAM_ss&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;SS&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;HGLM SAR&quot;</span>, <span class="st">&quot;HSAR SAR&quot;</span>, <span class="st">&quot;BX MRF&quot;</span>, <span class="st">&quot;GAM MRF&quot;</span>))</a>
<a class="sourceLine" id="cb698-1833" title="1833"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1834" title="1834"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1835" title="1835"></a>
<a class="sourceLine" id="cb698-1836" title="1836">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1837" title="1837">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1838" title="1838"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1839" title="1839">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1840" title="1840"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1841" title="1841">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1842" title="1842"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1843" title="1843"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1844" title="1844"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1845" title="1845">)</a>
<a class="sourceLine" id="cb698-1846" title="1846"></a>
<a class="sourceLine" id="cb698-1847" title="1847"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1848" title="1848">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1849" title="1849"></a>
<a class="sourceLine" id="cb698-1850" title="1850"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1851" title="1851"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1852" title="1852"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1853" title="1853">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1854" title="1854"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1855" title="1855"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1856" title="1856"></a>
<a class="sourceLine" id="cb698-1857" title="1857">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1858" title="1858">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1859" title="1859"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1860" title="1860">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1861" title="1861"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1862" title="1862">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1863" title="1863"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1864" title="1864"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1865" title="1865"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1866" title="1866">)</a>
<a class="sourceLine" id="cb698-1867" title="1867"></a>
<a class="sourceLine" id="cb698-1868" title="1868"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1869" title="1869">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1870" title="1870"></a>
<a class="sourceLine" id="cb698-1871" title="1871"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1872" title="1872"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1873" title="1873"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1874" title="1874">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1875" title="1875"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1876" title="1876"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1877" title="1877"></a>
<a class="sourceLine" id="cb698-1878" title="1878">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1879" title="1879">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1880" title="1880"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1881" title="1881">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1882" title="1882"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1883" title="1883">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1884" title="1884"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1885" title="1885"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1886" title="1886"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1887" title="1887">)</a>
<a class="sourceLine" id="cb698-1888" title="1888"></a>
<a class="sourceLine" id="cb698-1889" title="1889"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1890" title="1890">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1891" title="1891"></a>
<a class="sourceLine" id="cb698-1892" title="1892"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1893" title="1893"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1894" title="1894"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1895" title="1895">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1896" title="1896"><span class="co"># All R code in this book {-}</span></a>
<a class="sourceLine" id="cb698-1897" title="1897"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-1898" title="1898"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1899" title="1899"></a>
<a class="sourceLine" id="cb698-1900" title="1900">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-1901" title="1901">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-1902" title="1902"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-1903" title="1903">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-1904" title="1904"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-1905" title="1905">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-1906" title="1906"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-1907" title="1907"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-1908" title="1908"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-1909" title="1909">)</a>
<a class="sourceLine" id="cb698-1910" title="1910"></a>
<a class="sourceLine" id="cb698-1911" title="1911"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1912" title="1912">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1913" title="1913"></a>
<a class="sourceLine" id="cb698-1914" title="1914"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-1915" title="1915"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-1916" title="1916"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-1917" title="1917">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a>
<a class="sourceLine" id="cb698-1918" title="1918">a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">b</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">d</span>(<span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb698-1919" title="1919"><span class="kw">d</span>(<span class="kw">c</span>(<span class="kw">b</span>(a)), <span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb698-1920" title="1920">tmp1 &lt;-<span class="st"> </span><span class="kw">b</span>(a)</a>
<a class="sourceLine" id="cb698-1921" title="1921">tmp2 &lt;-<span class="st"> </span><span class="kw">c</span>(tmp1)</a>
<a class="sourceLine" id="cb698-1922" title="1922">tmp3 &lt;-<span class="st"> </span><span class="kw">d</span>(tmp2, <span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb698-1923" title="1923"><span class="kw">typeof</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb698-1924" title="1924"><span class="kw">length</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb698-1925" title="1925"><span class="kw">typeof</span>(<span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb698-1926" title="1926"><span class="kw">length</span>(<span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb698-1927" title="1927"><span class="kw">typeof</span>(<span class="kw">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>))</a>
<a class="sourceLine" id="cb698-1928" title="1928"><span class="kw">length</span>(<span class="kw">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>))</a>
<a class="sourceLine" id="cb698-1929" title="1929"><span class="kw">typeof</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb698-1930" title="1930">i =<span class="st"> </span><span class="kw">integer</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb698-1931" title="1931"><span class="kw">typeof</span>(i)</a>
<a class="sourceLine" id="cb698-1932" title="1932">i</a>
<a class="sourceLine" id="cb698-1933" title="1933"><span class="kw">length</span>(i)</a>
<a class="sourceLine" id="cb698-1934" title="1934">a =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1935" title="1935">a[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb698-1936" title="1936">a[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb698-1937" title="1937">a[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb698-1938" title="1938">a[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>] =<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-1939" title="1939">a</a>
<a class="sourceLine" id="cb698-1940" title="1940">a[[<span class="dv">3</span>]] =<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb698-1941" title="1941">a</a>
<a class="sourceLine" id="cb698-1942" title="1942">l &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dv">3</span>, <span class="ot">TRUE</span>, <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb698-1943" title="1943"><span class="kw">typeof</span>(l)</a>
<a class="sourceLine" id="cb698-1944" title="1944"><span class="kw">length</span>(l)</a>
<a class="sourceLine" id="cb698-1945" title="1945">l[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb698-1946" title="1946">l[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb698-1947" title="1947">l[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] =<span class="st"> </span><span class="kw">list</span>(<span class="dv">4</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-1948" title="1948">l</a>
<a class="sourceLine" id="cb698-1949" title="1949">l[[<span class="dv">3</span>]] =<span class="st"> &quot;bar&quot;</span></a>
<a class="sourceLine" id="cb698-1950" title="1950">l</a>
<a class="sourceLine" id="cb698-1951" title="1951">l =<span class="st"> </span><span class="kw">list</span>(<span class="dt">first =</span> <span class="dv">3</span>, <span class="dt">second =</span> <span class="ot">TRUE</span>, <span class="dt">third =</span> <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb698-1952" title="1952">l</a>
<a class="sourceLine" id="cb698-1953" title="1953">l<span class="op">$</span>second</a>
<a class="sourceLine" id="cb698-1954" title="1954">l<span class="op">$</span>second =<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb698-1955" title="1955">l</a>
<a class="sourceLine" id="cb698-1956" title="1956"><span class="dv">3</span> <span class="op">==</span><span class="st"> </span><span class="ot">NULL</span> <span class="co"># not FALSE!</span></a>
<a class="sourceLine" id="cb698-1957" title="1957"><span class="ot">NULL</span> <span class="op">==</span><span class="st"> </span><span class="ot">NULL</span> <span class="co"># not even TRUE!</span></a>
<a class="sourceLine" id="cb698-1958" title="1958"><span class="kw">is.null</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb698-1959" title="1959">l =<span class="st"> </span>l[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)] <span class="co"># remove second, implicitly</span></a>
<a class="sourceLine" id="cb698-1960" title="1960">l</a>
<a class="sourceLine" id="cb698-1961" title="1961">l<span class="op">$</span>second =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb698-1962" title="1962">l</a>
<a class="sourceLine" id="cb698-1963" title="1963">a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb698-1964" title="1964"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>) =<span class="st"> &quot;foo&quot;</span></a>
<a class="sourceLine" id="cb698-1965" title="1965">a</a>
<a class="sourceLine" id="cb698-1966" title="1966"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>)</a>
<a class="sourceLine" id="cb698-1967" title="1967"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>) =<span class="st"> &quot;bar&quot;</span></a>
<a class="sourceLine" id="cb698-1968" title="1968"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>)</a>
<a class="sourceLine" id="cb698-1969" title="1969"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb698-1970" title="1970"><span class="kw">attributes</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">some_meta_data =</span> <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb698-1971" title="1971"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb698-1972" title="1972"><span class="kw">class</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-1973" title="1973"><span class="kw">class</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb698-1974" title="1974"><span class="kw">class</span>(<span class="kw">c</span>(<span class="st">&quot;TRUE&quot;</span>, <span class="st">&quot;FALSE&quot;</span>))</a>
<a class="sourceLine" id="cb698-1975" title="1975">a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb698-1976" title="1976"><span class="kw">class</span>(a) =<span class="st"> &quot;foo&quot;</span></a>
<a class="sourceLine" id="cb698-1977" title="1977">a</a>
<a class="sourceLine" id="cb698-1978" title="1978"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb698-1979" title="1979"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb698-1980" title="1980">print.foo =<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;an object of class foo with length&quot;</span>, <span class="kw">length</span>(x)))</a>
<a class="sourceLine" id="cb698-1981" title="1981"><span class="kw">print</span>(a)</a>
<a class="sourceLine" id="cb698-1982" title="1982"><span class="kw">unclass</span>(a)</a>
<a class="sourceLine" id="cb698-1983" title="1983"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb698-1984" title="1984">p =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))))</a>
<a class="sourceLine" id="cb698-1985" title="1985">p</a>
<a class="sourceLine" id="cb698-1986" title="1986"><span class="kw">unclass</span>(p)</a>
<a class="sourceLine" id="cb698-1987" title="1987">a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span></a>
<a class="sourceLine" id="cb698-1988" title="1988"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb698-1989" title="1989"><span class="kw">attr</span>(a, <span class="st">&quot;dim&quot;</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>) <span class="co"># or: dim(a) = c(2,4)</span></a>
<a class="sourceLine" id="cb698-1990" title="1990"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb698-1991" title="1991">a</a>
<a class="sourceLine" id="cb698-1992" title="1992"><span class="kw">attr</span>(a, <span class="st">&quot;dim&quot;</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="co"># or: dim(a) = c(2,2,2)</span></a>
<a class="sourceLine" id="cb698-1993" title="1993"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb698-1994" title="1994">a</a>
<a class="sourceLine" id="cb698-1995" title="1995">a =<span class="st"> </span><span class="kw">c</span>(<span class="dt">first =</span> <span class="dv">3</span>, <span class="dt">second =</span> <span class="dv">4</span>, <span class="dt">last =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb698-1996" title="1996">a[<span class="st">&quot;second&quot;</span>]</a>
<a class="sourceLine" id="cb698-1997" title="1997"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb698-1998" title="1998">a =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb698-1999" title="1999"><span class="kw">dimnames</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">rows =</span> <span class="kw">c</span>(<span class="st">&quot;row1&quot;</span>, <span class="st">&quot;row2&quot;</span>), <span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">&quot;col1&quot;</span>, <span class="st">&quot;col2&quot;</span>))</a>
<a class="sourceLine" id="cb698-2000" title="2000">a</a>
<a class="sourceLine" id="cb698-2001" title="2001"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb698-2002" title="2002">df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">b =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb698-2003" title="2003"><span class="kw">attributes</span>(df)</a>
<a class="sourceLine" id="cb698-2004" title="2004">f =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb698-2005" title="2005">   a =<span class="st"> </span><span class="kw">create_obj</span>(x) <span class="co"># call some other function</span></a>
<a class="sourceLine" id="cb698-2006" title="2006">   <span class="kw">attributes</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">class =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">meta =</span> <span class="dv">33</span>)</a>
<a class="sourceLine" id="cb698-2007" title="2007">   a</a>
<a class="sourceLine" id="cb698-2008" title="2008">}</a>
<a class="sourceLine" id="cb698-2009" title="2009">f =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb698-2010" title="2010">   a =<span class="st"> </span><span class="kw">create_obj</span>(x) <span class="co"># call some other function</span></a>
<a class="sourceLine" id="cb698-2011" title="2011">   <span class="kw">structure</span>(a, <span class="dt">class =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">meta =</span> <span class="dv">33</span>)</a>
<a class="sourceLine" id="cb698-2012" title="2012">}</a>
<a class="sourceLine" id="cb698-2013" title="2013"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb698-2014" title="2014"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb698-2015" title="2015"></a>
<a class="sourceLine" id="cb698-2016" title="2016">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb698-2017" title="2017">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb698-2018" title="2018"><span class="co">#  collapse = TRUE,</span></a>
<a class="sourceLine" id="cb698-2019" title="2019">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb698-2020" title="2020"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb698-2021" title="2021">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb698-2022" title="2022"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb698-2023" title="2023"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb698-2024" title="2024"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb698-2025" title="2025">)</a>
<a class="sourceLine" id="cb698-2026" title="2026"></a>
<a class="sourceLine" id="cb698-2027" title="2027"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb698-2028" title="2028">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb698-2029" title="2029"></a>
<a class="sourceLine" id="cb698-2030" title="2030"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb698-2031" title="2031"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb698-2032" title="2032"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb698-2033" title="2033">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">72</span>)</a></code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="sp-and-raster.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="r-basics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/97-allcode.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
