<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>All R code in this book | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="All R code in this book | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="All R code in this book | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2021-07-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sp-and-raster.html"/>
<link rel="next" href="r-basics.html"/>
<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a>
<ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#proj"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a>
<ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a>
<ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a>
<ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and Summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a>
<ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a>
<ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a>
<ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#maps-with-ggplot2"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a>
<ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#model-based-inference"><i class="fa fa-check"></i><b>10.3</b> Model-based inference</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation</a>
<ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#atpk"><i class="fa fa-check"></i><b>12.8</b> Area-to-point kriging</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics</a>
<ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing-the-air-quality-dataset"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#multivariable-geostatistics"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data</a>
<ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours</a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours</a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours</a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification</a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation</a>
<ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification</a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures</a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a>
<ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models</a>
<ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions</a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts</a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spatecon_pred"><i class="fa fa-check"></i><b>17.4</b> Predictions</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="sp-and-raster.html"><a href="sp-and-raster.html"><i class="fa fa-check"></i><b>18</b> sp and raster</a>
<ul>
<li class="chapter" data-level="18.1" data-path="sp-and-raster.html"><a href="sp-and-raster.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.1</b> links and differences between sf and sp</a></li>
<li class="chapter" data-level="18.2" data-path="sp-and-raster.html"><a href="sp-and-raster.html#migration-packages"><i class="fa fa-check"></i><b>18.2</b> migration packages</a></li>
<li class="chapter" data-level="18.3" data-path="sp-and-raster.html"><a href="sp-and-raster.html#raster-stars-and-sf"><i class="fa fa-check"></i><b>18.3</b> raster, stars and sf</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a>
<ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="18.4" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i><b>18.4</b> Data structures</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="all-r-code-in-this-book" class="section level1 unnumbered" number="">
<h1>All R code in this book</h1>
<div class="sourceCode" id="cb666"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb666-1"><a href="all-r-code-in-this-book.html#cb666-1" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2"><a href="all-r-code-in-this-book.html#cb666-2" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-3"><a href="all-r-code-in-this-book.html#cb666-3" aria-hidden="true"></a></span>
<span id="cb666-4"><a href="all-r-code-in-this-book.html#cb666-4" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-5"><a href="all-r-code-in-this-book.html#cb666-5" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-6"><a href="all-r-code-in-this-book.html#cb666-6" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-7"><a href="all-r-code-in-this-book.html#cb666-7" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-8"><a href="all-r-code-in-this-book.html#cb666-8" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-9"><a href="all-r-code-in-this-book.html#cb666-9" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-10"><a href="all-r-code-in-this-book.html#cb666-10" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-11"><a href="all-r-code-in-this-book.html#cb666-11" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-12"><a href="all-r-code-in-this-book.html#cb666-12" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-13"><a href="all-r-code-in-this-book.html#cb666-13" aria-hidden="true"></a>)</span>
<span id="cb666-14"><a href="all-r-code-in-this-book.html#cb666-14" aria-hidden="true"></a></span>
<span id="cb666-15"><a href="all-r-code-in-this-book.html#cb666-15" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-16"><a href="all-r-code-in-this-book.html#cb666-16" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-17"><a href="all-r-code-in-this-book.html#cb666-17" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-18"><a href="all-r-code-in-this-book.html#cb666-18" aria-hidden="true"></a></span>
<span id="cb666-19"><a href="all-r-code-in-this-book.html#cb666-19" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-20"><a href="all-r-code-in-this-book.html#cb666-20" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-21"><a href="all-r-code-in-this-book.html#cb666-21" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-22"><a href="all-r-code-in-this-book.html#cb666-22" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-23"><a href="all-r-code-in-this-book.html#cb666-23" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-24"><a href="all-r-code-in-this-book.html#cb666-24" aria-hidden="true"></a>knitr<span class="op">::</span><span class="kw">write_bib</span>(<span class="kw">c</span>(</span>
<span id="cb666-25"><a href="all-r-code-in-this-book.html#cb666-25" aria-hidden="true"></a>  <span class="st">&quot;abind&quot;</span>,</span>
<span id="cb666-26"><a href="all-r-code-in-this-book.html#cb666-26" aria-hidden="true"></a>  <span class="st">&quot;classInt&quot;</span>,</span>
<span id="cb666-27"><a href="all-r-code-in-this-book.html#cb666-27" aria-hidden="true"></a>  <span class="st">&quot;colorspace&quot;</span>,</span>
<span id="cb666-28"><a href="all-r-code-in-this-book.html#cb666-28" aria-hidden="true"></a>  <span class="st">&quot;gdalcubes&quot;</span>,</span>
<span id="cb666-29"><a href="all-r-code-in-this-book.html#cb666-29" aria-hidden="true"></a>  <span class="st">&quot;gstat&quot;</span>,</span>
<span id="cb666-30"><a href="all-r-code-in-this-book.html#cb666-30" aria-hidden="true"></a>  <span class="st">&quot;ggplot2&quot;</span>,</span>
<span id="cb666-31"><a href="all-r-code-in-this-book.html#cb666-31" aria-hidden="true"></a>  <span class="st">&quot;ggspatial&quot;</span>,</span>
<span id="cb666-32"><a href="all-r-code-in-this-book.html#cb666-32" aria-hidden="true"></a>  <span class="st">&quot;lwgeom&quot;</span>,</span>
<span id="cb666-33"><a href="all-r-code-in-this-book.html#cb666-33" aria-hidden="true"></a>  <span class="st">&quot;osmar&quot;</span>, </span>
<span id="cb666-34"><a href="all-r-code-in-this-book.html#cb666-34" aria-hidden="true"></a>  <span class="st">&quot;raster&quot;</span>,</span>
<span id="cb666-35"><a href="all-r-code-in-this-book.html#cb666-35" aria-hidden="true"></a>  <span class="st">&quot;rgee&quot;</span>,</span>
<span id="cb666-36"><a href="all-r-code-in-this-book.html#cb666-36" aria-hidden="true"></a>  <span class="st">&quot;ecmwfr&quot;</span>,</span>
<span id="cb666-37"><a href="all-r-code-in-this-book.html#cb666-37" aria-hidden="true"></a>  <span class="st">&quot;rnaturalearth&quot;</span>,</span>
<span id="cb666-38"><a href="all-r-code-in-this-book.html#cb666-38" aria-hidden="true"></a>  <span class="st">&quot;RColorBrewer&quot;</span>,</span>
<span id="cb666-39"><a href="all-r-code-in-this-book.html#cb666-39" aria-hidden="true"></a>  <span class="st">&quot;raster&quot;</span>,</span>
<span id="cb666-40"><a href="all-r-code-in-this-book.html#cb666-40" aria-hidden="true"></a>  <span class="st">&quot;rstac&quot;</span>,</span>
<span id="cb666-41"><a href="all-r-code-in-this-book.html#cb666-41" aria-hidden="true"></a>  <span class="st">&quot;sf&quot;</span>, </span>
<span id="cb666-42"><a href="all-r-code-in-this-book.html#cb666-42" aria-hidden="true"></a>  <span class="st">&quot;sp&quot;</span>,</span>
<span id="cb666-43"><a href="all-r-code-in-this-book.html#cb666-43" aria-hidden="true"></a>  <span class="st">&quot;spacetime&quot;</span>,</span>
<span id="cb666-44"><a href="all-r-code-in-this-book.html#cb666-44" aria-hidden="true"></a>  <span class="st">&quot;spatstat&quot;</span>, <span class="co">#--&gt;&gt; generates too many authors!! </span><span class="al">FIXME</span><span class="co">: update before submit!</span></span>
<span id="cb666-45"><a href="all-r-code-in-this-book.html#cb666-45" aria-hidden="true"></a>  <span class="st">&quot;spdep&quot;</span>,</span>
<span id="cb666-46"><a href="all-r-code-in-this-book.html#cb666-46" aria-hidden="true"></a>  <span class="st">&quot;splm&quot;</span>,</span>
<span id="cb666-47"><a href="all-r-code-in-this-book.html#cb666-47" aria-hidden="true"></a>  <span class="st">&quot;stars&quot;</span>,</span>
<span id="cb666-48"><a href="all-r-code-in-this-book.html#cb666-48" aria-hidden="true"></a>  <span class="st">&quot;stcos&quot;</span>,</span>
<span id="cb666-49"><a href="all-r-code-in-this-book.html#cb666-49" aria-hidden="true"></a>  <span class="st">&quot;stplanr&quot;</span>, </span>
<span id="cb666-50"><a href="all-r-code-in-this-book.html#cb666-50" aria-hidden="true"></a>  <span class="st">&quot;terra&quot;</span>,</span>
<span id="cb666-51"><a href="all-r-code-in-this-book.html#cb666-51" aria-hidden="true"></a>  <span class="st">&quot;tidyverse&quot;</span>,</span>
<span id="cb666-52"><a href="all-r-code-in-this-book.html#cb666-52" aria-hidden="true"></a>  <span class="st">&quot;tsibble&quot;</span>,</span>
<span id="cb666-53"><a href="all-r-code-in-this-book.html#cb666-53" aria-hidden="true"></a>  <span class="st">&quot;viridis&quot;</span>,</span>
<span id="cb666-54"><a href="all-r-code-in-this-book.html#cb666-54" aria-hidden="true"></a>  <span class="st">&quot;units&quot;</span>,</span>
<span id="cb666-55"><a href="all-r-code-in-this-book.html#cb666-55" aria-hidden="true"></a>  <span class="st">&quot;xts&quot;</span>,</span>
<span id="cb666-56"><a href="all-r-code-in-this-book.html#cb666-56" aria-hidden="true"></a>  <span class="st">&quot;s2&quot;</span>,</span>
<span id="cb666-57"><a href="all-r-code-in-this-book.html#cb666-57" aria-hidden="true"></a>  <span class="st">&quot;tmap&quot;</span>,</span>
<span id="cb666-58"><a href="all-r-code-in-this-book.html#cb666-58" aria-hidden="true"></a>  <span class="st">&quot;mapview&quot;</span></span>
<span id="cb666-59"><a href="all-r-code-in-this-book.html#cb666-59" aria-hidden="true"></a>  ), <span class="st">&quot;packages.bib&quot;</span>, <span class="dt">width =</span> <span class="dv">60</span>)</span>
<span id="cb666-60"><a href="all-r-code-in-this-book.html#cb666-60" aria-hidden="true"></a>The first part of this book introduces concepts of spatial data science,</span>
<span id="cb666-61"><a href="all-r-code-in-this-book.html#cb666-61" aria-hidden="true"></a>and uses R only to generate text output or figures. The R code used <span class="cf">for</span></span>
<span id="cb666-62"><a href="all-r-code-in-this-book.html#cb666-62" aria-hidden="true"></a>this is not shown, as it would distract from the message. The online</span>
<span id="cb666-63"><a href="all-r-code-in-this-book.html#cb666-63" aria-hidden="true"></a>version of this book contains the R sections, which can be unfolded</span>
<span id="cb666-64"><a href="all-r-code-in-this-book.html#cb666-64" aria-hidden="true"></a>on demand and copied into the clipboard <span class="cf">for</span> execution and experimenting.</span>
<span id="cb666-65"><a href="all-r-code-in-this-book.html#cb666-65" aria-hidden="true"></a>The second part of this book explains how the concepts introduced <span class="cf">in</span></span>
<span id="cb666-66"><a href="all-r-code-in-this-book.html#cb666-66" aria-hidden="true"></a>part I are dealt with using R, and deals with basic handling and plotting</span>
<span id="cb666-67"><a href="all-r-code-in-this-book.html#cb666-67" aria-hidden="true"></a>of spatial and spatiotemporal data. Part III is dedicated to statistical</span>
<span id="cb666-68"><a href="all-r-code-in-this-book.html#cb666-68" aria-hidden="true"></a>modelling of spatial data.</span>
<span id="cb666-69"><a href="all-r-code-in-this-book.html#cb666-69" aria-hidden="true"></a>This work is licensed under the</span>
<span id="cb666-70"><a href="all-r-code-in-this-book.html#cb666-70" aria-hidden="true"></a>[Attribution<span class="op">-</span>NonCommercial<span class="op">-</span>NoDerivatives</span>
<span id="cb666-71"><a href="all-r-code-in-this-book.html#cb666-71" aria-hidden="true"></a><span class="fl">4.0</span>](https<span class="op">:</span><span class="er">//</span>creativecommons.org<span class="op">/</span>licenses<span class="op">/</span>by<span class="op">-</span>nc<span class="op">-</span>nd<span class="op">/</span><span class="fl">4.0</span><span class="op">/</span>legalcode)</span>
<span id="cb666-72"><a href="all-r-code-in-this-book.html#cb666-72" aria-hidden="true"></a>International License.</span>
<span id="cb666-73"><a href="all-r-code-in-this-book.html#cb666-73" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-74"><a href="all-r-code-in-this-book.html#cb666-74" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-75"><a href="all-r-code-in-this-book.html#cb666-75" aria-hidden="true"></a></span>
<span id="cb666-76"><a href="all-r-code-in-this-book.html#cb666-76" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-77"><a href="all-r-code-in-this-book.html#cb666-77" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-78"><a href="all-r-code-in-this-book.html#cb666-78" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-79"><a href="all-r-code-in-this-book.html#cb666-79" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-80"><a href="all-r-code-in-this-book.html#cb666-80" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-81"><a href="all-r-code-in-this-book.html#cb666-81" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-82"><a href="all-r-code-in-this-book.html#cb666-82" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-83"><a href="all-r-code-in-this-book.html#cb666-83" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-84"><a href="all-r-code-in-this-book.html#cb666-84" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-85"><a href="all-r-code-in-this-book.html#cb666-85" aria-hidden="true"></a>)</span>
<span id="cb666-86"><a href="all-r-code-in-this-book.html#cb666-86" aria-hidden="true"></a></span>
<span id="cb666-87"><a href="all-r-code-in-this-book.html#cb666-87" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-88"><a href="all-r-code-in-this-book.html#cb666-88" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-89"><a href="all-r-code-in-this-book.html#cb666-89" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-90"><a href="all-r-code-in-this-book.html#cb666-90" aria-hidden="true"></a></span>
<span id="cb666-91"><a href="all-r-code-in-this-book.html#cb666-91" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-92"><a href="all-r-code-in-this-book.html#cb666-92" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-93"><a href="all-r-code-in-this-book.html#cb666-93" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-94"><a href="all-r-code-in-this-book.html#cb666-94" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-95"><a href="all-r-code-in-this-book.html#cb666-95" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-96"><a href="all-r-code-in-this-book.html#cb666-96" aria-hidden="true"></a>Text introducing Part I</span>
<span id="cb666-97"><a href="all-r-code-in-this-book.html#cb666-97" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb666-98"><a href="all-r-code-in-this-book.html#cb666-98" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-99"><a href="all-r-code-in-this-book.html#cb666-99" aria-hidden="true"></a><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-100"><a href="all-r-code-in-this-book.html#cb666-100" aria-hidden="true"></a><span class="st">    </span><span class="kw">read_sf</span>() -&gt;<span class="st"> </span>nc</span>
<span id="cb666-101"><a href="all-r-code-in-this-book.html#cb666-101" aria-hidden="true"></a>nc<span class="fl">.32119</span> &lt;-<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">32119</span>)</span>
<span id="cb666-102"><a href="all-r-code-in-this-book.html#cb666-102" aria-hidden="true"></a>nc<span class="fl">.32119</span> <span class="op">%&gt;%</span></span>
<span id="cb666-103"><a href="all-r-code-in-this-book.html#cb666-103" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(BIR74) <span class="op">%&gt;%</span></span>
<span id="cb666-104"><a href="all-r-code-in-this-book.html#cb666-104" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>(<span class="dt">graticule =</span> <span class="ot">TRUE</span>, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-105"><a href="all-r-code-in-this-book.html#cb666-105" aria-hidden="true"></a>nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(AREA, BIR74, SID74) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="dv">3</span>)</span>
<span id="cb666-106"><a href="all-r-code-in-this-book.html#cb666-106" aria-hidden="true"></a>year_labels =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span> =<span class="st"> &quot;1974 - 1978&quot;</span>, <span class="st">&quot;SID79&quot;</span> =<span class="st"> &quot;1979 - 1984&quot;</span>)</span>
<span id="cb666-107"><a href="all-r-code-in-this-book.html#cb666-107" aria-hidden="true"></a>nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(VAR, SID, <span class="op">-</span>geom) -&gt;<span class="st"> </span>nc2</span>
<span id="cb666-108"><a href="all-r-code-in-this-book.html#cb666-108" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc2, <span class="kw">aes</span>(<span class="dt">fill =</span> SID)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-109"><a href="all-r-code-in-this-book.html#cb666-109" aria-hidden="true"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>VAR, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> <span class="kw">labeller</span>(<span class="dt">VAR =</span> year_labels)) <span class="op">+</span></span>
<span id="cb666-110"><a href="all-r-code-in-this-book.html#cb666-110" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">34</span><span class="op">:</span><span class="dv">36</span>) <span class="op">+</span></span>
<span id="cb666-111"><a href="all-r-code-in-this-book.html#cb666-111" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>)) <span class="op">+</span></span>
<span id="cb666-112"><a href="all-r-code-in-this-book.html#cb666-112" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>))</span>
<span id="cb666-113"><a href="all-r-code-in-this-book.html#cb666-113" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(mapview))</span>
<span id="cb666-114"><a href="all-r-code-in-this-book.html#cb666-114" aria-hidden="true"></a><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-115"><a href="all-r-code-in-this-book.html#cb666-115" aria-hidden="true"></a>nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mapview</span>(<span class="dt">zcol =</span> <span class="st">&quot;BIR74&quot;</span>, <span class="dt">legend =</span> <span class="ot">TRUE</span>, <span class="dt">col.regions =</span> sf.colors)</span>
<span id="cb666-116"><a href="all-r-code-in-this-book.html#cb666-116" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-117"><a href="all-r-code-in-this-book.html#cb666-117" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb666-118"><a href="all-r-code-in-this-book.html#cb666-118" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>))</span>
<span id="cb666-119"><a href="all-r-code-in-this-book.html#cb666-119" aria-hidden="true"></a>tif &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb666-120"><a href="all-r-code-in-this-book.html#cb666-120" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">read_stars</span>(tif)[,,,<span class="dv">1</span>]</span>
<span id="cb666-121"><a href="all-r-code-in-this-book.html#cb666-121" aria-hidden="true"></a><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(a)&quot;</span>)</span>
<span id="cb666-122"><a href="all-r-code-in-this-book.html#cb666-122" aria-hidden="true"></a><span class="kw">image</span>(x[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>], <span class="dt">text_values =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>, <span class="dt">main =</span> <span class="st">&quot;(b)&quot;</span>)</span>
<span id="cb666-123"><a href="all-r-code-in-this-book.html#cb666-123" aria-hidden="true"></a><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(c)&quot;</span>)</span>
<span id="cb666-124"><a href="all-r-code-in-this-book.html#cb666-124" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">131</span>)</span>
<span id="cb666-125"><a href="all-r-code-in-this-book.html#cb666-125" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">st_sample</span>(<span class="kw">st_as_sfc</span>(<span class="kw">st_bbox</span>(x)), <span class="dv">3</span>)</span>
<span id="cb666-126"><a href="all-r-code-in-this-book.html#cb666-126" aria-hidden="true"></a><span class="kw">plot</span>(pts, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</span>
<span id="cb666-127"><a href="all-r-code-in-this-book.html#cb666-127" aria-hidden="true"></a><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(d)&quot;</span>)</span>
<span id="cb666-128"><a href="all-r-code-in-this-book.html#cb666-128" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_buffer</span>(pts, <span class="dv">500</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-129"><a href="all-r-code-in-this-book.html#cb666-129" aria-hidden="true"></a><span class="kw">st_extract</span>(x, pts)</span>
<span id="cb666-130"><a href="all-r-code-in-this-book.html#cb666-130" aria-hidden="true"></a><span class="kw">aggregate</span>(x, <span class="kw">st_buffer</span>(pts, <span class="dv">500</span>), <span class="dt">FUN =</span> mean) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sf</span>()</span>
<span id="cb666-131"><a href="all-r-code-in-this-book.html#cb666-131" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_rasterize</span>(nc[<span class="st">&quot;BIR74&quot;</span>], <span class="dt">dx =</span> <span class="fl">0.1</span>), <span class="dt">col =</span><span class="kw">sf.colors</span>(), <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>)</span>
<span id="cb666-132"><a href="all-r-code-in-this-book.html#cb666-132" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span></span>
<span id="cb666-133"><a href="all-r-code-in-this-book.html#cb666-133" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span></span>
<span id="cb666-134"><a href="all-r-code-in-this-book.html#cb666-134" aria-hidden="true"></a>d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">.raster =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</span>
<span id="cb666-135"><a href="all-r-code-in-this-book.html#cb666-135" aria-hidden="true"></a>m =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">20</span>),<span class="dv">5</span>,<span class="dv">4</span>)</span>
<span id="cb666-136"><a href="all-r-code-in-this-book.html#cb666-136" aria-hidden="true"></a>r1 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</span>
<span id="cb666-137"><a href="all-r-code-in-this-book.html#cb666-137" aria-hidden="true"></a></span>
<span id="cb666-138"><a href="all-r-code-in-this-book.html#cb666-138" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>)</span>
<span id="cb666-139"><a href="all-r-code-in-this-book.html#cb666-139" aria-hidden="true"></a>r<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">-0.2</span>)</span>
<span id="cb666-140"><a href="all-r-code-in-this-book.html#cb666-140" aria-hidden="true"></a><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>) =<span class="st"> </span>r</span>
<span id="cb666-141"><a href="all-r-code-in-this-book.html#cb666-141" aria-hidden="true"></a>r2 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</span>
<span id="cb666-142"><a href="all-r-code-in-this-book.html#cb666-142" aria-hidden="true"></a></span>
<span id="cb666-143"><a href="all-r-code-in-this-book.html#cb666-143" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>)</span>
<span id="cb666-144"><a href="all-r-code-in-this-book.html#cb666-144" aria-hidden="true"></a>r<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">-0.3</span>)</span>
<span id="cb666-145"><a href="all-r-code-in-this-book.html#cb666-145" aria-hidden="true"></a><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>) =<span class="st"> </span>r</span>
<span id="cb666-146"><a href="all-r-code-in-this-book.html#cb666-146" aria-hidden="true"></a>r3 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</span>
<span id="cb666-147"><a href="all-r-code-in-this-book.html#cb666-147" aria-hidden="true"></a></span>
<span id="cb666-148"><a href="all-r-code-in-this-book.html#cb666-148" aria-hidden="true"></a>x =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="fl">3.5</span>, <span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb666-149"><a href="all-r-code-in-this-book.html#cb666-149" aria-hidden="true"></a>y =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">3</span>, <span class="fl">3.5</span>)</span>
<span id="cb666-150"><a href="all-r-code-in-this-book.html#cb666-150" aria-hidden="true"></a>d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">.raster =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</span>
<span id="cb666-151"><a href="all-r-code-in-this-book.html#cb666-151" aria-hidden="true"></a>r4 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</span>
<span id="cb666-152"><a href="all-r-code-in-this-book.html#cb666-152" aria-hidden="true"></a></span>
<span id="cb666-153"><a href="all-r-code-in-this-book.html#cb666-153" aria-hidden="true"></a>grd =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>), <span class="dt">offset =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">130</span>,<span class="dv">10</span>), <span class="dt">n=</span> <span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">5</span>), <span class="dt">crs=</span><span class="kw">st_crs</span>(<span class="dv">4326</span>))</span>
<span id="cb666-154"><a href="all-r-code-in-this-book.html#cb666-154" aria-hidden="true"></a>r5 =<span class="st"> </span><span class="kw">st_transform</span>(grd, <span class="st">&quot;+proj=laea +lon_0=-70 +lat_0=35&quot;</span>)</span>
<span id="cb666-155"><a href="all-r-code-in-this-book.html#cb666-155" aria-hidden="true"></a></span>
<span id="cb666-156"><a href="all-r-code-in-this-book.html#cb666-156" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="fl">1.1</span>, <span class="dv">1</span>))</span>
<span id="cb666-157"><a href="all-r-code-in-this-book.html#cb666-157" aria-hidden="true"></a>r1 =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>), <span class="dt">offset =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb666-158"><a href="all-r-code-in-this-book.html#cb666-158" aria-hidden="true"></a><span class="kw">plot</span>(r1, <span class="dt">main =</span> <span class="st">&quot;regular&quot;</span>)</span>
<span id="cb666-159"><a href="all-r-code-in-this-book.html#cb666-159" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r2)), <span class="dt">main =</span> <span class="st">&quot;rotated&quot;</span>)</span>
<span id="cb666-160"><a href="all-r-code-in-this-book.html#cb666-160" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r3)), <span class="dt">main =</span> <span class="st">&quot;sheared&quot;</span>)</span>
<span id="cb666-161"><a href="all-r-code-in-this-book.html#cb666-161" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r4, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)), <span class="dt">main =</span> <span class="st">&quot;rectilinear&quot;</span>)</span>
<span id="cb666-162"><a href="all-r-code-in-this-book.html#cb666-162" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>((r5)), <span class="dt">main =</span> <span class="st">&quot;curvilinear&quot;</span>)</span>
<span id="cb666-163"><a href="all-r-code-in-this-book.html#cb666-163" aria-hidden="true"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/sf_deps.png&quot;</span>)</span>
<span id="cb666-164"><a href="all-r-code-in-this-book.html#cb666-164" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-165"><a href="all-r-code-in-this-book.html#cb666-165" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-166"><a href="all-r-code-in-this-book.html#cb666-166" aria-hidden="true"></a></span>
<span id="cb666-167"><a href="all-r-code-in-this-book.html#cb666-167" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-168"><a href="all-r-code-in-this-book.html#cb666-168" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-169"><a href="all-r-code-in-this-book.html#cb666-169" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-170"><a href="all-r-code-in-this-book.html#cb666-170" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-171"><a href="all-r-code-in-this-book.html#cb666-171" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-172"><a href="all-r-code-in-this-book.html#cb666-172" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-173"><a href="all-r-code-in-this-book.html#cb666-173" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-174"><a href="all-r-code-in-this-book.html#cb666-174" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-175"><a href="all-r-code-in-this-book.html#cb666-175" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-176"><a href="all-r-code-in-this-book.html#cb666-176" aria-hidden="true"></a>)</span>
<span id="cb666-177"><a href="all-r-code-in-this-book.html#cb666-177" aria-hidden="true"></a></span>
<span id="cb666-178"><a href="all-r-code-in-this-book.html#cb666-178" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-179"><a href="all-r-code-in-this-book.html#cb666-179" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-180"><a href="all-r-code-in-this-book.html#cb666-180" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-181"><a href="all-r-code-in-this-book.html#cb666-181" aria-hidden="true"></a></span>
<span id="cb666-182"><a href="all-r-code-in-this-book.html#cb666-182" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-183"><a href="all-r-code-in-this-book.html#cb666-183" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-184"><a href="all-r-code-in-this-book.html#cb666-184" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-185"><a href="all-r-code-in-this-book.html#cb666-185" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-186"><a href="all-r-code-in-this-book.html#cb666-186" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-187"><a href="all-r-code-in-this-book.html#cb666-187" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb666-188"><a href="all-r-code-in-this-book.html#cb666-188" aria-hidden="true"></a><span class="kw">plot</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-189"><a href="all-r-code-in-this-book.html#cb666-189" aria-hidden="true"></a><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">6</span>)</span>
<span id="cb666-190"><a href="all-r-code-in-this-book.html#cb666-190" aria-hidden="true"></a><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">-6</span><span class="op">:</span><span class="dv">6</span>)</span>
<span id="cb666-191"><a href="all-r-code-in-this-book.html#cb666-191" aria-hidden="true"></a>xd =<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</span>
<span id="cb666-192"><a href="all-r-code-in-this-book.html#cb666-192" aria-hidden="true"></a><span class="kw">lines</span>(xd, <span class="kw">sqrt</span>(<span class="dv">25</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-193"><a href="all-r-code-in-this-book.html#cb666-193" aria-hidden="true"></a><span class="kw">lines</span>(xd, <span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">25</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-194"><a href="all-r-code-in-this-book.html#cb666-194" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</span>
<span id="cb666-195"><a href="all-r-code-in-this-book.html#cb666-195" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="dt">label =</span> <span class="st">&quot;r&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-196"><a href="all-r-code-in-this-book.html#cb666-196" aria-hidden="true"></a>xd =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">5</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</span>
<span id="cb666-197"><a href="all-r-code-in-this-book.html#cb666-197" aria-hidden="true"></a><span class="kw">lines</span>(xd, <span class="kw">sqrt</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-198"><a href="all-r-code-in-this-book.html#cb666-198" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;phi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-199"><a href="all-r-code-in-this-book.html#cb666-199" aria-hidden="true"></a><span class="kw">lines</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</span>
<span id="cb666-200"><a href="all-r-code-in-this-book.html#cb666-200" aria-hidden="true"></a><span class="kw">lines</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</span>
<span id="cb666-201"><a href="all-r-code-in-this-book.html#cb666-201" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.3</span>, <span class="fl">0.3</span>, <span class="dt">label =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</span>
<span id="cb666-202"><a href="all-r-code-in-this-book.html#cb666-202" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">0.3</span>, <span class="fl">4.3</span>, <span class="dt">label =</span> <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</span>
<span id="cb666-203"><a href="all-r-code-in-this-book.html#cb666-203" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(sf))</span>
<span id="cb666-204"><a href="all-r-code-in-this-book.html#cb666-204" aria-hidden="true"></a>e =<span class="st"> </span><span class="kw">cbind</span>(<span class="op">-</span><span class="dv">90</span><span class="op">:</span><span class="dv">90</span>,<span class="dv">0</span>) <span class="co"># equator</span></span>
<span id="cb666-205"><a href="all-r-code-in-this-book.html#cb666-205" aria-hidden="true"></a>f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">0</span>, <span class="dv">-90</span><span class="op">:</span><span class="dv">90</span>)) <span class="co"># 0/antimerid.</span></span>
<span id="cb666-206"><a href="all-r-code-in-this-book.html#cb666-206" aria-hidden="true"></a>f2 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">90</span>, <span class="dv">-90</span><span class="op">:</span><span class="dv">90</span>), <span class="kw">cbind</span>(<span class="dv">270</span>, <span class="dv">90</span><span class="op">:-</span><span class="dv">90</span>))<span class="co"># +/- 90</span></span>
<span id="cb666-207"><a href="all-r-code-in-this-book.html#cb666-207" aria-hidden="true"></a>eq =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(e), <span class="kw">st_linestring</span>(f1), <span class="kw">st_linestring</span>(f2), <span class="dt">crs=</span><span class="dv">4326</span>)</span>
<span id="cb666-208"><a href="all-r-code-in-this-book.html#cb666-208" aria-hidden="true"></a></span>
<span id="cb666-209"><a href="all-r-code-in-this-book.html#cb666-209" aria-hidden="true"></a>geoc =<span class="st"> </span><span class="kw">st_transform</span>(eq, <span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-210"><a href="all-r-code-in-this-book.html#cb666-210" aria-hidden="true"></a>cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]], <span class="ot">NA</span>, geoc[[<span class="dv">2</span>]], <span class="ot">NA</span>, geoc[[<span class="dv">3</span>]])</span>
<span id="cb666-211"><a href="all-r-code-in-this-book.html#cb666-211" aria-hidden="true"></a>from3d =<span class="st"> </span><span class="cf">function</span>(x, offset, maxz, minz) {</span>
<span id="cb666-212"><a href="all-r-code-in-this-book.html#cb666-212" aria-hidden="true"></a>    x =<span class="st"> </span>x[,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>)] <span class="op">+</span><span class="st"> </span>offset <span class="co"># move to y right, x up, z backw</span></span>
<span id="cb666-213"><a href="all-r-code-in-this-book.html#cb666-213" aria-hidden="true"></a>    x[,<span class="dv">2</span>] =<span class="st"> </span>x[,<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>maxz      <span class="co"># shift y to left</span></span>
<span id="cb666-214"><a href="all-r-code-in-this-book.html#cb666-214" aria-hidden="true"></a>    d =<span class="st"> </span>maxz</span>
<span id="cb666-215"><a href="all-r-code-in-this-book.html#cb666-215" aria-hidden="true"></a>    z =<span class="st"> </span>x[,<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>minz <span class="op">+</span><span class="st"> </span>offset</span>
<span id="cb666-216"><a href="all-r-code-in-this-book.html#cb666-216" aria-hidden="true"></a>    x[,<span class="dv">1</span>] =<span class="st"> </span>x[,<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>(d<span class="op">/</span>z)</span>
<span id="cb666-217"><a href="all-r-code-in-this-book.html#cb666-217" aria-hidden="true"></a>    x[,<span class="dv">2</span>] =<span class="st"> </span>x[,<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>(d<span class="op">/</span>z)</span>
<span id="cb666-218"><a href="all-r-code-in-this-book.html#cb666-218" aria-hidden="true"></a>    x[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</span>
<span id="cb666-219"><a href="all-r-code-in-this-book.html#cb666-219" aria-hidden="true"></a>}</span>
<span id="cb666-220"><a href="all-r-code-in-this-book.html#cb666-220" aria-hidden="true"></a>maxz =<span class="st"> </span><span class="kw">max</span>(cc[,<span class="dv">3</span>], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-221"><a href="all-r-code-in-this-book.html#cb666-221" aria-hidden="true"></a>minz =<span class="st"> </span><span class="kw">min</span>(cc[,<span class="dv">3</span>], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-222"><a href="all-r-code-in-this-book.html#cb666-222" aria-hidden="true"></a>offset =<span class="st"> </span><span class="fl">3e7</span></span>
<span id="cb666-223"><a href="all-r-code-in-this-book.html#cb666-223" aria-hidden="true"></a>circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</span>
<span id="cb666-224"><a href="all-r-code-in-this-book.html#cb666-224" aria-hidden="true"></a>mx =<span class="st"> </span><span class="kw">max</span>(cc, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.1</span></span>
<span id="cb666-225"><a href="all-r-code-in-this-book.html#cb666-225" aria-hidden="true"></a>x =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(mx, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb666-226"><a href="all-r-code-in-this-book.html#cb666-226" aria-hidden="true"></a>y =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, mx, <span class="dv">0</span>))</span>
<span id="cb666-227"><a href="all-r-code-in-this-book.html#cb666-227" aria-hidden="true"></a>z =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, mx))</span>
<span id="cb666-228"><a href="all-r-code-in-this-book.html#cb666-228" aria-hidden="true"></a>ll =<span class="st"> </span><span class="kw">rbind</span>(x, <span class="ot">NA</span>, y, <span class="ot">NA</span>, z)</span>
<span id="cb666-229"><a href="all-r-code-in-this-book.html#cb666-229" aria-hidden="true"></a>l0 =<span class="st">  </span><span class="kw">from3d</span>(ll, offset, maxz, minz)</span>
<span id="cb666-230"><a href="all-r-code-in-this-book.html#cb666-230" aria-hidden="true"></a>mx =<span class="st"> </span><span class="kw">max</span>(cc, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.2</span></span>
<span id="cb666-231"><a href="all-r-code-in-this-book.html#cb666-231" aria-hidden="true"></a>x =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(mx, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb666-232"><a href="all-r-code-in-this-book.html#cb666-232" aria-hidden="true"></a>y =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, mx, <span class="dv">0</span>))</span>
<span id="cb666-233"><a href="all-r-code-in-this-book.html#cb666-233" aria-hidden="true"></a>z =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, mx))</span>
<span id="cb666-234"><a href="all-r-code-in-this-book.html#cb666-234" aria-hidden="true"></a>ll =<span class="st"> </span><span class="kw">rbind</span>(x, <span class="ot">NA</span>, y, <span class="ot">NA</span>, z)</span>
<span id="cb666-235"><a href="all-r-code-in-this-book.html#cb666-235" aria-hidden="true"></a>l =<span class="st">  </span><span class="kw">from3d</span>(ll, offset, maxz, minz)</span>
<span id="cb666-236"><a href="all-r-code-in-this-book.html#cb666-236" aria-hidden="true"></a></span>
<span id="cb666-237"><a href="all-r-code-in-this-book.html#cb666-237" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb666-238"><a href="all-r-code-in-this-book.html#cb666-238" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb666-239"><a href="all-r-code-in-this-book.html#cb666-239" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-240"><a href="all-r-code-in-this-book.html#cb666-240" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">1</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">3607103</span><span class="op">*</span><span class="fl">1.02</span>), </span>
<span id="cb666-241"><a href="all-r-code-in-this-book.html#cb666-241" aria-hidden="true"></a>                        <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">2</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2873898</span><span class="op">*</span><span class="fl">1.1</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-242"><a href="all-r-code-in-this-book.html#cb666-242" aria-hidden="true"></a><span class="kw">lines</span>(circ)</span>
<span id="cb666-243"><a href="all-r-code-in-this-book.html#cb666-243" aria-hidden="true"></a><span class="kw">lines</span>(l0)</span>
<span id="cb666-244"><a href="all-r-code-in-this-book.html#cb666-244" aria-hidden="true"></a><span class="kw">text</span>(l[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">8</span>),], <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;z&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-245"><a href="all-r-code-in-this-book.html#cb666-245" aria-hidden="true"></a><span class="co"># add POINT(60 47)</span></span>
<span id="cb666-246"><a href="all-r-code-in-this-book.html#cb666-246" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-247"><a href="all-r-code-in-this-book.html#cb666-247" aria-hidden="true"></a>p =<span class="st"> </span>p[[<span class="dv">1</span>]]</span>
<span id="cb666-248"><a href="all-r-code-in-this-book.html#cb666-248" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],p[<span class="dv">2</span>]))</span>
<span id="cb666-249"><a href="all-r-code-in-this-book.html#cb666-249" aria-hidden="true"></a>ptsl =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</span>
<span id="cb666-250"><a href="all-r-code-in-this-book.html#cb666-250" aria-hidden="true"></a><span class="kw">lines</span>(ptsl, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-251"><a href="all-r-code-in-this-book.html#cb666-251" aria-hidden="true"></a><span class="kw">points</span>(ptsl[<span class="dv">4</span>,<span class="dv">1</span>], ptsl[<span class="dv">4</span>,<span class="dv">2</span>], <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-252"><a href="all-r-code-in-this-book.html#cb666-252" aria-hidden="true"></a></span>
<span id="cb666-253"><a href="all-r-code-in-this-book.html#cb666-253" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-254"><a href="all-r-code-in-this-book.html#cb666-254" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">1</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">3607103</span><span class="op">*</span><span class="fl">1.02</span>), </span>
<span id="cb666-255"><a href="all-r-code-in-this-book.html#cb666-255" aria-hidden="true"></a>                        <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">2</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2873898</span><span class="op">*</span><span class="fl">1.1</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-256"><a href="all-r-code-in-this-book.html#cb666-256" aria-hidden="true"></a><span class="kw">lines</span>(circ)</span>
<span id="cb666-257"><a href="all-r-code-in-this-book.html#cb666-257" aria-hidden="true"></a></span>
<span id="cb666-258"><a href="all-r-code-in-this-book.html#cb666-258" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-259"><a href="all-r-code-in-this-book.html#cb666-259" aria-hidden="true"></a>p =<span class="st"> </span>p[[<span class="dv">1</span>]]</span>
<span id="cb666-260"><a href="all-r-code-in-this-book.html#cb666-260" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],p[<span class="dv">3</span>]))</span>
<span id="cb666-261"><a href="all-r-code-in-this-book.html#cb666-261" aria-hidden="true"></a>pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</span>
<span id="cb666-262"><a href="all-r-code-in-this-book.html#cb666-262" aria-hidden="true"></a><span class="kw">lines</span>(pt)</span>
<span id="cb666-263"><a href="all-r-code-in-this-book.html#cb666-263" aria-hidden="true"></a><span class="kw">points</span>(pt[<span class="dv">2</span>,<span class="dv">1</span>], pt[<span class="dv">2</span>,<span class="dv">2</span>], <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-264"><a href="all-r-code-in-this-book.html#cb666-264" aria-hidden="true"></a></span>
<span id="cb666-265"><a href="all-r-code-in-this-book.html#cb666-265" aria-hidden="true"></a>p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-266"><a href="all-r-code-in-this-book.html#cb666-266" aria-hidden="true"></a>p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</span>
<span id="cb666-267"><a href="all-r-code-in-this-book.html#cb666-267" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</span>
<span id="cb666-268"><a href="all-r-code-in-this-book.html#cb666-268" aria-hidden="true"></a>pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</span>
<span id="cb666-269"><a href="all-r-code-in-this-book.html#cb666-269" aria-hidden="true"></a><span class="kw">lines</span>(pt)</span>
<span id="cb666-270"><a href="all-r-code-in-this-book.html#cb666-270" aria-hidden="true"></a></span>
<span id="cb666-271"><a href="all-r-code-in-this-book.html#cb666-271" aria-hidden="true"></a>p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(0 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-272"><a href="all-r-code-in-this-book.html#cb666-272" aria-hidden="true"></a>p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</span>
<span id="cb666-273"><a href="all-r-code-in-this-book.html#cb666-273" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</span>
<span id="cb666-274"><a href="all-r-code-in-this-book.html#cb666-274" aria-hidden="true"></a>pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</span>
<span id="cb666-275"><a href="all-r-code-in-this-book.html#cb666-275" aria-hidden="true"></a><span class="kw">lines</span>(pt)</span>
<span id="cb666-276"><a href="all-r-code-in-this-book.html#cb666-276" aria-hidden="true"></a></span>
<span id="cb666-277"><a href="all-r-code-in-this-book.html#cb666-277" aria-hidden="true"></a>p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(0 90)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-278"><a href="all-r-code-in-this-book.html#cb666-278" aria-hidden="true"></a>p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</span>
<span id="cb666-279"><a href="all-r-code-in-this-book.html#cb666-279" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</span>
<span id="cb666-280"><a href="all-r-code-in-this-book.html#cb666-280" aria-hidden="true"></a>pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</span>
<span id="cb666-281"><a href="all-r-code-in-this-book.html#cb666-281" aria-hidden="true"></a><span class="kw">lines</span>(pt, <span class="dt">lty =</span> <span class="dv">2</span>)</span>
<span id="cb666-282"><a href="all-r-code-in-this-book.html#cb666-282" aria-hidden="true"></a></span>
<span id="cb666-283"><a href="all-r-code-in-this-book.html#cb666-283" aria-hidden="true"></a>p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(90 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-284"><a href="all-r-code-in-this-book.html#cb666-284" aria-hidden="true"></a>p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</span>
<span id="cb666-285"><a href="all-r-code-in-this-book.html#cb666-285" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</span>
<span id="cb666-286"><a href="all-r-code-in-this-book.html#cb666-286" aria-hidden="true"></a>pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</span>
<span id="cb666-287"><a href="all-r-code-in-this-book.html#cb666-287" aria-hidden="true"></a><span class="kw">lines</span>(pt, <span class="dt">lty =</span> <span class="dv">2</span>)</span>
<span id="cb666-288"><a href="all-r-code-in-this-book.html#cb666-288" aria-hidden="true"></a></span>
<span id="cb666-289"><a href="all-r-code-in-this-book.html#cb666-289" aria-hidden="true"></a>f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">60</span>, <span class="dv">0</span>))</span>
<span id="cb666-290"><a href="all-r-code-in-this-book.html#cb666-290" aria-hidden="true"></a>arc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(f1), <span class="dt">crs=</span><span class="dv">4326</span>)</span>
<span id="cb666-291"><a href="all-r-code-in-this-book.html#cb666-291" aria-hidden="true"></a>geoc =<span class="st"> </span><span class="kw">st_transform</span>(arc, <span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-292"><a href="all-r-code-in-this-book.html#cb666-292" aria-hidden="true"></a>cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]])</span>
<span id="cb666-293"><a href="all-r-code-in-this-book.html#cb666-293" aria-hidden="true"></a>circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</span>
<span id="cb666-294"><a href="all-r-code-in-this-book.html#cb666-294" aria-hidden="true"></a><span class="kw">lines</span>(circ, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</span>
<span id="cb666-295"><a href="all-r-code-in-this-book.html#cb666-295" aria-hidden="true"></a></span>
<span id="cb666-296"><a href="all-r-code-in-this-book.html#cb666-296" aria-hidden="true"></a>f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">60</span>, <span class="dv">0</span><span class="op">:</span><span class="dv">47</span>))</span>
<span id="cb666-297"><a href="all-r-code-in-this-book.html#cb666-297" aria-hidden="true"></a>arc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(f1), <span class="dt">crs=</span><span class="dv">4326</span>)</span>
<span id="cb666-298"><a href="all-r-code-in-this-book.html#cb666-298" aria-hidden="true"></a>geoc =<span class="st"> </span><span class="kw">st_transform</span>(arc, <span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-299"><a href="all-r-code-in-this-book.html#cb666-299" aria-hidden="true"></a>cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]])</span>
<span id="cb666-300"><a href="all-r-code-in-this-book.html#cb666-300" aria-hidden="true"></a>circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</span>
<span id="cb666-301"><a href="all-r-code-in-this-book.html#cb666-301" aria-hidden="true"></a><span class="kw">lines</span>(circ, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</span>
<span id="cb666-302"><a href="all-r-code-in-this-book.html#cb666-302" aria-hidden="true"></a></span>
<span id="cb666-303"><a href="all-r-code-in-this-book.html#cb666-303" aria-hidden="true"></a><span class="kw">text</span>(pt[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span><span class="dv">100000</span>, pt[<span class="dv">1</span>,<span class="dv">2</span>]<span class="op">+</span><span class="dv">50000</span>, <span class="dt">labels =</span> <span class="kw">expression</span>(phi), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>) <span class="co"># lat</span></span>
<span id="cb666-304"><a href="all-r-code-in-this-book.html#cb666-304" aria-hidden="true"></a><span class="kw">text</span>(pt[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span><span class="dv">20000</span>, pt[<span class="dv">1</span>,<span class="dv">2</span>]<span class="op">-</span><span class="dv">50000</span>, <span class="dt">labels =</span> <span class="kw">expression</span>(lambda), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>) <span class="co"># lng</span></span>
<span id="cb666-305"><a href="all-r-code-in-this-book.html#cb666-305" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb666-306"><a href="all-r-code-in-this-book.html#cb666-306" aria-hidden="true"></a>p[[<span class="dv">1</span>]]</span>
<span id="cb666-307"><a href="all-r-code-in-this-book.html#cb666-307" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-308"><a href="all-r-code-in-this-book.html#cb666-308" aria-hidden="true"></a>p[[<span class="dv">1</span>]]</span>
<span id="cb666-309"><a href="all-r-code-in-this-book.html#cb666-309" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb666-310"><a href="all-r-code-in-this-book.html#cb666-310" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">4</span></span>
<span id="cb666-311"><a href="all-r-code-in-this-book.html#cb666-311" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">48</span>)</span>
<span id="cb666-312"><a href="all-r-code-in-this-book.html#cb666-312" aria-hidden="true"></a><span class="kw">plot</span>(x, y, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>,<span class="dv">8</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-313"><a href="all-r-code-in-this-book.html#cb666-313" aria-hidden="true"></a><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">9</span>)</span>
<span id="cb666-314"><a href="all-r-code-in-this-book.html#cb666-314" aria-hidden="true"></a><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">-5</span><span class="op">:</span><span class="dv">5</span>)</span>
<span id="cb666-315"><a href="all-r-code-in-this-book.html#cb666-315" aria-hidden="true"></a>xd =<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">8</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</span>
<span id="cb666-316"><a href="all-r-code-in-this-book.html#cb666-316" aria-hidden="true"></a><span class="kw">lines</span>(xd, <span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">64</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-317"><a href="all-r-code-in-this-book.html#cb666-317" aria-hidden="true"></a><span class="kw">lines</span>(xd, <span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">64</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-318"><a href="all-r-code-in-this-book.html#cb666-318" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, x, y, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</span>
<span id="cb666-319"><a href="all-r-code-in-this-book.html#cb666-319" aria-hidden="true"></a>b =<span class="st"> </span>(x <span class="op">*</span><span class="st"> </span><span class="dv">25</span>) <span class="op">/</span><span class="st"> </span>(<span class="op">-</span>y <span class="op">*</span><span class="st"> </span><span class="dv">64</span>)</span>
<span id="cb666-320"><a href="all-r-code-in-this-book.html#cb666-320" aria-hidden="true"></a>a =<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>b</span>
<span id="cb666-321"><a href="all-r-code-in-this-book.html#cb666-321" aria-hidden="true"></a><span class="kw">abline</span>(a, b, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-322"><a href="all-r-code-in-this-book.html#cb666-322" aria-hidden="true"></a>b =<span class="st"> </span><span class="dv">-1</span><span class="op">/</span>b</span>
<span id="cb666-323"><a href="all-r-code-in-this-book.html#cb666-323" aria-hidden="true"></a>x0 =<span class="st"> </span>x <span class="op">-</span><span class="st"> </span>y <span class="op">/</span><span class="st"> </span>b</span>
<span id="cb666-324"><a href="all-r-code-in-this-book.html#cb666-324" aria-hidden="true"></a><span class="kw">arrows</span>(x0, <span class="dv">0</span>, x, y, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</span>
<span id="cb666-325"><a href="all-r-code-in-this-book.html#cb666-325" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;psi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-326"><a href="all-r-code-in-this-book.html#cb666-326" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;phi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</span>
<span id="cb666-327"><a href="all-r-code-in-this-book.html#cb666-327" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">13.4050</span>, <span class="fl">52.5200</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">2.3522</span>, <span class="fl">48.8566</span>)), <span class="dt">crs =</span> <span class="st">&#39;EPSG:4326&#39;</span>)</span>
<span id="cb666-328"><a href="all-r-code-in-this-book.html#cb666-328" aria-hidden="true"></a>s2_orig =<span class="st"> </span><span class="kw">sf_use_s2</span>(<span class="ot">FALSE</span>)</span>
<span id="cb666-329"><a href="all-r-code-in-this-book.html#cb666-329" aria-hidden="true"></a>d1 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gc_ellipse =</span> <span class="kw">st_distance</span>(pts)[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb666-330"><a href="all-r-code-in-this-book.html#cb666-330" aria-hidden="true"></a><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</span>
<span id="cb666-331"><a href="all-r-code-in-this-book.html#cb666-331" aria-hidden="true"></a><span class="co"># or, without using s2, use st_distance(st_transform(pts, &quot;+proj=longlat +ellps=sphere&quot;))</span></span>
<span id="cb666-332"><a href="all-r-code-in-this-book.html#cb666-332" aria-hidden="true"></a>d2 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gc_sphere =</span> <span class="kw">st_distance</span>(pts)[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb666-333"><a href="all-r-code-in-this-book.html#cb666-333" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-334"><a href="all-r-code-in-this-book.html#cb666-334" aria-hidden="true"></a>d3 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">straight_ellipse =</span> units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">apply</span>(<span class="kw">do.call</span>(cbind, p), <span class="dv">1</span>, diff)<span class="op">^</span><span class="dv">2</span>)), m))</span>
<span id="cb666-335"><a href="all-r-code-in-this-book.html#cb666-335" aria-hidden="true"></a>p2 =<span class="st"> </span><span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=longlat +ellps=sphere&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</span>
<span id="cb666-336"><a href="all-r-code-in-this-book.html#cb666-336" aria-hidden="true"></a>d4 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">straight_sphere =</span> units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">apply</span>(<span class="kw">do.call</span>(cbind, p2), <span class="dv">1</span>, diff)<span class="op">^</span><span class="dv">2</span>)), m))</span>
<span id="cb666-337"><a href="all-r-code-in-this-book.html#cb666-337" aria-hidden="true"></a>res =<span class="st"> </span><span class="kw">c</span>(d1,d3,d2,d4)</span>
<span id="cb666-338"><a href="all-r-code-in-this-book.html#cb666-338" aria-hidden="true"></a><span class="co"># print as km, re-add names:</span></span>
<span id="cb666-339"><a href="all-r-code-in-this-book.html#cb666-339" aria-hidden="true"></a><span class="kw">sf_use_s2</span>(s2_orig) <span class="co"># back to what it was before changing</span></span>
<span id="cb666-340"><a href="all-r-code-in-this-book.html#cb666-340" aria-hidden="true"></a>res <span class="op">%&gt;%</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(km) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">setNames</span>(<span class="kw">names</span>(res)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">digits =</span> <span class="dv">5</span>)</span>
<span id="cb666-341"><a href="all-r-code-in-this-book.html#cb666-341" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-342"><a href="all-r-code-in-this-book.html#cb666-342" aria-hidden="true"></a><span class="kw">library</span>(rnaturalearth)</span>
<span id="cb666-343"><a href="all-r-code-in-this-book.html#cb666-343" aria-hidden="true"></a>countries110 =<span class="st"> </span><span class="kw">st_as_sf</span>(countries110)</span>
<span id="cb666-344"><a href="all-r-code-in-this-book.html#cb666-344" aria-hidden="true"></a>uk =<span class="st"> </span>countries110[countries110<span class="op">$</span>admin <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;United Kingdom&quot;</span>),] <span class="op">%&gt;%</span></span>
<span id="cb666-345"><a href="all-r-code-in-this-book.html#cb666-345" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_geometry</span>()</span>
<span id="cb666-346"><a href="all-r-code-in-this-book.html#cb666-346" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/uk_os_OSTN15_NTv2_OSGBtoETRS.tif&quot;</span>)</span>
<span id="cb666-347"><a href="all-r-code-in-this-book.html#cb666-347" aria-hidden="true"></a><span class="co"># r = read_stars(&quot;/vsicurl/https://cdn.proj.org/uk_os_OSTN15_NTv2_OSGBtoETRS.tif&quot;)</span></span>
<span id="cb666-348"><a href="all-r-code-in-this-book.html#cb666-348" aria-hidden="true"></a>hook =<span class="st"> </span><span class="cf">function</span>() {</span>
<span id="cb666-349"><a href="all-r-code-in-this-book.html#cb666-349" aria-hidden="true"></a>        <span class="kw">plot</span>(uk, <span class="dt">border =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-350"><a href="all-r-code-in-this-book.html#cb666-350" aria-hidden="true"></a>}</span>
<span id="cb666-351"><a href="all-r-code-in-this-book.html#cb666-351" aria-hidden="true"></a><span class="kw">plot</span>(r[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">hook =</span> hook, <span class="dt">key.pos =</span> <span class="dv">4</span>)</span>
<span id="cb666-352"><a href="all-r-code-in-this-book.html#cb666-352" aria-hidden="true"></a>h =<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/uk_os_OSGM15_GB.tif&quot;</span>)</span>
<span id="cb666-353"><a href="all-r-code-in-this-book.html#cb666-353" aria-hidden="true"></a><span class="co"># h = read_stars(&quot;/vsicurl/https://cdn.proj.org/uk_os_OSGM15_GB.tif&quot;)</span></span>
<span id="cb666-354"><a href="all-r-code-in-this-book.html#cb666-354" aria-hidden="true"></a><span class="kw">plot</span>(h, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-355"><a href="all-r-code-in-this-book.html#cb666-355" aria-hidden="true"></a><span class="kw">plot</span>(uk, <span class="dt">border =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-356"><a href="all-r-code-in-this-book.html#cb666-356" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-357"><a href="all-r-code-in-this-book.html#cb666-357" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-358"><a href="all-r-code-in-this-book.html#cb666-358" aria-hidden="true"></a></span>
<span id="cb666-359"><a href="all-r-code-in-this-book.html#cb666-359" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-360"><a href="all-r-code-in-this-book.html#cb666-360" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-361"><a href="all-r-code-in-this-book.html#cb666-361" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-362"><a href="all-r-code-in-this-book.html#cb666-362" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-363"><a href="all-r-code-in-this-book.html#cb666-363" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-364"><a href="all-r-code-in-this-book.html#cb666-364" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-365"><a href="all-r-code-in-this-book.html#cb666-365" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-366"><a href="all-r-code-in-this-book.html#cb666-366" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-367"><a href="all-r-code-in-this-book.html#cb666-367" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-368"><a href="all-r-code-in-this-book.html#cb666-368" aria-hidden="true"></a>)</span>
<span id="cb666-369"><a href="all-r-code-in-this-book.html#cb666-369" aria-hidden="true"></a></span>
<span id="cb666-370"><a href="all-r-code-in-this-book.html#cb666-370" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-371"><a href="all-r-code-in-this-book.html#cb666-371" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-372"><a href="all-r-code-in-this-book.html#cb666-372" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-373"><a href="all-r-code-in-this-book.html#cb666-373" aria-hidden="true"></a></span>
<span id="cb666-374"><a href="all-r-code-in-this-book.html#cb666-374" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-375"><a href="all-r-code-in-this-book.html#cb666-375" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-376"><a href="all-r-code-in-this-book.html#cb666-376" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-377"><a href="all-r-code-in-this-book.html#cb666-377" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-378"><a href="all-r-code-in-this-book.html#cb666-378" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-379"><a href="all-r-code-in-this-book.html#cb666-379" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-380"><a href="all-r-code-in-this-book.html#cb666-380" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</span>
<span id="cb666-381"><a href="all-r-code-in-this-book.html#cb666-381" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>))</span>
<span id="cb666-382"><a href="all-r-code-in-this-book.html#cb666-382" aria-hidden="true"></a></span>
<span id="cb666-383"><a href="all-r-code-in-this-book.html#cb666-383" aria-hidden="true"></a><span class="co"># 1</span></span>
<span id="cb666-384"><a href="all-r-code-in-this-book.html#cb666-384" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_point</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>)</span>
<span id="cb666-385"><a href="all-r-code-in-this-book.html#cb666-385" aria-hidden="true"></a><span class="kw">plot</span>(p, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-386"><a href="all-r-code-in-this-book.html#cb666-386" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;point&quot;</span>)</span>
<span id="cb666-387"><a href="all-r-code-in-this-book.html#cb666-387" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-388"><a href="all-r-code-in-this-book.html#cb666-388" aria-hidden="true"></a></span>
<span id="cb666-389"><a href="all-r-code-in-this-book.html#cb666-389" aria-hidden="true"></a><span class="co"># 2</span></span>
<span id="cb666-390"><a href="all-r-code-in-this-book.html#cb666-390" aria-hidden="true"></a>mp =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)))</span>
<span id="cb666-391"><a href="all-r-code-in-this-book.html#cb666-391" aria-hidden="true"></a><span class="kw">plot</span>(mp, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-392"><a href="all-r-code-in-this-book.html#cb666-392" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;multipoint&quot;</span>)</span>
<span id="cb666-393"><a href="all-r-code-in-this-book.html#cb666-393" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-394"><a href="all-r-code-in-this-book.html#cb666-394" aria-hidden="true"></a></span>
<span id="cb666-395"><a href="all-r-code-in-this-book.html#cb666-395" aria-hidden="true"></a><span class="co"># 3</span></span>
<span id="cb666-396"><a href="all-r-code-in-this-book.html#cb666-396" aria-hidden="true"></a>ls =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</span>
<span id="cb666-397"><a href="all-r-code-in-this-book.html#cb666-397" aria-hidden="true"></a><span class="kw">plot</span>(ls, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-398"><a href="all-r-code-in-this-book.html#cb666-398" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;linestring&quot;</span>)</span>
<span id="cb666-399"><a href="all-r-code-in-this-book.html#cb666-399" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-400"><a href="all-r-code-in-this-book.html#cb666-400" aria-hidden="true"></a></span>
<span id="cb666-401"><a href="all-r-code-in-this-book.html#cb666-401" aria-hidden="true"></a><span class="co"># 4</span></span>
<span id="cb666-402"><a href="all-r-code-in-this-book.html#cb666-402" aria-hidden="true"></a>mls =<span class="st"> </span><span class="kw">st_multilinestring</span>(<span class="kw">list</span>(</span>
<span id="cb666-403"><a href="all-r-code-in-this-book.html#cb666-403" aria-hidden="true"></a>  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)),</span>
<span id="cb666-404"><a href="all-r-code-in-this-book.html#cb666-404" aria-hidden="true"></a>  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))))</span>
<span id="cb666-405"><a href="all-r-code-in-this-book.html#cb666-405" aria-hidden="true"></a><span class="kw">plot</span>(mls, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-406"><a href="all-r-code-in-this-book.html#cb666-406" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;multilinestring&quot;</span>)</span>
<span id="cb666-407"><a href="all-r-code-in-this-book.html#cb666-407" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-408"><a href="all-r-code-in-this-book.html#cb666-408" aria-hidden="true"></a></span>
<span id="cb666-409"><a href="all-r-code-in-this-book.html#cb666-409" aria-hidden="true"></a><span class="co"># 5 polygon</span></span>
<span id="cb666-410"><a href="all-r-code-in-this-book.html#cb666-410" aria-hidden="true"></a>po =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)),</span>
<span id="cb666-411"><a href="all-r-code-in-this-book.html#cb666-411" aria-hidden="true"></a>    <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))))</span>
<span id="cb666-412"><a href="all-r-code-in-this-book.html#cb666-412" aria-hidden="true"></a><span class="kw">plot</span>(po, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-413"><a href="all-r-code-in-this-book.html#cb666-413" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;polygon&quot;</span>)</span>
<span id="cb666-414"><a href="all-r-code-in-this-book.html#cb666-414" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-415"><a href="all-r-code-in-this-book.html#cb666-415" aria-hidden="true"></a></span>
<span id="cb666-416"><a href="all-r-code-in-this-book.html#cb666-416" aria-hidden="true"></a><span class="co"># 6 multipolygon</span></span>
<span id="cb666-417"><a href="all-r-code-in-this-book.html#cb666-417" aria-hidden="true"></a>mpo =<span class="st"> </span><span class="kw">st_multipolygon</span>(<span class="kw">list</span>(</span>
<span id="cb666-418"><a href="all-r-code-in-this-book.html#cb666-418" aria-hidden="true"></a>    <span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)),</span>
<span id="cb666-419"><a href="all-r-code-in-this-book.html#cb666-419" aria-hidden="true"></a>        <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))),</span>
<span id="cb666-420"><a href="all-r-code-in-this-book.html#cb666-420" aria-hidden="true"></a>    <span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">8</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">9</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">8</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)))))</span>
<span id="cb666-421"><a href="all-r-code-in-this-book.html#cb666-421" aria-hidden="true"></a><span class="kw">plot</span>(mpo, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-422"><a href="all-r-code-in-this-book.html#cb666-422" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;multipolygon&quot;</span>)</span>
<span id="cb666-423"><a href="all-r-code-in-this-book.html#cb666-423" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-424"><a href="all-r-code-in-this-book.html#cb666-424" aria-hidden="true"></a></span>
<span id="cb666-425"><a href="all-r-code-in-this-book.html#cb666-425" aria-hidden="true"></a><span class="co"># 7 geometrycollection</span></span>
<span id="cb666-426"><a href="all-r-code-in-this-book.html#cb666-426" aria-hidden="true"></a>gc =<span class="st"> </span><span class="kw">st_geometrycollection</span>(<span class="kw">list</span>(po, ls <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">5</span>), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>))))</span>
<span id="cb666-427"><a href="all-r-code-in-this-book.html#cb666-427" aria-hidden="true"></a><span class="kw">plot</span>(gc, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff6666&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-428"><a href="all-r-code-in-this-book.html#cb666-428" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;geometrycollection&quot;</span>)</span>
<span id="cb666-429"><a href="all-r-code-in-this-book.html#cb666-429" aria-hidden="true"></a><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-430"><a href="all-r-code-in-this-book.html#cb666-430" aria-hidden="true"></a>p</span>
<span id="cb666-431"><a href="all-r-code-in-this-book.html#cb666-431" aria-hidden="true"></a>mp</span>
<span id="cb666-432"><a href="all-r-code-in-this-book.html#cb666-432" aria-hidden="true"></a>ls</span>
<span id="cb666-433"><a href="all-r-code-in-this-book.html#cb666-433" aria-hidden="true"></a>mls</span>
<span id="cb666-434"><a href="all-r-code-in-this-book.html#cb666-434" aria-hidden="true"></a>po</span>
<span id="cb666-435"><a href="all-r-code-in-this-book.html#cb666-435" aria-hidden="true"></a>mpo</span>
<span id="cb666-436"><a href="all-r-code-in-this-book.html#cb666-436" aria-hidden="true"></a>gc</span>
<span id="cb666-437"><a href="all-r-code-in-this-book.html#cb666-437" aria-hidden="true"></a>(<span class="dt">ls =</span> <span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">0</span>))))</span>
<span id="cb666-438"><a href="all-r-code-in-this-book.html#cb666-438" aria-hidden="true"></a><span class="kw">c</span>(<span class="dt">is_simple =</span> <span class="kw">st_is_simple</span>(ls))</span>
<span id="cb666-439"><a href="all-r-code-in-this-book.html#cb666-439" aria-hidden="true"></a><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb666-440"><a href="all-r-code-in-this-book.html#cb666-440" aria-hidden="true"></a><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">dim =</span> <span class="st">&quot;XYM&quot;</span>)</span>
<span id="cb666-441"><a href="all-r-code-in-this-book.html#cb666-441" aria-hidden="true"></a><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>)))</span>
<span id="cb666-442"><a href="all-r-code-in-this-book.html#cb666-442" aria-hidden="true"></a>(<span class="dt">e =</span> <span class="kw">st_intersection</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))))</span>
<span id="cb666-443"><a href="all-r-code-in-this-book.html#cb666-443" aria-hidden="true"></a><span class="kw">st_point</span>()</span>
<span id="cb666-444"><a href="all-r-code-in-this-book.html#cb666-444" aria-hidden="true"></a><span class="kw">st_linestring</span>(<span class="kw">matrix</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>)[<span class="dv">0</span>,], <span class="dt">dim =</span> <span class="st">&quot;XYM&quot;</span>)</span>
<span id="cb666-445"><a href="all-r-code-in-this-book.html#cb666-445" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-446"><a href="all-r-code-in-this-book.html#cb666-446" aria-hidden="true"></a>polygon =<span class="st"> </span>po =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))))</span>
<span id="cb666-447"><a href="all-r-code-in-this-book.html#cb666-447" aria-hidden="true"></a>p0 =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))))</span>
<span id="cb666-448"><a href="all-r-code-in-this-book.html#cb666-448" aria-hidden="true"></a>line =<span class="st"> </span>li =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">0.5</span>)))</span>
<span id="cb666-449"><a href="all-r-code-in-this-book.html#cb666-449" aria-hidden="true"></a>s =<span class="st"> </span><span class="kw">st_sfc</span>(po, li)</span>
<span id="cb666-450"><a href="all-r-code-in-this-book.html#cb666-450" aria-hidden="true"></a></span>
<span id="cb666-451"><a href="all-r-code-in-this-book.html#cb666-451" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb666-452"><a href="all-r-code-in-this-book.html#cb666-452" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb666-453"><a href="all-r-code-in-this-book.html#cb666-453" aria-hidden="true"></a></span>
<span id="cb666-454"><a href="all-r-code-in-this-book.html#cb666-454" aria-hidden="true"></a><span class="co"># &quot;1020F1102&quot;</span></span>
<span id="cb666-455"><a href="all-r-code-in-this-book.html#cb666-455" aria-hidden="true"></a><span class="co"># 1: 1</span></span>
<span id="cb666-456"><a href="all-r-code-in-this-book.html#cb666-456" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 1&quot;</span>)))</span>
<span id="cb666-457"><a href="all-r-code-in-this-book.html#cb666-457" aria-hidden="true"></a><span class="kw">lines</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>,<span class="dv">0</span>), <span class="kw">c</span>(.<span class="dv">5</span>,.<span class="dv">495</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-458"><a href="all-r-code-in-this-book.html#cb666-458" aria-hidden="true"></a><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">pch =</span> <span class="dv">1</span>)</span>
<span id="cb666-459"><a href="all-r-code-in-this-book.html#cb666-459" aria-hidden="true"></a></span>
<span id="cb666-460"><a href="all-r-code-in-this-book.html#cb666-460" aria-hidden="true"></a><span class="co"># 2: 0</span></span>
<span id="cb666-461"><a href="all-r-code-in-this-book.html#cb666-461" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = 0&quot;</span>)))</span>
<span id="cb666-462"><a href="all-r-code-in-this-book.html#cb666-462" aria-hidden="true"></a><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-463"><a href="all-r-code-in-this-book.html#cb666-463" aria-hidden="true"></a></span>
<span id="cb666-464"><a href="all-r-code-in-this-book.html#cb666-464" aria-hidden="true"></a><span class="co"># 3: 2</span></span>
<span id="cb666-465"><a href="all-r-code-in-this-book.html#cb666-465" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 2&quot;</span>)))</span>
<span id="cb666-466"><a href="all-r-code-in-this-book.html#cb666-466" aria-hidden="true"></a><span class="kw">plot</span>(po, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-467"><a href="all-r-code-in-this-book.html#cb666-467" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-468"><a href="all-r-code-in-this-book.html#cb666-468" aria-hidden="true"></a></span>
<span id="cb666-469"><a href="all-r-code-in-this-book.html#cb666-469" aria-hidden="true"></a><span class="co"># 4: 0</span></span>
<span id="cb666-470"><a href="all-r-code-in-this-book.html#cb666-470" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 0&quot;</span>)))</span>
<span id="cb666-471"><a href="all-r-code-in-this-book.html#cb666-471" aria-hidden="true"></a><span class="kw">points</span>(.<span class="dv">5</span>, <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-472"><a href="all-r-code-in-this-book.html#cb666-472" aria-hidden="true"></a></span>
<span id="cb666-473"><a href="all-r-code-in-this-book.html#cb666-473" aria-hidden="true"></a><span class="co"># 5: F</span></span>
<span id="cb666-474"><a href="all-r-code-in-this-book.html#cb666-474" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = F&quot;</span>)))</span>
<span id="cb666-475"><a href="all-r-code-in-this-book.html#cb666-475" aria-hidden="true"></a></span>
<span id="cb666-476"><a href="all-r-code-in-this-book.html#cb666-476" aria-hidden="true"></a><span class="co"># 6: 1</span></span>
<span id="cb666-477"><a href="all-r-code-in-this-book.html#cb666-477" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 1&quot;</span>)))</span>
<span id="cb666-478"><a href="all-r-code-in-this-book.html#cb666-478" aria-hidden="true"></a><span class="kw">plot</span>(po, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-479"><a href="all-r-code-in-this-book.html#cb666-479" aria-hidden="true"></a></span>
<span id="cb666-480"><a href="all-r-code-in-this-book.html#cb666-480" aria-hidden="true"></a><span class="co"># 7: 1</span></span>
<span id="cb666-481"><a href="all-r-code-in-this-book.html#cb666-481" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 1&quot;</span>)))</span>
<span id="cb666-482"><a href="all-r-code-in-this-book.html#cb666-482" aria-hidden="true"></a><span class="kw">lines</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="dv">0</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-483"><a href="all-r-code-in-this-book.html#cb666-483" aria-hidden="true"></a></span>
<span id="cb666-484"><a href="all-r-code-in-this-book.html#cb666-484" aria-hidden="true"></a><span class="co"># 8: 0</span></span>
<span id="cb666-485"><a href="all-r-code-in-this-book.html#cb666-485" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = 0&quot;</span>)))</span>
<span id="cb666-486"><a href="all-r-code-in-this-book.html#cb666-486" aria-hidden="true"></a><span class="kw">points</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-487"><a href="all-r-code-in-this-book.html#cb666-487" aria-hidden="true"></a></span>
<span id="cb666-488"><a href="all-r-code-in-this-book.html#cb666-488" aria-hidden="true"></a><span class="co"># 9: 2</span></span>
<span id="cb666-489"><a href="all-r-code-in-this-book.html#cb666-489" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 2&quot;</span>)))</span>
<span id="cb666-490"><a href="all-r-code-in-this-book.html#cb666-490" aria-hidden="true"></a><span class="kw">plot</span>(p0 <span class="op">/</span><span class="st"> </span>po, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-491"><a href="all-r-code-in-this-book.html#cb666-491" aria-hidden="true"></a><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-492"><a href="all-r-code-in-this-book.html#cb666-492" aria-hidden="true"></a><span class="kw">st_relate</span>(polygon, line)</span>
<span id="cb666-493"><a href="all-r-code-in-this-book.html#cb666-493" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb666-494"><a href="all-r-code-in-this-book.html#cb666-494" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">133331</span>)</span>
<span id="cb666-495"><a href="all-r-code-in-this-book.html#cb666-495" aria-hidden="true"></a>mp =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">20</span>), <span class="dv">10</span>))</span>
<span id="cb666-496"><a href="all-r-code-in-this-book.html#cb666-496" aria-hidden="true"></a><span class="kw">plot</span>(mp, <span class="dt">cex =</span> <span class="dv">2</span>)</span>
<span id="cb666-497"><a href="all-r-code-in-this-book.html#cb666-497" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_convex_hull</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-498"><a href="all-r-code-in-this-book.html#cb666-498" aria-hidden="true"></a><span class="kw">box</span>()</span>
<span id="cb666-499"><a href="all-r-code-in-this-book.html#cb666-499" aria-hidden="true"></a><span class="kw">plot</span>(mp, <span class="dt">cex =</span> <span class="dv">2</span>)</span>
<span id="cb666-500"><a href="all-r-code-in-this-book.html#cb666-500" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_voronoi</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-501"><a href="all-r-code-in-this-book.html#cb666-501" aria-hidden="true"></a><span class="kw">box</span>()</span>
<span id="cb666-502"><a href="all-r-code-in-this-book.html#cb666-502" aria-hidden="true"></a><span class="kw">plot</span>(mp, <span class="dt">cex =</span> <span class="dv">2</span>)</span>
<span id="cb666-503"><a href="all-r-code-in-this-book.html#cb666-503" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_triangulate</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;darkgreen&#39;</span>)</span>
<span id="cb666-504"><a href="all-r-code-in-this-book.html#cb666-504" aria-hidden="true"></a><span class="kw">box</span>()</span>
<span id="cb666-505"><a href="all-r-code-in-this-book.html#cb666-505" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb666-506"><a href="all-r-code-in-this-book.html#cb666-506" aria-hidden="true"></a>sq =<span class="st"> </span><span class="cf">function</span>(pt, <span class="dt">sz =</span> <span class="dv">1</span>) <span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(pt <span class="op">-</span><span class="st"> </span>sz), </span>
<span id="cb666-507"><a href="all-r-code-in-this-book.html#cb666-507" aria-hidden="true"></a>  <span class="kw">c</span>(pt[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>sz, pt[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>sz), <span class="kw">c</span>(pt <span class="op">+</span><span class="st"> </span>sz), <span class="kw">c</span>(pt[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>sz, pt[<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>sz), <span class="kw">c</span>(pt <span class="op">-</span><span class="st"> </span>sz))))</span>
<span id="cb666-508"><a href="all-r-code-in-this-book.html#cb666-508" aria-hidden="true"></a>x =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">box =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="kw">st_sfc</span>(<span class="kw">sq</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="kw">sq</span>(<span class="kw">c</span>(<span class="fl">1.7</span>, <span class="fl">-0.5</span>)), <span class="kw">sq</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>))))</span>
<span id="cb666-509"><a href="all-r-code-in-this-book.html#cb666-509" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(x), <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>), <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb666-510"><a href="all-r-code-in-this-book.html#cb666-510" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_intersection</span>(<span class="kw">st_geometry</span>(x)), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">7</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>))</span>
<span id="cb666-511"><a href="all-r-code-in-this-book.html#cb666-511" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) </span>
<span id="cb666-512"><a href="all-r-code-in-this-book.html#cb666-512" aria-hidden="true"></a>xg =<span class="st"> </span><span class="kw">st_geometry</span>(x)</span>
<span id="cb666-513"><a href="all-r-code-in-this-book.html#cb666-513" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_difference</span>(xg), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>))</span>
<span id="cb666-514"><a href="all-r-code-in-this-book.html#cb666-514" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_difference</span>(xg[<span class="dv">3</span><span class="op">:</span><span class="dv">1</span>]), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>))</span>
<span id="cb666-515"><a href="all-r-code-in-this-book.html#cb666-515" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-516"><a href="all-r-code-in-this-book.html#cb666-516" aria-hidden="true"></a>ls =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">a =</span> <span class="dv">2</span>, <span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">0.1</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">.9</span>)))))</span>
<span id="cb666-517"><a href="all-r-code-in-this-book.html#cb666-517" aria-hidden="true"></a>grd =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="kw">st_bbox</span>(ls), <span class="dt">nx =</span> <span class="dv">10</span>, <span class="dt">ny =</span> <span class="dv">10</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb666-518"><a href="all-r-code-in-this-book.html#cb666-518" aria-hidden="true"></a>   <span class="dt">values =</span> <span class="dv">-1</span>)</span>
<span id="cb666-519"><a href="all-r-code-in-this-book.html#cb666-519" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">st_rasterize</span>(ls, grd, <span class="dt">options =</span> <span class="st">&quot;ALL_TOUCHED=TRUE&quot;</span>)</span>
<span id="cb666-520"><a href="all-r-code-in-this-book.html#cb666-520" aria-hidden="true"></a>r[r <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>] =<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb666-521"><a href="all-r-code-in-this-book.html#cb666-521" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(grd)), <span class="dt">border =</span> <span class="st">&#39;orange&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, </span>
<span id="cb666-522"><a href="all-r-code-in-this-book.html#cb666-522" aria-hidden="true"></a>     <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">key.pos=</span><span class="ot">NULL</span>)</span>
<span id="cb666-523"><a href="all-r-code-in-this-book.html#cb666-523" aria-hidden="true"></a><span class="kw">plot</span>(r, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) <span class="co"># ALL_TOUCHED=FALSE;</span></span>
<span id="cb666-524"><a href="all-r-code-in-this-book.html#cb666-524" aria-hidden="true"></a><span class="kw">plot</span>(ls, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-525"><a href="all-r-code-in-this-book.html#cb666-525" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-526"><a href="all-r-code-in-this-book.html#cb666-526" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-527"><a href="all-r-code-in-this-book.html#cb666-527" aria-hidden="true"></a></span>
<span id="cb666-528"><a href="all-r-code-in-this-book.html#cb666-528" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-529"><a href="all-r-code-in-this-book.html#cb666-529" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-530"><a href="all-r-code-in-this-book.html#cb666-530" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-531"><a href="all-r-code-in-this-book.html#cb666-531" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-532"><a href="all-r-code-in-this-book.html#cb666-532" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-533"><a href="all-r-code-in-this-book.html#cb666-533" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-534"><a href="all-r-code-in-this-book.html#cb666-534" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-535"><a href="all-r-code-in-this-book.html#cb666-535" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-536"><a href="all-r-code-in-this-book.html#cb666-536" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-537"><a href="all-r-code-in-this-book.html#cb666-537" aria-hidden="true"></a>)</span>
<span id="cb666-538"><a href="all-r-code-in-this-book.html#cb666-538" aria-hidden="true"></a></span>
<span id="cb666-539"><a href="all-r-code-in-this-book.html#cb666-539" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-540"><a href="all-r-code-in-this-book.html#cb666-540" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-541"><a href="all-r-code-in-this-book.html#cb666-541" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-542"><a href="all-r-code-in-this-book.html#cb666-542" aria-hidden="true"></a></span>
<span id="cb666-543"><a href="all-r-code-in-this-book.html#cb666-543" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-544"><a href="all-r-code-in-this-book.html#cb666-544" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-545"><a href="all-r-code-in-this-book.html#cb666-545" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-546"><a href="all-r-code-in-this-book.html#cb666-546" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-547"><a href="all-r-code-in-this-book.html#cb666-547" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-548"><a href="all-r-code-in-this-book.html#cb666-548" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-549"><a href="all-r-code-in-this-book.html#cb666-549" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(maps))</span>
<span id="cb666-550"><a href="all-r-code-in-this-book.html#cb666-550" aria-hidden="true"></a><span class="co"># maps:</span></span>
<span id="cb666-551"><a href="all-r-code-in-this-book.html#cb666-551" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb666-552"><a href="all-r-code-in-this-book.html#cb666-552" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb666-553"><a href="all-r-code-in-this-book.html#cb666-553" aria-hidden="true"></a>m =<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>))</span>
<span id="cb666-554"><a href="all-r-code-in-this-book.html#cb666-554" aria-hidden="true"></a>a =<span class="st"> </span>m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, ]</span>
<span id="cb666-555"><a href="all-r-code-in-this-book.html#cb666-555" aria-hidden="true"></a><span class="kw">st_bbox</span>(a)</span>
<span id="cb666-556"><a href="all-r-code-in-this-book.html#cb666-556" aria-hidden="true"></a><span class="kw">library</span>(s2)</span>
<span id="cb666-557"><a href="all-r-code-in-this-book.html#cb666-557" aria-hidden="true"></a><span class="kw">s2_bounds_cap</span>(a)</span>
<span id="cb666-558"><a href="all-r-code-in-this-book.html#cb666-558" aria-hidden="true"></a><span class="kw">s2_bounds_rect</span>(a)</span>
<span id="cb666-559"><a href="all-r-code-in-this-book.html#cb666-559" aria-hidden="true"></a><span class="kw">st_bbox</span>(m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Fiji&quot;</span>,])</span>
<span id="cb666-560"><a href="all-r-code-in-this-book.html#cb666-560" aria-hidden="true"></a><span class="kw">s2_bounds_rect</span>(m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Fiji&quot;</span>,])</span>
<span id="cb666-561"><a href="all-r-code-in-this-book.html#cb666-561" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-562"><a href="all-r-code-in-this-book.html#cb666-562" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(maps))</span>
<span id="cb666-563"><a href="all-r-code-in-this-book.html#cb666-563" aria-hidden="true"></a><span class="co"># maps:</span></span>
<span id="cb666-564"><a href="all-r-code-in-this-book.html#cb666-564" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb666-565"><a href="all-r-code-in-this-book.html#cb666-565" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb666-566"><a href="all-r-code-in-this-book.html#cb666-566" aria-hidden="true"></a>m =<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>))</span>
<span id="cb666-567"><a href="all-r-code-in-this-book.html#cb666-567" aria-hidden="true"></a>m =<span class="st"> </span>m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, ]</span>
<span id="cb666-568"><a href="all-r-code-in-this-book.html#cb666-568" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(m), <span class="dt">asp =</span> <span class="dv">2</span>)</span>
<span id="cb666-569"><a href="all-r-code-in-this-book.html#cb666-569" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;a (not valid)&quot;</span>)</span>
<span id="cb666-570"><a href="all-r-code-in-this-book.html#cb666-570" aria-hidden="true"></a><span class="co"># ne:</span></span>
<span id="cb666-571"><a href="all-r-code-in-this-book.html#cb666-571" aria-hidden="true"></a><span class="kw">library</span>(rnaturalearth)</span>
<span id="cb666-572"><a href="all-r-code-in-this-book.html#cb666-572" aria-hidden="true"></a>ne =<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb666-573"><a href="all-r-code-in-this-book.html#cb666-573" aria-hidden="true"></a>ne =<span class="st"> </span>ne[ne<span class="op">$</span>region_un <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, <span class="st">&quot;region_un&quot;</span>]</span>
<span id="cb666-574"><a href="all-r-code-in-this-book.html#cb666-574" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(ne), <span class="dt">asp =</span> <span class="dv">2</span>)</span>
<span id="cb666-575"><a href="all-r-code-in-this-book.html#cb666-575" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;b (valid)&quot;</span>)</span>
<span id="cb666-576"><a href="all-r-code-in-this-book.html#cb666-576" aria-hidden="true"></a><span class="co"># 3031</span></span>
<span id="cb666-577"><a href="all-r-code-in-this-book.html#cb666-577" aria-hidden="true"></a>m <span class="op">%&gt;%</span></span>
<span id="cb666-578"><a href="all-r-code-in-this-book.html#cb666-578" aria-hidden="true"></a><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-579"><a href="all-r-code-in-this-book.html#cb666-579" aria-hidden="true"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3031</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-580"><a href="all-r-code-in-this-book.html#cb666-580" aria-hidden="true"></a><span class="st">  </span><span class="kw">plot</span>()</span>
<span id="cb666-581"><a href="all-r-code-in-this-book.html#cb666-581" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;c (valid)&quot;</span>)</span>
<span id="cb666-582"><a href="all-r-code-in-this-book.html#cb666-582" aria-hidden="true"></a>ne <span class="op">%&gt;%</span></span>
<span id="cb666-583"><a href="all-r-code-in-this-book.html#cb666-583" aria-hidden="true"></a><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-584"><a href="all-r-code-in-this-book.html#cb666-584" aria-hidden="true"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3031</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-585"><a href="all-r-code-in-this-book.html#cb666-585" aria-hidden="true"></a><span class="st">  </span><span class="kw">plot</span>()</span>
<span id="cb666-586"><a href="all-r-code-in-this-book.html#cb666-586" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&quot;d (not valid)&quot;</span>)</span>
<span id="cb666-587"><a href="all-r-code-in-this-book.html#cb666-587" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-588"><a href="all-r-code-in-this-book.html#cb666-588" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-589"><a href="all-r-code-in-this-book.html#cb666-589" aria-hidden="true"></a></span>
<span id="cb666-590"><a href="all-r-code-in-this-book.html#cb666-590" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-591"><a href="all-r-code-in-this-book.html#cb666-591" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-592"><a href="all-r-code-in-this-book.html#cb666-592" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-593"><a href="all-r-code-in-this-book.html#cb666-593" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-594"><a href="all-r-code-in-this-book.html#cb666-594" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-595"><a href="all-r-code-in-this-book.html#cb666-595" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-596"><a href="all-r-code-in-this-book.html#cb666-596" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-597"><a href="all-r-code-in-this-book.html#cb666-597" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-598"><a href="all-r-code-in-this-book.html#cb666-598" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-599"><a href="all-r-code-in-this-book.html#cb666-599" aria-hidden="true"></a>)</span>
<span id="cb666-600"><a href="all-r-code-in-this-book.html#cb666-600" aria-hidden="true"></a></span>
<span id="cb666-601"><a href="all-r-code-in-this-book.html#cb666-601" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-602"><a href="all-r-code-in-this-book.html#cb666-602" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-603"><a href="all-r-code-in-this-book.html#cb666-603" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-604"><a href="all-r-code-in-this-book.html#cb666-604" aria-hidden="true"></a></span>
<span id="cb666-605"><a href="all-r-code-in-this-book.html#cb666-605" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-606"><a href="all-r-code-in-this-book.html#cb666-606" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-607"><a href="all-r-code-in-this-book.html#cb666-607" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-608"><a href="all-r-code-in-this-book.html#cb666-608" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-609"><a href="all-r-code-in-this-book.html#cb666-609" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-610"><a href="all-r-code-in-this-book.html#cb666-610" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-611"><a href="all-r-code-in-this-book.html#cb666-611" aria-hidden="true"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb666-612"><a href="all-r-code-in-this-book.html#cb666-612" aria-hidden="true"></a><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-613"><a href="all-r-code-in-this-book.html#cb666-613" aria-hidden="true"></a><span class="st">    </span><span class="kw">read_sf</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-614"><a href="all-r-code-in-this-book.html#cb666-614" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">32119</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-615"><a href="all-r-code-in-this-book.html#cb666-615" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(BIR74, SID74, NAME) <span class="op">%&gt;%</span></span>
<span id="cb666-616"><a href="all-r-code-in-this-book.html#cb666-616" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_centroid</span>() -&gt;<span class="st"> </span>x</span>
<span id="cb666-617"><a href="all-r-code-in-this-book.html#cb666-617" aria-hidden="true"></a>nc &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</span>
<span id="cb666-618"><a href="all-r-code-in-this-book.html#cb666-618" aria-hidden="true"></a><span class="co"># encode quadrant by two logicals:</span></span>
<span id="cb666-619"><a href="all-r-code-in-this-book.html#cb666-619" aria-hidden="true"></a>nc<span class="op">$</span>lng =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc)))[,<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">-79</span></span>
<span id="cb666-620"><a href="all-r-code-in-this-book.html#cb666-620" aria-hidden="true"></a>nc<span class="op">$</span>lat =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc)))[,<span class="dv">2</span>] <span class="op">&gt;</span><span class="st"> </span><span class="fl">35.5</span></span>
<span id="cb666-621"><a href="all-r-code-in-this-book.html#cb666-621" aria-hidden="true"></a>nc.grp =<span class="st"> </span><span class="kw">aggregate</span>(nc[<span class="st">&quot;SID74&quot;</span>], <span class="kw">list</span>(nc<span class="op">$</span>lng, nc<span class="op">$</span>lat), sum)</span>
<span id="cb666-622"><a href="all-r-code-in-this-book.html#cb666-622" aria-hidden="true"></a><span class="kw">plot</span>(nc.grp[<span class="st">&quot;SID74&quot;</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-623"><a href="all-r-code-in-this-book.html#cb666-623" aria-hidden="true"></a>nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">2264</span>)</span>
<span id="cb666-624"><a href="all-r-code-in-this-book.html#cb666-624" aria-hidden="true"></a>gr =<span class="st"> </span><span class="kw">st_sf</span>(</span>
<span id="cb666-625"><a href="all-r-code-in-this-book.html#cb666-625" aria-hidden="true"></a>   <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</span>
<span id="cb666-626"><a href="all-r-code-in-this-book.html#cb666-626" aria-hidden="true"></a>   <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</span>
<span id="cb666-627"><a href="all-r-code-in-this-book.html#cb666-627" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-628"><a href="all-r-code-in-this-book.html#cb666-628" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-629"><a href="all-r-code-in-this-book.html#cb666-629" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">aggregate</span>(nc[<span class="st">&quot;SID74&quot;</span>], gr, sum)</span>
<span id="cb666-630"><a href="all-r-code-in-this-book.html#cb666-630" aria-hidden="true"></a><span class="kw">c</span>(<span class="dt">sid74_sum_counties =</span> <span class="kw">sum</span>(nc<span class="op">$</span>SID74), <span class="dt">sid74_sum_rectangles =</span> <span class="kw">sum</span>(a<span class="op">$</span>SID74, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb666-631"><a href="all-r-code-in-this-book.html#cb666-631" aria-hidden="true"></a>g =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="kw">st_bbox</span>(<span class="kw">st_as_sfc</span>(<span class="st">&quot;LINESTRING(0 0,1 1)&quot;</span>)), <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb666-632"><a href="all-r-code-in-this-book.html#cb666-632" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb666-633"><a href="all-r-code-in-this-book.html#cb666-633" aria-hidden="true"></a><span class="kw">plot</span>(g)</span>
<span id="cb666-634"><a href="all-r-code-in-this-book.html#cb666-634" aria-hidden="true"></a><span class="kw">plot</span>(g[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.125</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</span>
<span id="cb666-635"><a href="all-r-code-in-this-book.html#cb666-635" aria-hidden="true"></a><span class="kw">text</span>(<span class="kw">c</span>(.<span class="dv">2</span>, <span class="fl">.8</span>, <span class="fl">.2</span>, <span class="fl">.8</span>), <span class="kw">c</span>(.<span class="dv">2</span>, <span class="fl">.2</span>, <span class="fl">.8</span>, <span class="fl">.8</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb666-636"><a href="all-r-code-in-this-book.html#cb666-636" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-637"><a href="all-r-code-in-this-book.html#cb666-637" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-638"><a href="all-r-code-in-this-book.html#cb666-638" aria-hidden="true"></a></span>
<span id="cb666-639"><a href="all-r-code-in-this-book.html#cb666-639" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-640"><a href="all-r-code-in-this-book.html#cb666-640" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-641"><a href="all-r-code-in-this-book.html#cb666-641" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-642"><a href="all-r-code-in-this-book.html#cb666-642" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-643"><a href="all-r-code-in-this-book.html#cb666-643" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-644"><a href="all-r-code-in-this-book.html#cb666-644" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-645"><a href="all-r-code-in-this-book.html#cb666-645" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-646"><a href="all-r-code-in-this-book.html#cb666-646" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-647"><a href="all-r-code-in-this-book.html#cb666-647" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-648"><a href="all-r-code-in-this-book.html#cb666-648" aria-hidden="true"></a>)</span>
<span id="cb666-649"><a href="all-r-code-in-this-book.html#cb666-649" aria-hidden="true"></a></span>
<span id="cb666-650"><a href="all-r-code-in-this-book.html#cb666-650" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-651"><a href="all-r-code-in-this-book.html#cb666-651" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-652"><a href="all-r-code-in-this-book.html#cb666-652" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-653"><a href="all-r-code-in-this-book.html#cb666-653" aria-hidden="true"></a></span>
<span id="cb666-654"><a href="all-r-code-in-this-book.html#cb666-654" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-655"><a href="all-r-code-in-this-book.html#cb666-655" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-656"><a href="all-r-code-in-this-book.html#cb666-656" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-657"><a href="all-r-code-in-this-book.html#cb666-657" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-658"><a href="all-r-code-in-this-book.html#cb666-658" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-659"><a href="all-r-code-in-this-book.html#cb666-659" aria-hidden="true"></a><span class="co"># (C) 2019, Edzer Pebesma, CC-BY-SA</span></span>
<span id="cb666-660"><a href="all-r-code-in-this-book.html#cb666-660" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1331</span>)</span>
<span id="cb666-661"><a href="all-r-code-in-this-book.html#cb666-661" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(stars))</span>
<span id="cb666-662"><a href="all-r-code-in-this-book.html#cb666-662" aria-hidden="true"></a><span class="kw">library</span>(colorspace)</span>
<span id="cb666-663"><a href="all-r-code-in-this-book.html#cb666-663" aria-hidden="true"></a>tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb666-664"><a href="all-r-code-in-this-book.html#cb666-664" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</span>
<span id="cb666-665"><a href="all-r-code-in-this-book.html#cb666-665" aria-hidden="true"></a></span>
<span id="cb666-666"><a href="all-r-code-in-this-book.html#cb666-666" aria-hidden="true"></a>nrow =<span class="st"> </span><span class="dv">5</span></span>
<span id="cb666-667"><a href="all-r-code-in-this-book.html#cb666-667" aria-hidden="true"></a>ncol =<span class="st"> </span><span class="dv">8</span></span>
<span id="cb666-668"><a href="all-r-code-in-this-book.html#cb666-668" aria-hidden="true"></a>m =<span class="st"> </span>r[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>nrow,<span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb666-669"><a href="all-r-code-in-this-book.html#cb666-669" aria-hidden="true"></a><span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb666-670"><a href="all-r-code-in-this-book.html#cb666-670" aria-hidden="true"></a>s =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</span>
<span id="cb666-671"><a href="all-r-code-in-this-book.html#cb666-671" aria-hidden="true"></a><span class="co"># s</span></span>
<span id="cb666-672"><a href="all-r-code-in-this-book.html#cb666-672" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-673"><a href="all-r-code-in-this-book.html#cb666-673" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="fl">-.5</span></span>
<span id="cb666-674"><a href="all-r-code-in-this-book.html#cb666-674" aria-hidden="true"></a><span class="kw">attr</span>(<span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span>)</span>
<span id="cb666-675"><a href="all-r-code-in-this-book.html#cb666-675" aria-hidden="true"></a></span>
<span id="cb666-676"><a href="all-r-code-in-this-book.html#cb666-676" aria-hidden="true"></a>plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb666-677"><a href="all-r-code-in-this-book.html#cb666-677" aria-hidden="true"></a>    <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset</span>
<span id="cb666-678"><a href="all-r-code-in-this-book.html#cb666-678" aria-hidden="true"></a>    l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-679"><a href="all-r-code-in-this-book.html#cb666-679" aria-hidden="true"></a>    pal =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>)</span>
<span id="cb666-680"><a href="all-r-code-in-this-book.html#cb666-680" aria-hidden="true"></a>    <span class="cf">if</span> (li)</span>
<span id="cb666-681"><a href="all-r-code-in-this-book.html#cb666-681" aria-hidden="true"></a>        pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb666-682"><a href="all-r-code-in-this-book.html#cb666-682" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</span>
<span id="cb666-683"><a href="all-r-code-in-this-book.html#cb666-683" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb666-684"><a href="all-r-code-in-this-book.html#cb666-684" aria-hidden="true"></a>    <span class="cf">else</span></span>
<span id="cb666-685"><a href="all-r-code-in-this-book.html#cb666-685" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>))</span>
<span id="cb666-686"><a href="all-r-code-in-this-book.html#cb666-686" aria-hidden="true"></a>    u =<span class="st"> </span><span class="kw">st_union</span>(l)</span>
<span id="cb666-687"><a href="all-r-code-in-this-book.html#cb666-687" aria-hidden="true"></a>    <span class="co"># print(u)</span></span>
<span id="cb666-688"><a href="all-r-code-in-this-book.html#cb666-688" aria-hidden="true"></a>    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</span>
<span id="cb666-689"><a href="all-r-code-in-this-book.html#cb666-689" aria-hidden="true"></a>}</span>
<span id="cb666-690"><a href="all-r-code-in-this-book.html#cb666-690" aria-hidden="true"></a></span>
<span id="cb666-691"><a href="all-r-code-in-this-book.html#cb666-691" aria-hidden="true"></a>pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb666-692"><a href="all-r-code-in-this-book.html#cb666-692" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb666-693"><a href="all-r-code-in-this-book.html#cb666-693" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb666-694"><a href="all-r-code-in-this-book.html#cb666-694" aria-hidden="true"></a>  m =<span class="st"> </span>r[[<span class="dv">1</span>]][y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow,x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb666-695"><a href="all-r-code-in-this-book.html#cb666-695" aria-hidden="true"></a>  <span class="cf">if</span> (randomize)</span>
<span id="cb666-696"><a href="all-r-code-in-this-book.html#cb666-696" aria-hidden="true"></a>    m =<span class="st"> </span>m[<span class="kw">sample</span>(y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow),x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol]</span>
<span id="cb666-697"><a href="all-r-code-in-this-book.html#cb666-697" aria-hidden="true"></a>  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb666-698"><a href="all-r-code-in-this-book.html#cb666-698" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</span>
<span id="cb666-699"><a href="all-r-code-in-this-book.html#cb666-699" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, add)</span>
<span id="cb666-700"><a href="all-r-code-in-this-book.html#cb666-700" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-701"><a href="all-r-code-in-this-book.html#cb666-701" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-702"><a href="all-r-code-in-this-book.html#cb666-702" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-703"><a href="all-r-code-in-this-book.html#cb666-703" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">4</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-704"><a href="all-r-code-in-this-book.html#cb666-704" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">5</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-705"><a href="all-r-code-in-this-book.html#cb666-705" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">6</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-706"><a href="all-r-code-in-this-book.html#cb666-706" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">7</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-707"><a href="all-r-code-in-this-book.html#cb666-707" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">8</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</span>
<span id="cb666-708"><a href="all-r-code-in-this-book.html#cb666-708" aria-hidden="true"></a>}</span>
<span id="cb666-709"><a href="all-r-code-in-this-book.html#cb666-709" aria-hidden="true"></a></span>
<span id="cb666-710"><a href="all-r-code-in-this-book.html#cb666-710" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-711"><a href="all-r-code-in-this-book.html#cb666-711" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="fl">0.5</span>,<span class="dv">4</span>))</span>
<span id="cb666-712"><a href="all-r-code-in-this-book.html#cb666-712" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">12</span>,<span class="dv">15</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">5</span>,<span class="dv">10</span>), <span class="dt">asp=</span><span class="dv">1</span>)</span>
<span id="cb666-713"><a href="all-r-code-in-this-book.html#cb666-713" aria-hidden="true"></a><span class="kw">pl</span>(s, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb666-714"><a href="all-r-code-in-this-book.html#cb666-714" aria-hidden="true"></a><span class="co"># box()</span></span>
<span id="cb666-715"><a href="all-r-code-in-this-book.html#cb666-715" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">-90</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb666-716"><a href="all-r-code-in-this-book.html#cb666-716" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">5</span>,  <span class="fl">6.5</span>, <span class="st">&quot;latitude&quot;</span>, <span class="dt">srt =</span> <span class="dv">25</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb666-717"><a href="all-r-code-in-this-book.html#cb666-717" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">5</span>,  <span class="fl">8.5</span>, <span class="st">&quot;longitude&quot;</span>, <span class="dt">srt =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb666-718"><a href="all-r-code-in-this-book.html#cb666-718" aria-hidden="true"></a><span class="co"># (C) 2021, Jonathan Bahlmann, CC-BY-SA</span></span>
<span id="cb666-719"><a href="all-r-code-in-this-book.html#cb666-719" aria-hidden="true"></a><span class="co"># https://github.com/Open-EO/openeo.org/tree/master/documentation/1.0/datacubes/.scripts</span></span>
<span id="cb666-720"><a href="all-r-code-in-this-book.html#cb666-720" aria-hidden="true"></a><span class="co"># based on work by Edzer Pebesma, 2019, here: https://gist.github.com/edzer/5f1b0faa3e93073784e01d5a4bb60eca</span></span>
<span id="cb666-721"><a href="all-r-code-in-this-book.html#cb666-721" aria-hidden="true"></a></span>
<span id="cb666-722"><a href="all-r-code-in-this-book.html#cb666-722" aria-hidden="true"></a><span class="co"># plotting runs via a dummy stars object with x, y dimensions (no bands)</span></span>
<span id="cb666-723"><a href="all-r-code-in-this-book.html#cb666-723" aria-hidden="true"></a><span class="co"># to not be overly dependent on an input image, time steps and bands</span></span>
<span id="cb666-724"><a href="all-r-code-in-this-book.html#cb666-724" aria-hidden="true"></a><span class="co"># are displayed by replacing the matrix contained in the dummy stars object</span></span>
<span id="cb666-725"><a href="all-r-code-in-this-book.html#cb666-725" aria-hidden="true"></a><span class="co"># every time something is plotted</span></span>
<span id="cb666-726"><a href="all-r-code-in-this-book.html#cb666-726" aria-hidden="true"></a></span>
<span id="cb666-727"><a href="all-r-code-in-this-book.html#cb666-727" aria-hidden="true"></a><span class="co"># packages, read input ----</span></span>
<span id="cb666-728"><a href="all-r-code-in-this-book.html#cb666-728" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1331</span>)</span>
<span id="cb666-729"><a href="all-r-code-in-this-book.html#cb666-729" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-730"><a href="all-r-code-in-this-book.html#cb666-730" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(colorspace))</span>
<span id="cb666-731"><a href="all-r-code-in-this-book.html#cb666-731" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(scales))</span>
<span id="cb666-732"><a href="all-r-code-in-this-book.html#cb666-732" aria-hidden="true"></a></span>
<span id="cb666-733"><a href="all-r-code-in-this-book.html#cb666-733" aria-hidden="true"></a><span class="co"># make color palettes ----</span></span>
<span id="cb666-734"><a href="all-r-code-in-this-book.html#cb666-734" aria-hidden="true"></a>blues &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">211</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb666-735"><a href="all-r-code-in-this-book.html#cb666-735" aria-hidden="true"></a>greens &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">134</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb666-736"><a href="all-r-code-in-this-book.html#cb666-736" aria-hidden="true"></a>reds &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">360</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb666-737"><a href="all-r-code-in-this-book.html#cb666-737" aria-hidden="true"></a>purples &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">299</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb666-738"><a href="all-r-code-in-this-book.html#cb666-738" aria-hidden="true"></a>greys &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">0</span>, <span class="dt">c1 =</span> <span class="dv">0</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb666-739"><a href="all-r-code-in-this-book.html#cb666-739" aria-hidden="true"></a></span>
<span id="cb666-740"><a href="all-r-code-in-this-book.html#cb666-740" aria-hidden="true"></a><span class="co"># matrices from raster ----</span></span>
<span id="cb666-741"><a href="all-r-code-in-this-book.html#cb666-741" aria-hidden="true"></a><span class="co"># make input matrices from an actual raster image</span></span>
<span id="cb666-742"><a href="all-r-code-in-this-book.html#cb666-742" aria-hidden="true"></a>input &lt;-<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/iceland_delta_cutout_2.tif&quot;</span>) <span class="co"># this raster needs approx 6x7 format</span></span>
<span id="cb666-743"><a href="all-r-code-in-this-book.html#cb666-743" aria-hidden="true"></a><span class="co"># if the input raster is changed, every image where a pixel value is written as text needs to be checked and corrected accordingly</span></span>
<span id="cb666-744"><a href="all-r-code-in-this-book.html#cb666-744" aria-hidden="true"></a>input &lt;-<span class="st"> </span>input[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span>
<span id="cb666-745"><a href="all-r-code-in-this-book.html#cb666-745" aria-hidden="true"></a>warped &lt;-<span class="st"> </span><span class="kw">st_warp</span>(input, <span class="dt">crs =</span> <span class="kw">st_crs</span>(input), <span class="dt">cellsize =</span> <span class="dv">200</span>) <span class="co"># warp to approx. 6x7 pixel</span></span>
<span id="cb666-746"><a href="all-r-code-in-this-book.html#cb666-746" aria-hidden="true"></a></span>
<span id="cb666-747"><a href="all-r-code-in-this-book.html#cb666-747" aria-hidden="true"></a><span class="co"># these are only needed for resampling</span></span>
<span id="cb666-748"><a href="all-r-code-in-this-book.html#cb666-748" aria-hidden="true"></a>warped_highres &lt;-<span class="st"> </span><span class="kw">st_warp</span>(warped, <span class="dt">crs =</span> <span class="kw">st_crs</span>(warped), <span class="dt">cellsize =</span> <span class="dv">100</span>) <span class="co"># with different input, cellsize must be adapted</span></span>
<span id="cb666-749"><a href="all-r-code-in-this-book.html#cb666-749" aria-hidden="true"></a><span class="co"># this is a bit of a trick, because 3:4 is different format than 6:7</span></span>
<span id="cb666-750"><a href="all-r-code-in-this-book.html#cb666-750" aria-hidden="true"></a><span class="co"># when downsampling, the raster of origin isn&#39;t so important anyway</span></span>
<span id="cb666-751"><a href="all-r-code-in-this-book.html#cb666-751" aria-hidden="true"></a>warped_lowres &lt;-<span class="st"> </span><span class="kw">st_warp</span>(warped_highres[,<span class="dv">1</span><span class="op">:</span><span class="dv">11</span>,,], <span class="dt">crs =</span> <span class="kw">st_crs</span>(warped), <span class="dt">cellsize =</span> <span class="dv">390</span>)</span>
<span id="cb666-752"><a href="all-r-code-in-this-book.html#cb666-752" aria-hidden="true"></a><span class="co"># plot(warped_lowres)</span></span>
<span id="cb666-753"><a href="all-r-code-in-this-book.html#cb666-753" aria-hidden="true"></a><span class="co"># image(warped[,,,1], text_values = TRUE)</span></span>
<span id="cb666-754"><a href="all-r-code-in-this-book.html#cb666-754" aria-hidden="true"></a></span>
<span id="cb666-755"><a href="all-r-code-in-this-book.html#cb666-755" aria-hidden="true"></a>t1 &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">42</span>, <span class="dv">-30</span>, <span class="dv">150</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)) <span class="co"># create timesteps 2 and 3 randomly</span></span>
<span id="cb666-756"><a href="all-r-code-in-this-book.html#cb666-756" aria-hidden="true"></a>t2 &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">42</span>, <span class="dv">-250</span>, <span class="dv">50</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-757"><a href="all-r-code-in-this-book.html#cb666-757" aria-hidden="true"></a></span>
<span id="cb666-758"><a href="all-r-code-in-this-book.html#cb666-758" aria-hidden="true"></a><span class="co"># create dummy stars object ----</span></span>
<span id="cb666-759"><a href="all-r-code-in-this-book.html#cb666-759" aria-hidden="true"></a>make_dummy_stars &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, d1, d2, aff) {</span>
<span id="cb666-760"><a href="all-r-code-in-this-book.html#cb666-760" aria-hidden="true"></a>  m =<span class="st"> </span>warped_highres[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>x,<span class="dv">1</span><span class="op">:</span>y,<span class="dv">1</span>] <span class="co"># underlying raster doesn&#39;t matter because it&#39;s just dummy construct</span></span>
<span id="cb666-761"><a href="all-r-code-in-this-book.html#cb666-761" aria-hidden="true"></a>  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y) <span class="co"># named dim</span></span>
<span id="cb666-762"><a href="all-r-code-in-this-book.html#cb666-762" aria-hidden="true"></a>  dummy =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</span>
<span id="cb666-763"><a href="all-r-code-in-this-book.html#cb666-763" aria-hidden="true"></a>  <span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span>d1</span>
<span id="cb666-764"><a href="all-r-code-in-this-book.html#cb666-764" aria-hidden="true"></a>  <span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span>d2</span>
<span id="cb666-765"><a href="all-r-code-in-this-book.html#cb666-765" aria-hidden="true"></a>  <span class="kw">attr</span>(<span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(aff, <span class="fl">0.0</span>)</span>
<span id="cb666-766"><a href="all-r-code-in-this-book.html#cb666-766" aria-hidden="true"></a>  <span class="kw">return</span>(dummy)</span>
<span id="cb666-767"><a href="all-r-code-in-this-book.html#cb666-767" aria-hidden="true"></a>}</span>
<span id="cb666-768"><a href="all-r-code-in-this-book.html#cb666-768" aria-hidden="true"></a></span>
<span id="cb666-769"><a href="all-r-code-in-this-book.html#cb666-769" aria-hidden="true"></a>s &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="fl">2.5</span>, <span class="fl">-.5714286</span>, <span class="fl">-1.14</span>) <span class="co"># mainly used, perspective</span></span>
<span id="cb666-770"><a href="all-r-code-in-this-book.html#cb666-770" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="co"># flat</span></span>
<span id="cb666-771"><a href="all-r-code-in-this-book.html#cb666-771" aria-hidden="true"></a>highres &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">12</span>, <span class="dv">14</span>, <span class="fl">1.25</span>, <span class="fl">-.2857143</span>, <span class="fl">-.57</span>) <span class="co"># for resampling</span></span>
<span id="cb666-772"><a href="all-r-code-in-this-book.html#cb666-772" aria-hidden="true"></a>lowres &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">-1</span>, <span class="dv">-2</span>) <span class="co"># for resampling</span></span>
<span id="cb666-773"><a href="all-r-code-in-this-book.html#cb666-773" aria-hidden="true"></a></span>
<span id="cb666-774"><a href="all-r-code-in-this-book.html#cb666-774" aria-hidden="true"></a><span class="co"># matrices from image ----</span></span>
<span id="cb666-775"><a href="all-r-code-in-this-book.html#cb666-775" aria-hidden="true"></a>make_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(image, band, <span class="dt">n =</span> <span class="dv">42</span>, <span class="dt">ncol =</span> <span class="dv">7</span>, <span class="dt">t =</span> <span class="dv">0</span>) {</span>
<span id="cb666-776"><a href="all-r-code-in-this-book.html#cb666-776" aria-hidden="true"></a>  <span class="co"># this is based on an input image with &gt;= 4 input bands</span></span>
<span id="cb666-777"><a href="all-r-code-in-this-book.html#cb666-777" aria-hidden="true"></a>  <span class="co"># n is meant to cut off NAs, ncol is y, t is random matrix for time difference</span></span>
<span id="cb666-778"><a href="all-r-code-in-this-book.html#cb666-778" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">matrix</span>(image[,,,band][[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>n], <span class="dt">ncol =</span> ncol) <span class="op">-</span><span class="st"> </span>t)</span>
<span id="cb666-779"><a href="all-r-code-in-this-book.html#cb666-779" aria-hidden="true"></a>  <span class="co"># before: b3 &lt;- matrix(warped[,,,1][[1]][1:42], ncol = 7) - t2</span></span>
<span id="cb666-780"><a href="all-r-code-in-this-book.html#cb666-780" aria-hidden="true"></a>}</span>
<span id="cb666-781"><a href="all-r-code-in-this-book.html#cb666-781" aria-hidden="true"></a></span>
<span id="cb666-782"><a href="all-r-code-in-this-book.html#cb666-782" aria-hidden="true"></a><span class="co"># now use function: </span></span>
<span id="cb666-783"><a href="all-r-code-in-this-book.html#cb666-783" aria-hidden="true"></a>b1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>)</span>
<span id="cb666-784"><a href="all-r-code-in-this-book.html#cb666-784" aria-hidden="true"></a>b2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>, <span class="dt">t =</span> t1)</span>
<span id="cb666-785"><a href="all-r-code-in-this-book.html#cb666-785" aria-hidden="true"></a>b3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>, <span class="dt">t =</span> t2)</span>
<span id="cb666-786"><a href="all-r-code-in-this-book.html#cb666-786" aria-hidden="true"></a>g1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>)</span>
<span id="cb666-787"><a href="all-r-code-in-this-book.html#cb666-787" aria-hidden="true"></a>g2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>, <span class="dt">t =</span> t1)</span>
<span id="cb666-788"><a href="all-r-code-in-this-book.html#cb666-788" aria-hidden="true"></a>g3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>, <span class="dt">t =</span> t2)</span>
<span id="cb666-789"><a href="all-r-code-in-this-book.html#cb666-789" aria-hidden="true"></a>r1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>)</span>
<span id="cb666-790"><a href="all-r-code-in-this-book.html#cb666-790" aria-hidden="true"></a>r2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>, <span class="dt">t =</span> t1)</span>
<span id="cb666-791"><a href="all-r-code-in-this-book.html#cb666-791" aria-hidden="true"></a>r3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>, <span class="dt">t =</span> t2)</span>
<span id="cb666-792"><a href="all-r-code-in-this-book.html#cb666-792" aria-hidden="true"></a>n1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>)</span>
<span id="cb666-793"><a href="all-r-code-in-this-book.html#cb666-793" aria-hidden="true"></a>n2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>, <span class="dt">t =</span> t1)</span>
<span id="cb666-794"><a href="all-r-code-in-this-book.html#cb666-794" aria-hidden="true"></a>n3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>, <span class="dt">t =</span> t2)</span>
<span id="cb666-795"><a href="all-r-code-in-this-book.html#cb666-795" aria-hidden="true"></a></span>
<span id="cb666-796"><a href="all-r-code-in-this-book.html#cb666-796" aria-hidden="true"></a><span class="co"># plot functions ----</span></span>
<span id="cb666-797"><a href="all-r-code-in-this-book.html#cb666-797" aria-hidden="true"></a>plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>, pal, <span class="dt">print_geom =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="fl">.75</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) {</span>
<span id="cb666-798"><a href="all-r-code-in-this-book.html#cb666-798" aria-hidden="true"></a>  <span class="co"># pal is color palette</span></span>
<span id="cb666-799"><a href="all-r-code-in-this-book.html#cb666-799" aria-hidden="true"></a>  <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset </span>
<span id="cb666-800"><a href="all-r-code-in-this-book.html#cb666-800" aria-hidden="true"></a>  l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-801"><a href="all-r-code-in-this-book.html#cb666-801" aria-hidden="true"></a>  <span class="cf">if</span> (li)</span>
<span id="cb666-802"><a href="all-r-code-in-this-book.html#cb666-802" aria-hidden="true"></a>    pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.2</span>) <span class="co"># + rnorm(1, 0, 0.1))</span></span>
<span id="cb666-803"><a href="all-r-code-in-this-book.html#cb666-803" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</span>
<span id="cb666-804"><a href="all-r-code-in-this-book.html#cb666-804" aria-hidden="true"></a>    <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> breaks, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(border), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb666-805"><a href="all-r-code-in-this-book.html#cb666-805" aria-hidden="true"></a>  <span class="cf">else</span></span>
<span id="cb666-806"><a href="all-r-code-in-this-book.html#cb666-806" aria-hidden="true"></a>    <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> breaks, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(border))</span>
<span id="cb666-807"><a href="all-r-code-in-this-book.html#cb666-807" aria-hidden="true"></a>  u =<span class="st"> </span><span class="kw">st_union</span>(l)</span>
<span id="cb666-808"><a href="all-r-code-in-this-book.html#cb666-808" aria-hidden="true"></a>  <span class="co"># print(u)</span></span>
<span id="cb666-809"><a href="all-r-code-in-this-book.html#cb666-809" aria-hidden="true"></a>  <span class="cf">if</span>(print_geom) {</span>
<span id="cb666-810"><a href="all-r-code-in-this-book.html#cb666-810" aria-hidden="true"></a>    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</span>
<span id="cb666-811"><a href="all-r-code-in-this-book.html#cb666-811" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb666-812"><a href="all-r-code-in-this-book.html#cb666-812" aria-hidden="true"></a>    <span class="co"># not print geometry</span></span>
<span id="cb666-813"><a href="all-r-code-in-this-book.html#cb666-813" aria-hidden="true"></a>  }</span>
<span id="cb666-814"><a href="all-r-code-in-this-book.html#cb666-814" aria-hidden="true"></a>}</span>
<span id="cb666-815"><a href="all-r-code-in-this-book.html#cb666-815" aria-hidden="true"></a></span>
<span id="cb666-816"><a href="all-r-code-in-this-book.html#cb666-816" aria-hidden="true"></a>pl_stack =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, nrM, <span class="dt">imgY =</span> <span class="dv">7</span>, <span class="dt">inner =</span> <span class="dv">1</span>) {</span>
<span id="cb666-817"><a href="all-r-code-in-this-book.html#cb666-817" aria-hidden="true"></a>  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span id="cb666-818"><a href="all-r-code-in-this-book.html#cb666-818" aria-hidden="true"></a>  <span class="co"># prints all 4 bands at once</span></span>
<span id="cb666-819"><a href="all-r-code-in-this-book.html#cb666-819" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb666-820"><a href="all-r-code-in-this-book.html#cb666-820" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb666-821"><a href="all-r-code-in-this-book.html#cb666-821" aria-hidden="true"></a>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb666-822"><a href="all-r-code-in-this-book.html#cb666-822" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, nrM)))</span>
<span id="cb666-823"><a href="all-r-code-in-this-book.html#cb666-823" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)] <span class="co"># turn around to have same orientation as flat plot</span></span>
<span id="cb666-824"><a href="all-r-code-in-this-book.html#cb666-824" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> purples)</span>
<span id="cb666-825"><a href="all-r-code-in-this-book.html#cb666-825" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, nrM)))</span>
<span id="cb666-826"><a href="all-r-code-in-this-book.html#cb666-826" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb666-827"><a href="all-r-code-in-this-book.html#cb666-827" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> reds)</span>
<span id="cb666-828"><a href="all-r-code-in-this-book.html#cb666-828" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;g&quot;</span>, nrM)))</span>
<span id="cb666-829"><a href="all-r-code-in-this-book.html#cb666-829" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb666-830"><a href="all-r-code-in-this-book.html#cb666-830" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> greens)</span>
<span id="cb666-831"><a href="all-r-code-in-this-book.html#cb666-831" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;b&quot;</span>, nrM)))</span>
<span id="cb666-832"><a href="all-r-code-in-this-book.html#cb666-832" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb666-833"><a href="all-r-code-in-this-book.html#cb666-833" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span><span class="op">*</span>inner, <span class="ot">TRUE</span>, <span class="dt">pal =</span> blues) <span class="co"># li FALSE deleted</span></span>
<span id="cb666-834"><a href="all-r-code-in-this-book.html#cb666-834" aria-hidden="true"></a>}</span>
<span id="cb666-835"><a href="all-r-code-in-this-book.html#cb666-835" aria-hidden="true"></a></span>
<span id="cb666-836"><a href="all-r-code-in-this-book.html#cb666-836" aria-hidden="true"></a><span class="co"># flat plot function</span></span>
<span id="cb666-837"><a href="all-r-code-in-this-book.html#cb666-837" aria-hidden="true"></a><span class="co"># prints any dummy stars with any single matrix to position</span></span>
<span id="cb666-838"><a href="all-r-code-in-this-book.html#cb666-838" aria-hidden="true"></a>pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>, pal, m, <span class="dt">print_geom =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="fl">.75</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) {</span>
<span id="cb666-839"><a href="all-r-code-in-this-book.html#cb666-839" aria-hidden="true"></a>  <span class="co"># m is matrix to replace image with</span></span>
<span id="cb666-840"><a href="all-r-code-in-this-book.html#cb666-840" aria-hidden="true"></a>  <span class="co"># m &lt;- t(m)</span></span>
<span id="cb666-841"><a href="all-r-code-in-this-book.html#cb666-841" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb666-842"><a href="all-r-code-in-this-book.html#cb666-842" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb666-843"><a href="all-r-code-in-this-book.html#cb666-843" aria-hidden="true"></a>  <span class="co"># print(m)</span></span>
<span id="cb666-844"><a href="all-r-code-in-this-book.html#cb666-844" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</span>
<span id="cb666-845"><a href="all-r-code-in-this-book.html#cb666-845" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pal =</span> pal, <span class="dt">print_geom =</span> print_geom, <span class="dt">border =</span> border, <span class="dt">breaks =</span> breaks)</span>
<span id="cb666-846"><a href="all-r-code-in-this-book.html#cb666-846" aria-hidden="true"></a>  <span class="co">#plot(s, text_values = TRUE)</span></span>
<span id="cb666-847"><a href="all-r-code-in-this-book.html#cb666-847" aria-hidden="true"></a>}</span>
<span id="cb666-848"><a href="all-r-code-in-this-book.html#cb666-848" aria-hidden="true"></a></span>
<span id="cb666-849"><a href="all-r-code-in-this-book.html#cb666-849" aria-hidden="true"></a>print_segments &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, seg, <span class="dt">by =</span> <span class="dv">1</span>, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>) {</span>
<span id="cb666-850"><a href="all-r-code-in-this-book.html#cb666-850" aria-hidden="true"></a>  seg =<span class="st"> </span>seg <span class="op">*</span><span class="st"> </span>by</span>
<span id="cb666-851"><a href="all-r-code-in-this-book.html#cb666-851" aria-hidden="true"></a>  seg[,<span class="dv">1</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>x</span>
<span id="cb666-852"><a href="all-r-code-in-this-book.html#cb666-852" aria-hidden="true"></a>  seg[,<span class="dv">3</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">3</span>] <span class="op">+</span><span class="st"> </span>x</span>
<span id="cb666-853"><a href="all-r-code-in-this-book.html#cb666-853" aria-hidden="true"></a>  seg[,<span class="dv">2</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb666-854"><a href="all-r-code-in-this-book.html#cb666-854" aria-hidden="true"></a>  seg[,<span class="dv">4</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">4</span>] <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb666-855"><a href="all-r-code-in-this-book.html#cb666-855" aria-hidden="true"></a>  <span class="kw">segments</span>(seg[,<span class="dv">1</span>], seg[,<span class="dv">2</span>], seg[,<span class="dv">3</span>], seg[,<span class="dv">4</span>], <span class="dt">lwd =</span> lwd, <span class="dt">col =</span> col)</span>
<span id="cb666-856"><a href="all-r-code-in-this-book.html#cb666-856" aria-hidden="true"></a>}</span>
<span id="cb666-857"><a href="all-r-code-in-this-book.html#cb666-857" aria-hidden="true"></a></span>
<span id="cb666-858"><a href="all-r-code-in-this-book.html#cb666-858" aria-hidden="true"></a><span class="co"># time series ----</span></span>
<span id="cb666-859"><a href="all-r-code-in-this-book.html#cb666-859" aria-hidden="true"></a></span>
<span id="cb666-860"><a href="all-r-code-in-this-book.html#cb666-860" aria-hidden="true"></a><span class="co"># from: cube1_ts_6x7_bigger.png</span></span>
<span id="cb666-861"><a href="all-r-code-in-this-book.html#cb666-861" aria-hidden="true"></a>offset =<span class="st"> </span><span class="dv">26</span></span>
<span id="cb666-862"><a href="all-r-code-in-this-book.html#cb666-862" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-863"><a href="all-r-code-in-this-book.html#cb666-863" aria-hidden="true"></a><span class="co">#par(mar = c(3, 2, 7, 2))</span></span>
<span id="cb666-864"><a href="all-r-code-in-this-book.html#cb666-864" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb666-865"><a href="all-r-code-in-this-book.html#cb666-865" aria-hidden="true"></a><span class="co">#plot.window(xlim = c(10, 50), ylim = c(-3, 10), asp = 1)</span></span>
<span id="cb666-866"><a href="all-r-code-in-this-book.html#cb666-866" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">15</span>, <span class="dv">75</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">10</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-867"><a href="all-r-code-in-this-book.html#cb666-867" aria-hidden="true"></a><span class="kw">pl_stack</span>(s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">3</span>)</span>
<span id="cb666-868"><a href="all-r-code-in-this-book.html#cb666-868" aria-hidden="true"></a><span class="kw">pl_stack</span>(s, offset, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">2</span>)</span>
<span id="cb666-869"><a href="all-r-code-in-this-book.html#cb666-869" aria-hidden="true"></a><span class="kw">pl_stack</span>(s, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>offset, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">1</span>)</span>
<span id="cb666-870"><a href="all-r-code-in-this-book.html#cb666-870" aria-hidden="true"></a><span class="co"># po &lt;- matrix(c(0,-8,7,0,15,3.5,  0,1,1,5,5,14), ncol = 2)</span></span>
<span id="cb666-871"><a href="all-r-code-in-this-book.html#cb666-871" aria-hidden="true"></a>heads &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="dv">14</span>,<span class="dv">14</span>,<span class="dv">14</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb666-872"><a href="all-r-code-in-this-book.html#cb666-872" aria-hidden="true"></a><span class="kw">points</span>(heads, <span class="dt">pch =</span> <span class="dv">16</span>) <span class="co"># 4 or 16</span></span>
<span id="cb666-873"><a href="all-r-code-in-this-book.html#cb666-873" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span>, <span class="dv">14</span>) <span class="co"># first stack pyramid</span></span>
<span id="cb666-874"><a href="all-r-code-in-this-book.html#cb666-874" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span>offset, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, <span class="dv">14</span>) <span class="co"># second stack pyramid</span></span>
<span id="cb666-875"><a href="all-r-code-in-this-book.html#cb666-875" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="dv">14</span>) <span class="co"># third stack pyramid</span></span>
<span id="cb666-876"><a href="all-r-code-in-this-book.html#cb666-876" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="op">-</span><span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">72</span>, <span class="dv">14</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)  <span class="co"># timeline</span></span>
<span id="cb666-877"><a href="all-r-code-in-this-book.html#cb666-877" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">7.5</span>, <span class="fl">3.8</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-878"><a href="all-r-code-in-this-book.html#cb666-878" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="fl">-2.5</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-879"><a href="all-r-code-in-this-book.html#cb666-879" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="fl">4.5</span>, <span class="fl">1.8</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">srt =</span> <span class="fl">27.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-880"><a href="all-r-code-in-this-book.html#cb666-880" aria-hidden="true"></a>y =<span class="st"> </span><span class="fl">15.8</span></span>
<span id="cb666-881"><a href="all-r-code-in-this-book.html#cb666-881" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">69</span>, y, <span class="st">&quot;time&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-882"><a href="all-r-code-in-this-book.html#cb666-882" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.5</span>, y, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-883"><a href="all-r-code-in-this-book.html#cb666-883" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, y, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-884"><a href="all-r-code-in-this-book.html#cb666-884" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, y, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-885"><a href="all-r-code-in-this-book.html#cb666-885" aria-hidden="true"></a><span class="co"># flat ----</span></span>
<span id="cb666-886"><a href="all-r-code-in-this-book.html#cb666-886" aria-hidden="true"></a>xlabels &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span><span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">length.out =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>to, <span class="dt">by =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta)</span>
<span id="cb666-887"><a href="all-r-code-in-this-book.html#cb666-887" aria-hidden="true"></a>ylabels &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span><span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">length.out =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>to, <span class="dt">by =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta)</span>
<span id="cb666-888"><a href="all-r-code-in-this-book.html#cb666-888" aria-hidden="true"></a></span>
<span id="cb666-889"><a href="all-r-code-in-this-book.html#cb666-889" aria-hidden="true"></a>print_labels &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, off, lab, horizontal, <span class="dt">cex =</span> <span class="dv">1</span>) {</span>
<span id="cb666-890"><a href="all-r-code-in-this-book.html#cb666-890" aria-hidden="true"></a>  <span class="cf">if</span>(horizontal) { <span class="co"># x</span></span>
<span id="cb666-891"><a href="all-r-code-in-this-book.html#cb666-891" aria-hidden="true"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(lab)<span class="op">-</span><span class="dv">1</span>)) {</span>
<span id="cb666-892"><a href="all-r-code-in-this-book.html#cb666-892" aria-hidden="true"></a>      <span class="kw">text</span>(x <span class="op">+</span><span class="st"> </span>i<span class="op">*</span>off, y, lab[i<span class="op">+</span><span class="dv">1</span>], <span class="dt">cex =</span> cex, <span class="dt">srt =</span> <span class="dv">90</span>)</span>
<span id="cb666-893"><a href="all-r-code-in-this-book.html#cb666-893" aria-hidden="true"></a>    }</span>
<span id="cb666-894"><a href="all-r-code-in-this-book.html#cb666-894" aria-hidden="true"></a>  } <span class="cf">else</span> { <span class="co"># y</span></span>
<span id="cb666-895"><a href="all-r-code-in-this-book.html#cb666-895" aria-hidden="true"></a>    lab &lt;-<span class="st"> </span>lab[<span class="kw">length</span>(lab)<span class="op">:</span><span class="dv">0</span>]</span>
<span id="cb666-896"><a href="all-r-code-in-this-book.html#cb666-896" aria-hidden="true"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(lab)<span class="op">-</span><span class="dv">1</span>)) {</span>
<span id="cb666-897"><a href="all-r-code-in-this-book.html#cb666-897" aria-hidden="true"></a>      <span class="kw">text</span>(x, y <span class="op">+</span><span class="st"> </span>i<span class="op">*</span>off, lab[i<span class="op">+</span><span class="dv">1</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-898"><a href="all-r-code-in-this-book.html#cb666-898" aria-hidden="true"></a>    }</span>
<span id="cb666-899"><a href="all-r-code-in-this-book.html#cb666-899" aria-hidden="true"></a>  }</span>
<span id="cb666-900"><a href="all-r-code-in-this-book.html#cb666-900" aria-hidden="true"></a>}</span>
<span id="cb666-901"><a href="all-r-code-in-this-book.html#cb666-901" aria-hidden="true"></a></span>
<span id="cb666-902"><a href="all-r-code-in-this-book.html#cb666-902" aria-hidden="true"></a><span class="co"># before: width=1000, xlim(-2, 33), date labels x=31</span></span>
<span id="cb666-903"><a href="all-r-code-in-this-book.html#cb666-903" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-904"><a href="all-r-code-in-this-book.html#cb666-904" aria-hidden="true"></a><span class="co"># par(mar = c(0,0,0,0))</span></span>
<span id="cb666-905"><a href="all-r-code-in-this-book.html#cb666-905" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb666-906"><a href="all-r-code-in-this-book.html#cb666-906" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">40</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">25</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-907"><a href="all-r-code-in-this-book.html#cb666-907" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</span>
<span id="cb666-908"><a href="all-r-code-in-this-book.html#cb666-908" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">10</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</span>
<span id="cb666-909"><a href="all-r-code-in-this-book.html#cb666-909" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">20</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb666-910"><a href="all-r-code-in-this-book.html#cb666-910" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">0</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</span>
<span id="cb666-911"><a href="all-r-code-in-this-book.html#cb666-911" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">10</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</span>
<span id="cb666-912"><a href="all-r-code-in-this-book.html#cb666-912" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">20</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb666-913"><a href="all-r-code-in-this-book.html#cb666-913" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">0</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</span>
<span id="cb666-914"><a href="all-r-code-in-this-book.html#cb666-914" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">10</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</span>
<span id="cb666-915"><a href="all-r-code-in-this-book.html#cb666-915" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">20</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb666-916"><a href="all-r-code-in-this-book.html#cb666-916" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">0</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</span>
<span id="cb666-917"><a href="all-r-code-in-this-book.html#cb666-917" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">10</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</span>
<span id="cb666-918"><a href="all-r-code-in-this-book.html#cb666-918" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">20</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb666-919"><a href="all-r-code-in-this-book.html#cb666-919" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="fl">28.5</span>, <span class="dv">-2</span>, <span class="dv">1</span>, xlabels, <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb666-920"><a href="all-r-code-in-this-book.html#cb666-920" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dv">36</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, ylabels, <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb666-921"><a href="all-r-code-in-this-book.html#cb666-921" aria-hidden="true"></a><span class="co"># arrows(6, 27, 6, 0, angle = 20, lwd = 2)</span></span>
<span id="cb666-922"><a href="all-r-code-in-this-book.html#cb666-922" aria-hidden="true"></a><span class="co"># text(5, 14, &quot;time&quot;, srt = 90, col = &quot;black&quot;)</span></span>
<span id="cb666-923"><a href="all-r-code-in-this-book.html#cb666-923" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">10</span>, <span class="dv">28</span>, <span class="st">&quot;blue&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-924"><a href="all-r-code-in-this-book.html#cb666-924" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">17</span>, <span class="dv">28</span>, <span class="st">&quot;green&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-925"><a href="all-r-code-in-this-book.html#cb666-925" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">24</span>, <span class="dv">28</span>, <span class="st">&quot;red&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-926"><a href="all-r-code-in-this-book.html#cb666-926" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">31</span>, <span class="dv">28</span>, <span class="st">&quot;nir&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-927"><a href="all-r-code-in-this-book.html#cb666-927" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">23.5</span>, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-928"><a href="all-r-code-in-this-book.html#cb666-928" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span>, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-929"><a href="all-r-code-in-this-book.html#cb666-929" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">3.5</span>, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-930"><a href="all-r-code-in-this-book.html#cb666-930" aria-hidden="true"></a><span class="co"># filter ----</span></span>
<span id="cb666-931"><a href="all-r-code-in-this-book.html#cb666-931" aria-hidden="true"></a><span class="co"># mask &lt;- matrix(c(rep(NA, 26), 1,NA,1,NA,1,1,1, rep(NA, 9)), ncol = 7)</span></span>
<span id="cb666-932"><a href="all-r-code-in-this-book.html#cb666-932" aria-hidden="true"></a>mask &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb666-933"><a href="all-r-code-in-this-book.html#cb666-933" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb666-934"><a href="all-r-code-in-this-book.html#cb666-934" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb666-935"><a href="all-r-code-in-this-book.html#cb666-935" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb666-936"><a href="all-r-code-in-this-book.html#cb666-936" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb666-937"><a href="all-r-code-in-this-book.html#cb666-937" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb666-938"><a href="all-r-code-in-this-book.html#cb666-938" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb666-939"><a href="all-r-code-in-this-book.html#cb666-939" aria-hidden="true"></a></span>
<span id="cb666-940"><a href="all-r-code-in-this-book.html#cb666-940" aria-hidden="true"></a>print_grid &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb666-941"><a href="all-r-code-in-this-book.html#cb666-941" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</span>
<span id="cb666-942"><a href="all-r-code-in-this-book.html#cb666-942" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</span>
<span id="cb666-943"><a href="all-r-code-in-this-book.html#cb666-943" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb666-944"><a href="all-r-code-in-this-book.html#cb666-944" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</span>
<span id="cb666-945"><a href="all-r-code-in-this-book.html#cb666-945" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</span>
<span id="cb666-946"><a href="all-r-code-in-this-book.html#cb666-946" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb666-947"><a href="all-r-code-in-this-book.html#cb666-947" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</span>
<span id="cb666-948"><a href="all-r-code-in-this-book.html#cb666-948" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</span>
<span id="cb666-949"><a href="all-r-code-in-this-book.html#cb666-949" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb666-950"><a href="all-r-code-in-this-book.html#cb666-950" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</span>
<span id="cb666-951"><a href="all-r-code-in-this-book.html#cb666-951" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</span>
<span id="cb666-952"><a href="all-r-code-in-this-book.html#cb666-952" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb666-953"><a href="all-r-code-in-this-book.html#cb666-953" aria-hidden="true"></a>}</span>
<span id="cb666-954"><a href="all-r-code-in-this-book.html#cb666-954" aria-hidden="true"></a>print_alpha_grid &lt;-<span class="st"> </span><span class="cf">function</span>(x,y, <span class="dt">alp =</span> <span class="fl">0.2</span>, <span class="dt">geom =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb666-955"><a href="all-r-code-in-this-book.html#cb666-955" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-956"><a href="all-r-code-in-this-book.html#cb666-956" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-957"><a href="all-r-code-in-this-book.html#cb666-957" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b3, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-958"><a href="all-r-code-in-this-book.html#cb666-958" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-959"><a href="all-r-code-in-this-book.html#cb666-959" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-960"><a href="all-r-code-in-this-book.html#cb666-960" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g3, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-961"><a href="all-r-code-in-this-book.html#cb666-961" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-962"><a href="all-r-code-in-this-book.html#cb666-962" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-963"><a href="all-r-code-in-this-book.html#cb666-963" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r3, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-964"><a href="all-r-code-in-this-book.html#cb666-964" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-965"><a href="all-r-code-in-this-book.html#cb666-965" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb666-966"><a href="all-r-code-in-this-book.html#cb666-966" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n3, <span class="dt">border =</span> <span class="dv">1</span>))</span>
<span id="cb666-967"><a href="all-r-code-in-this-book.html#cb666-967" aria-hidden="true"></a>}</span>
<span id="cb666-968"><a href="all-r-code-in-this-book.html#cb666-968" aria-hidden="true"></a></span>
<span id="cb666-969"><a href="all-r-code-in-this-book.html#cb666-969" aria-hidden="true"></a>print_grid_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb666-970"><a href="all-r-code-in-this-book.html#cb666-970" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-971"><a href="all-r-code-in-this-book.html#cb666-971" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-972"><a href="all-r-code-in-this-book.html#cb666-972" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-973"><a href="all-r-code-in-this-book.html#cb666-973" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-974"><a href="all-r-code-in-this-book.html#cb666-974" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-975"><a href="all-r-code-in-this-book.html#cb666-975" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-976"><a href="all-r-code-in-this-book.html#cb666-976" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-977"><a href="all-r-code-in-this-book.html#cb666-977" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-978"><a href="all-r-code-in-this-book.html#cb666-978" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-979"><a href="all-r-code-in-this-book.html#cb666-979" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-980"><a href="all-r-code-in-this-book.html#cb666-980" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-981"><a href="all-r-code-in-this-book.html#cb666-981" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-982"><a href="all-r-code-in-this-book.html#cb666-982" aria-hidden="true"></a>}</span>
<span id="cb666-983"><a href="all-r-code-in-this-book.html#cb666-983" aria-hidden="true"></a></span>
<span id="cb666-984"><a href="all-r-code-in-this-book.html#cb666-984" aria-hidden="true"></a>print_grid_time_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) { <span class="co"># 3x1, 28x7</span></span>
<span id="cb666-985"><a href="all-r-code-in-this-book.html#cb666-985" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb666-986"><a href="all-r-code-in-this-book.html#cb666-986" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb666-987"><a href="all-r-code-in-this-book.html#cb666-987" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb666-988"><a href="all-r-code-in-this-book.html#cb666-988" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb666-989"><a href="all-r-code-in-this-book.html#cb666-989" aria-hidden="true"></a>}</span>
<span id="cb666-990"><a href="all-r-code-in-this-book.html#cb666-990" aria-hidden="true"></a></span>
<span id="cb666-991"><a href="all-r-code-in-this-book.html#cb666-991" aria-hidden="true"></a>print_grid_bands_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">pal =</span> greys) { <span class="co"># 1x3 6x27</span></span>
<span id="cb666-992"><a href="all-r-code-in-this-book.html#cb666-992" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n1)</span>
<span id="cb666-993"><a href="all-r-code-in-this-book.html#cb666-993" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n2)</span>
<span id="cb666-994"><a href="all-r-code-in-this-book.html#cb666-994" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n3)</span>
<span id="cb666-995"><a href="all-r-code-in-this-book.html#cb666-995" aria-hidden="true"></a>}</span>
<span id="cb666-996"><a href="all-r-code-in-this-book.html#cb666-996" aria-hidden="true"></a></span>
<span id="cb666-997"><a href="all-r-code-in-this-book.html#cb666-997" aria-hidden="true"></a><span class="co"># build exactly like reduce</span></span>
<span id="cb666-998"><a href="all-r-code-in-this-book.html#cb666-998" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-999"><a href="all-r-code-in-this-book.html#cb666-999" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb666-1000"><a href="all-r-code-in-this-book.html#cb666-1000" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">120</span></span>
<span id="cb666-1001"><a href="all-r-code-in-this-book.html#cb666-1001" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb666-1002"><a href="all-r-code-in-this-book.html#cb666-1002" aria-hidden="true"></a>down =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb666-1003"><a href="all-r-code-in-this-book.html#cb666-1003" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-1004"><a href="all-r-code-in-this-book.html#cb666-1004" aria-hidden="true"></a><span class="kw">print_grid</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-27</span>)</span>
<span id="cb666-1005"><a href="all-r-code-in-this-book.html#cb666-1005" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></span>
<span id="cb666-1006"><a href="all-r-code-in-this-book.html#cb666-1006" aria-hidden="true"></a><span class="kw">print_grid_time_filter</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">-10</span><span class="op">-</span>down) <span class="co"># select 3rd</span></span>
<span id="cb666-1007"><a href="all-r-code-in-this-book.html#cb666-1007" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3-6</span>)<span class="op">/</span><span class="dv">2</span>) <span class="fl">-10.5</span>, <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></span>
<span id="cb666-1008"><a href="all-r-code-in-this-book.html#cb666-1008" aria-hidden="true"></a><span class="kw">print_grid_bands_filter</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3</span><span class="fl">-12.4</span>)), <span class="dv">0</span><span class="op">-</span>down, <span class="dt">pal =</span> purples)</span>
<span id="cb666-1009"><a href="all-r-code-in-this-book.html#cb666-1009" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></span>
<span id="cb666-1010"><a href="all-r-code-in-this-book.html#cb666-1010" aria-hidden="true"></a><span class="kw">print_grid_filter</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span><span class="op">-</span>down)</span>
<span id="cb666-1011"><a href="all-r-code-in-this-book.html#cb666-1011" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1012"><a href="all-r-code-in-this-book.html#cb666-1012" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">43</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1013"><a href="all-r-code-in-this-book.html#cb666-1013" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">83</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1014"><a href="all-r-code-in-this-book.html#cb666-1014" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">20</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1015"><a href="all-r-code-in-this-book.html#cb666-1015" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1016"><a href="all-r-code-in-this-book.html#cb666-1016" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">100</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1017"><a href="all-r-code-in-this-book.html#cb666-1017" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">6</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1018"><a href="all-r-code-in-this-book.html#cb666-1018" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">2</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1019"><a href="all-r-code-in-this-book.html#cb666-1019" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, <span class="dv">100</span>, <span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1020"><a href="all-r-code-in-this-book.html#cb666-1020" aria-hidden="true"></a><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span id="cb666-1021"><a href="all-r-code-in-this-book.html#cb666-1021" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">28.5</span>,<span class="dv">49</span>, <span class="st">&quot;filter temporally&quot;</span>, <span class="dt">srt =</span> <span class="fl">55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1022"><a href="all-r-code-in-this-book.html#cb666-1022" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>,<span class="dv">49</span>, <span class="st">&quot;filter bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1023"><a href="all-r-code-in-this-book.html#cb666-1023" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">91.5</span>,<span class="dv">49</span>, <span class="st">&quot;filter spatially&quot;</span>, <span class="dt">srt =</span> <span class="fl">-55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1024"><a href="all-r-code-in-this-book.html#cb666-1024" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">y =</span> y<span class="op">+</span><span class="dv">4</span>, <span class="dt">off =</span> <span class="dv">7</span>, <span class="dt">lab =</span> <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;nir&quot;</span>),</span>
<span id="cb666-1025"><a href="all-r-code-in-this-book.html#cb666-1025" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb666-1026"><a href="all-r-code-in-this-book.html#cb666-1026" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">9</span>, <span class="dt">y =</span> y<span class="dv">-23</span>, <span class="dt">off =</span> <span class="dv">10</span>, <span class="dt">lab =</span> <span class="kw">c</span>(<span class="st">&quot;2020-10-01&quot;</span>, <span class="st">&quot;2020-10-13&quot;</span>, <span class="st">&quot;2020-10-25&quot;</span>),</span>
<span id="cb666-1027"><a href="all-r-code-in-this-book.html#cb666-1027" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb666-1028"><a href="all-r-code-in-this-book.html#cb666-1028" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="fl">21.5</span>, <span class="dt">y =</span> y<span class="dv">-30</span>, <span class="dt">off =</span> <span class="dv">1</span>, <span class="dt">lab =</span> xlabels,</span>
<span id="cb666-1029"><a href="all-r-code-in-this-book.html#cb666-1029" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>)</span>
<span id="cb666-1030"><a href="all-r-code-in-this-book.html#cb666-1030" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">30</span>, <span class="dt">y =</span> y<span class="fl">-26.5</span>, <span class="dt">off =</span> <span class="dv">1</span>, <span class="dt">lab =</span> ylabels,</span>
<span id="cb666-1031"><a href="all-r-code-in-this-book.html#cb666-1031" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>)</span>
<span id="cb666-1032"><a href="all-r-code-in-this-book.html#cb666-1032" aria-hidden="true"></a><span class="co"># apply ----</span></span>
<span id="cb666-1033"><a href="all-r-code-in-this-book.html#cb666-1033" aria-hidden="true"></a>print_text =<span class="st"> </span><span class="cf">function</span>(s, x, y, m) {</span>
<span id="cb666-1034"><a href="all-r-code-in-this-book.html#cb666-1034" aria-hidden="true"></a>  <span class="co"># m &lt;- t(m) # transverse for correct order</span></span>
<span id="cb666-1035"><a href="all-r-code-in-this-book.html#cb666-1035" aria-hidden="true"></a>  <span class="co"># print(m)</span></span>
<span id="cb666-1036"><a href="all-r-code-in-this-book.html#cb666-1036" aria-hidden="true"></a>  r &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">5.5</span>, <span class="dv">1</span>), <span class="dv">7</span>)</span>
<span id="cb666-1037"><a href="all-r-code-in-this-book.html#cb666-1037" aria-hidden="true"></a>  r &lt;-<span class="st"> </span>r <span class="op">+</span><span class="st"> </span>x <span class="co"># consider offsets</span></span>
<span id="cb666-1038"><a href="all-r-code-in-this-book.html#cb666-1038" aria-hidden="true"></a>  u &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="fl">0.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">1.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">2.5</span>, <span class="dv">6</span>), </span>
<span id="cb666-1039"><a href="all-r-code-in-this-book.html#cb666-1039" aria-hidden="true"></a>         <span class="kw">rep</span>(<span class="fl">3.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">4.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">5.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">6.5</span>, <span class="dv">6</span>))</span>
<span id="cb666-1040"><a href="all-r-code-in-this-book.html#cb666-1040" aria-hidden="true"></a>  u &lt;-<span class="st"> </span>u <span class="op">+</span><span class="st"> </span>y <span class="co"># offset</span></span>
<span id="cb666-1041"><a href="all-r-code-in-this-book.html#cb666-1041" aria-hidden="true"></a>  tab &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(r,u), <span class="dt">nrow =</span> <span class="dv">42</span>, <span class="dt">byrow =</span> <span class="ot">FALSE</span>) <span class="co"># make point table</span></span>
<span id="cb666-1042"><a href="all-r-code-in-this-book.html#cb666-1042" aria-hidden="true"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">42</span>) {</span>
<span id="cb666-1043"><a href="all-r-code-in-this-book.html#cb666-1043" aria-hidden="true"></a>    <span class="co">#text(tab[i, 1], tab[i, 2], labels = paste0(&quot;&quot;, m[i]), cex = 1.1)</span></span>
<span id="cb666-1044"><a href="all-r-code-in-this-book.html#cb666-1044" aria-hidden="true"></a>    <span class="kw">text</span>(tab[i, <span class="dv">1</span>], tab[i, <span class="dv">2</span>], <span class="dt">labels =</span> <span class="kw">paste0</span>(<span class="st">&quot;&quot;</span>, m[i]), <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1045"><a href="all-r-code-in-this-book.html#cb666-1045" aria-hidden="true"></a>    }</span>
<span id="cb666-1046"><a href="all-r-code-in-this-book.html#cb666-1046" aria-hidden="true"></a>}</span>
<span id="cb666-1047"><a href="all-r-code-in-this-book.html#cb666-1047" aria-hidden="true"></a></span>
<span id="cb666-1048"><a href="all-r-code-in-this-book.html#cb666-1048" aria-hidden="true"></a>abs_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">500</span>,<span class="dv">500</span>, <span class="dv">50</span>)</span>
<span id="cb666-1049"><a href="all-r-code-in-this-book.html#cb666-1049" aria-hidden="true"></a>abs_pal &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">211</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">30</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="fl">1.2</span>)</span>
<span id="cb666-1050"><a href="all-r-code-in-this-book.html#cb666-1050" aria-hidden="true"></a></span>
<span id="cb666-1051"><a href="all-r-code-in-this-book.html#cb666-1051" aria-hidden="true"></a><span class="co">#png(&quot;exp_apply_unary.png&quot;, width = 2400, height = 1000, pointsize = 24)</span></span>
<span id="cb666-1052"><a href="all-r-code-in-this-book.html#cb666-1052" aria-hidden="true"></a><span class="co">#plot.new()</span></span>
<span id="cb666-1053"><a href="all-r-code-in-this-book.html#cb666-1053" aria-hidden="true"></a><span class="co">#par(mar = c(2,2,2,2))</span></span>
<span id="cb666-1054"><a href="all-r-code-in-this-book.html#cb666-1054" aria-hidden="true"></a><span class="co">#x = 30</span></span>
<span id="cb666-1055"><a href="all-r-code-in-this-book.html#cb666-1055" aria-hidden="true"></a><span class="co">#y = 7.5</span></span>
<span id="cb666-1056"><a href="all-r-code-in-this-book.html#cb666-1056" aria-hidden="true"></a><span class="co">#plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></span>
<span id="cb666-1057"><a href="all-r-code-in-this-book.html#cb666-1057" aria-hidden="true"></a><span class="co">#pl(f, 3, 2, pal = abs_pal, m = b3 - 200, breaks = abs_brks)</span></span>
<span id="cb666-1058"><a href="all-r-code-in-this-book.html#cb666-1058" aria-hidden="true"></a><span class="co">#pl(f, 1.5, .5, pal = abs_pal, m = b2 - 200, breaks = abs_brks)</span></span>
<span id="cb666-1059"><a href="all-r-code-in-this-book.html#cb666-1059" aria-hidden="true"></a><span class="co">#pl(f, 0, -1, pal = abs_pal, m = b1 - 200, breaks = abs_brks)</span></span>
<span id="cb666-1060"><a href="all-r-code-in-this-book.html#cb666-1060" aria-hidden="true"></a><span class="co">#print_text(s, 0, -1, m = b1 - 200)</span></span>
<span id="cb666-1061"><a href="all-r-code-in-this-book.html#cb666-1061" aria-hidden="true"></a><span class="co">#pl(f, 23, 2, pal = abs_pal, m = abs(b3 - 200), breaks = abs_brks)</span></span>
<span id="cb666-1062"><a href="all-r-code-in-this-book.html#cb666-1062" aria-hidden="true"></a><span class="co">#pl(f, 21.5, 0.5, pal = abs_pal, m = abs(b2 - 200), breaks = abs_brks)</span></span>
<span id="cb666-1063"><a href="all-r-code-in-this-book.html#cb666-1063" aria-hidden="true"></a><span class="co">#pl(f, 20, -1, pal = abs_pal, m = abs(b1 - 200), breaks = abs_brks)</span></span>
<span id="cb666-1064"><a href="all-r-code-in-this-book.html#cb666-1064" aria-hidden="true"></a><span class="co">#print_text(s, 20, -1, m = abs(b1 - 200))</span></span>
<span id="cb666-1065"><a href="all-r-code-in-this-book.html#cb666-1065" aria-hidden="true"></a><span class="co">#arrows(11, 4, 17.5, 4, lwd = 3)</span></span>
<span id="cb666-1066"><a href="all-r-code-in-this-book.html#cb666-1066" aria-hidden="true"></a><span class="co">#text(14.3, 3.5, &quot;absolute()&quot;, cex = 1.4)</span></span>
<span id="cb666-1067"><a href="all-r-code-in-this-book.html#cb666-1067" aria-hidden="true"></a><span class="co">#dev.off()</span></span>
<span id="cb666-1068"><a href="all-r-code-in-this-book.html#cb666-1068" aria-hidden="true"></a></span>
<span id="cb666-1069"><a href="all-r-code-in-this-book.html#cb666-1069" aria-hidden="true"></a>vNeumann_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb666-1070"><a href="all-r-code-in-this-book.html#cb666-1070" aria-hidden="true"></a>                         <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb666-1071"><a href="all-r-code-in-this-book.html#cb666-1071" aria-hidden="true"></a></span>
<span id="cb666-1072"><a href="all-r-code-in-this-book.html#cb666-1072" aria-hidden="true"></a>apply_filter &lt;-<span class="st"> </span><span class="cf">function</span>(input, <span class="dt">pad =</span> <span class="ot">TRUE</span>, <span class="dt">padValue =</span> <span class="dv">1</span>) {</span>
<span id="cb666-1073"><a href="all-r-code-in-this-book.html#cb666-1073" aria-hidden="true"></a>  ras &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">focal</span>(raster<span class="op">::</span><span class="kw">raster</span>(input), <span class="dt">w =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.2</span>,<span class="dv">0</span>, <span class="fl">0.2</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>, <span class="dv">0</span>,<span class="fl">0.2</span>,<span class="dv">0</span>), <span class="dt">ncol =</span> <span class="dv">3</span>), <span class="dt">pad =</span> pad, <span class="dt">padValue =</span> padValue)</span>
<span id="cb666-1074"><a href="all-r-code-in-this-book.html#cb666-1074" aria-hidden="true"></a>  ras &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">as.matrix</span>(ras)</span>
<span id="cb666-1075"><a href="all-r-code-in-this-book.html#cb666-1075" aria-hidden="true"></a>  ras[ras <span class="op">==</span><span class="st"> &quot;NaN&quot;</span>] &lt;-<span class="st"> </span><span class="dv">-999</span></span>
<span id="cb666-1076"><a href="all-r-code-in-this-book.html#cb666-1076" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">floor</span>(ras))</span>
<span id="cb666-1077"><a href="all-r-code-in-this-book.html#cb666-1077" aria-hidden="true"></a>}</span>
<span id="cb666-1078"><a href="all-r-code-in-this-book.html#cb666-1078" aria-hidden="true"></a></span>
<span id="cb666-1079"><a href="all-r-code-in-this-book.html#cb666-1079" aria-hidden="true"></a>brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1000</span>, <span class="dv">50</span>)</span>
<span id="cb666-1080"><a href="all-r-code-in-this-book.html#cb666-1080" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-1081"><a href="all-r-code-in-this-book.html#cb666-1081" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb666-1082"><a href="all-r-code-in-this-book.html#cb666-1082" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">30</span></span>
<span id="cb666-1083"><a href="all-r-code-in-this-book.html#cb666-1083" aria-hidden="true"></a>y =<span class="st"> </span><span class="fl">7.5</span></span>
<span id="cb666-1084"><a href="all-r-code-in-this-book.html#cb666-1084" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-1085"><a href="all-r-code-in-this-book.html#cb666-1085" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1086"><a href="all-r-code-in-this-book.html#cb666-1086" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">1.5</span>, <span class="fl">.5</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1087"><a href="all-r-code-in-this-book.html#cb666-1087" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1088"><a href="all-r-code-in-this-book.html#cb666-1088" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">m =</span> b1) <span class="co"># print text on left first stack</span></span>
<span id="cb666-1089"><a href="all-r-code-in-this-book.html#cb666-1089" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb666-1090"><a href="all-r-code-in-this-book.html#cb666-1090" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">23</span>, <span class="dv">2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b3), <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1091"><a href="all-r-code-in-this-book.html#cb666-1091" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">21.5</span>, <span class="fl">0.5</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b2), <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1092"><a href="all-r-code-in-this-book.html#cb666-1092" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b1), <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1093"><a href="all-r-code-in-this-book.html#cb666-1093" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b1)) <span class="co"># set pad = FALSE for -99</span></span>
<span id="cb666-1094"><a href="all-r-code-in-this-book.html#cb666-1094" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="dv">22</span>, <span class="dv">3</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb666-1095"><a href="all-r-code-in-this-book.html#cb666-1095" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="dv">11</span>, <span class="dv">4</span>, <span class="fl">17.5</span>, <span class="dv">4</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb666-1096"><a href="all-r-code-in-this-book.html#cb666-1096" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">3.5</span>, <span class="st">&quot;apply_kernel()&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.4</span>)</span>
<span id="cb666-1097"><a href="all-r-code-in-this-book.html#cb666-1097" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">13.8</span>, <span class="dv">1</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb666-1098"><a href="all-r-code-in-this-book.html#cb666-1098" aria-hidden="true"></a>cex =<span class="st"> </span><span class="fl">.8</span></span>
<span id="cb666-1099"><a href="all-r-code-in-this-book.html#cb666-1099" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1100"><a href="all-r-code-in-this-book.html#cb666-1100" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">13.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1101"><a href="all-r-code-in-this-book.html#cb666-1101" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">15.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1102"><a href="all-r-code-in-this-book.html#cb666-1102" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">2.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1103"><a href="all-r-code-in-this-book.html#cb666-1103" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1104"><a href="all-r-code-in-this-book.html#cb666-1104" aria-hidden="true"></a></span>
<span id="cb666-1105"><a href="all-r-code-in-this-book.html#cb666-1105" aria-hidden="true"></a>time_arrow_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span>),</span>
<span id="cb666-1106"><a href="all-r-code-in-this-book.html#cb666-1106" aria-hidden="true"></a>                           <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb666-1107"><a href="all-r-code-in-this-book.html#cb666-1107" aria-hidden="true"></a>time_arrow_flag_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>),</span>
<span id="cb666-1108"><a href="all-r-code-in-this-book.html#cb666-1108" aria-hidden="true"></a>                                <span class="kw">c</span>(<span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span>), <span class="kw">c</span>(<span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb666-1109"><a href="all-r-code-in-this-book.html#cb666-1109" aria-hidden="true"></a></span>
<span id="cb666-1110"><a href="all-r-code-in-this-book.html#cb666-1110" aria-hidden="true"></a>b11 &lt;-<span class="st"> </span>b2 <span class="op">-</span><span class="st"> </span>t1</span>
<span id="cb666-1111"><a href="all-r-code-in-this-book.html#cb666-1111" aria-hidden="true"></a>b12 &lt;-<span class="st"> </span>b1 <span class="op">-</span><span class="st"> </span>t2 <span class="op">+</span><span class="st"> </span>t1</span>
<span id="cb666-1112"><a href="all-r-code-in-this-book.html#cb666-1112" aria-hidden="true"></a></span>
<span id="cb666-1113"><a href="all-r-code-in-this-book.html#cb666-1113" aria-hidden="true"></a><span class="co"># png(&quot;exp_apply_ts.png&quot;, width = 2400, height = 1000, pointsize = 24)</span></span>
<span id="cb666-1114"><a href="all-r-code-in-this-book.html#cb666-1114" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-1115"><a href="all-r-code-in-this-book.html#cb666-1115" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb666-1116"><a href="all-r-code-in-this-book.html#cb666-1116" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">30</span></span>
<span id="cb666-1117"><a href="all-r-code-in-this-book.html#cb666-1117" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">10</span> <span class="co"># 7.5</span></span>
<span id="cb666-1118"><a href="all-r-code-in-this-book.html#cb666-1118" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-1119"><a href="all-r-code-in-this-book.html#cb666-1119" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">4.8</span>, <span class="fl">3.8</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1120"><a href="all-r-code-in-this-book.html#cb666-1120" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">4.8</span>, <span class="fl">3.8</span>, <span class="dt">m =</span> b3)</span>
<span id="cb666-1121"><a href="all-r-code-in-this-book.html#cb666-1121" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">3.6</span>, <span class="fl">2.6</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b11, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1122"><a href="all-r-code-in-this-book.html#cb666-1122" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">3.6</span>, <span class="fl">2.6</span>, <span class="dt">m =</span> b11)</span>
<span id="cb666-1123"><a href="all-r-code-in-this-book.html#cb666-1123" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">2.4</span>, <span class="fl">1.4</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b12, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1124"><a href="all-r-code-in-this-book.html#cb666-1124" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">2.4</span>, <span class="fl">1.4</span>, <span class="dt">m =</span> b12)</span>
<span id="cb666-1125"><a href="all-r-code-in-this-book.html#cb666-1125" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">1.2</span>, <span class="fl">.2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1126"><a href="all-r-code-in-this-book.html#cb666-1126" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">1.2</span>, <span class="fl">.2</span>, <span class="dt">m =</span> b2)</span>
<span id="cb666-1127"><a href="all-r-code-in-this-book.html#cb666-1127" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1128"><a href="all-r-code-in-this-book.html#cb666-1128" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">m =</span> b1) <span class="co"># print text on left first stack</span></span>
<span id="cb666-1129"><a href="all-r-code-in-this-book.html#cb666-1129" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">24.8</span>, <span class="fl">3.8</span>, <span class="dt">pal =</span> <span class="kw">alpha</span>(greys, <span class="fl">0.1</span>), <span class="dt">m =</span> <span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">42</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-1130"><a href="all-r-code-in-this-book.html#cb666-1130" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">23.6</span>, <span class="fl">2.6</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b12 <span class="op">+</span><span class="st"> </span>b11 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1131"><a href="all-r-code-in-this-book.html#cb666-1131" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">23.6</span>, <span class="fl">2.6</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b12 <span class="op">+</span><span class="st"> </span>b11 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb666-1132"><a href="all-r-code-in-this-book.html#cb666-1132" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">22.4</span>, <span class="fl">1.4</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b2 <span class="op">+</span><span class="st"> </span>b12 <span class="op">+</span><span class="st"> </span>b11) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1133"><a href="all-r-code-in-this-book.html#cb666-1133" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">22.4</span>, <span class="fl">1.4</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b2 <span class="op">+</span><span class="st"> </span>b12 <span class="op">+</span><span class="st"> </span>b11) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb666-1134"><a href="all-r-code-in-this-book.html#cb666-1134" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">21.2</span>, <span class="fl">.2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b12) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</span>
<span id="cb666-1135"><a href="all-r-code-in-this-book.html#cb666-1135" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">21.2</span>, <span class="fl">.2</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b12) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb666-1136"><a href="all-r-code-in-this-book.html#cb666-1136" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> <span class="kw">alpha</span>(greys, <span class="fl">0.1</span>), <span class="dt">m =</span> <span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">42</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb666-1137"><a href="all-r-code-in-this-book.html#cb666-1137" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">5.7</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>)</span>
<span id="cb666-1138"><a href="all-r-code-in-this-book.html#cb666-1138" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="fl">12.5</span>, <span class="dv">9</span>, <span class="dv">20</span>, <span class="dv">9</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1139"><a href="all-r-code-in-this-book.html#cb666-1139" aria-hidden="true"></a>cex =<span class="st"> </span><span class="fl">.9</span></span>
<span id="cb666-1140"><a href="all-r-code-in-this-book.html#cb666-1140" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">16.3</span>, <span class="fl">8.3</span>, <span class="st">&quot;apply_dimension(dimension = &#39;t&#39;)&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1141"><a href="all-r-code-in-this-book.html#cb666-1141" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">9.7</span>, <span class="fl">1.7</span>, time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>) <span class="co"># draw ma explanation</span></span>
<span id="cb666-1142"><a href="all-r-code-in-this-book.html#cb666-1142" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">-0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;496&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1143"><a href="all-r-code-in-this-book.html#cb666-1143" aria-hidden="true"></a><span class="kw">text</span>(.<span class="dv">7</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">.7</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;363&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1144"><a href="all-r-code-in-this-book.html#cb666-1144" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;658&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1145"><a href="all-r-code-in-this-book.html#cb666-1145" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;230&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1146"><a href="all-r-code-in-this-book.html#cb666-1146" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;525&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1147"><a href="all-r-code-in-this-book.html#cb666-1147" aria-hidden="true"></a>t_formula &lt;-<span class="st"> </span><span class="kw">expression</span>(<span class="st">&quot;t&quot;</span>[n]<span class="op">*</span><span class="st">&quot; = (t&quot;</span>[n<span class="dv">-1</span>]<span class="op">*</span><span class="st">&quot; + t&quot;</span>[n]<span class="op">*</span><span class="st">&quot; + t&quot;</span>[n<span class="op">+</span><span class="dv">1</span>]<span class="op">*</span><span class="st">&quot;) / 3&quot;</span>)</span>
<span id="cb666-1148"><a href="all-r-code-in-this-book.html#cb666-1148" aria-hidden="true"></a><span class="co"># text(13.8, 3, t_formula, srt = 45, cex = 1.2)</span></span>
<span id="cb666-1149"><a href="all-r-code-in-this-book.html#cb666-1149" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.4</span>, <span class="fl">3.6</span>, <span class="st">&quot;calculate moving average&quot;</span>, <span class="dt">srt =</span> <span class="dv">45</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1150"><a href="all-r-code-in-this-book.html#cb666-1150" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="dv">15</span>, <span class="fl">5.7</span>, <span class="dv">18</span>, <span class="fl">5.7</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1151"><a href="all-r-code-in-this-book.html#cb666-1151" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">15.4</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>) <span class="co"># draw ma explanation</span></span>
<span id="cb666-1152"><a href="all-r-code-in-this-book.html#cb666-1152" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">-0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;NA&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1153"><a href="all-r-code-in-this-book.html#cb666-1153" aria-hidden="true"></a><span class="kw">text</span>(.<span class="dv">7</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">.7</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;505&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1154"><a href="all-r-code-in-this-book.html#cb666-1154" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;417&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1155"><a href="all-r-code-in-this-book.html#cb666-1155" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;471&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1156"><a href="all-r-code-in-this-book.html#cb666-1156" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;NA&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb666-1157"><a href="all-r-code-in-this-book.html#cb666-1157" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">25.7</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>)</span>
<span id="cb666-1158"><a href="all-r-code-in-this-book.html#cb666-1158" aria-hidden="true"></a><span class="co"># reduce ----</span></span>
<span id="cb666-1159"><a href="all-r-code-in-this-book.html#cb666-1159" aria-hidden="true"></a></span>
<span id="cb666-1160"><a href="all-r-code-in-this-book.html#cb666-1160" aria-hidden="true"></a><span class="co"># calc mean over time</span></span>
<span id="cb666-1161"><a href="all-r-code-in-this-book.html#cb666-1161" aria-hidden="true"></a>timeB &lt;-<span class="st"> </span>(b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-1162"><a href="all-r-code-in-this-book.html#cb666-1162" aria-hidden="true"></a>timeG &lt;-<span class="st"> </span>(g1 <span class="op">+</span><span class="st"> </span>g2 <span class="op">+</span><span class="st"> </span>g3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-1163"><a href="all-r-code-in-this-book.html#cb666-1163" aria-hidden="true"></a>timeR &lt;-<span class="st"> </span>(r1 <span class="op">+</span><span class="st"> </span>r2 <span class="op">+</span><span class="st"> </span>r3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-1164"><a href="all-r-code-in-this-book.html#cb666-1164" aria-hidden="true"></a>timeN &lt;-<span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>n2 <span class="op">+</span><span class="st"> </span>n3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-1165"><a href="all-r-code-in-this-book.html#cb666-1165" aria-hidden="true"></a></span>
<span id="cb666-1166"><a href="all-r-code-in-this-book.html#cb666-1166" aria-hidden="true"></a>print_grid_time &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) { <span class="co"># 3x1, 28x7</span></span>
<span id="cb666-1167"><a href="all-r-code-in-this-book.html#cb666-1167" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> timeB)</span>
<span id="cb666-1168"><a href="all-r-code-in-this-book.html#cb666-1168" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> timeG)</span>
<span id="cb666-1169"><a href="all-r-code-in-this-book.html#cb666-1169" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> timeR)</span>
<span id="cb666-1170"><a href="all-r-code-in-this-book.html#cb666-1170" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> timeN)</span>
<span id="cb666-1171"><a href="all-r-code-in-this-book.html#cb666-1171" aria-hidden="true"></a>}</span>
<span id="cb666-1172"><a href="all-r-code-in-this-book.html#cb666-1172" aria-hidden="true"></a></span>
<span id="cb666-1173"><a href="all-r-code-in-this-book.html#cb666-1173" aria-hidden="true"></a><span class="co"># calc ndvi</span></span>
<span id="cb666-1174"><a href="all-r-code-in-this-book.html#cb666-1174" aria-hidden="true"></a>ndvi1 &lt;-<span class="st"> </span>(n1 <span class="op">-</span><span class="st"> </span>r1) <span class="op">/</span><span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>r1)</span>
<span id="cb666-1175"><a href="all-r-code-in-this-book.html#cb666-1175" aria-hidden="true"></a>ndvi2 &lt;-<span class="st"> </span>(n2 <span class="op">-</span><span class="st"> </span>r2) <span class="op">/</span><span class="st"> </span>(n2 <span class="op">+</span><span class="st"> </span>r2)</span>
<span id="cb666-1176"><a href="all-r-code-in-this-book.html#cb666-1176" aria-hidden="true"></a>ndvi3 &lt;-<span class="st"> </span>(n3 <span class="op">-</span><span class="st"> </span>r3) <span class="op">/</span><span class="st"> </span>(n3 <span class="op">+</span><span class="st"> </span>r3)</span>
<span id="cb666-1177"><a href="all-r-code-in-this-book.html#cb666-1177" aria-hidden="true"></a></span>
<span id="cb666-1178"><a href="all-r-code-in-this-book.html#cb666-1178" aria-hidden="true"></a>print_grid_bands &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">pal =</span> greys) { <span class="co"># 1x3 6x27</span></span>
<span id="cb666-1179"><a href="all-r-code-in-this-book.html#cb666-1179" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi1)</span>
<span id="cb666-1180"><a href="all-r-code-in-this-book.html#cb666-1180" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi2)</span>
<span id="cb666-1181"><a href="all-r-code-in-this-book.html#cb666-1181" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi3)</span>
<span id="cb666-1182"><a href="all-r-code-in-this-book.html#cb666-1182" aria-hidden="true"></a>}</span>
<span id="cb666-1183"><a href="all-r-code-in-this-book.html#cb666-1183" aria-hidden="true"></a></span>
<span id="cb666-1184"><a href="all-r-code-in-this-book.html#cb666-1184" aria-hidden="true"></a>plte =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>, pal, m) {</span>
<span id="cb666-1185"><a href="all-r-code-in-this-book.html#cb666-1185" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb666-1186"><a href="all-r-code-in-this-book.html#cb666-1186" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb666-1187"><a href="all-r-code-in-this-book.html#cb666-1187" aria-hidden="true"></a>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb666-1188"><a href="all-r-code-in-this-book.html#cb666-1188" aria-hidden="true"></a>  <span class="co"># dim(m) = c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb666-1189"><a href="all-r-code-in-this-book.html#cb666-1189" aria-hidden="true"></a>  <span class="co"># s[[1]] = m</span></span>
<span id="cb666-1190"><a href="all-r-code-in-this-book.html#cb666-1190" aria-hidden="true"></a>  <span class="co"># me &lt;- floor(mean(s[[1]]))</span></span>
<span id="cb666-1191"><a href="all-r-code-in-this-book.html#cb666-1191" aria-hidden="true"></a>  me &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">mean</span>(m))</span>
<span id="cb666-1192"><a href="all-r-code-in-this-book.html#cb666-1192" aria-hidden="true"></a>  <span class="cf">if</span> (me[<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>) { <span class="co"># in case non-artificial grids with very high</span></span>
<span id="cb666-1193"><a href="all-r-code-in-this-book.html#cb666-1193" aria-hidden="true"></a>    me &lt;-<span class="st"> </span>m <span class="op">/</span><span class="st"> </span><span class="dv">10</span>     <span class="co"># numbers are used, make them smaller</span></span>
<span id="cb666-1194"><a href="all-r-code-in-this-book.html#cb666-1194" aria-hidden="true"></a>    me &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">mean</span>(me))</span>
<span id="cb666-1195"><a href="all-r-code-in-this-book.html#cb666-1195" aria-hidden="true"></a>  }</span>
<span id="cb666-1196"><a href="all-r-code-in-this-book.html#cb666-1196" aria-hidden="true"></a>  <span class="kw">text</span>(x,y,me,<span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1197"><a href="all-r-code-in-this-book.html#cb666-1197" aria-hidden="true"></a>}</span>
<span id="cb666-1198"><a href="all-r-code-in-this-book.html#cb666-1198" aria-hidden="true"></a></span>
<span id="cb666-1199"><a href="all-r-code-in-this-book.html#cb666-1199" aria-hidden="true"></a>print_grid_spat &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb666-1200"><a href="all-r-code-in-this-book.html#cb666-1200" aria-hidden="true"></a>  x =<span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-1201"><a href="all-r-code-in-this-book.html#cb666-1201" aria-hidden="true"></a>  y =<span class="st"> </span>y <span class="op">+</span><span class="st"> </span><span class="fl">3.5</span></span>
<span id="cb666-1202"><a href="all-r-code-in-this-book.html#cb666-1202" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</span>
<span id="cb666-1203"><a href="all-r-code-in-this-book.html#cb666-1203" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</span>
<span id="cb666-1204"><a href="all-r-code-in-this-book.html#cb666-1204" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb666-1205"><a href="all-r-code-in-this-book.html#cb666-1205" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</span>
<span id="cb666-1206"><a href="all-r-code-in-this-book.html#cb666-1206" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</span>
<span id="cb666-1207"><a href="all-r-code-in-this-book.html#cb666-1207" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb666-1208"><a href="all-r-code-in-this-book.html#cb666-1208" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</span>
<span id="cb666-1209"><a href="all-r-code-in-this-book.html#cb666-1209" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</span>
<span id="cb666-1210"><a href="all-r-code-in-this-book.html#cb666-1210" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb666-1211"><a href="all-r-code-in-this-book.html#cb666-1211" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</span>
<span id="cb666-1212"><a href="all-r-code-in-this-book.html#cb666-1212" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</span>
<span id="cb666-1213"><a href="all-r-code-in-this-book.html#cb666-1213" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb666-1214"><a href="all-r-code-in-this-book.html#cb666-1214" aria-hidden="true"></a>}</span>
<span id="cb666-1215"><a href="all-r-code-in-this-book.html#cb666-1215" aria-hidden="true"></a></span>
<span id="cb666-1216"><a href="all-r-code-in-this-book.html#cb666-1216" aria-hidden="true"></a><span class="co"># png(&quot;exp_reduce.png&quot;, width = 1200, height = 1000, pointsize = 32)</span></span>
<span id="cb666-1217"><a href="all-r-code-in-this-book.html#cb666-1217" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-1218"><a href="all-r-code-in-this-book.html#cb666-1218" aria-hidden="true"></a><span class="co">#par(mar = c(3,3,3,3))</span></span>
<span id="cb666-1219"><a href="all-r-code-in-this-book.html#cb666-1219" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb666-1220"><a href="all-r-code-in-this-book.html#cb666-1220" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">120</span></span>
<span id="cb666-1221"><a href="all-r-code-in-this-book.html#cb666-1221" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb666-1222"><a href="all-r-code-in-this-book.html#cb666-1222" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-1223"><a href="all-r-code-in-this-book.html#cb666-1223" aria-hidden="true"></a><span class="kw">print_grid</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-27</span>)</span>
<span id="cb666-1224"><a href="all-r-code-in-this-book.html#cb666-1224" aria-hidden="true"></a><span class="co"># print_alpha_grid((x/3-28)/2, 0) # alpha grid</span></span>
<span id="cb666-1225"><a href="all-r-code-in-this-book.html#cb666-1225" aria-hidden="true"></a><span class="kw">print_grid_time</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>) <span class="co"># off = 5.5</span></span>
<span id="cb666-1226"><a href="all-r-code-in-this-book.html#cb666-1226" aria-hidden="true"></a><span class="co"># print_alpha_grid(x/3+((x/3-6)/2) -10.5, 0) # alpha grid</span></span>
<span id="cb666-1227"><a href="all-r-code-in-this-book.html#cb666-1227" aria-hidden="true"></a><span class="kw">print_grid_bands</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3-6</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>)</span>
<span id="cb666-1228"><a href="all-r-code-in-this-book.html#cb666-1228" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dt">alp =</span> <span class="dv">0</span>, <span class="dt">geom =</span> <span class="ot">TRUE</span>) <span class="co"># alpha grid</span></span>
<span id="cb666-1229"><a href="all-r-code-in-this-book.html#cb666-1229" aria-hidden="true"></a><span class="kw">print_grid_spat</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>)</span>
<span id="cb666-1230"><a href="all-r-code-in-this-book.html#cb666-1230" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1231"><a href="all-r-code-in-this-book.html#cb666-1231" aria-hidden="true"></a><span class="co">#segments(3.6, 8, 3.7, 19, col = &quot;red&quot;, lwd=3)</span></span>
<span id="cb666-1232"><a href="all-r-code-in-this-book.html#cb666-1232" aria-hidden="true"></a><span class="kw">segments</span>(<span class="fl">3.4</span>, <span class="dv">8</span>, <span class="fl">3.4</span>, <span class="dv">19</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb666-1233"><a href="all-r-code-in-this-book.html#cb666-1233" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">43</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1234"><a href="all-r-code-in-this-book.html#cb666-1234" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">83</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1235"><a href="all-r-code-in-this-book.html#cb666-1235" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">20</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1236"><a href="all-r-code-in-this-book.html#cb666-1236" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1237"><a href="all-r-code-in-this-book.html#cb666-1237" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">53</span>,<span class="fl">29.8</span>, <span class="dv">67</span>,<span class="fl">29.8</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb666-1238"><a href="all-r-code-in-this-book.html#cb666-1238" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">100</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1239"><a href="all-r-code-in-this-book.html#cb666-1239" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">30</span>, <span class="dv">7</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1240"><a href="all-r-code-in-this-book.html#cb666-1240" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">36</span>, <span class="dv">13</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1241"><a href="all-r-code-in-this-book.html#cb666-1241" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">-3</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1242"><a href="all-r-code-in-this-book.html#cb666-1242" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">66</span>, <span class="dv">3</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1243"><a href="all-r-code-in-this-book.html#cb666-1243" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">110</span>, <span class="dv">-3</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1244"><a href="all-r-code-in-this-book.html#cb666-1244" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">116</span>, <span class="dv">3</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1245"><a href="all-r-code-in-this-book.html#cb666-1245" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">108</span>,<span class="op">-</span><span class="fl">2.4</span>, <span class="dv">112</span>,<span class="op">-</span><span class="fl">3.2</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb666-1246"><a href="all-r-code-in-this-book.html#cb666-1246" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">114</span>,<span class="fl">3.2</span>, <span class="dv">118</span>,<span class="fl">2.4</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb666-1247"><a href="all-r-code-in-this-book.html#cb666-1247" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, y<span class="op">+</span><span class="dv">4</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># dim names on main</span></span>
<span id="cb666-1248"><a href="all-r-code-in-this-book.html#cb666-1248" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">43</span>, y<span class="dv">-14</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1249"><a href="all-r-code-in-this-book.html#cb666-1249" aria-hidden="true"></a><span class="kw">text</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span>, y<span class="dv">-30</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1250"><a href="all-r-code-in-this-book.html#cb666-1250" aria-hidden="true"></a><span class="kw">text</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">30</span>, y<span class="dv">-24</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1251"><a href="all-r-code-in-this-book.html#cb666-1251" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">6</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1252"><a href="all-r-code-in-this-book.html#cb666-1252" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">2</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1253"><a href="all-r-code-in-this-book.html#cb666-1253" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, <span class="dv">100</span>, <span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1254"><a href="all-r-code-in-this-book.html#cb666-1254" aria-hidden="true"></a><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span id="cb666-1255"><a href="all-r-code-in-this-book.html#cb666-1255" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">28.5</span>,<span class="dv">49</span>, <span class="st">&quot;reduce temporally&quot;</span>, <span class="dt">srt =</span> <span class="fl">55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1256"><a href="all-r-code-in-this-book.html#cb666-1256" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>,<span class="dv">49</span>, <span class="st">&quot;reduce bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1257"><a href="all-r-code-in-this-book.html#cb666-1257" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">91.5</span>,<span class="dv">49</span>, <span class="st">&quot;reduce spatially&quot;</span>, <span class="dt">srt =</span> <span class="fl">-55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb666-1258"><a href="all-r-code-in-this-book.html#cb666-1258" aria-hidden="true"></a><span class="co"># aggregate ----</span></span>
<span id="cb666-1259"><a href="all-r-code-in-this-book.html#cb666-1259" aria-hidden="true"></a></span>
<span id="cb666-1260"><a href="all-r-code-in-this-book.html#cb666-1260" aria-hidden="true"></a>mask_agg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb666-1261"><a href="all-r-code-in-this-book.html#cb666-1261" aria-hidden="true"></a>                 <span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb666-1262"><a href="all-r-code-in-this-book.html#cb666-1262" aria-hidden="true"></a>                  <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb666-1263"><a href="all-r-code-in-this-book.html#cb666-1263" aria-hidden="true"></a>                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb666-1264"><a href="all-r-code-in-this-book.html#cb666-1264" aria-hidden="true"></a>                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb666-1265"><a href="all-r-code-in-this-book.html#cb666-1265" aria-hidden="true"></a>                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb666-1266"><a href="all-r-code-in-this-book.html#cb666-1266" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb666-1267"><a href="all-r-code-in-this-book.html#cb666-1267" aria-hidden="true"></a></span>
<span id="cb666-1268"><a href="all-r-code-in-this-book.html#cb666-1268" aria-hidden="true"></a>pl_stack_agg =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, nrM, <span class="dt">imgY =</span> <span class="dv">7</span>, <span class="dt">inner =</span> <span class="dv">1</span>) {</span>
<span id="cb666-1269"><a href="all-r-code-in-this-book.html#cb666-1269" aria-hidden="true"></a>  <span class="co"># pl_stack that masks the added matrices</span></span>
<span id="cb666-1270"><a href="all-r-code-in-this-book.html#cb666-1270" aria-hidden="true"></a>  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span id="cb666-1271"><a href="all-r-code-in-this-book.html#cb666-1271" aria-hidden="true"></a>  <span class="co"># prints all 4 bands at once</span></span>
<span id="cb666-1272"><a href="all-r-code-in-this-book.html#cb666-1272" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb666-1273"><a href="all-r-code-in-this-book.html#cb666-1273" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb666-1274"><a href="all-r-code-in-this-book.html#cb666-1274" aria-hidden="true"></a>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb666-1275"><a href="all-r-code-in-this-book.html#cb666-1275" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, nrM)))</span>
<span id="cb666-1276"><a href="all-r-code-in-this-book.html#cb666-1276" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb666-1277"><a href="all-r-code-in-this-book.html#cb666-1277" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)] <span class="co"># turn around to have same orientation as flat plot</span></span>
<span id="cb666-1278"><a href="all-r-code-in-this-book.html#cb666-1278" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> purples)</span>
<span id="cb666-1279"><a href="all-r-code-in-this-book.html#cb666-1279" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, nrM)))</span>
<span id="cb666-1280"><a href="all-r-code-in-this-book.html#cb666-1280" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb666-1281"><a href="all-r-code-in-this-book.html#cb666-1281" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb666-1282"><a href="all-r-code-in-this-book.html#cb666-1282" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> reds)</span>
<span id="cb666-1283"><a href="all-r-code-in-this-book.html#cb666-1283" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;g&quot;</span>, nrM)))</span>
<span id="cb666-1284"><a href="all-r-code-in-this-book.html#cb666-1284" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb666-1285"><a href="all-r-code-in-this-book.html#cb666-1285" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb666-1286"><a href="all-r-code-in-this-book.html#cb666-1286" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> greens)</span>
<span id="cb666-1287"><a href="all-r-code-in-this-book.html#cb666-1287" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;b&quot;</span>, nrM)))</span>
<span id="cb666-1288"><a href="all-r-code-in-this-book.html#cb666-1288" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb666-1289"><a href="all-r-code-in-this-book.html#cb666-1289" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb666-1290"><a href="all-r-code-in-this-book.html#cb666-1290" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span><span class="op">*</span>inner, <span class="ot">TRUE</span>, <span class="dt">pal =</span> blues) <span class="co"># li FALSE</span></span>
<span id="cb666-1291"><a href="all-r-code-in-this-book.html#cb666-1291" aria-hidden="true"></a>}</span>
<span id="cb666-1292"><a href="all-r-code-in-this-book.html#cb666-1292" aria-hidden="true"></a></span>
<span id="cb666-1293"><a href="all-r-code-in-this-book.html#cb666-1293" aria-hidden="true"></a>polygon_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>), <span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>),</span>
<span id="cb666-1294"><a href="all-r-code-in-this-book.html#cb666-1294" aria-hidden="true"></a>                      <span class="kw">c</span>(<span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>, <span class="fl">0.0</span>), <span class="kw">c</span>(<span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>, <span class="fl">0.0</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb666-1295"><a href="all-r-code-in-this-book.html#cb666-1295" aria-hidden="true"></a></span>
<span id="cb666-1296"><a href="all-r-code-in-this-book.html#cb666-1296" aria-hidden="true"></a>a &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>, <span class="fl">-1.14</span>, <span class="fl">-2.28</span>)</span>
<span id="cb666-1297"><a href="all-r-code-in-this-book.html#cb666-1297" aria-hidden="true"></a></span>
<span id="cb666-1298"><a href="all-r-code-in-this-book.html#cb666-1298" aria-hidden="true"></a>print_vector_content &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">cex =</span> <span class="fl">0.8</span>) {</span>
<span id="cb666-1299"><a href="all-r-code-in-this-book.html#cb666-1299" aria-hidden="true"></a>  vec &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">rnorm</span>(<span class="dv">8</span>, <span class="dv">250</span>, <span class="dv">100</span>))</span>
<span id="cb666-1300"><a href="all-r-code-in-this-book.html#cb666-1300" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x,<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">1</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1301"><a href="all-r-code-in-this-book.html#cb666-1301" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">8</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">2</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1302"><a href="all-r-code-in-this-book.html#cb666-1302" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">4</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">3</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1303"><a href="all-r-code-in-this-book.html#cb666-1303" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">4</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1304"><a href="all-r-code-in-this-book.html#cb666-1304" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x,<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">5</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1305"><a href="all-r-code-in-this-book.html#cb666-1305" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">8</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">6</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1306"><a href="all-r-code-in-this-book.html#cb666-1306" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">4</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">7</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1307"><a href="all-r-code-in-this-book.html#cb666-1307" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">8</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb666-1308"><a href="all-r-code-in-this-book.html#cb666-1308" aria-hidden="true"></a>}</span>
<span id="cb666-1309"><a href="all-r-code-in-this-book.html#cb666-1309" aria-hidden="true"></a></span>
<span id="cb666-1310"><a href="all-r-code-in-this-book.html#cb666-1310" aria-hidden="true"></a>print_ts &lt;-<span class="st"> </span><span class="cf">function</span>(off2, yoff2) {</span>
<span id="cb666-1311"><a href="all-r-code-in-this-book.html#cb666-1311" aria-hidden="true"></a>  <span class="kw">pl_stack</span>(s, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">3</span>) <span class="co"># input 2</span></span>
<span id="cb666-1312"><a href="all-r-code-in-this-book.html#cb666-1312" aria-hidden="true"></a>  <span class="kw">pl_stack</span>(s, off <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">2</span>)</span>
<span id="cb666-1313"><a href="all-r-code-in-this-book.html#cb666-1313" aria-hidden="true"></a>  <span class="kw">pl_stack</span>(s, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">1</span>)</span>
<span id="cb666-1314"><a href="all-r-code-in-this-book.html#cb666-1314" aria-hidden="true"></a>  <span class="kw">arrows</span>(<span class="op">-</span><span class="dv">13</span> <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span> <span class="op">+</span><span class="st"> </span>yoff2, <span class="dv">72</span> <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span> <span class="op">+</span><span class="st"> </span>yoff2, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)  <span class="co"># timeline</span></span>
<span id="cb666-1315"><a href="all-r-code-in-this-book.html#cb666-1315" aria-hidden="true"></a>  heads &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">3.5</span><span class="op">+</span>off2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2,<span class="dv">14</span><span class="op">+</span>yoff2,<span class="dv">14</span><span class="op">+</span>yoff2), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb666-1316"><a href="all-r-code-in-this-book.html#cb666-1316" aria-hidden="true"></a>  <span class="kw">points</span>(heads, <span class="dt">pch =</span> <span class="dv">16</span>) <span class="co"># 4 or 16</span></span>
<span id="cb666-1317"><a href="all-r-code-in-this-book.html#cb666-1317" aria-hidden="true"></a>  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>)<span class="op">+</span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span><span class="op">+</span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># first stack pyramid</span></span>
<span id="cb666-1318"><a href="all-r-code-in-this-book.html#cb666-1318" aria-hidden="true"></a>  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># second stack pyramid</span></span>
<span id="cb666-1319"><a href="all-r-code-in-this-book.html#cb666-1319" aria-hidden="true"></a>  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># third stack pyramid</span></span>
<span id="cb666-1320"><a href="all-r-code-in-this-book.html#cb666-1320" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">7.5</span><span class="op">+</span>off2, <span class="fl">4.3</span><span class="op">+</span>yoff2, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</span>
<span id="cb666-1321"><a href="all-r-code-in-this-book.html#cb666-1321" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="op">-</span><span class="fl">9.5</span><span class="op">+</span>off2, <span class="fl">-2.5</span><span class="op">+</span>yoff2, <span class="st">&quot;bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</span>
<span id="cb666-1322"><a href="all-r-code-in-this-book.html#cb666-1322" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="op">-</span><span class="fl">4.5</span><span class="op">+</span>off2, <span class="dv">2</span><span class="op">+</span>yoff2, <span class="st">&quot;y&quot;</span>, <span class="dt">srt =</span> <span class="fl">27.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</span>
<span id="cb666-1323"><a href="all-r-code-in-this-book.html#cb666-1323" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="dv">69</span><span class="op">+</span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2<span class="op">+</span><span class="dv">1</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1324"><a href="all-r-code-in-this-book.html#cb666-1324" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">3.5</span><span class="op">+</span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1325"><a href="all-r-code-in-this-book.html#cb666-1325" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1326"><a href="all-r-code-in-this-book.html#cb666-1326" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb666-1327"><a href="all-r-code-in-this-book.html#cb666-1327" aria-hidden="true"></a>}</span>
<span id="cb666-1328"><a href="all-r-code-in-this-book.html#cb666-1328" aria-hidden="true"></a></span>
<span id="cb666-1329"><a href="all-r-code-in-this-book.html#cb666-1329" aria-hidden="true"></a>secText =<span class="st"> </span><span class="fl">0.8</span> <span class="co"># secondary text size (dimension naming)</span></span>
<span id="cb666-1330"><a href="all-r-code-in-this-book.html#cb666-1330" aria-hidden="true"></a>off =<span class="st"> </span><span class="dv">26</span> <span class="co"># image stacks are always 26 apart</span></span>
<span id="cb666-1331"><a href="all-r-code-in-this-book.html#cb666-1331" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">72</span> <span class="co"># png X</span></span>
<span id="cb666-1332"><a href="all-r-code-in-this-book.html#cb666-1332" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">48</span> <span class="co"># png Y</span></span>
<span id="cb666-1333"><a href="all-r-code-in-this-book.html#cb666-1333" aria-hidden="true"></a>yoff =<span class="st"> </span><span class="dv">30</span></span>
<span id="cb666-1334"><a href="all-r-code-in-this-book.html#cb666-1334" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-1335"><a href="all-r-code-in-this-book.html#cb666-1335" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb666-1336"><a href="all-r-code-in-this-book.html#cb666-1336" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-1337"><a href="all-r-code-in-this-book.html#cb666-1337" aria-hidden="true"></a><span class="kw">print_ts</span>(<span class="dv">5</span>, yoff)</span>
<span id="cb666-1338"><a href="all-r-code-in-this-book.html#cb666-1338" aria-hidden="true"></a>col =<span class="st"> &#39;#ff5555&#39;</span></span>
<span id="cb666-1339"><a href="all-r-code-in-this-book.html#cb666-1339" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">10.57</span>, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1340"><a href="all-r-code-in-this-book.html#cb666-1340" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb666-1341"><a href="all-r-code-in-this-book.html#cb666-1341" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1342"><a href="all-r-code-in-this-book.html#cb666-1342" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">10.57</span><span class="op">+</span>off, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1343"><a href="all-r-code-in-this-book.html#cb666-1343" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span>off</span>
<span id="cb666-1344"><a href="all-r-code-in-this-book.html#cb666-1344" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1345"><a href="all-r-code-in-this-book.html#cb666-1345" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">10.57</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>off, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1346"><a href="all-r-code-in-this-book.html#cb666-1346" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>off</span>
<span id="cb666-1347"><a href="all-r-code-in-this-book.html#cb666-1347" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1348"><a href="all-r-code-in-this-book.html#cb666-1348" aria-hidden="true"></a><span class="co"># old 75 28 poly 86.25, 27.15</span></span>
<span id="cb666-1349"><a href="all-r-code-in-this-book.html#cb666-1349" aria-hidden="true"></a><span class="kw">pl_stack_agg</span>(a, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">nrM =</span> <span class="dv">1</span>, <span class="dt">inner =</span> <span class="dv">3</span>) <span class="co"># print masked enlargement</span></span>
<span id="cb666-1350"><a href="all-r-code-in-this-book.html#cb666-1350" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">16.25</span>, <span class="fl">7.15</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">by =</span> <span class="dv">2</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1351"><a href="all-r-code-in-this-book.html#cb666-1351" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb666-1352"><a href="all-r-code-in-this-book.html#cb666-1352" aria-hidden="true"></a>y &lt;-<span class="st"> </span><span class="dv">8</span></span>
<span id="cb666-1353"><a href="all-r-code-in-this-book.html#cb666-1353" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="fl">-2.6</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">2</span>)<span class="op">+</span>y, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-2.6</span>, <span class="dv">2</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>)<span class="op">+</span>y, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col) <span class="co"># line in large</span></span>
<span id="cb666-1354"><a href="all-r-code-in-this-book.html#cb666-1354" aria-hidden="true"></a><span class="kw">segments</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">25</span>, <span class="dv">-7</span>, <span class="dv">9</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-1355"><a href="all-r-code-in-this-book.html#cb666-1355" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">21</span>, <span class="dv">29</span>, <span class="fl">27.5</span>, <span class="dv">14</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-1356"><a href="all-r-code-in-this-book.html#cb666-1356" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="st">&quot;1. Group by geometry&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</span>
<span id="cb666-1357"><a href="all-r-code-in-this-book.html#cb666-1357" aria-hidden="true"></a>vecM &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">8</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb666-1358"><a href="all-r-code-in-this-book.html#cb666-1358" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>, <span class="dv">21</span>, <span class="st">&quot;2. Reduce to vector cube&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</span>
<span id="cb666-1359"><a href="all-r-code-in-this-book.html#cb666-1359" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">4</span>, <span class="dv">0</span>)</span>
<span id="cb666-1360"><a href="all-r-code-in-this-book.html#cb666-1360" aria-hidden="true"></a><span class="kw">pl</span>(b, <span class="dv">48</span>, <span class="dv">-5</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</span>
<span id="cb666-1361"><a href="all-r-code-in-this-book.html#cb666-1361" aria-hidden="true"></a><span class="kw">print_vector_content</span>(<span class="dv">54</span>, <span class="dv">-3</span>)</span>
<span id="cb666-1362"><a href="all-r-code-in-this-book.html#cb666-1362" aria-hidden="true"></a><span class="kw">pl</span>(b, <span class="fl">46.5</span>, <span class="fl">-3.5</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</span>
<span id="cb666-1363"><a href="all-r-code-in-this-book.html#cb666-1363" aria-hidden="true"></a><span class="kw">print_vector_content</span>(<span class="fl">52.5</span>, <span class="fl">-1.5</span>)</span>
<span id="cb666-1364"><a href="all-r-code-in-this-book.html#cb666-1364" aria-hidden="true"></a><span class="kw">pl</span>(b, <span class="dv">45</span>, <span class="dv">-2</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</span>
<span id="cb666-1365"><a href="all-r-code-in-this-book.html#cb666-1365" aria-hidden="true"></a><span class="kw">print_vector_content</span>(<span class="dv">51</span>, <span class="dv">0</span>)</span>
<span id="cb666-1366"><a href="all-r-code-in-this-book.html#cb666-1366" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">51.5</span>, <span class="dv">15</span>, <span class="st">&quot;Line_1&quot;</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1367"><a href="all-r-code-in-this-book.html#cb666-1367" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">63</span>, <span class="dv">15</span>, <span class="st">&quot;Polygon_1&quot;</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1368"><a href="all-r-code-in-this-book.html#cb666-1368" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>, <span class="fl">17.5</span>, <span class="st">&quot;Geometries&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb666-1369"><a href="all-r-code-in-this-book.html#cb666-1369" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>, <span class="dv">12</span>, <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb666-1370"><a href="all-r-code-in-this-book.html#cb666-1370" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">8</span>, <span class="st">&quot;green&quot;</span>)</span>
<span id="cb666-1371"><a href="all-r-code-in-this-book.html#cb666-1371" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">4</span>, <span class="st">&quot;red&quot;</span>)</span>
<span id="cb666-1372"><a href="all-r-code-in-this-book.html#cb666-1372" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">0</span>, <span class="st">&quot;nir&quot;</span>)</span>
<span id="cb666-1373"><a href="all-r-code-in-this-book.html#cb666-1373" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">38</span>, <span class="dv">6</span>, <span class="st">&quot;Bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb666-1374"><a href="all-r-code-in-this-book.html#cb666-1374" aria-hidden="true"></a><span class="co"># arrows(13.5, -2, 13.5, -6, angle = 20, lwd = 3)</span></span>
<span id="cb666-1375"><a href="all-r-code-in-this-book.html#cb666-1375" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">72</span>, <span class="fl">15.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">315</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb666-1376"><a href="all-r-code-in-this-book.html#cb666-1376" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="fl">69.5</span>, <span class="dv">15</span>, <span class="fl">72.5</span>, <span class="dv">12</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1377"><a href="all-r-code-in-this-book.html#cb666-1377" aria-hidden="true"></a><span class="co"># print_segments(30, 35, seg = arrow_seg)</span></span>
<span id="cb666-1378"><a href="all-r-code-in-this-book.html#cb666-1378" aria-hidden="true"></a></span>
<span id="cb666-1379"><a href="all-r-code-in-this-book.html#cb666-1379" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1331</span>)</span>
<span id="cb666-1380"><a href="all-r-code-in-this-book.html#cb666-1380" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-1381"><a href="all-r-code-in-this-book.html#cb666-1381" aria-hidden="true"></a><span class="kw">library</span>(colorspace)</span>
<span id="cb666-1382"><a href="all-r-code-in-this-book.html#cb666-1382" aria-hidden="true"></a>tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb666-1383"><a href="all-r-code-in-this-book.html#cb666-1383" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</span>
<span id="cb666-1384"><a href="all-r-code-in-this-book.html#cb666-1384" aria-hidden="true"></a></span>
<span id="cb666-1385"><a href="all-r-code-in-this-book.html#cb666-1385" aria-hidden="true"></a>nrow =<span class="st"> </span><span class="dv">5</span></span>
<span id="cb666-1386"><a href="all-r-code-in-this-book.html#cb666-1386" aria-hidden="true"></a>ncol =<span class="st"> </span><span class="dv">8</span></span>
<span id="cb666-1387"><a href="all-r-code-in-this-book.html#cb666-1387" aria-hidden="true"></a><span class="co">#m = matrix(runif(nrow * ncol), nrow = nrow, ncol = ncol)</span></span>
<span id="cb666-1388"><a href="all-r-code-in-this-book.html#cb666-1388" aria-hidden="true"></a>m =<span class="st"> </span>r[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>nrow,<span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb666-1389"><a href="all-r-code-in-this-book.html#cb666-1389" aria-hidden="true"></a><span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb666-1390"><a href="all-r-code-in-this-book.html#cb666-1390" aria-hidden="true"></a>s =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</span>
<span id="cb666-1391"><a href="all-r-code-in-this-book.html#cb666-1391" aria-hidden="true"></a><span class="co"># s</span></span>
<span id="cb666-1392"><a href="all-r-code-in-this-book.html#cb666-1392" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="dv">3</span> </span>
<span id="cb666-1393"><a href="all-r-code-in-this-book.html#cb666-1393" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="fl">-.5</span></span>
<span id="cb666-1394"><a href="all-r-code-in-this-book.html#cb666-1394" aria-hidden="true"></a><span class="kw">attr</span>(<span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span>)</span>
<span id="cb666-1395"><a href="all-r-code-in-this-book.html#cb666-1395" aria-hidden="true"></a></span>
<span id="cb666-1396"><a href="all-r-code-in-this-book.html#cb666-1396" aria-hidden="true"></a>plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb666-1397"><a href="all-r-code-in-this-book.html#cb666-1397" aria-hidden="true"></a>    <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset </span>
<span id="cb666-1398"><a href="all-r-code-in-this-book.html#cb666-1398" aria-hidden="true"></a>    l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1399"><a href="all-r-code-in-this-book.html#cb666-1399" aria-hidden="true"></a>    pal =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>)</span>
<span id="cb666-1400"><a href="all-r-code-in-this-book.html#cb666-1400" aria-hidden="true"></a>    <span class="cf">if</span> (li)</span>
<span id="cb666-1401"><a href="all-r-code-in-this-book.html#cb666-1401" aria-hidden="true"></a>        pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb666-1402"><a href="all-r-code-in-this-book.html#cb666-1402" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</span>
<span id="cb666-1403"><a href="all-r-code-in-this-book.html#cb666-1403" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb666-1404"><a href="all-r-code-in-this-book.html#cb666-1404" aria-hidden="true"></a>    <span class="cf">else</span></span>
<span id="cb666-1405"><a href="all-r-code-in-this-book.html#cb666-1405" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>))</span>
<span id="cb666-1406"><a href="all-r-code-in-this-book.html#cb666-1406" aria-hidden="true"></a>    u =<span class="st"> </span><span class="kw">st_union</span>(l)</span>
<span id="cb666-1407"><a href="all-r-code-in-this-book.html#cb666-1407" aria-hidden="true"></a>    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</span>
<span id="cb666-1408"><a href="all-r-code-in-this-book.html#cb666-1408" aria-hidden="true"></a>}</span>
<span id="cb666-1409"><a href="all-r-code-in-this-book.html#cb666-1409" aria-hidden="true"></a></span>
<span id="cb666-1410"><a href="all-r-code-in-this-book.html#cb666-1410" aria-hidden="true"></a>pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb666-1411"><a href="all-r-code-in-this-book.html#cb666-1411" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb666-1412"><a href="all-r-code-in-this-book.html#cb666-1412" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb666-1413"><a href="all-r-code-in-this-book.html#cb666-1413" aria-hidden="true"></a>  m =<span class="st"> </span>r[[<span class="dv">1</span>]][y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow,x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb666-1414"><a href="all-r-code-in-this-book.html#cb666-1414" aria-hidden="true"></a>  <span class="cf">if</span> (randomize)</span>
<span id="cb666-1415"><a href="all-r-code-in-this-book.html#cb666-1415" aria-hidden="true"></a>    m =<span class="st"> </span>m[<span class="kw">sample</span>(y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow),x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol]</span>
<span id="cb666-1416"><a href="all-r-code-in-this-book.html#cb666-1416" aria-hidden="true"></a>  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb666-1417"><a href="all-r-code-in-this-book.html#cb666-1417" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</span>
<span id="cb666-1418"><a href="all-r-code-in-this-book.html#cb666-1418" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, add)</span>
<span id="cb666-1419"><a href="all-r-code-in-this-book.html#cb666-1419" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1420"><a href="all-r-code-in-this-book.html#cb666-1420" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1421"><a href="all-r-code-in-this-book.html#cb666-1421" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1422"><a href="all-r-code-in-this-book.html#cb666-1422" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">4</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1423"><a href="all-r-code-in-this-book.html#cb666-1423" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">5</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1424"><a href="all-r-code-in-this-book.html#cb666-1424" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">6</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1425"><a href="all-r-code-in-this-book.html#cb666-1425" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">7</span>, <span class="ot">TRUE</span>)</span>
<span id="cb666-1426"><a href="all-r-code-in-this-book.html#cb666-1426" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">8</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</span>
<span id="cb666-1427"><a href="all-r-code-in-this-book.html#cb666-1427" aria-hidden="true"></a>}</span>
<span id="cb666-1428"><a href="all-r-code-in-this-book.html#cb666-1428" aria-hidden="true"></a></span>
<span id="cb666-1429"><a href="all-r-code-in-this-book.html#cb666-1429" aria-hidden="true"></a><span class="co"># point vector data cube:</span></span>
<span id="cb666-1430"><a href="all-r-code-in-this-book.html#cb666-1430" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb666-1431"><a href="all-r-code-in-this-book.html#cb666-1431" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">0</span>))</span>
<span id="cb666-1432"><a href="all-r-code-in-this-book.html#cb666-1432" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">16</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>,<span class="dv">12</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb666-1433"><a href="all-r-code-in-this-book.html#cb666-1433" aria-hidden="true"></a><span class="kw">library</span>(spacetime)</span>
<span id="cb666-1434"><a href="all-r-code-in-this-book.html#cb666-1434" aria-hidden="true"></a><span class="kw">data</span>(air)</span>
<span id="cb666-1435"><a href="all-r-code-in-this-book.html#cb666-1435" aria-hidden="true"></a>de =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">st_normalize</span>(<span class="kw">st_as_sf</span>(DE)))</span>
<span id="cb666-1436"><a href="all-r-code-in-this-book.html#cb666-1436" aria-hidden="true"></a><span class="co"># </span></span>
<span id="cb666-1437"><a href="all-r-code-in-this-book.html#cb666-1437" aria-hidden="true"></a><span class="kw">pl</span>(s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1438"><a href="all-r-code-in-this-book.html#cb666-1438" aria-hidden="true"></a>de =<span class="st"> </span>de <span class="op">*</span><span class="st"> </span><span class="dv">6</span> <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>, <span class="dv">9</span>)</span>
<span id="cb666-1439"><a href="all-r-code-in-this-book.html#cb666-1439" aria-hidden="true"></a><span class="kw">plot</span>(de, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">5</span>))</span>
<span id="cb666-1440"><a href="all-r-code-in-this-book.html#cb666-1440" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">-90</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb666-1441"><a href="all-r-code-in-this-book.html#cb666-1441" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">5</span>,  <span class="fl">7.5</span>, <span class="st">&quot;sensor location&quot;</span>, <span class="dt">srt =</span> <span class="dv">25</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb666-1442"><a href="all-r-code-in-this-book.html#cb666-1442" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">7</span>,  <span class="fl">10.5</span>, <span class="st">&quot;air quality parameter&quot;</span>, <span class="dt">srt =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb666-1443"><a href="all-r-code-in-this-book.html#cb666-1443" aria-hidden="true"></a><span class="kw">text</span>( <span class="fl">1.5</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(PM[<span class="dv">10</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb666-1444"><a href="all-r-code-in-this-book.html#cb666-1444" aria-hidden="true"></a><span class="kw">text</span>( <span class="fl">4.5</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(NO[x]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb666-1445"><a href="all-r-code-in-this-book.html#cb666-1445" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">8</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(SO[<span class="dv">4</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb666-1446"><a href="all-r-code-in-this-book.html#cb666-1446" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">11</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(O[<span class="dv">3</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb666-1447"><a href="all-r-code-in-this-book.html#cb666-1447" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">14</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(CO), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb666-1448"><a href="all-r-code-in-this-book.html#cb666-1448" aria-hidden="true"></a><span class="co"># location points:</span></span>
<span id="cb666-1449"><a href="all-r-code-in-this-book.html#cb666-1449" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_coordinates</span>(s[,<span class="dv">1</span>])</span>
<span id="cb666-1450"><a href="all-r-code-in-this-book.html#cb666-1450" aria-hidden="true"></a>p[,<span class="dv">1</span>] =<span class="st"> </span>p[,<span class="dv">1</span>]<span class="op">-</span><span class="fl">1.4</span></span>
<span id="cb666-1451"><a href="all-r-code-in-this-book.html#cb666-1451" aria-hidden="true"></a>p[,<span class="dv">2</span>] =<span class="st"> </span>p[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="fl">8.2</span></span>
<span id="cb666-1452"><a href="all-r-code-in-this-book.html#cb666-1452" aria-hidden="true"></a><span class="kw">points</span>(p, <span class="dt">col =</span> <span class="kw">grey</span>(.<span class="dv">7</span>), <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-1453"><a href="all-r-code-in-this-book.html#cb666-1453" aria-hidden="true"></a><span class="co"># centroids:</span></span>
<span id="cb666-1454"><a href="all-r-code-in-this-book.html#cb666-1454" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">131</span>)</span>
<span id="cb666-1455"><a href="all-r-code-in-this-book.html#cb666-1455" aria-hidden="true"></a>cent =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_sample</span>(de, <span class="dv">8</span>))</span>
<span id="cb666-1456"><a href="all-r-code-in-this-book.html#cb666-1456" aria-hidden="true"></a><span class="kw">points</span>(cent, <span class="dt">col =</span> <span class="kw">grey</span>(.<span class="dv">7</span>), <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb666-1457"><a href="all-r-code-in-this-book.html#cb666-1457" aria-hidden="true"></a>cent =<span class="st"> </span>cent[<span class="kw">rev</span>(<span class="kw">order</span>(cent[,<span class="dv">1</span>])),]</span>
<span id="cb666-1458"><a href="all-r-code-in-this-book.html#cb666-1458" aria-hidden="true"></a>seg =<span class="st"> </span><span class="kw">cbind</span>(p, cent[<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>,])</span>
<span id="cb666-1459"><a href="all-r-code-in-this-book.html#cb666-1459" aria-hidden="true"></a><span class="kw">segments</span>(seg[,<span class="dv">1</span>], seg[,<span class="dv">2</span>], seg[,<span class="dv">3</span>], seg[,<span class="dv">4</span>], <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-1460"><a href="all-r-code-in-this-book.html#cb666-1460" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-1461"><a href="all-r-code-in-this-book.html#cb666-1461" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-1462"><a href="all-r-code-in-this-book.html#cb666-1462" aria-hidden="true"></a></span>
<span id="cb666-1463"><a href="all-r-code-in-this-book.html#cb666-1463" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-1464"><a href="all-r-code-in-this-book.html#cb666-1464" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-1465"><a href="all-r-code-in-this-book.html#cb666-1465" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-1466"><a href="all-r-code-in-this-book.html#cb666-1466" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-1467"><a href="all-r-code-in-this-book.html#cb666-1467" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-1468"><a href="all-r-code-in-this-book.html#cb666-1468" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-1469"><a href="all-r-code-in-this-book.html#cb666-1469" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-1470"><a href="all-r-code-in-this-book.html#cb666-1470" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-1471"><a href="all-r-code-in-this-book.html#cb666-1471" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-1472"><a href="all-r-code-in-this-book.html#cb666-1472" aria-hidden="true"></a>)</span>
<span id="cb666-1473"><a href="all-r-code-in-this-book.html#cb666-1473" aria-hidden="true"></a></span>
<span id="cb666-1474"><a href="all-r-code-in-this-book.html#cb666-1474" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-1475"><a href="all-r-code-in-this-book.html#cb666-1475" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-1476"><a href="all-r-code-in-this-book.html#cb666-1476" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1477"><a href="all-r-code-in-this-book.html#cb666-1477" aria-hidden="true"></a></span>
<span id="cb666-1478"><a href="all-r-code-in-this-book.html#cb666-1478" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-1479"><a href="all-r-code-in-this-book.html#cb666-1479" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-1480"><a href="all-r-code-in-this-book.html#cb666-1480" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-1481"><a href="all-r-code-in-this-book.html#cb666-1481" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-1482"><a href="all-r-code-in-this-book.html#cb666-1482" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-1483"><a href="all-r-code-in-this-book.html#cb666-1483" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1484"><a href="all-r-code-in-this-book.html#cb666-1484" aria-hidden="true"></a>p1 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.35</span>, <span class="fl">52.42</span>))</span>
<span id="cb666-1485"><a href="all-r-code-in-this-book.html#cb666-1485" aria-hidden="true"></a>p2 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.22</span>, <span class="fl">52.18</span>))</span>
<span id="cb666-1486"><a href="all-r-code-in-this-book.html#cb666-1486" aria-hidden="true"></a>p3 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.44</span>, <span class="fl">52.19</span>))</span>
<span id="cb666-1487"><a href="all-r-code-in-this-book.html#cb666-1487" aria-hidden="true"></a>sfc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">list</span>(p1, p2, p3), <span class="dt">crs =</span> <span class="st">&#39;OGC:CRS84&#39;</span>)</span>
<span id="cb666-1488"><a href="all-r-code-in-this-book.html#cb666-1488" aria-hidden="true"></a><span class="kw">st_sf</span>(<span class="dt">elev =</span> <span class="kw">c</span>(<span class="fl">33.2</span>, <span class="fl">52.1</span>, <span class="fl">81.2</span>), <span class="dt">marker =</span> <span class="kw">c</span>(<span class="st">&quot;Id01&quot;</span>, <span class="st">&quot;Id02&quot;</span>, <span class="st">&quot;Id03&quot;</span>),</span>
<span id="cb666-1489"><a href="all-r-code-in-this-book.html#cb666-1489" aria-hidden="true"></a>      <span class="dt">geom =</span> sfc)</span>
<span id="cb666-1490"><a href="all-r-code-in-this-book.html#cb666-1490" aria-hidden="true"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/sf_obj.png&quot;</span>)</span>
<span id="cb666-1491"><a href="all-r-code-in-this-book.html#cb666-1491" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1492"><a href="all-r-code-in-this-book.html#cb666-1492" aria-hidden="true"></a>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</span>
<span id="cb666-1493"><a href="all-r-code-in-this-book.html#cb666-1493" aria-hidden="true"></a>nc =<span class="st"> </span><span class="kw">st_read</span>(file)</span>
<span id="cb666-1494"><a href="all-r-code-in-this-book.html#cb666-1494" aria-hidden="true"></a><span class="kw">st_layers</span>(file)</span>
<span id="cb666-1495"><a href="all-r-code-in-this-book.html#cb666-1495" aria-hidden="true"></a>(<span class="dt">file =</span> <span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.gpkg&quot;</span>))</span>
<span id="cb666-1496"><a href="all-r-code-in-this-book.html#cb666-1496" aria-hidden="true"></a><span class="kw">st_write</span>(nc, file, <span class="dt">layer =</span> <span class="st">&quot;layer_nc&quot;</span>)</span>
<span id="cb666-1497"><a href="all-r-code-in-this-book.html#cb666-1497" aria-hidden="true"></a>nc[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>]</span>
<span id="cb666-1498"><a href="all-r-code-in-this-book.html#cb666-1498" aria-hidden="true"></a>nc5 =<span class="st"> </span>nc[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, ]</span>
<span id="cb666-1499"><a href="all-r-code-in-this-book.html#cb666-1499" aria-hidden="true"></a>nc7 =<span class="st"> </span>nc[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>, ]</span>
<span id="cb666-1500"><a href="all-r-code-in-this-book.html#cb666-1500" aria-hidden="true"></a>(<span class="dt">i =</span> <span class="kw">st_intersects</span>(nc5, nc7))</span>
<span id="cb666-1501"><a href="all-r-code-in-this-book.html#cb666-1501" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc7))</span>
<span id="cb666-1502"><a href="all-r-code-in-this-book.html#cb666-1502" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc5), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&quot;brown&quot;</span>)</span>
<span id="cb666-1503"><a href="all-r-code-in-this-book.html#cb666-1503" aria-hidden="true"></a>cc =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc7)))</span>
<span id="cb666-1504"><a href="all-r-code-in-this-book.html#cb666-1504" aria-hidden="true"></a><span class="kw">text</span>(cc, <span class="dt">labels =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(nc7), <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb666-1505"><a href="all-r-code-in-this-book.html#cb666-1505" aria-hidden="true"></a><span class="kw">as.matrix</span>(i)</span>
<span id="cb666-1506"><a href="all-r-code-in-this-book.html#cb666-1506" aria-hidden="true"></a><span class="kw">lengths</span>(i)</span>
<span id="cb666-1507"><a href="all-r-code-in-this-book.html#cb666-1507" aria-hidden="true"></a><span class="kw">lengths</span>(<span class="kw">t</span>(i))</span>
<span id="cb666-1508"><a href="all-r-code-in-this-book.html#cb666-1508" aria-hidden="true"></a><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;sgbp&quot;</span>)</span>
<span id="cb666-1509"><a href="all-r-code-in-this-book.html#cb666-1509" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb666-1510"><a href="all-r-code-in-this-book.html#cb666-1510" aria-hidden="true"></a>nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(BIR74) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb666-1511"><a href="all-r-code-in-this-book.html#cb666-1511" aria-hidden="true"></a>orange &lt;-<span class="st"> </span>nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(NAME <span class="op">==</span><span class="st"> &quot;Orange&quot;</span>)</span>
<span id="cb666-1512"><a href="all-r-code-in-this-book.html#cb666-1512" aria-hidden="true"></a>wd =<span class="st"> </span><span class="kw">st_is_within_distance</span>(nc, orange, units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">50</span>, km))</span>
<span id="cb666-1513"><a href="all-r-code-in-this-book.html#cb666-1513" aria-hidden="true"></a>o50 &lt;-<span class="st"> </span>nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">lengths</span>(wd) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb666-1514"><a href="all-r-code-in-this-book.html#cb666-1514" aria-hidden="true"></a><span class="kw">nrow</span>(o50)</span>
<span id="cb666-1515"><a href="all-r-code-in-this-book.html#cb666-1515" aria-hidden="true"></a>og =<span class="st"> </span><span class="kw">st_geometry</span>(orange)</span>
<span id="cb666-1516"><a href="all-r-code-in-this-book.html#cb666-1516" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(o50), <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb666-1517"><a href="all-r-code-in-this-book.html#cb666-1517" aria-hidden="true"></a><span class="kw">plot</span>(og, <span class="dt">col =</span> <span class="st">&#39;orange&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1518"><a href="all-r-code-in-this-book.html#cb666-1518" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_buffer</span>(og, units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">50</span>, km)), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;brown&#39;</span>)</span>
<span id="cb666-1519"><a href="all-r-code-in-this-book.html#cb666-1519" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb666-1520"><a href="all-r-code-in-this-book.html#cb666-1520" aria-hidden="true"></a><span class="co"># example of largest = TRUE:</span></span>
<span id="cb666-1521"><a href="all-r-code-in-this-book.html#cb666-1521" aria-hidden="true"></a>nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;shape/nc.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>)), <span class="dv">2264</span>)</span>
<span id="cb666-1522"><a href="all-r-code-in-this-book.html#cb666-1522" aria-hidden="true"></a>gr =<span class="st"> </span><span class="kw">st_sf</span>(</span>
<span id="cb666-1523"><a href="all-r-code-in-this-book.html#cb666-1523" aria-hidden="true"></a>         <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</span>
<span id="cb666-1524"><a href="all-r-code-in-this-book.html#cb666-1524" aria-hidden="true"></a>         <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</span>
<span id="cb666-1525"><a href="all-r-code-in-this-book.html#cb666-1525" aria-hidden="true"></a>gr<span class="op">$</span>col =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>, <span class="dt">categorical =</span> <span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.3</span>)</span>
<span id="cb666-1526"><a href="all-r-code-in-this-book.html#cb666-1526" aria-hidden="true"></a><span class="co"># cut, to check, NA&#39;s work out:</span></span>
<span id="cb666-1527"><a href="all-r-code-in-this-book.html#cb666-1527" aria-hidden="true"></a>gr =<span class="st"> </span>gr[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>),]</span>
<span id="cb666-1528"><a href="all-r-code-in-this-book.html#cb666-1528" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(nc_j &lt;-<span class="st"> </span><span class="kw">st_join</span>(nc, gr, <span class="dt">largest =</span> <span class="ot">TRUE</span>))</span>
<span id="cb666-1529"><a href="all-r-code-in-this-book.html#cb666-1529" aria-hidden="true"></a><span class="co"># the two datasets:</span></span>
<span id="cb666-1530"><a href="all-r-code-in-this-book.html#cb666-1530" aria-hidden="true"></a>opar =<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb666-1531"><a href="all-r-code-in-this-book.html#cb666-1531" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j))</span>
<span id="cb666-1532"><a href="all-r-code-in-this-book.html#cb666-1532" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> gr<span class="op">$</span>col)</span>
<span id="cb666-1533"><a href="all-r-code-in-this-book.html#cb666-1533" aria-hidden="true"></a><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(gr))), <span class="dt">labels =</span> gr<span class="op">$</span>label)</span>
<span id="cb666-1534"><a href="all-r-code-in-this-book.html#cb666-1534" aria-hidden="true"></a><span class="co"># the joined dataset:</span></span>
<span id="cb666-1535"><a href="all-r-code-in-this-book.html#cb666-1535" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j), <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> nc_j<span class="op">$</span>col)</span>
<span id="cb666-1536"><a href="all-r-code-in-this-book.html#cb666-1536" aria-hidden="true"></a><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc_j))), <span class="dt">labels =</span> nc_j<span class="op">$</span>label, <span class="dt">cex =</span> <span class="fl">.8</span>)</span>
<span id="cb666-1537"><a href="all-r-code-in-this-book.html#cb666-1537" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">border =</span> <span class="st">&#39;green&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1538"><a href="all-r-code-in-this-book.html#cb666-1538" aria-hidden="true"></a><span class="kw">par</span>(opar)</span>
<span id="cb666-1539"><a href="all-r-code-in-this-book.html#cb666-1539" aria-hidden="true"></a>tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb666-1540"><a href="all-r-code-in-this-book.html#cb666-1540" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-1541"><a href="all-r-code-in-this-book.html#cb666-1541" aria-hidden="true"></a>(<span class="dt">r =</span> <span class="kw">read_stars</span>(tif))</span>
<span id="cb666-1542"><a href="all-r-code-in-this-book.html#cb666-1542" aria-hidden="true"></a><span class="kw">length</span>(r)</span>
<span id="cb666-1543"><a href="all-r-code-in-this-book.html#cb666-1543" aria-hidden="true"></a><span class="kw">class</span>(r[[<span class="dv">1</span>]])</span>
<span id="cb666-1544"><a href="all-r-code-in-this-book.html#cb666-1544" aria-hidden="true"></a><span class="kw">dim</span>(r[[<span class="dv">1</span>]])</span>
<span id="cb666-1545"><a href="all-r-code-in-this-book.html#cb666-1545" aria-hidden="true"></a><span class="kw">st_dimensions</span>(r)</span>
<span id="cb666-1546"><a href="all-r-code-in-this-book.html#cb666-1546" aria-hidden="true"></a><span class="kw">st_bbox</span>(r)</span>
<span id="cb666-1547"><a href="all-r-code-in-this-book.html#cb666-1547" aria-hidden="true"></a>tf =<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.tif&quot;</span>)</span>
<span id="cb666-1548"><a href="all-r-code-in-this-book.html#cb666-1548" aria-hidden="true"></a><span class="kw">write_stars</span>(r, tf)</span>
<span id="cb666-1549"><a href="all-r-code-in-this-book.html#cb666-1549" aria-hidden="true"></a><span class="kw">st_drivers</span>(<span class="st">&quot;raster&quot;</span>)</span>
<span id="cb666-1550"><a href="all-r-code-in-this-book.html#cb666-1550" aria-hidden="true"></a>r[,<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dim</span>()</span>
<span id="cb666-1551"><a href="all-r-code-in-this-book.html#cb666-1551" aria-hidden="true"></a>r[,<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>, drop =<span class="st"> </span><span class="ot">TRUE</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dim</span>()</span>
<span id="cb666-1552"><a href="all-r-code-in-this-book.html#cb666-1552" aria-hidden="true"></a><span class="kw">library</span>(dplyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1553"><a href="all-r-code-in-this-book.html#cb666-1553" aria-hidden="true"></a><span class="kw">filter</span>(r, x <span class="op">&gt;</span><span class="st"> </span><span class="dv">289000</span>, x <span class="op">&lt;</span><span class="st"> </span><span class="dv">290000</span>)</span>
<span id="cb666-1554"><a href="all-r-code-in-this-book.html#cb666-1554" aria-hidden="true"></a><span class="kw">slice</span>(r, band, <span class="dv">3</span>)</span>
<span id="cb666-1555"><a href="all-r-code-in-this-book.html#cb666-1555" aria-hidden="true"></a>b =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span></span>
<span id="cb666-1556"><a href="all-r-code-in-this-book.html#cb666-1556" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1557"><a href="all-r-code-in-this-book.html#cb666-1557" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_centroid</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1558"><a href="all-r-code-in-this-book.html#cb666-1558" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_buffer</span>(units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">500</span>, m))</span>
<span id="cb666-1559"><a href="all-r-code-in-this-book.html#cb666-1559" aria-hidden="true"></a>r[b]</span>
<span id="cb666-1560"><a href="all-r-code-in-this-book.html#cb666-1560" aria-hidden="true"></a><span class="kw">plot</span>(r[b][,,,<span class="dv">1</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1561"><a href="all-r-code-in-this-book.html#cb666-1561" aria-hidden="true"></a><span class="kw">plot</span>(b, <span class="dt">border =</span> <span class="st">&#39;brown&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1562"><a href="all-r-code-in-this-book.html#cb666-1562" aria-hidden="true"></a>r[b] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_normalize</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_dimensions</span>()</span>
<span id="cb666-1563"><a href="all-r-code-in-this-book.html#cb666-1563" aria-hidden="true"></a>r[b, crop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb666-1564"><a href="all-r-code-in-this-book.html#cb666-1564" aria-hidden="true"></a><span class="kw">st_crop</span>(r, b)</span>
<span id="cb666-1565"><a href="all-r-code-in-this-book.html#cb666-1565" aria-hidden="true"></a><span class="kw">aperm</span>(r, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb666-1566"><a href="all-r-code-in-this-book.html#cb666-1566" aria-hidden="true"></a>(<span class="dt">rs =</span> <span class="kw">split</span>(r))</span>
<span id="cb666-1567"><a href="all-r-code-in-this-book.html#cb666-1567" aria-hidden="true"></a><span class="kw">merge</span>(rs)</span>
<span id="cb666-1568"><a href="all-r-code-in-this-book.html#cb666-1568" aria-hidden="true"></a><span class="kw">st_redimension</span>(r, <span class="kw">c</span>(<span class="dv">349</span>, <span class="dv">352</span>, <span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb666-1569"><a href="all-r-code-in-this-book.html#cb666-1569" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">115517</span>)</span>
<span id="cb666-1570"><a href="all-r-code-in-this-book.html#cb666-1570" aria-hidden="true"></a>pts =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_sample</span>(<span class="dv">20</span>)</span>
<span id="cb666-1571"><a href="all-r-code-in-this-book.html#cb666-1571" aria-hidden="true"></a>(<span class="dt">e =</span> <span class="kw">st_extract</span>(r, pts))</span>
<span id="cb666-1572"><a href="all-r-code-in-this-book.html#cb666-1572" aria-hidden="true"></a><span class="kw">plot</span>(r[,,,<span class="dv">1</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1573"><a href="all-r-code-in-this-book.html#cb666-1573" aria-hidden="true"></a>col =<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;green&quot;</span>, <span class="dv">20</span>)</span>
<span id="cb666-1574"><a href="all-r-code-in-this-book.html#cb666-1574" aria-hidden="true"></a>col[<span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] =<span class="st"> &quot;red&quot;</span></span>
<span id="cb666-1575"><a href="all-r-code-in-this-book.html#cb666-1575" aria-hidden="true"></a><span class="kw">st_as_sf</span>(e) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_coordinates</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">text</span>(<span class="dt">labels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>, <span class="dt">col =</span> col)</span>
<span id="cb666-1576"><a href="all-r-code-in-this-book.html#cb666-1576" aria-hidden="true"></a>rs =<span class="st"> </span><span class="kw">split</span>(r)</span>
<span id="cb666-1577"><a href="all-r-code-in-this-book.html#cb666-1577" aria-hidden="true"></a>trn =<span class="st"> </span><span class="kw">st_extract</span>(rs, pts)</span>
<span id="cb666-1578"><a href="all-r-code-in-this-book.html#cb666-1578" aria-hidden="true"></a>trn<span class="op">$</span>cls =<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;land&quot;</span>, <span class="dv">20</span>)</span>
<span id="cb666-1579"><a href="all-r-code-in-this-book.html#cb666-1579" aria-hidden="true"></a>trn<span class="op">$</span>cls[<span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] =<span class="st"> &quot;water&quot;</span></span>
<span id="cb666-1580"><a href="all-r-code-in-this-book.html#cb666-1580" aria-hidden="true"></a>model =<span class="st"> </span>MASS<span class="op">::</span><span class="kw">lda</span>(cls <span class="op">~</span><span class="st"> </span>., <span class="kw">st_set_geometry</span>(trn, <span class="ot">NULL</span>))</span>
<span id="cb666-1581"><a href="all-r-code-in-this-book.html#cb666-1581" aria-hidden="true"></a>pr =<span class="st"> </span><span class="kw">predict</span>(rs, model)</span>
<span id="cb666-1582"><a href="all-r-code-in-this-book.html#cb666-1582" aria-hidden="true"></a><span class="kw">plot</span>(pr[<span class="dv">1</span>], <span class="dt">key.pos =</span> <span class="dv">4</span>, <span class="dt">key.width =</span> <span class="kw">lcm</span>(<span class="fl">3.5</span>), <span class="dt">key.length =</span> <span class="kw">lcm</span>(<span class="dv">2</span>))</span>
<span id="cb666-1583"><a href="all-r-code-in-this-book.html#cb666-1583" aria-hidden="true"></a><span class="kw">plot</span>(r)</span>
<span id="cb666-1584"><a href="all-r-code-in-this-book.html#cb666-1584" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb666-1585"><a href="all-r-code-in-this-book.html#cb666-1585" aria-hidden="true"></a><span class="kw">plot</span>(r, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">&quot;RGB&quot;</span>)    <span class="co"># rgb</span></span>
<span id="cb666-1586"><a href="all-r-code-in-this-book.html#cb666-1586" aria-hidden="true"></a><span class="kw">plot</span>(r, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">main =</span> <span class="st">&quot;False color (NIR-R-G)&quot;</span>) <span class="co"># false color</span></span>
<span id="cb666-1587"><a href="all-r-code-in-this-book.html#cb666-1587" aria-hidden="true"></a><span class="kw">log</span>(r)</span>
<span id="cb666-1588"><a href="all-r-code-in-this-book.html#cb666-1588" aria-hidden="true"></a>r <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(r)</span>
<span id="cb666-1589"><a href="all-r-code-in-this-book.html#cb666-1589" aria-hidden="true"></a>r2 =<span class="st"> </span>r</span>
<span id="cb666-1590"><a href="all-r-code-in-this-book.html#cb666-1590" aria-hidden="true"></a>r2[r <span class="op">&lt;</span><span class="st"> </span><span class="dv">50</span>] =<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb666-1591"><a href="all-r-code-in-this-book.html#cb666-1591" aria-hidden="true"></a>r2</span>
<span id="cb666-1592"><a href="all-r-code-in-this-book.html#cb666-1592" aria-hidden="true"></a>r2[<span class="kw">is.na</span>(r2)] =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb666-1593"><a href="all-r-code-in-this-book.html#cb666-1593" aria-hidden="true"></a>r2</span>
<span id="cb666-1594"><a href="all-r-code-in-this-book.html#cb666-1594" aria-hidden="true"></a><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), mean)</span>
<span id="cb666-1595"><a href="all-r-code-in-this-book.html#cb666-1595" aria-hidden="true"></a>ndvi =<span class="st"> </span><span class="cf">function</span>(b1, b2, b3, b4, b5, b6) (b4 <span class="op">-</span><span class="st"> </span>b3)<span class="op">/</span>(b4 <span class="op">+</span><span class="st"> </span>b3)</span>
<span id="cb666-1596"><a href="all-r-code-in-this-book.html#cb666-1596" aria-hidden="true"></a><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), ndvi)</span>
<span id="cb666-1597"><a href="all-r-code-in-this-book.html#cb666-1597" aria-hidden="true"></a>ndvi2 =<span class="st"> </span><span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="op">-</span>x[<span class="dv">3</span>])<span class="op">/</span>(x[<span class="dv">4</span>]<span class="op">+</span>x[<span class="dv">3</span>])</span>
<span id="cb666-1598"><a href="all-r-code-in-this-book.html#cb666-1598" aria-hidden="true"></a><span class="kw">as.data.frame</span>(<span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), mean))</span>
<span id="cb666-1599"><a href="all-r-code-in-this-book.html#cb666-1599" aria-hidden="true"></a><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</span>
<span id="cb666-1600"><a href="all-r-code-in-this-book.html#cb666-1600" aria-hidden="true"></a><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</span>
<span id="cb666-1601"><a href="all-r-code-in-this-book.html#cb666-1601" aria-hidden="true"></a><span class="kw">options</span>(<span class="st">&quot;rgdal_show_exportToProj4_warnings&quot;</span>=<span class="st">&quot;none&quot;</span>) <span class="co"># led to:</span></span>
<span id="cb666-1602"><a href="all-r-code-in-this-book.html#cb666-1602" aria-hidden="true"></a><span class="co"># Warning in sp::proj4string(obj): CRS object has comment, which is</span></span>
<span id="cb666-1603"><a href="all-r-code-in-this-book.html#cb666-1603" aria-hidden="true"></a><span class="co"># lost in output</span></span>
<span id="cb666-1604"><a href="all-r-code-in-this-book.html#cb666-1604" aria-hidden="true"></a><span class="kw">library</span>(spacetime)</span>
<span id="cb666-1605"><a href="all-r-code-in-this-book.html#cb666-1605" aria-hidden="true"></a><span class="kw">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span></span>
<span id="cb666-1606"><a href="all-r-code-in-this-book.html#cb666-1606" aria-hidden="true"></a><span class="kw">dim</span>(air)</span>
<span id="cb666-1607"><a href="all-r-code-in-this-book.html#cb666-1607" aria-hidden="true"></a>d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">station =</span> <span class="kw">st_as_sfc</span>(stations), <span class="dt">time =</span> dates)</span>
<span id="cb666-1608"><a href="all-r-code-in-this-book.html#cb666-1608" aria-hidden="true"></a>(<span class="dt">aq =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">PM10 =</span> air), <span class="dt">dimensions =</span> d))</span>
<span id="cb666-1609"><a href="all-r-code-in-this-book.html#cb666-1609" aria-hidden="true"></a><span class="kw">image</span>(<span class="kw">aperm</span>(<span class="kw">log</span>(aq), <span class="dv">2</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">main =</span> <span class="st">&quot;NA pattern (white) in PM10 station time series&quot;</span>)</span>
<span id="cb666-1610"><a href="all-r-code-in-this-book.html#cb666-1610" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(<span class="kw">st_apply</span>(aq, <span class="dv">1</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">pch =</span> <span class="dv">16</span>,</span>
<span id="cb666-1611"><a href="all-r-code-in-this-book.html#cb666-1611" aria-hidden="true"></a>    <span class="dt">ylim =</span> <span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)])</span>
<span id="cb666-1612"><a href="all-r-code-in-this-book.html#cb666-1612" aria-hidden="true"></a><span class="kw">plot</span>(DE, <span class="dt">add=</span><span class="ot">TRUE</span>)</span>
<span id="cb666-1613"><a href="all-r-code-in-this-book.html#cb666-1613" aria-hidden="true"></a>(<span class="dt">a =</span> <span class="kw">aggregate</span>(aq, <span class="kw">st_as_sf</span>(DE_NUTS1), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb666-1614"><a href="all-r-code-in-this-book.html#cb666-1614" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb666-1615"><a href="all-r-code-in-this-book.html#cb666-1615" aria-hidden="true"></a>a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(time <span class="op">&gt;=</span><span class="st"> &quot;2008-01-01&quot;</span>, time <span class="op">&lt;</span><span class="st"> &quot;2008-01-07&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-1616"><a href="all-r-code-in-this-book.html#cb666-1616" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>(<span class="dt">key.pos =</span> <span class="dv">4</span>)</span>
<span id="cb666-1617"><a href="all-r-code-in-this-book.html#cb666-1617" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(xts))</span>
<span id="cb666-1618"><a href="all-r-code-in-this-book.html#cb666-1618" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">as.xts</span>(a)[,<span class="dv">4</span>], <span class="dt">main =</span> DE_NUTS1<span class="op">$</span>NAME_<span class="dv">1</span>[<span class="dv">4</span>])</span>
<span id="cb666-1619"><a href="all-r-code-in-this-book.html#cb666-1619" aria-hidden="true"></a><span class="kw">library</span>(spDataLarge)</span>
<span id="cb666-1620"><a href="all-r-code-in-this-book.html#cb666-1620" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1621"><a href="all-r-code-in-this-book.html#cb666-1621" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones)[<span class="dv">33</span>], <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1622"><a href="all-r-code-in-this-book.html#cb666-1622" aria-hidden="true"></a><span class="kw">head</span>(bristol_od)</span>
<span id="cb666-1623"><a href="all-r-code-in-this-book.html#cb666-1623" aria-hidden="true"></a><span class="kw">nrow</span>(bristol_zones)<span class="op">^</span><span class="dv">2</span> <span class="co"># all combinations</span></span>
<span id="cb666-1624"><a href="all-r-code-in-this-book.html#cb666-1624" aria-hidden="true"></a><span class="kw">nrow</span>(bristol_od) <span class="co"># non-zero combinations</span></span>
<span id="cb666-1625"><a href="all-r-code-in-this-book.html#cb666-1625" aria-hidden="true"></a><span class="co"># create O-D-mode array:</span></span>
<span id="cb666-1626"><a href="all-r-code-in-this-book.html#cb666-1626" aria-hidden="true"></a>bristol_tidy &lt;-<span class="st"> </span>bristol_od <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-1627"><a href="all-r-code-in-this-book.html#cb666-1627" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>all) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-1628"><a href="all-r-code-in-this-book.html#cb666-1628" aria-hidden="true"></a><span class="st">    </span><span class="kw">gather</span>(<span class="st">&quot;mode&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="op">-</span>o, <span class="op">-</span>d)</span>
<span id="cb666-1629"><a href="all-r-code-in-this-book.html#cb666-1629" aria-hidden="true"></a><span class="kw">head</span>(bristol_tidy)</span>
<span id="cb666-1630"><a href="all-r-code-in-this-book.html#cb666-1630" aria-hidden="true"></a>od =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;o&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</span>
<span id="cb666-1631"><a href="all-r-code-in-this-book.html#cb666-1631" aria-hidden="true"></a>nod =<span class="st"> </span><span class="kw">length</span>(od)</span>
<span id="cb666-1632"><a href="all-r-code-in-this-book.html#cb666-1632" aria-hidden="true"></a>mode =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;mode&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</span>
<span id="cb666-1633"><a href="all-r-code-in-this-book.html#cb666-1633" aria-hidden="true"></a>nmode =<span class="st"> </span><span class="kw">length</span>(mode)</span>
<span id="cb666-1634"><a href="all-r-code-in-this-book.html#cb666-1634" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">array</span>(0L,  <span class="kw">c</span>(nod, nod, nmode), </span>
<span id="cb666-1635"><a href="all-r-code-in-this-book.html#cb666-1635" aria-hidden="true"></a>    <span class="dt">dimnames =</span> <span class="kw">list</span>(<span class="dt">o =</span> od, <span class="dt">d =</span> od, <span class="dt">mode =</span> mode))</span>
<span id="cb666-1636"><a href="all-r-code-in-this-book.html#cb666-1636" aria-hidden="true"></a><span class="kw">dim</span>(a)</span>
<span id="cb666-1637"><a href="all-r-code-in-this-book.html#cb666-1637" aria-hidden="true"></a>a[<span class="kw">as.matrix</span>(bristol_tidy[<span class="kw">c</span>(<span class="st">&quot;o&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;mode&quot;</span>)])] =<span class="st"> </span>bristol_tidy<span class="op">$</span>n</span>
<span id="cb666-1638"><a href="all-r-code-in-this-book.html#cb666-1638" aria-hidden="true"></a>order =<span class="st"> </span><span class="kw">match</span>(od, bristol_zones<span class="op">$</span>geo_code) <span class="co"># it happens this equals 1:102</span></span>
<span id="cb666-1639"><a href="all-r-code-in-this-book.html#cb666-1639" aria-hidden="true"></a>zones =<span class="st"> </span><span class="kw">st_geometry</span>(bristol_zones)[order]</span>
<span id="cb666-1640"><a href="all-r-code-in-this-book.html#cb666-1640" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-1641"><a href="all-r-code-in-this-book.html#cb666-1641" aria-hidden="true"></a>(<span class="dt">d =</span> <span class="kw">st_dimensions</span>(<span class="dt">o =</span> zones, <span class="dt">d =</span> zones, <span class="dt">mode =</span> mode))</span>
<span id="cb666-1642"><a href="all-r-code-in-this-book.html#cb666-1642" aria-hidden="true"></a>(<span class="dt">odm =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">N =</span> a), <span class="dt">dimensions =</span> d))</span>
<span id="cb666-1643"><a href="all-r-code-in-this-book.html#cb666-1643" aria-hidden="true"></a><span class="kw">plot</span>(odm[,,<span class="dv">33</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1644"><a href="all-r-code-in-this-book.html#cb666-1644" aria-hidden="true"></a>d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</span>
<span id="cb666-1645"><a href="all-r-code-in-this-book.html#cb666-1645" aria-hidden="true"></a><span class="kw">which.max</span>(d[[<span class="dv">1</span>]])</span>
<span id="cb666-1646"><a href="all-r-code-in-this-book.html#cb666-1646" aria-hidden="true"></a><span class="kw">st_apply</span>(odm, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, sum)</span>
<span id="cb666-1647"><a href="all-r-code-in-this-book.html#cb666-1647" aria-hidden="true"></a><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</span>
<span id="cb666-1648"><a href="all-r-code-in-this-book.html#cb666-1648" aria-hidden="true"></a><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</span>
<span id="cb666-1649"><a href="all-r-code-in-this-book.html#cb666-1649" aria-hidden="true"></a>o =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">1</span>, sum)</span>
<span id="cb666-1650"><a href="all-r-code-in-this-book.html#cb666-1650" aria-hidden="true"></a>d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</span>
<span id="cb666-1651"><a href="all-r-code-in-this-book.html#cb666-1651" aria-hidden="true"></a>x =<span class="st"> </span>(<span class="kw">c</span>(o, d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))))</span>
<span id="cb666-1652"><a href="all-r-code-in-this-book.html#cb666-1652" aria-hidden="true"></a><span class="kw">plot</span>(x, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1653"><a href="all-r-code-in-this-book.html#cb666-1653" aria-hidden="true"></a><span class="kw">library</span>(units)</span>
<span id="cb666-1654"><a href="all-r-code-in-this-book.html#cb666-1654" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">set_units</span>(<span class="kw">st_area</span>(<span class="kw">st_as_sf</span>(o)), km<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb666-1655"><a href="all-r-code-in-this-book.html#cb666-1655" aria-hidden="true"></a>o<span class="op">$</span>sum_km =<span class="st"> </span>o<span class="op">$</span>sum <span class="op">/</span><span class="st"> </span>a</span>
<span id="cb666-1656"><a href="all-r-code-in-this-book.html#cb666-1656" aria-hidden="true"></a>d<span class="op">$</span>sum_km =<span class="st"> </span>d<span class="op">$</span>sum <span class="op">/</span><span class="st"> </span>a</span>
<span id="cb666-1657"><a href="all-r-code-in-this-book.html#cb666-1657" aria-hidden="true"></a>od =<span class="st"> </span><span class="kw">c</span>(o[<span class="st">&quot;sum_km&quot;</span>], d[<span class="st">&quot;sum_km&quot;</span>], <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>)))</span>
<span id="cb666-1658"><a href="all-r-code-in-this-book.html#cb666-1658" aria-hidden="true"></a><span class="kw">plot</span>(od, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1659"><a href="all-r-code-in-this-book.html#cb666-1659" aria-hidden="true"></a>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</span>
<span id="cb666-1660"><a href="all-r-code-in-this-book.html#cb666-1660" aria-hidden="true"></a><span class="kw">read_sf</span>(file) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-1661"><a href="all-r-code-in-this-book.html#cb666-1661" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1662"><a href="all-r-code-in-this-book.html#cb666-1662" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_as_stars</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1663"><a href="all-r-code-in-this-book.html#cb666-1663" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>()</span>
<span id="cb666-1664"><a href="all-r-code-in-this-book.html#cb666-1664" aria-hidden="true"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb666-1665"><a href="all-r-code-in-this-book.html#cb666-1665" aria-hidden="true"></a><span class="kw">read_sf</span>(file) <span class="op">%&gt;%</span></span>
<span id="cb666-1666"><a href="all-r-code-in-this-book.html#cb666-1666" aria-hidden="true"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">as.factor</span>(NAME)) <span class="op">%&gt;%</span></span>
<span id="cb666-1667"><a href="all-r-code-in-this-book.html#cb666-1667" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(SID74, SID79, name) <span class="op">%&gt;%</span></span>
<span id="cb666-1668"><a href="all-r-code-in-this-book.html#cb666-1668" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_rasterize</span>()</span>
<span id="cb666-1669"><a href="all-r-code-in-this-book.html#cb666-1669" aria-hidden="true"></a><span class="kw">read_sf</span>(file) <span class="op">%&gt;%</span></span>
<span id="cb666-1670"><a href="all-r-code-in-this-book.html#cb666-1670" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-1671"><a href="all-r-code-in-this-book.html#cb666-1671" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(CNTY_ID) <span class="op">%&gt;%</span></span>
<span id="cb666-1672"><a href="all-r-code-in-this-book.html#cb666-1672" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_rasterize</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1673"><a href="all-r-code-in-this-book.html#cb666-1673" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>()</span>
<span id="cb666-1674"><a href="all-r-code-in-this-book.html#cb666-1674" aria-hidden="true"></a>x =<span class="st"> </span><span class="kw">st_crs</span>(<span class="st">&quot;OGC:CRS84&quot;</span>)</span>
<span id="cb666-1675"><a href="all-r-code-in-this-book.html#cb666-1675" aria-hidden="true"></a>x<span class="op">$</span>proj4string</span>
<span id="cb666-1676"><a href="all-r-code-in-this-book.html#cb666-1676" aria-hidden="true"></a><span class="kw">sf_proj_search_paths</span>()</span>
<span id="cb666-1677"><a href="all-r-code-in-this-book.html#cb666-1677" aria-hidden="true"></a><span class="kw">paste0</span>(<span class="kw">tail</span>(<span class="kw">sf_proj_search_paths</span>(), <span class="dv">1</span>), .Platform<span class="op">$</span>file.sep, <span class="st">&quot;proj.db&quot;</span>)</span>
<span id="cb666-1678"><a href="all-r-code-in-this-book.html#cb666-1678" aria-hidden="true"></a><span class="kw">sf_extSoftVersion</span>()[<span class="st">&quot;PROJ&quot;</span>]</span>
<span id="cb666-1679"><a href="all-r-code-in-this-book.html#cb666-1679" aria-hidden="true"></a><span class="kw">sf_proj_network</span>()</span>
<span id="cb666-1680"><a href="all-r-code-in-this-book.html#cb666-1680" aria-hidden="true"></a><span class="kw">sf_proj_network</span>(<span class="ot">TRUE</span>)</span>
<span id="cb666-1681"><a href="all-r-code-in-this-book.html#cb666-1681" aria-hidden="true"></a><span class="kw">list.files</span>(<span class="kw">sf_proj_search_paths</span>()[<span class="dv">1</span>], <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1682"><a href="all-r-code-in-this-book.html#cb666-1682" aria-hidden="true"></a>(<span class="dt">p =</span> <span class="kw">sf_proj_pipelines</span>(<span class="st">&quot;EPSG:4326&quot;</span>, <span class="st">&quot;EPSG:22525&quot;</span>))</span>
<span id="cb666-1683"><a href="all-r-code-in-this-book.html#cb666-1683" aria-hidden="true"></a><span class="kw">sf_proj_network</span>(<span class="ot">FALSE</span>)</span>
<span id="cb666-1684"><a href="all-r-code-in-this-book.html#cb666-1684" aria-hidden="true"></a><span class="kw">sf_proj_pipelines</span>(<span class="st">&quot;EPSG:4326&quot;</span>, <span class="st">&quot;EPSG:22525&quot;</span>)</span>
<span id="cb666-1685"><a href="all-r-code-in-this-book.html#cb666-1685" aria-hidden="true"></a><span class="kw">names</span>(p)</span>
<span id="cb666-1686"><a href="all-r-code-in-this-book.html#cb666-1686" aria-hidden="true"></a>p<span class="op">$</span>accuracy</span>
<span id="cb666-1687"><a href="all-r-code-in-this-book.html#cb666-1687" aria-hidden="true"></a>p[<span class="kw">is.na</span>(p<span class="op">$</span>accuracy),]</span>
<span id="cb666-1688"><a href="all-r-code-in-this-book.html#cb666-1688" aria-hidden="true"></a>tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb666-1689"><a href="all-r-code-in-this-book.html#cb666-1689" aria-hidden="true"></a><span class="kw">read_stars</span>(tif) <span class="op">%&gt;%</span></span>
<span id="cb666-1690"><a href="all-r-code-in-this-book.html#cb666-1690" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb666-1691"><a href="all-r-code-in-this-book.html#cb666-1691" aria-hidden="true"></a><span class="kw">read_stars</span>(tif) <span class="op">%&gt;%</span></span>
<span id="cb666-1692"><a href="all-r-code-in-this-book.html#cb666-1692" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_warp</span>(<span class="dt">crs =</span> <span class="kw">st_crs</span>(<span class="dv">4326</span>)) <span class="op">%&gt;%</span></span>
<span id="cb666-1693"><a href="all-r-code-in-this-book.html#cb666-1693" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_dimensions</span>()</span>
<span id="cb666-1694"><a href="all-r-code-in-this-book.html#cb666-1694" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</span>
<span id="cb666-1695"><a href="all-r-code-in-this-book.html#cb666-1695" aria-hidden="true"></a>grd =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span></span>
<span id="cb666-1696"><a href="all-r-code-in-this-book.html#cb666-1696" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1697"><a href="all-r-code-in-this-book.html#cb666-1697" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_transform</span>(<span class="dv">4326</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-1698"><a href="all-r-code-in-this-book.html#cb666-1698" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_bbox</span>() <span class="op">%&gt;%</span></span>
<span id="cb666-1699"><a href="all-r-code-in-this-book.html#cb666-1699" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_as_stars</span>(<span class="dt">nx =</span> <span class="kw">dim</span>(r)[<span class="st">&quot;x&quot;</span>], <span class="dt">ny =</span> <span class="kw">dim</span>(r)[<span class="st">&quot;y&quot;</span>])</span>
<span id="cb666-1700"><a href="all-r-code-in-this-book.html#cb666-1700" aria-hidden="true"></a><span class="kw">st_warp</span>(r, grd)</span>
<span id="cb666-1701"><a href="all-r-code-in-this-book.html#cb666-1701" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-1702"><a href="all-r-code-in-this-book.html#cb666-1702" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-1703"><a href="all-r-code-in-this-book.html#cb666-1703" aria-hidden="true"></a></span>
<span id="cb666-1704"><a href="all-r-code-in-this-book.html#cb666-1704" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-1705"><a href="all-r-code-in-this-book.html#cb666-1705" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-1706"><a href="all-r-code-in-this-book.html#cb666-1706" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-1707"><a href="all-r-code-in-this-book.html#cb666-1707" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-1708"><a href="all-r-code-in-this-book.html#cb666-1708" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-1709"><a href="all-r-code-in-this-book.html#cb666-1709" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-1710"><a href="all-r-code-in-this-book.html#cb666-1710" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-1711"><a href="all-r-code-in-this-book.html#cb666-1711" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-1712"><a href="all-r-code-in-this-book.html#cb666-1712" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-1713"><a href="all-r-code-in-this-book.html#cb666-1713" aria-hidden="true"></a>)</span>
<span id="cb666-1714"><a href="all-r-code-in-this-book.html#cb666-1714" aria-hidden="true"></a></span>
<span id="cb666-1715"><a href="all-r-code-in-this-book.html#cb666-1715" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-1716"><a href="all-r-code-in-this-book.html#cb666-1716" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-1717"><a href="all-r-code-in-this-book.html#cb666-1717" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1718"><a href="all-r-code-in-this-book.html#cb666-1718" aria-hidden="true"></a></span>
<span id="cb666-1719"><a href="all-r-code-in-this-book.html#cb666-1719" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-1720"><a href="all-r-code-in-this-book.html#cb666-1720" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-1721"><a href="all-r-code-in-this-book.html#cb666-1721" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-1722"><a href="all-r-code-in-this-book.html#cb666-1722" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-1723"><a href="all-r-code-in-this-book.html#cb666-1723" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-1724"><a href="all-r-code-in-this-book.html#cb666-1724" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1725"><a href="all-r-code-in-this-book.html#cb666-1725" aria-hidden="true"></a>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</span>
<span id="cb666-1726"><a href="all-r-code-in-this-book.html#cb666-1726" aria-hidden="true"></a>bb =<span class="st"> &quot;POLYGON ((-81.7 36.2, -80.4 36.2, -80.4 36.5, -81.7 36.5, -81.7 36.2))&quot;</span></span>
<span id="cb666-1727"><a href="all-r-code-in-this-book.html#cb666-1727" aria-hidden="true"></a>nc<span class="fl">.1</span> =<span class="st"> </span><span class="kw">st_read</span>(file, <span class="dt">wkt_filter =</span> bb)</span>
<span id="cb666-1728"><a href="all-r-code-in-this-book.html#cb666-1728" aria-hidden="true"></a>q =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;select BIR74,SID74,geom from &#39;nc.gpkg&#39; where BIR74 &gt; 1500&quot;</span>)</span>
<span id="cb666-1729"><a href="all-r-code-in-this-book.html#cb666-1729" aria-hidden="true"></a>nc<span class="fl">.2</span> =<span class="st"> </span><span class="kw">st_read</span>(file, <span class="dt">query =</span> q)</span>
<span id="cb666-1730"><a href="all-r-code-in-this-book.html#cb666-1730" aria-hidden="true"></a>q =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;select BIR74,SID74,geom from &#39;nc.gpkg&#39; LIMIT 10 OFFSET 50&quot;</span>)</span>
<span id="cb666-1731"><a href="all-r-code-in-this-book.html#cb666-1731" aria-hidden="true"></a>nc<span class="fl">.2</span> =<span class="st"> </span><span class="kw">st_read</span>(file, <span class="dt">query =</span> q)</span>
<span id="cb666-1732"><a href="all-r-code-in-this-book.html#cb666-1732" aria-hidden="true"></a>has_PG &lt;-<span class="st"> </span><span class="kw">any</span>(<span class="st">&quot;PostgreSQL&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">st_drivers</span>()<span class="op">$</span>name) <span class="op">&amp;&amp;</span></span>
<span id="cb666-1733"><a href="all-r-code-in-this-book.html#cb666-1733" aria-hidden="true"></a><span class="st">    </span><span class="op">!</span><span class="kw">inherits</span>(<span class="kw">try</span>(DBI<span class="op">::</span><span class="kw">dbConnect</span>( </span>
<span id="cb666-1734"><a href="all-r-code-in-this-book.html#cb666-1734" aria-hidden="true"></a>        RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</span>
<span id="cb666-1735"><a href="all-r-code-in-this-book.html#cb666-1735" aria-hidden="true"></a>        <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</span>
<span id="cb666-1736"><a href="all-r-code-in-this-book.html#cb666-1736" aria-hidden="true"></a>        <span class="dt">dbname =</span> <span class="st">&quot;postgis&quot;</span>), <span class="dt">silent =</span> <span class="ot">TRUE</span>), <span class="st">&quot;try-error&quot;</span>)</span>
<span id="cb666-1737"><a href="all-r-code-in-this-book.html#cb666-1737" aria-hidden="true"></a>nc =<span class="st"> </span><span class="kw">read_sf</span>(file)</span>
<span id="cb666-1738"><a href="all-r-code-in-this-book.html#cb666-1738" aria-hidden="true"></a><span class="kw">write_sf</span>(nc, <span class="st">&quot;PG:dbname=postgis&quot;</span>, <span class="st">&quot;nc&quot;</span>)</span>
<span id="cb666-1739"><a href="all-r-code-in-this-book.html#cb666-1739" aria-hidden="true"></a>pg &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</span>
<span id="cb666-1740"><a href="all-r-code-in-this-book.html#cb666-1740" aria-hidden="true"></a>    RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</span>
<span id="cb666-1741"><a href="all-r-code-in-this-book.html#cb666-1741" aria-hidden="true"></a>    <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</span>
<span id="cb666-1742"><a href="all-r-code-in-this-book.html#cb666-1742" aria-hidden="true"></a>    <span class="dt">dbname =</span> <span class="st">&quot;postgis&quot;</span>)</span>
<span id="cb666-1743"><a href="all-r-code-in-this-book.html#cb666-1743" aria-hidden="true"></a><span class="kw">st_read</span>(pg, <span class="dt">query =</span> <span class="st">&quot;select BIR74,wkb_geometry from nc limit 3&quot;</span>)</span>
<span id="cb666-1744"><a href="all-r-code-in-this-book.html#cb666-1744" aria-hidden="true"></a>q =<span class="st"> &quot;SELECT BIR74,wkb_geometry FROM nc WHERE \</span></span>
<span id="cb666-1745"><a href="all-r-code-in-this-book.html#cb666-1745" aria-hidden="true"></a><span class="st">  ST_Intersects(wkb_geometry, &#39;SRID=4267;POINT (-81.49826 36.4314)&#39;);&quot;</span></span>
<span id="cb666-1746"><a href="all-r-code-in-this-book.html#cb666-1746" aria-hidden="true"></a><span class="kw">st_read</span>(pg, <span class="dt">query =</span> q)</span>
<span id="cb666-1747"><a href="all-r-code-in-this-book.html#cb666-1747" aria-hidden="true"></a><span class="kw">library</span>(dplyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1748"><a href="all-r-code-in-this-book.html#cb666-1748" aria-hidden="true"></a>nc_db =<span class="st"> </span><span class="kw">tbl</span>(pg, <span class="st">&quot;nc&quot;</span>)</span>
<span id="cb666-1749"><a href="all-r-code-in-this-book.html#cb666-1749" aria-hidden="true"></a>nc_db <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-1750"><a href="all-r-code-in-this-book.html#cb666-1750" aria-hidden="true"></a><span class="st">     </span><span class="kw">filter</span>(<span class="kw">ST_Intersects</span>(wkb_geometry, <span class="st">&#39;SRID=4267;POINT (-81.49826 36.4314)&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb666-1751"><a href="all-r-code-in-this-book.html#cb666-1751" aria-hidden="true"></a><span class="st">     </span><span class="kw">collect</span>()</span>
<span id="cb666-1752"><a href="all-r-code-in-this-book.html#cb666-1752" aria-hidden="true"></a>nc_db <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">ST_Area</span>(wkb_geometry) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb666-1753"><a href="all-r-code-in-this-book.html#cb666-1753" aria-hidden="true"></a><span class="kw">download.file</span>(</span>
<span id="cb666-1754"><a href="all-r-code-in-this-book.html#cb666-1754" aria-hidden="true"></a>  <span class="st">&quot;https://openstreetmap.org/api/0.6/map?bbox=7.595,51.969,7.598,51.970&quot;</span>,</span>
<span id="cb666-1755"><a href="all-r-code-in-this-book.html#cb666-1755" aria-hidden="true"></a>  <span class="st">&quot;data/ms.osm&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;auto&quot;</span>)</span>
<span id="cb666-1756"><a href="all-r-code-in-this-book.html#cb666-1756" aria-hidden="true"></a>o =<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/ms.osm&quot;</span>, <span class="st">&quot;lines&quot;</span>)</span>
<span id="cb666-1757"><a href="all-r-code-in-this-book.html#cb666-1757" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/ms.osm&quot;</span>, <span class="st">&quot;multipolygons&quot;</span>)</span>
<span id="cb666-1758"><a href="all-r-code-in-this-book.html#cb666-1758" aria-hidden="true"></a>bb =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin=</span><span class="fl">7.595</span>, <span class="dt">ymin =</span> <span class="fl">51.969</span>, <span class="dt">xmax =</span> <span class="fl">7.598</span>, <span class="dt">ymax =</span> <span class="fl">51.970</span>),</span>
<span id="cb666-1759"><a href="all-r-code-in-this-book.html#cb666-1759" aria-hidden="true"></a>    <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb666-1760"><a href="all-r-code-in-this-book.html#cb666-1760" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_as_sfc</span>(bb), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">cex.axis =</span> <span class="fl">.5</span>)</span>
<span id="cb666-1761"><a href="all-r-code-in-this-book.html#cb666-1761" aria-hidden="true"></a><span class="kw">plot</span>(o[,<span class="dv">1</span>], <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1762"><a href="all-r-code-in-this-book.html#cb666-1762" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(p), <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">col =</span> <span class="st">&#39;#88888888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1763"><a href="all-r-code-in-this-book.html#cb666-1763" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">timeout =</span> <span class="dv">600</span>) <span class="co"># or large in case of slow network</span></span>
<span id="cb666-1764"><a href="all-r-code-in-this-book.html#cb666-1764" aria-hidden="true"></a><span class="kw">install.packages</span>(<span class="st">&quot;starsdata&quot;</span>, <span class="dt">repos =</span> <span class="st">&quot;http://pebesma.staff.ifgi.de&quot;</span>, </span>
<span id="cb666-1765"><a href="all-r-code-in-this-book.html#cb666-1765" aria-hidden="true"></a>    <span class="dt">type =</span> <span class="st">&quot;source&quot;</span>)</span>
<span id="cb666-1766"><a href="all-r-code-in-this-book.html#cb666-1766" aria-hidden="true"></a>f =<span class="st"> &quot;sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip&quot;</span></span>
<span id="cb666-1767"><a href="all-r-code-in-this-book.html#cb666-1767" aria-hidden="true"></a>granule =<span class="st"> </span><span class="kw">system.file</span>(<span class="dt">file =</span> f, <span class="dt">package =</span> <span class="st">&quot;starsdata&quot;</span>)</span>
<span id="cb666-1768"><a href="all-r-code-in-this-book.html#cb666-1768" aria-hidden="true"></a><span class="kw">file.size</span>(granule)</span>
<span id="cb666-1769"><a href="all-r-code-in-this-book.html#cb666-1769" aria-hidden="true"></a>base_name =<span class="st"> </span><span class="kw">strsplit</span>(<span class="kw">basename</span>(granule), <span class="st">&quot;.zip&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb666-1770"><a href="all-r-code-in-this-book.html#cb666-1770" aria-hidden="true"></a>s2 =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;SENTINEL2_L1C:/vsizip/&quot;</span>, granule, <span class="st">&quot;/&quot;</span>, base_name, </span>
<span id="cb666-1771"><a href="all-r-code-in-this-book.html#cb666-1771" aria-hidden="true"></a>    <span class="st">&quot;.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632&quot;</span>)</span>
<span id="cb666-1772"><a href="all-r-code-in-this-book.html#cb666-1772" aria-hidden="true"></a>(<span class="dt">p =</span> <span class="kw">read_stars</span>(s2, <span class="dt">proxy =</span> <span class="ot">TRUE</span>))</span>
<span id="cb666-1773"><a href="all-r-code-in-this-book.html#cb666-1773" aria-hidden="true"></a><span class="kw">object.size</span>(p)</span>
<span id="cb666-1774"><a href="all-r-code-in-this-book.html#cb666-1774" aria-hidden="true"></a>p2 =<span class="st"> </span>p <span class="op">*</span><span class="st"> </span><span class="dv">2</span></span>
<span id="cb666-1775"><a href="all-r-code-in-this-book.html#cb666-1775" aria-hidden="true"></a><span class="kw">plot</span>(p)</span>
<span id="cb666-1776"><a href="all-r-code-in-this-book.html#cb666-1776" aria-hidden="true"></a>(<span class="dt">ds =</span> <span class="kw">floor</span>(<span class="kw">sqrt</span>(<span class="kw">prod</span>(<span class="kw">dim</span>(p)) <span class="op">/</span><span class="st"> </span><span class="kw">prod</span>(<span class="kw">dev.size</span>(<span class="st">&quot;px&quot;</span>)))))</span>
<span id="cb666-1777"><a href="all-r-code-in-this-book.html#cb666-1777" aria-hidden="true"></a><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;stars_proxy&quot;</span>)</span>
<span id="cb666-1778"><a href="all-r-code-in-this-book.html#cb666-1778" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-1779"><a href="all-r-code-in-this-book.html#cb666-1779" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-1780"><a href="all-r-code-in-this-book.html#cb666-1780" aria-hidden="true"></a></span>
<span id="cb666-1781"><a href="all-r-code-in-this-book.html#cb666-1781" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-1782"><a href="all-r-code-in-this-book.html#cb666-1782" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-1783"><a href="all-r-code-in-this-book.html#cb666-1783" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-1784"><a href="all-r-code-in-this-book.html#cb666-1784" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-1785"><a href="all-r-code-in-this-book.html#cb666-1785" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-1786"><a href="all-r-code-in-this-book.html#cb666-1786" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-1787"><a href="all-r-code-in-this-book.html#cb666-1787" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-1788"><a href="all-r-code-in-this-book.html#cb666-1788" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-1789"><a href="all-r-code-in-this-book.html#cb666-1789" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-1790"><a href="all-r-code-in-this-book.html#cb666-1790" aria-hidden="true"></a>)</span>
<span id="cb666-1791"><a href="all-r-code-in-this-book.html#cb666-1791" aria-hidden="true"></a></span>
<span id="cb666-1792"><a href="all-r-code-in-this-book.html#cb666-1792" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-1793"><a href="all-r-code-in-this-book.html#cb666-1793" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-1794"><a href="all-r-code-in-this-book.html#cb666-1794" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1795"><a href="all-r-code-in-this-book.html#cb666-1795" aria-hidden="true"></a></span>
<span id="cb666-1796"><a href="all-r-code-in-this-book.html#cb666-1796" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-1797"><a href="all-r-code-in-this-book.html#cb666-1797" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-1798"><a href="all-r-code-in-this-book.html#cb666-1798" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-1799"><a href="all-r-code-in-this-book.html#cb666-1799" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-1800"><a href="all-r-code-in-this-book.html#cb666-1800" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-1801"><a href="all-r-code-in-this-book.html#cb666-1801" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1802"><a href="all-r-code-in-this-book.html#cb666-1802" aria-hidden="true"></a><span class="kw">library</span>(rnaturalearth)</span>
<span id="cb666-1803"><a href="all-r-code-in-this-book.html#cb666-1803" aria-hidden="true"></a>w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb666-1804"><a href="all-r-code-in-this-book.html#cb666-1804" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(<span class="kw">st_crs</span>(w) &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">4326</span>))</span>
<span id="cb666-1805"><a href="all-r-code-in-this-book.html#cb666-1805" aria-hidden="true"></a><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb666-1806"><a href="all-r-code-in-this-book.html#cb666-1806" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span>
<span id="cb666-1807"><a href="all-r-code-in-this-book.html#cb666-1807" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</span>
<span id="cb666-1808"><a href="all-r-code-in-this-book.html#cb666-1808" aria-hidden="true"></a></span>
<span id="cb666-1809"><a href="all-r-code-in-this-book.html#cb666-1809" aria-hidden="true"></a><span class="co"># sphere:</span></span>
<span id="cb666-1810"><a href="all-r-code-in-this-book.html#cb666-1810" aria-hidden="true"></a><span class="kw">library</span>(s2)</span>
<span id="cb666-1811"><a href="all-r-code-in-this-book.html#cb666-1811" aria-hidden="true"></a>g =<span class="st"> </span><span class="kw">as_s2_geography</span>(<span class="ot">TRUE</span>) <span class="co"># Earth</span></span>
<span id="cb666-1812"><a href="all-r-code-in-this-book.html#cb666-1812" aria-hidden="true"></a>co =<span class="st"> </span><span class="kw">s2_data_countries</span>()</span>
<span id="cb666-1813"><a href="all-r-code-in-this-book.html#cb666-1813" aria-hidden="true"></a>oc =<span class="st"> </span><span class="kw">s2_difference</span>(g, <span class="kw">s2_union_agg</span>(co)) <span class="co"># oceans</span></span>
<span id="cb666-1814"><a href="all-r-code-in-this-book.html#cb666-1814" aria-hidden="true"></a>b =<span class="st"> </span><span class="kw">s2_buffer_cells</span>(<span class="kw">as_s2_geography</span>(<span class="st">&quot;POINT(-30 -10)&quot;</span>), <span class="dv">9800000</span>) <span class="co"># visible half</span></span>
<span id="cb666-1815"><a href="all-r-code-in-this-book.html#cb666-1815" aria-hidden="true"></a>i =<span class="st"> </span><span class="kw">s2_intersection</span>(b, oc) <span class="co"># visible ocean</span></span>
<span id="cb666-1816"><a href="all-r-code-in-this-book.html#cb666-1816" aria-hidden="true"></a>co =<span class="st"> </span><span class="kw">s2_intersection</span>(b, co)</span>
<span id="cb666-1817"><a href="all-r-code-in-this-book.html#cb666-1817" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(i), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;lightblue&#39;</span>)</span>
<span id="cb666-1818"><a href="all-r-code-in-this-book.html#cb666-1818" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(co), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1819"><a href="all-r-code-in-this-book.html#cb666-1819" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1820"><a href="all-r-code-in-this-book.html#cb666-1820" aria-hidden="true"></a><span class="kw">library</span>(rnaturalearth)</span>
<span id="cb666-1821"><a href="all-r-code-in-this-book.html#cb666-1821" aria-hidden="true"></a>w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb666-1822"><a href="all-r-code-in-this-book.html#cb666-1822" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</span>
<span id="cb666-1823"><a href="all-r-code-in-this-book.html#cb666-1823" aria-hidden="true"></a><span class="kw">st_is_longlat</span>(w)</span>
<span id="cb666-1824"><a href="all-r-code-in-this-book.html#cb666-1824" aria-hidden="true"></a>DE =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">ne_countries</span>(<span class="dt">country =</span> <span class="st">&quot;germany&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>))</span>
<span id="cb666-1825"><a href="all-r-code-in-this-book.html#cb666-1825" aria-hidden="true"></a>DE.eqc =<span class="st"> </span><span class="kw">st_transform</span>(DE, <span class="st">&quot;+proj=eqc +lat_ts=51.14 +lon_0=90w&quot;</span>)</span>
<span id="cb666-1826"><a href="all-r-code-in-this-book.html#cb666-1826" aria-hidden="true"></a><span class="kw">print</span>(<span class="kw">mean</span>(<span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="st">&quot;ymin&quot;</span>, <span class="st">&quot;ymax&quot;</span>)]), <span class="dt">digits =</span> <span class="dv">4</span>)</span>
<span id="cb666-1827"><a href="all-r-code-in-this-book.html#cb666-1827" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb666-1828"><a href="all-r-code-in-this-book.html#cb666-1828" aria-hidden="true"></a><span class="kw">plot</span>(DE, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1829"><a href="all-r-code-in-this-book.html#cb666-1829" aria-hidden="true"></a><span class="kw">plot</span>(DE.eqc, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1830"><a href="all-r-code-in-this-book.html#cb666-1830" aria-hidden="true"></a><span class="kw">library</span>(classInt)</span>
<span id="cb666-1831"><a href="all-r-code-in-this-book.html#cb666-1831" aria-hidden="true"></a><span class="co"># set.seed(1) needed ?</span></span>
<span id="cb666-1832"><a href="all-r-code-in-this-book.html#cb666-1832" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb666-1833"><a href="all-r-code-in-this-book.html#cb666-1833" aria-hidden="true"></a>(cI &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(r))</span>
<span id="cb666-1834"><a href="all-r-code-in-this-book.html#cb666-1834" aria-hidden="true"></a>cI<span class="op">$</span>brks</span>
<span id="cb666-1835"><a href="all-r-code-in-this-book.html#cb666-1835" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1836"><a href="all-r-code-in-this-book.html#cb666-1836" aria-hidden="true"></a>nc =<span class="st"> </span><span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</span>
<span id="cb666-1837"><a href="all-r-code-in-this-book.html#cb666-1837" aria-hidden="true"></a><span class="kw">plot</span>(nc[<span class="st">&quot;BIR74&quot;</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">key.pos =</span> <span class="dv">4</span>)</span>
<span id="cb666-1838"><a href="all-r-code-in-this-book.html#cb666-1838" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">st_buffer</span>(nc[<span class="dv">1</span>,<span class="dv">1</span>], units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">10</span>, km)), <span class="dt">col =</span> <span class="st">&#39;NA&#39;</span>, </span>
<span id="cb666-1839"><a href="all-r-code-in-this-book.html#cb666-1839" aria-hidden="true"></a>     <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1840"><a href="all-r-code-in-this-book.html#cb666-1840" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-1841"><a href="all-r-code-in-this-book.html#cb666-1841" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>))</span>
<span id="cb666-1842"><a href="all-r-code-in-this-book.html#cb666-1842" aria-hidden="true"></a>circ =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_sample</span>(<span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_buffer</span>(<span class="dv">300</span>)</span>
<span id="cb666-1843"><a href="all-r-code-in-this-book.html#cb666-1843" aria-hidden="true"></a>hook =<span class="st"> </span><span class="cf">function</span>() <span class="kw">plot</span>(circ, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;yellow&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1844"><a href="all-r-code-in-this-book.html#cb666-1844" aria-hidden="true"></a><span class="kw">plot</span>(r, <span class="dt">hook =</span> hook, <span class="dt">key.pos =</span> <span class="dv">4</span>)</span>
<span id="cb666-1845"><a href="all-r-code-in-this-book.html#cb666-1845" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(tidyverse))</span>
<span id="cb666-1846"><a href="all-r-code-in-this-book.html#cb666-1846" aria-hidden="true"></a>nc<span class="fl">.32119</span> =<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">32119</span>) </span>
<span id="cb666-1847"><a href="all-r-code-in-this-book.html#cb666-1847" aria-hidden="true"></a>year_labels =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span> =<span class="st"> &quot;1974 - 1978&quot;</span>, <span class="st">&quot;SID79&quot;</span> =<span class="st"> &quot;1979 - 1984&quot;</span>)</span>
<span id="cb666-1848"><a href="all-r-code-in-this-book.html#cb666-1848" aria-hidden="true"></a>nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(VAR, SID, <span class="op">-</span>geom) -&gt;<span class="st"> </span>nc2</span>
<span id="cb666-1849"><a href="all-r-code-in-this-book.html#cb666-1849" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc2, <span class="kw">aes</span>(<span class="dt">fill =</span> SID)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-1850"><a href="all-r-code-in-this-book.html#cb666-1850" aria-hidden="true"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>VAR, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> <span class="kw">labeller</span>(<span class="dt">VAR =</span> year_labels)) <span class="op">+</span></span>
<span id="cb666-1851"><a href="all-r-code-in-this-book.html#cb666-1851" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">34</span><span class="op">:</span><span class="dv">36</span>) <span class="op">+</span></span>
<span id="cb666-1852"><a href="all-r-code-in-this-book.html#cb666-1852" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>)) <span class="op">+</span></span>
<span id="cb666-1853"><a href="all-r-code-in-this-book.html#cb666-1853" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>))</span>
<span id="cb666-1854"><a href="all-r-code-in-this-book.html#cb666-1854" aria-hidden="true"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb666-1855"><a href="all-r-code-in-this-book.html#cb666-1855" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-1856"><a href="all-r-code-in-this-book.html#cb666-1856" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>))</span>
<span id="cb666-1857"><a href="all-r-code-in-this-book.html#cb666-1857" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> r) <span class="op">+</span></span>
<span id="cb666-1858"><a href="all-r-code-in-this-book.html#cb666-1858" aria-hidden="true"></a><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span>band) <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></span>
<span id="cb666-1859"><a href="all-r-code-in-this-book.html#cb666-1859" aria-hidden="true"></a><span class="st">        </span><span class="kw">theme_void</span>() <span class="op">+</span></span>
<span id="cb666-1860"><a href="all-r-code-in-this-book.html#cb666-1860" aria-hidden="true"></a><span class="st">        </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-1861"><a href="all-r-code-in-this-book.html#cb666-1861" aria-hidden="true"></a><span class="st">        </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb666-1862"><a href="all-r-code-in-this-book.html#cb666-1862" aria-hidden="true"></a><span class="st">        </span><span class="kw">scale_fill_viridis_c</span>()</span>
<span id="cb666-1863"><a href="all-r-code-in-this-book.html#cb666-1863" aria-hidden="true"></a><span class="kw">library</span>(tmap)</span>
<span id="cb666-1864"><a href="all-r-code-in-this-book.html#cb666-1864" aria-hidden="true"></a><span class="kw">tm_shape</span>(nc<span class="fl">.32119</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span>, <span class="st">&quot;SID79&quot;</span>))</span>
<span id="cb666-1865"><a href="all-r-code-in-this-book.html#cb666-1865" aria-hidden="true"></a><span class="kw">tm_shape</span>(nc2) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="st">&quot;SID&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">by =</span> <span class="st">&quot;VAR&quot;</span>)</span>
<span id="cb666-1866"><a href="all-r-code-in-this-book.html#cb666-1866" aria-hidden="true"></a><span class="kw">tm_shape</span>(r) <span class="op">+</span><span class="st"> </span><span class="kw">tm_raster</span>(<span class="st">&quot;L7_ETMs.tif&quot;</span>)</span>
<span id="cb666-1867"><a href="all-r-code-in-this-book.html#cb666-1867" aria-hidden="true"></a><span class="kw">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</span>
<span id="cb666-1868"><a href="all-r-code-in-this-book.html#cb666-1868" aria-hidden="true"></a><span class="kw">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb666-1869"><a href="all-r-code-in-this-book.html#cb666-1869" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-1870"><a href="all-r-code-in-this-book.html#cb666-1870" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-1871"><a href="all-r-code-in-this-book.html#cb666-1871" aria-hidden="true"></a></span>
<span id="cb666-1872"><a href="all-r-code-in-this-book.html#cb666-1872" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-1873"><a href="all-r-code-in-this-book.html#cb666-1873" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-1874"><a href="all-r-code-in-this-book.html#cb666-1874" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-1875"><a href="all-r-code-in-this-book.html#cb666-1875" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-1876"><a href="all-r-code-in-this-book.html#cb666-1876" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-1877"><a href="all-r-code-in-this-book.html#cb666-1877" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-1878"><a href="all-r-code-in-this-book.html#cb666-1878" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-1879"><a href="all-r-code-in-this-book.html#cb666-1879" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-1880"><a href="all-r-code-in-this-book.html#cb666-1880" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-1881"><a href="all-r-code-in-this-book.html#cb666-1881" aria-hidden="true"></a>)</span>
<span id="cb666-1882"><a href="all-r-code-in-this-book.html#cb666-1882" aria-hidden="true"></a></span>
<span id="cb666-1883"><a href="all-r-code-in-this-book.html#cb666-1883" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-1884"><a href="all-r-code-in-this-book.html#cb666-1884" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-1885"><a href="all-r-code-in-this-book.html#cb666-1885" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1886"><a href="all-r-code-in-this-book.html#cb666-1886" aria-hidden="true"></a></span>
<span id="cb666-1887"><a href="all-r-code-in-this-book.html#cb666-1887" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-1888"><a href="all-r-code-in-this-book.html#cb666-1888" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-1889"><a href="all-r-code-in-this-book.html#cb666-1889" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-1890"><a href="all-r-code-in-this-book.html#cb666-1890" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-1891"><a href="all-r-code-in-this-book.html#cb666-1891" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-1892"><a href="all-r-code-in-this-book.html#cb666-1892" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-1893"><a href="all-r-code-in-this-book.html#cb666-1893" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-1894"><a href="all-r-code-in-this-book.html#cb666-1894" aria-hidden="true"></a></span>
<span id="cb666-1895"><a href="all-r-code-in-this-book.html#cb666-1895" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-1896"><a href="all-r-code-in-this-book.html#cb666-1896" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-1897"><a href="all-r-code-in-this-book.html#cb666-1897" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-1898"><a href="all-r-code-in-this-book.html#cb666-1898" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-1899"><a href="all-r-code-in-this-book.html#cb666-1899" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-1900"><a href="all-r-code-in-this-book.html#cb666-1900" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-1901"><a href="all-r-code-in-this-book.html#cb666-1901" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-1902"><a href="all-r-code-in-this-book.html#cb666-1902" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-1903"><a href="all-r-code-in-this-book.html#cb666-1903" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-1904"><a href="all-r-code-in-this-book.html#cb666-1904" aria-hidden="true"></a>)</span>
<span id="cb666-1905"><a href="all-r-code-in-this-book.html#cb666-1905" aria-hidden="true"></a></span>
<span id="cb666-1906"><a href="all-r-code-in-this-book.html#cb666-1906" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-1907"><a href="all-r-code-in-this-book.html#cb666-1907" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-1908"><a href="all-r-code-in-this-book.html#cb666-1908" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1909"><a href="all-r-code-in-this-book.html#cb666-1909" aria-hidden="true"></a></span>
<span id="cb666-1910"><a href="all-r-code-in-this-book.html#cb666-1910" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-1911"><a href="all-r-code-in-this-book.html#cb666-1911" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-1912"><a href="all-r-code-in-this-book.html#cb666-1912" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-1913"><a href="all-r-code-in-this-book.html#cb666-1913" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-1914"><a href="all-r-code-in-this-book.html#cb666-1914" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-1915"><a href="all-r-code-in-this-book.html#cb666-1915" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-1916"><a href="all-r-code-in-this-book.html#cb666-1916" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-1917"><a href="all-r-code-in-this-book.html#cb666-1917" aria-hidden="true"></a></span>
<span id="cb666-1918"><a href="all-r-code-in-this-book.html#cb666-1918" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-1919"><a href="all-r-code-in-this-book.html#cb666-1919" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-1920"><a href="all-r-code-in-this-book.html#cb666-1920" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-1921"><a href="all-r-code-in-this-book.html#cb666-1921" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-1922"><a href="all-r-code-in-this-book.html#cb666-1922" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-1923"><a href="all-r-code-in-this-book.html#cb666-1923" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-1924"><a href="all-r-code-in-this-book.html#cb666-1924" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-1925"><a href="all-r-code-in-this-book.html#cb666-1925" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-1926"><a href="all-r-code-in-this-book.html#cb666-1926" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-1927"><a href="all-r-code-in-this-book.html#cb666-1927" aria-hidden="true"></a>)</span>
<span id="cb666-1928"><a href="all-r-code-in-this-book.html#cb666-1928" aria-hidden="true"></a></span>
<span id="cb666-1929"><a href="all-r-code-in-this-book.html#cb666-1929" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-1930"><a href="all-r-code-in-this-book.html#cb666-1930" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-1931"><a href="all-r-code-in-this-book.html#cb666-1931" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-1932"><a href="all-r-code-in-this-book.html#cb666-1932" aria-hidden="true"></a></span>
<span id="cb666-1933"><a href="all-r-code-in-this-book.html#cb666-1933" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-1934"><a href="all-r-code-in-this-book.html#cb666-1934" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-1935"><a href="all-r-code-in-this-book.html#cb666-1935" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-1936"><a href="all-r-code-in-this-book.html#cb666-1936" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-1937"><a href="all-r-code-in-this-book.html#cb666-1937" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-1938"><a href="all-r-code-in-this-book.html#cb666-1938" aria-hidden="true"></a><span class="co"># after running the &quot;Spatiotemporal Geostatistics&quot; chapter, write NO2 means by</span></span>
<span id="cb666-1939"><a href="all-r-code-in-this-book.html#cb666-1939" aria-hidden="true"></a><span class="kw">write_csv</span>(<span class="kw">right_join</span>(a2, tb), <span class="st">&quot;no2.csv&quot;</span>)</span>
<span id="cb666-1940"><a href="all-r-code-in-this-book.html#cb666-1940" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb666-1941"><a href="all-r-code-in-this-book.html#cb666-1941" aria-hidden="true"></a>no2 =<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">system.file</span>(<span class="st">&quot;external/no2.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;gstat&quot;</span>))</span>
<span id="cb666-1942"><a href="all-r-code-in-this-book.html#cb666-1942" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-1943"><a href="all-r-code-in-this-book.html#cb666-1943" aria-hidden="true"></a>crs =<span class="st"> </span><span class="kw">st_crs</span>(<span class="st">&quot;EPSG:32632&quot;</span>)</span>
<span id="cb666-1944"><a href="all-r-code-in-this-book.html#cb666-1944" aria-hidden="true"></a>no2.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(no2, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;station_longitude_deg&quot;</span>, <span class="st">&quot;station_latitude_deg&quot;</span>), <span class="dt">crs =</span> <span class="st">&quot;OGC:CRS84&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-1945"><a href="all-r-code-in-this-book.html#cb666-1945" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_transform</span>(crs)</span>
<span id="cb666-1946"><a href="all-r-code-in-this-book.html#cb666-1946" aria-hidden="true"></a><span class="co"># load German boundaries</span></span>
<span id="cb666-1947"><a href="all-r-code-in-this-book.html#cb666-1947" aria-hidden="true"></a><span class="kw">data</span>(air, <span class="dt">package =</span> <span class="st">&quot;spacetime&quot;</span>)</span>
<span id="cb666-1948"><a href="all-r-code-in-this-book.html#cb666-1948" aria-hidden="true"></a>de &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(DE_NUTS1), crs)</span>
<span id="cb666-1949"><a href="all-r-code-in-this-book.html#cb666-1949" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> de) <span class="op">+</span><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">col =</span> NO2))</span>
<span id="cb666-1950"><a href="all-r-code-in-this-book.html#cb666-1950" aria-hidden="true"></a><span class="co"># build a grid over Germany:</span></span>
<span id="cb666-1951"><a href="all-r-code-in-this-book.html#cb666-1951" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-1952"><a href="all-r-code-in-this-book.html#cb666-1952" aria-hidden="true"></a><span class="kw">st_bbox</span>(de) <span class="op">%&gt;%</span></span>
<span id="cb666-1953"><a href="all-r-code-in-this-book.html#cb666-1953" aria-hidden="true"></a><span class="st">  </span><span class="kw">st_as_stars</span>(<span class="dt">dx =</span> <span class="dv">10000</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-1954"><a href="all-r-code-in-this-book.html#cb666-1954" aria-hidden="true"></a><span class="st">  </span><span class="kw">st_crop</span>(de) -&gt;<span class="st"> </span>grd</span>
<span id="cb666-1955"><a href="all-r-code-in-this-book.html#cb666-1955" aria-hidden="true"></a>grd</span>
<span id="cb666-1956"><a href="all-r-code-in-this-book.html#cb666-1956" aria-hidden="true"></a><span class="kw">library</span>(gstat)</span>
<span id="cb666-1957"><a href="all-r-code-in-this-book.html#cb666-1957" aria-hidden="true"></a>i =<span class="st"> </span><span class="kw">idw</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd)</span>
<span id="cb666-1958"><a href="all-r-code-in-this-book.html#cb666-1958" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> i, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-1959"><a href="all-r-code-in-this-book.html#cb666-1959" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>), <span class="kw">aes</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-1960"><a href="all-r-code-in-this-book.html#cb666-1960" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf)</span>
<span id="cb666-1961"><a href="all-r-code-in-this-book.html#cb666-1961" aria-hidden="true"></a>v =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf)</span>
<span id="cb666-1962"><a href="all-r-code-in-this-book.html#cb666-1962" aria-hidden="true"></a><span class="kw">plot</span>(v, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1963"><a href="all-r-code-in-this-book.html#cb666-1963" aria-hidden="true"></a><span class="kw">library</span>(gstat)</span>
<span id="cb666-1964"><a href="all-r-code-in-this-book.html#cb666-1964" aria-hidden="true"></a>v0 =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, <span class="dt">cutoff =</span> <span class="dv">100000</span>, <span class="dt">width =</span> <span class="dv">10000</span>)</span>
<span id="cb666-1965"><a href="all-r-code-in-this-book.html#cb666-1965" aria-hidden="true"></a><span class="kw">plot</span>(v0, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1966"><a href="all-r-code-in-this-book.html#cb666-1966" aria-hidden="true"></a>v.m =<span class="st"> </span><span class="kw">fit.variogram</span>(v, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</span>
<span id="cb666-1967"><a href="all-r-code-in-this-book.html#cb666-1967" aria-hidden="true"></a><span class="kw">plot</span>(v, v.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-1968"><a href="all-r-code-in-this-book.html#cb666-1968" aria-hidden="true"></a>k =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m)</span>
<span id="cb666-1969"><a href="all-r-code-in-this-book.html#cb666-1969" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> k, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-1970"><a href="all-r-code-in-this-book.html#cb666-1970" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-1971"><a href="all-r-code-in-this-book.html#cb666-1971" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span></span>
<span id="cb666-1972"><a href="all-r-code-in-this-book.html#cb666-1972" aria-hidden="true"></a><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</span>
<span id="cb666-1973"><a href="all-r-code-in-this-book.html#cb666-1973" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], <span class="dt">by =</span> de, <span class="dt">FUN =</span> mean)</span>
<span id="cb666-1974"><a href="all-r-code-in-this-book.html#cb666-1974" aria-hidden="true"></a>b =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, de, v.m)</span>
<span id="cb666-1975"><a href="all-r-code-in-this-book.html#cb666-1975" aria-hidden="true"></a>b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</span>
<span id="cb666-1976"><a href="all-r-code-in-this-book.html#cb666-1976" aria-hidden="true"></a>b<span class="op">$</span>kriging =<span class="st"> </span>b<span class="op">$</span>var1.pred</span>
<span id="cb666-1977"><a href="all-r-code-in-this-book.html#cb666-1977" aria-hidden="true"></a>b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(var, NO2, <span class="op">-</span>geometry) -&gt;<span class="st"> </span>b2</span>
<span id="cb666-1978"><a href="all-r-code-in-this-book.html#cb666-1978" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> NO2)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var) <span class="op">+</span></span>
<span id="cb666-1979"><a href="all-r-code-in-this-book.html#cb666-1979" aria-hidden="true"></a><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</span>
<span id="cb666-1980"><a href="all-r-code-in-this-book.html#cb666-1980" aria-hidden="true"></a>SE =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sqrt</span>(<span class="kw">var</span>(x)<span class="op">/</span><span class="kw">length</span>(x))</span>
<span id="cb666-1981"><a href="all-r-code-in-this-book.html#cb666-1981" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], de, SE)</span>
<span id="cb666-1982"><a href="all-r-code-in-this-book.html#cb666-1982" aria-hidden="true"></a>b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</span>
<span id="cb666-1983"><a href="all-r-code-in-this-book.html#cb666-1983" aria-hidden="true"></a>b<span class="op">$</span>kriging =<span class="st"> </span><span class="kw">sqrt</span>(b<span class="op">$</span>var1.var)</span>
<span id="cb666-1984"><a href="all-r-code-in-this-book.html#cb666-1984" aria-hidden="true"></a>b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(var, NO2, <span class="op">-</span>geometry) -&gt;<span class="st"> </span>b2</span>
<span id="cb666-1985"><a href="all-r-code-in-this-book.html#cb666-1985" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> NO2)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var) <span class="op">+</span></span>
<span id="cb666-1986"><a href="all-r-code-in-this-book.html#cb666-1986" aria-hidden="true"></a><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</span>
<span id="cb666-1987"><a href="all-r-code-in-this-book.html#cb666-1987" aria-hidden="true"></a><span class="kw">library</span>(viridis)</span>
<span id="cb666-1988"><a href="all-r-code-in-this-book.html#cb666-1988" aria-hidden="true"></a>s =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m, <span class="dt">nmax =</span> <span class="dv">30</span>, <span class="dt">nsim =</span> <span class="dv">10</span>)</span>
<span id="cb666-1989"><a href="all-r-code-in-this-book.html#cb666-1989" aria-hidden="true"></a>g =<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></span>
<span id="cb666-1990"><a href="all-r-code-in-this-book.html#cb666-1990" aria-hidden="true"></a><span class="st">    </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span></span>
<span id="cb666-1991"><a href="all-r-code-in-this-book.html#cb666-1991" aria-hidden="true"></a><span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span></span>
<span id="cb666-1992"><a href="all-r-code-in-this-book.html#cb666-1992" aria-hidden="true"></a><span class="st">    </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb666-1993"><a href="all-r-code-in-this-book.html#cb666-1993" aria-hidden="true"></a><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb666-1994"><a href="all-r-code-in-this-book.html#cb666-1994" aria-hidden="true"></a>g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> s[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sample)</span>
<span id="cb666-1995"><a href="all-r-code-in-this-book.html#cb666-1995" aria-hidden="true"></a>v =<span class="st"> </span>vroom<span class="op">::</span><span class="kw">vroom</span>(<span class="st">&quot;aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv&quot;</span>)</span>
<span id="cb666-1996"><a href="all-r-code-in-this-book.html#cb666-1996" aria-hidden="true"></a>v <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Einwohner <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-1997"><a href="all-r-code-in-this-book.html#cb666-1997" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>Gitter_ID_100m) <span class="op">%&gt;%</span></span>
<span id="cb666-1998"><a href="all-r-code-in-this-book.html#cb666-1998" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x_mp_100m&quot;</span>, <span class="st">&quot;y_mp_100m&quot;</span>), <span class="dt">crs =</span> <span class="dv">3035</span>) <span class="op">%&gt;%</span></span>
<span id="cb666-1999"><a href="all-r-code-in-this-book.html#cb666-1999" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(grd)) -&gt;<span class="st"> </span>b</span>
<span id="cb666-2000"><a href="all-r-code-in-this-book.html#cb666-2000" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">aggregate</span>(b, <span class="kw">st_as_sf</span>(grd, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), sum)</span>
<span id="cb666-2001"><a href="all-r-code-in-this-book.html#cb666-2001" aria-hidden="true"></a>v =<span class="st"> </span>vroom<span class="op">::</span><span class="kw">vroom</span>(<span class="st">&quot;aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv&quot;</span>)</span>
<span id="cb666-2002"><a href="all-r-code-in-this-book.html#cb666-2002" aria-hidden="true"></a>v1 &lt;-<span class="st"> </span>v[v<span class="op">$</span>Einwohner <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb666-2003"><a href="all-r-code-in-this-book.html#cb666-2003" aria-hidden="true"></a><span class="kw">rm</span>(v); <span class="kw">gc</span>(<span class="dt">full=</span><span class="ot">TRUE</span>)</span>
<span id="cb666-2004"><a href="all-r-code-in-this-book.html#cb666-2004" aria-hidden="true"></a>v2 &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(v1, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x_mp_100m&quot;</span>, <span class="st">&quot;y_mp_100m&quot;</span>), <span class="dt">crs =</span> <span class="dv">3035</span>)</span>
<span id="cb666-2005"><a href="all-r-code-in-this-book.html#cb666-2005" aria-hidden="true"></a><span class="kw">rm</span>(v1); <span class="kw">gc</span>()</span>
<span id="cb666-2006"><a href="all-r-code-in-this-book.html#cb666-2006" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">st_transform</span>(v2, <span class="kw">st_crs</span>(grd))</span>
<span id="cb666-2007"><a href="all-r-code-in-this-book.html#cb666-2007" aria-hidden="true"></a><span class="kw">rm</span>(v2); <span class="kw">gc</span>()</span>
<span id="cb666-2008"><a href="all-r-code-in-this-book.html#cb666-2008" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">aggregate</span>(b, <span class="kw">st_as_sf</span>(grd, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), sum)</span>
<span id="cb666-2009"><a href="all-r-code-in-this-book.html#cb666-2009" aria-hidden="true"></a><span class="kw">gc</span>()</span>
<span id="cb666-2010"><a href="all-r-code-in-this-book.html#cb666-2010" aria-hidden="true"></a>grd<span class="op">$</span>ID =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">prod</span>(<span class="kw">dim</span>(grd)) <span class="co"># so we can find out later which grid cell we have</span></span>
<span id="cb666-2011"><a href="all-r-code-in-this-book.html#cb666-2011" aria-hidden="true"></a>ii =<span class="st"> </span><span class="kw">st_intersects</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="kw">st_cast</span>(<span class="kw">st_union</span>(de), <span class="st">&quot;MULTILINESTRING&quot;</span>))</span>
<span id="cb666-2012"><a href="all-r-code-in-this-book.html#cb666-2012" aria-hidden="true"></a>grd_sf =<span class="st"> </span><span class="kw">st_as_sf</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)[<span class="kw">lengths</span>(ii) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,]</span>
<span id="cb666-2013"><a href="all-r-code-in-this-book.html#cb666-2013" aria-hidden="true"></a>iii =<span class="st"> </span><span class="kw">st_intersection</span>(grd_sf, <span class="kw">st_union</span>(de))</span>
<span id="cb666-2014"><a href="all-r-code-in-this-book.html#cb666-2014" aria-hidden="true"></a>grd<span class="op">$</span>area =<span class="st"> </span><span class="kw">st_area</span>(grd)[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(grd<span class="op">$</span>values, m<span class="op">^</span><span class="dv">2</span>) <span class="co"># NA&#39;s</span></span>
<span id="cb666-2015"><a href="all-r-code-in-this-book.html#cb666-2015" aria-hidden="true"></a>grd<span class="op">$</span>area[iii<span class="op">$</span>ID] =<span class="st"> </span><span class="kw">st_area</span>(iii)</span>
<span id="cb666-2016"><a href="all-r-code-in-this-book.html#cb666-2016" aria-hidden="true"></a>grd<span class="op">$</span>pop_dens =<span class="st"> </span>a<span class="op">$</span>Einwohner <span class="op">/</span><span class="st"> </span>grd<span class="op">$</span>area</span>
<span id="cb666-2017"><a href="all-r-code-in-this-book.html#cb666-2017" aria-hidden="true"></a><span class="kw">sum</span>(grd<span class="op">$</span>pop_dens <span class="op">*</span><span class="st"> </span>grd<span class="op">$</span>area, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># verify</span></span>
<span id="cb666-2018"><a href="all-r-code-in-this-book.html#cb666-2018" aria-hidden="true"></a><span class="kw">sum</span>(b<span class="op">$</span>Einwohner)</span>
<span id="cb666-2019"><a href="all-r-code-in-this-book.html#cb666-2019" aria-hidden="true"></a>g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> grd, <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">sqrt</span>(pop_dens), <span class="dt">x =</span> x, <span class="dt">y =</span> y))</span>
<span id="cb666-2020"><a href="all-r-code-in-this-book.html#cb666-2020" aria-hidden="true"></a>(<span class="dt">a =</span> <span class="kw">aggregate</span>(grd[<span class="st">&quot;pop_dens&quot;</span>], no2.sf, mean))</span>
<span id="cb666-2021"><a href="all-r-code-in-this-book.html#cb666-2021" aria-hidden="true"></a>no2.sf<span class="op">$</span>pop_dens =<span class="st"> </span><span class="kw">st_as_sf</span>(a)[[<span class="dv">1</span>]]</span>
<span id="cb666-2022"><a href="all-r-code-in-this-book.html#cb666-2022" aria-hidden="true"></a><span class="kw">summary</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</span>
<span id="cb666-2023"><a href="all-r-code-in-this-book.html#cb666-2023" aria-hidden="true"></a><span class="kw">plot</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</span>
<span id="cb666-2024"><a href="all-r-code-in-this-book.html#cb666-2024" aria-hidden="true"></a><span class="kw">abline</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</span>
<span id="cb666-2025"><a href="all-r-code-in-this-book.html#cb666-2025" aria-hidden="true"></a>no2.sf =<span class="st"> </span>no2.sf[<span class="op">!</span><span class="kw">is.na</span>(no2.sf<span class="op">$</span>pop_dens),]</span>
<span id="cb666-2026"><a href="all-r-code-in-this-book.html#cb666-2026" aria-hidden="true"></a>vr =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</span>
<span id="cb666-2027"><a href="all-r-code-in-this-book.html#cb666-2027" aria-hidden="true"></a>vr.m =<span class="st"> </span><span class="kw">fit.variogram</span>(vr, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</span>
<span id="cb666-2028"><a href="all-r-code-in-this-book.html#cb666-2028" aria-hidden="true"></a><span class="kw">plot</span>(vr, vr.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-2029"><a href="all-r-code-in-this-book.html#cb666-2029" aria-hidden="true"></a>kr =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf, grd[<span class="st">&quot;pop_dens&quot;</span>], vr.m)</span>
<span id="cb666-2030"><a href="all-r-code-in-this-book.html#cb666-2030" aria-hidden="true"></a>k<span class="op">$</span>kr1 =<span class="st"> </span>k<span class="op">$</span>var1.pred</span>
<span id="cb666-2031"><a href="all-r-code-in-this-book.html#cb666-2031" aria-hidden="true"></a>k<span class="op">$</span>kr2 =<span class="st"> </span>kr<span class="op">$</span>var1.pred</span>
<span id="cb666-2032"><a href="all-r-code-in-this-book.html#cb666-2032" aria-hidden="true"></a><span class="kw">st_redimension</span>(k[<span class="kw">c</span>(<span class="st">&quot;kr1&quot;</span>, <span class="st">&quot;kr2&quot;</span>)], </span>
<span id="cb666-2033"><a href="all-r-code-in-this-book.html#cb666-2033" aria-hidden="true"></a>    <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">what =</span> <span class="kw">c</span>(<span class="st">&quot;kriging&quot;</span>, <span class="st">&quot;residual kriging&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb666-2034"><a href="all-r-code-in-this-book.html#cb666-2034" aria-hidden="true"></a><span class="st">    </span><span class="kw">setNames</span>(<span class="st">&quot;NO2&quot;</span>) -&gt;<span class="st"> </span>km</span>
<span id="cb666-2035"><a href="all-r-code-in-this-book.html#cb666-2035" aria-hidden="true"></a>g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> km, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2036"><a href="all-r-code-in-this-book.html#cb666-2036" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2037"><a href="all-r-code-in-this-book.html#cb666-2037" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>what) <span class="op">+</span></span>
<span id="cb666-2038"><a href="all-r-code-in-this-book.html#cb666-2038" aria-hidden="true"></a><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</span>
<span id="cb666-2039"><a href="all-r-code-in-this-book.html#cb666-2039" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2040"><a href="all-r-code-in-this-book.html#cb666-2040" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2041"><a href="all-r-code-in-this-book.html#cb666-2041" aria-hidden="true"></a></span>
<span id="cb666-2042"><a href="all-r-code-in-this-book.html#cb666-2042" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2043"><a href="all-r-code-in-this-book.html#cb666-2043" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2044"><a href="all-r-code-in-this-book.html#cb666-2044" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2045"><a href="all-r-code-in-this-book.html#cb666-2045" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2046"><a href="all-r-code-in-this-book.html#cb666-2046" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2047"><a href="all-r-code-in-this-book.html#cb666-2047" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2048"><a href="all-r-code-in-this-book.html#cb666-2048" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2049"><a href="all-r-code-in-this-book.html#cb666-2049" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2050"><a href="all-r-code-in-this-book.html#cb666-2050" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2051"><a href="all-r-code-in-this-book.html#cb666-2051" aria-hidden="true"></a>)</span>
<span id="cb666-2052"><a href="all-r-code-in-this-book.html#cb666-2052" aria-hidden="true"></a></span>
<span id="cb666-2053"><a href="all-r-code-in-this-book.html#cb666-2053" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2054"><a href="all-r-code-in-this-book.html#cb666-2054" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2055"><a href="all-r-code-in-this-book.html#cb666-2055" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2056"><a href="all-r-code-in-this-book.html#cb666-2056" aria-hidden="true"></a></span>
<span id="cb666-2057"><a href="all-r-code-in-this-book.html#cb666-2057" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2058"><a href="all-r-code-in-this-book.html#cb666-2058" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2059"><a href="all-r-code-in-this-book.html#cb666-2059" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2060"><a href="all-r-code-in-this-book.html#cb666-2060" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2061"><a href="all-r-code-in-this-book.html#cb666-2061" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-2062"><a href="all-r-code-in-this-book.html#cb666-2062" aria-hidden="true"></a><span class="co"># try(load(&quot;data/ch16.rda&quot;))</span></span>
<span id="cb666-2063"><a href="all-r-code-in-this-book.html#cb666-2063" aria-hidden="true"></a>files =<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;aq&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;*.csv&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-2064"><a href="all-r-code-in-this-book.html#cb666-2064" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">lapply</span>(files[<span class="op">-</span><span class="dv">1</span>], <span class="cf">function</span>(f) <span class="kw">read.csv</span>(f))</span>
<span id="cb666-2065"><a href="all-r-code-in-this-book.html#cb666-2065" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">TZ =</span> <span class="st">&quot;UTC&quot;</span>) <span class="co"># make sure times are not interpreted as DST</span></span>
<span id="cb666-2066"><a href="all-r-code-in-this-book.html#cb666-2066" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">lapply</span>(r, <span class="cf">function</span>(f) {</span>
<span id="cb666-2067"><a href="all-r-code-in-this-book.html#cb666-2067" aria-hidden="true"></a>        f<span class="op">$</span>t =<span class="st"> </span><span class="kw">as.POSIXct</span>(f<span class="op">$</span>DatetimeBegin) </span>
<span id="cb666-2068"><a href="all-r-code-in-this-book.html#cb666-2068" aria-hidden="true"></a>        f[<span class="kw">order</span>(f<span class="op">$</span>t), ] </span>
<span id="cb666-2069"><a href="all-r-code-in-this-book.html#cb666-2069" aria-hidden="true"></a>    }</span>
<span id="cb666-2070"><a href="all-r-code-in-this-book.html#cb666-2070" aria-hidden="true"></a>) </span>
<span id="cb666-2071"><a href="all-r-code-in-this-book.html#cb666-2071" aria-hidden="true"></a>r =<span class="st"> </span>r[<span class="kw">sapply</span>(r, nrow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span>]</span>
<span id="cb666-2072"><a href="all-r-code-in-this-book.html#cb666-2072" aria-hidden="true"></a><span class="kw">names</span>(r) =<span class="st">  </span><span class="kw">sapply</span>(r, <span class="cf">function</span>(f) <span class="kw">unique</span>(f<span class="op">$</span>AirQualityStationEoICode))</span>
<span id="cb666-2073"><a href="all-r-code-in-this-book.html#cb666-2073" aria-hidden="true"></a><span class="kw">length</span>(r) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(<span class="kw">names</span>(r)))</span>
<span id="cb666-2074"><a href="all-r-code-in-this-book.html#cb666-2074" aria-hidden="true"></a><span class="kw">library</span>(xts)</span>
<span id="cb666-2075"><a href="all-r-code-in-this-book.html#cb666-2075" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">lapply</span>(r, <span class="cf">function</span>(f) <span class="kw">xts</span>(f<span class="op">$</span>Concentration, f<span class="op">$</span>t))</span>
<span id="cb666-2076"><a href="all-r-code-in-this-book.html#cb666-2076" aria-hidden="true"></a>aq =<span class="st"> </span><span class="kw">do.call</span>(cbind, r)</span>
<span id="cb666-2077"><a href="all-r-code-in-this-book.html#cb666-2077" aria-hidden="true"></a><span class="co"># remove stations with more than 75% missing values:</span></span>
<span id="cb666-2078"><a href="all-r-code-in-this-book.html#cb666-2078" aria-hidden="true"></a>sel =<span class="st"> </span><span class="kw">apply</span>(aq, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="kw">is.na</span>(x)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.75</span> <span class="op">*</span><span class="st"> </span><span class="dv">365</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span>)</span>
<span id="cb666-2079"><a href="all-r-code-in-this-book.html#cb666-2079" aria-hidden="true"></a>aqsel =<span class="st"> </span>aq[, sel] <span class="co"># stations are in columns</span></span>
<span id="cb666-2080"><a href="all-r-code-in-this-book.html#cb666-2080" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb666-2081"><a href="all-r-code-in-this-book.html#cb666-2081" aria-hidden="true"></a><span class="kw">read.csv</span>(<span class="st">&quot;aq/AirBase_v8_stations.csv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2082"><a href="all-r-code-in-this-book.html#cb666-2082" aria-hidden="true"></a><span class="st">    </span>as_tibble  <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2083"><a href="all-r-code-in-this-book.html#cb666-2083" aria-hidden="true"></a><span class="st">    </span><span class="kw">filter</span>(country_iso_code <span class="op">==</span><span class="st"> &quot;DE&quot;</span>, station_type_of_area <span class="op">==</span><span class="st"> &quot;rural&quot;</span>, </span>
<span id="cb666-2084"><a href="all-r-code-in-this-book.html#cb666-2084" aria-hidden="true"></a>                 type_of_station <span class="op">==</span><span class="st"> &quot;Background&quot;</span>) -&gt;<span class="st"> </span>a2</span>
<span id="cb666-2085"><a href="all-r-code-in-this-book.html#cb666-2085" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-2086"><a href="all-r-code-in-this-book.html#cb666-2086" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb666-2087"><a href="all-r-code-in-this-book.html#cb666-2087" aria-hidden="true"></a>a2.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(a2, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;station_longitude_deg&quot;</span>, <span class="st">&quot;station_latitude_deg&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb666-2088"><a href="all-r-code-in-this-book.html#cb666-2088" aria-hidden="true"></a>sel =<span class="st">  </span><span class="kw">colnames</span>(aqsel) <span class="op">%in%</span><span class="st"> </span>a2<span class="op">$</span>station_european_code</span>
<span id="cb666-2089"><a href="all-r-code-in-this-book.html#cb666-2089" aria-hidden="true"></a>aqsel =<span class="st"> </span>aqsel[, sel]</span>
<span id="cb666-2090"><a href="all-r-code-in-this-book.html#cb666-2090" aria-hidden="true"></a>tb =<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">NO2 =</span> <span class="kw">apply</span>(aqsel, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">station_european_code =</span> <span class="kw">colnames</span>(aqsel))</span>
<span id="cb666-2091"><a href="all-r-code-in-this-book.html#cb666-2091" aria-hidden="true"></a>crs =<span class="st"> </span><span class="dv">32632</span></span>
<span id="cb666-2092"><a href="all-r-code-in-this-book.html#cb666-2092" aria-hidden="true"></a><span class="kw">right_join</span>(a2.sf, tb) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(crs) -&gt;<span class="st"> </span>no2.sf </span>
<span id="cb666-2093"><a href="all-r-code-in-this-book.html#cb666-2093" aria-hidden="true"></a><span class="co"># load German boundaries</span></span>
<span id="cb666-2094"><a href="all-r-code-in-this-book.html#cb666-2094" aria-hidden="true"></a><span class="kw">data</span>(air, <span class="dt">package =</span> <span class="st">&quot;spacetime&quot;</span>)</span>
<span id="cb666-2095"><a href="all-r-code-in-this-book.html#cb666-2095" aria-hidden="true"></a>de &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(DE_NUTS1), crs)</span>
<span id="cb666-2096"><a href="all-r-code-in-this-book.html#cb666-2096" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> de) <span class="op">+</span><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">col =</span> NO2))</span>
<span id="cb666-2097"><a href="all-r-code-in-this-book.html#cb666-2097" aria-hidden="true"></a><span class="kw">library</span>(gstat)</span>
<span id="cb666-2098"><a href="all-r-code-in-this-book.html#cb666-2098" aria-hidden="true"></a><span class="kw">demo</span>(cokriging)</span>
<span id="cb666-2099"><a href="all-r-code-in-this-book.html#cb666-2099" aria-hidden="true"></a><span class="kw">demo</span>(cosimulation)</span>
<span id="cb666-2100"><a href="all-r-code-in-this-book.html#cb666-2100" aria-hidden="true"></a>aqx =<span class="st"> </span>aq[ , <span class="kw">colnames</span>(aq) <span class="op">%in%</span><span class="st"> </span>a2<span class="op">$</span>station_european_code]</span>
<span id="cb666-2101"><a href="all-r-code-in-this-book.html#cb666-2101" aria-hidden="true"></a>sfc =<span class="st"> </span><span class="kw">st_geometry</span>(a2.sf)[<span class="kw">match</span>(<span class="kw">colnames</span>(aqx), a2.sf<span class="op">$</span>station_european_code)]</span>
<span id="cb666-2102"><a href="all-r-code-in-this-book.html#cb666-2102" aria-hidden="true"></a><span class="kw">st_as_stars</span>(<span class="dt">NO2 =</span> <span class="kw">as.matrix</span>(aqx)) <span class="op">%&gt;%</span></span>
<span id="cb666-2103"><a href="all-r-code-in-this-book.html#cb666-2103" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;station&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb666-2104"><a href="all-r-code-in-this-book.html#cb666-2104" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="kw">index</span>(aqx)) <span class="op">%&gt;%</span></span>
<span id="cb666-2105"><a href="all-r-code-in-this-book.html#cb666-2105" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;station&quot;</span>, sfc) -&gt;<span class="st"> </span>no2.st</span>
<span id="cb666-2106"><a href="all-r-code-in-this-book.html#cb666-2106" aria-hidden="true"></a>v.st =<span class="st"> </span><span class="kw">variogramST</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.st[,<span class="dv">1</span><span class="op">:</span>(<span class="dv">24</span><span class="op">*</span><span class="dv">31</span>)], <span class="dt">tlags =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">48</span>, </span>
<span id="cb666-2107"><a href="all-r-code-in-this-book.html#cb666-2107" aria-hidden="true"></a>    <span class="dt">cores =</span> <span class="kw">getOption</span>(<span class="st">&quot;mc.cores&quot;</span>, <span class="dv">2</span>))</span>
<span id="cb666-2108"><a href="all-r-code-in-this-book.html#cb666-2108" aria-hidden="true"></a>v1 =<span class="st"> </span><span class="kw">plot</span>(v.st)</span>
<span id="cb666-2109"><a href="all-r-code-in-this-book.html#cb666-2109" aria-hidden="true"></a>v2 =<span class="st"> </span><span class="kw">plot</span>(v.st, <span class="dt">map =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2110"><a href="all-r-code-in-this-book.html#cb666-2110" aria-hidden="true"></a><span class="kw">print</span>(v1, <span class="dt">split =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">more =</span> <span class="ot">TRUE</span>)</span>
<span id="cb666-2111"><a href="all-r-code-in-this-book.html#cb666-2111" aria-hidden="true"></a><span class="kw">print</span>(v2, <span class="dt">split =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">more =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2112"><a href="all-r-code-in-this-book.html#cb666-2112" aria-hidden="true"></a><span class="co"># product-sum</span></span>
<span id="cb666-2113"><a href="all-r-code-in-this-book.html#cb666-2113" aria-hidden="true"></a>prodSumModel &lt;-<span class="st"> </span><span class="kw">vgmST</span>(<span class="st">&quot;productSum&quot;</span>,</span>
<span id="cb666-2114"><a href="all-r-code-in-this-book.html#cb666-2114" aria-hidden="true"></a>    <span class="dt">space=</span><span class="kw">vgm</span>(<span class="dv">150</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">200</span>, <span class="dv">0</span>),</span>
<span id="cb666-2115"><a href="all-r-code-in-this-book.html#cb666-2115" aria-hidden="true"></a>    <span class="dt">time=</span> <span class="kw">vgm</span>(<span class="dv">20</span>, <span class="st">&quot;Sph&quot;</span>,   <span class="dv">40</span>, <span class="dv">0</span>),</span>
<span id="cb666-2116"><a href="all-r-code-in-this-book.html#cb666-2116" aria-hidden="true"></a>    <span class="dt">k=</span><span class="dv">2</span>)</span>
<span id="cb666-2117"><a href="all-r-code-in-this-book.html#cb666-2117" aria-hidden="true"></a>StAni =<span class="st"> </span><span class="kw">estiStAni</span>(v.st, <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">200000</span>))</span>
<span id="cb666-2118"><a href="all-r-code-in-this-book.html#cb666-2118" aria-hidden="true"></a>(fitProdSumModel &lt;-<span class="st"> </span><span class="kw">fit.StVariogram</span>(v.st, prodSumModel, <span class="dt">fit.method =</span> <span class="dv">7</span>,</span>
<span id="cb666-2119"><a href="all-r-code-in-this-book.html#cb666-2119" aria-hidden="true"></a>    <span class="dt">stAni =</span> StAni, <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>,</span>
<span id="cb666-2120"><a href="all-r-code-in-this-book.html#cb666-2120" aria-hidden="true"></a>    <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">parscale =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">10</span>)),</span>
<span id="cb666-2121"><a href="all-r-code-in-this-book.html#cb666-2121" aria-hidden="true"></a>    <span class="dt">lower =</span> <span class="kw">rep</span>(<span class="fl">0.0001</span>, <span class="dv">7</span>)))</span>
<span id="cb666-2122"><a href="all-r-code-in-this-book.html#cb666-2122" aria-hidden="true"></a><span class="kw">plot</span>(v.st, fitProdSumModel, <span class="dt">wireframe=</span><span class="ot">FALSE</span>, <span class="dt">all=</span><span class="ot">TRUE</span>, <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">arrows=</span><span class="ot">FALSE</span>), <span class="dt">zlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">150</span>))</span>
<span id="cb666-2123"><a href="all-r-code-in-this-book.html#cb666-2123" aria-hidden="true"></a><span class="kw">plot</span>(v.st, <span class="dt">model=</span>fitProdSumModel, <span class="dt">wireframe=</span><span class="ot">TRUE</span>, <span class="dt">all=</span><span class="ot">TRUE</span>, <span class="dt">scales=</span><span class="kw">list</span>(<span class="dt">arrows=</span><span class="ot">FALSE</span>), <span class="dt">zlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">185</span>))</span>
<span id="cb666-2124"><a href="all-r-code-in-this-book.html#cb666-2124" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb666-2125"><a href="all-r-code-in-this-book.html#cb666-2125" aria-hidden="true"></a>pt =<span class="st"> </span><span class="kw">st_sample</span>(de, <span class="dv">2</span>)</span>
<span id="cb666-2126"><a href="all-r-code-in-this-book.html#cb666-2126" aria-hidden="true"></a>t =<span class="st"> </span><span class="kw">st_get_dimension_values</span>(no2.st, <span class="dv">1</span>)</span>
<span id="cb666-2127"><a href="all-r-code-in-this-book.html#cb666-2127" aria-hidden="true"></a><span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">pts =</span> <span class="kw">matrix</span>(<span class="dv">1</span>, <span class="kw">length</span>(t), <span class="kw">length</span>(pt)))) <span class="op">%&gt;%</span></span>
<span id="cb666-2128"><a href="all-r-code-in-this-book.html#cb666-2128" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;station&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb666-2129"><a href="all-r-code-in-this-book.html#cb666-2129" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, t) <span class="op">%&gt;%</span></span>
<span id="cb666-2130"><a href="all-r-code-in-this-book.html#cb666-2130" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;station&quot;</span>, pt) -&gt;<span class="st"> </span>new_pt</span>
<span id="cb666-2131"><a href="all-r-code-in-this-book.html#cb666-2131" aria-hidden="true"></a>no2.st &lt;-<span class="st"> </span><span class="kw">st_transform</span>(no2.st, crs)</span>
<span id="cb666-2132"><a href="all-r-code-in-this-book.html#cb666-2132" aria-hidden="true"></a>new_ts &lt;-<span class="st"> </span><span class="kw">krigeST</span>(NO2<span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> no2.st[<span class="st">&quot;NO2&quot;</span>], <span class="dt">newdata =</span> new_pt,</span>
<span id="cb666-2133"><a href="all-r-code-in-this-book.html#cb666-2133" aria-hidden="true"></a>         <span class="dt">nmax =</span> <span class="dv">50</span>, <span class="dt">stAni =</span> StAni, <span class="dt">modelList =</span> fitProdSumModel,</span>
<span id="cb666-2134"><a href="all-r-code-in-this-book.html#cb666-2134" aria-hidden="true"></a>         <span class="dt">progress =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2135"><a href="all-r-code-in-this-book.html#cb666-2135" aria-hidden="true"></a><span class="kw">plot</span>(<span class="kw">as.xts</span>(new_ts[<span class="dv">2</span>]))</span>
<span id="cb666-2136"><a href="all-r-code-in-this-book.html#cb666-2136" aria-hidden="true"></a>t4 =<span class="st"> </span>t[(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">*</span><span class="st"> </span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">*</span><span class="dv">30</span>)]</span>
<span id="cb666-2137"><a href="all-r-code-in-this-book.html#cb666-2137" aria-hidden="true"></a></span>
<span id="cb666-2138"><a href="all-r-code-in-this-book.html#cb666-2138" aria-hidden="true"></a>d =<span class="st"> </span><span class="kw">dim</span>(grd)</span>
<span id="cb666-2139"><a href="all-r-code-in-this-book.html#cb666-2139" aria-hidden="true"></a><span class="kw">st_as_stars</span>(<span class="dt">pts =</span> <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(d[<span class="dv">1</span>], d[<span class="dv">2</span>], <span class="dt">time=</span><span class="kw">length</span>(t4)))) <span class="op">%&gt;%</span></span>
<span id="cb666-2140"><a href="all-r-code-in-this-book.html#cb666-2140" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, t4) <span class="op">%&gt;%</span></span>
<span id="cb666-2141"><a href="all-r-code-in-this-book.html#cb666-2141" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;x&quot;</span>, <span class="kw">st_get_dimension_values</span>(grd, <span class="st">&quot;x&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb666-2142"><a href="all-r-code-in-this-book.html#cb666-2142" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;y&quot;</span>, <span class="kw">st_get_dimension_values</span>(grd, <span class="st">&quot;y&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb666-2143"><a href="all-r-code-in-this-book.html#cb666-2143" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_set_crs</span>(crs) -&gt;<span class="st"> </span>grd.st</span>
<span id="cb666-2144"><a href="all-r-code-in-this-book.html#cb666-2144" aria-hidden="true"></a>new_int &lt;-<span class="st"> </span><span class="kw">krigeST</span>(NO2<span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> no2.st[<span class="st">&quot;NO2&quot;</span>], <span class="dt">newdata =</span> grd.st,</span>
<span id="cb666-2145"><a href="all-r-code-in-this-book.html#cb666-2145" aria-hidden="true"></a>         <span class="dt">nmax =</span> <span class="dv">200</span>, <span class="dt">stAni =</span> StAni, <span class="dt">modelList =</span> fitProdSumModel,</span>
<span id="cb666-2146"><a href="all-r-code-in-this-book.html#cb666-2146" aria-hidden="true"></a>         <span class="dt">progress =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2147"><a href="all-r-code-in-this-book.html#cb666-2147" aria-hidden="true"></a><span class="kw">names</span>(new_int)[<span class="dv">2</span>] =<span class="st"> &quot;NO2&quot;</span></span>
<span id="cb666-2148"><a href="all-r-code-in-this-book.html#cb666-2148" aria-hidden="true"></a>g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> new_int, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2149"><a href="all-r-code-in-this-book.html#cb666-2149" aria-hidden="true"></a><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">as.Date</span>(time)) <span class="op">+</span></span>
<span id="cb666-2150"><a href="all-r-code-in-this-book.html#cb666-2150" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2151"><a href="all-r-code-in-this-book.html#cb666-2151" aria-hidden="true"></a><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>, <span class="dt">cex =</span> <span class="fl">.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2152"><a href="all-r-code-in-this-book.html#cb666-2152" aria-hidden="true"></a><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</span>
<span id="cb666-2153"><a href="all-r-code-in-this-book.html#cb666-2153" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2154"><a href="all-r-code-in-this-book.html#cb666-2154" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2155"><a href="all-r-code-in-this-book.html#cb666-2155" aria-hidden="true"></a></span>
<span id="cb666-2156"><a href="all-r-code-in-this-book.html#cb666-2156" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2157"><a href="all-r-code-in-this-book.html#cb666-2157" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2158"><a href="all-r-code-in-this-book.html#cb666-2158" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2159"><a href="all-r-code-in-this-book.html#cb666-2159" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2160"><a href="all-r-code-in-this-book.html#cb666-2160" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2161"><a href="all-r-code-in-this-book.html#cb666-2161" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2162"><a href="all-r-code-in-this-book.html#cb666-2162" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2163"><a href="all-r-code-in-this-book.html#cb666-2163" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2164"><a href="all-r-code-in-this-book.html#cb666-2164" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2165"><a href="all-r-code-in-this-book.html#cb666-2165" aria-hidden="true"></a>)</span>
<span id="cb666-2166"><a href="all-r-code-in-this-book.html#cb666-2166" aria-hidden="true"></a></span>
<span id="cb666-2167"><a href="all-r-code-in-this-book.html#cb666-2167" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2168"><a href="all-r-code-in-this-book.html#cb666-2168" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2169"><a href="all-r-code-in-this-book.html#cb666-2169" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2170"><a href="all-r-code-in-this-book.html#cb666-2170" aria-hidden="true"></a></span>
<span id="cb666-2171"><a href="all-r-code-in-this-book.html#cb666-2171" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2172"><a href="all-r-code-in-this-book.html#cb666-2172" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2173"><a href="all-r-code-in-this-book.html#cb666-2173" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2174"><a href="all-r-code-in-this-book.html#cb666-2174" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2175"><a href="all-r-code-in-this-book.html#cb666-2175" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-2176"><a href="all-r-code-in-this-book.html#cb666-2176" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">echo =</span> <span class="ot">TRUE</span>, <span class="dt">paged.print=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2177"><a href="all-r-code-in-this-book.html#cb666-2177" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-2178"><a href="all-r-code-in-this-book.html#cb666-2178" aria-hidden="true"></a><span class="kw">data</span>(pol_pres15, <span class="dt">package=</span><span class="st">&quot;spDataLarge&quot;</span>)</span>
<span id="cb666-2179"><a href="all-r-code-in-this-book.html#cb666-2179" aria-hidden="true"></a>pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2180"><a href="all-r-code-in-this-book.html#cb666-2180" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(TERYT, name, types)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2181"><a href="all-r-code-in-this-book.html#cb666-2181" aria-hidden="true"></a><span class="st">    </span><span class="kw">head</span>()</span>
<span id="cb666-2182"><a href="all-r-code-in-this-book.html#cb666-2182" aria-hidden="true"></a><span class="kw">library</span>(tmap)</span>
<span id="cb666-2183"><a href="all-r-code-in-this-book.html#cb666-2183" aria-hidden="true"></a><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;types&quot;</span>)</span>
<span id="cb666-2184"><a href="all-r-code-in-this-book.html#cb666-2184" aria-hidden="true"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">all</span>(<span class="kw">st_is_valid</span>(pol_pres15))) pol_pres15 &lt;-<span class="st"> </span><span class="kw">st_make_valid</span>(pol_pres15)</span>
<span id="cb666-2185"><a href="all-r-code-in-this-book.html#cb666-2185" aria-hidden="true"></a><span class="kw">library</span>(spdep)</span>
<span id="cb666-2186"><a href="all-r-code-in-this-book.html#cb666-2186" aria-hidden="true"></a><span class="kw">args</span>(poly2nb)</span>
<span id="cb666-2187"><a href="all-r-code-in-this-book.html#cb666-2187" aria-hidden="true"></a><span class="kw">system.time</span>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">poly2nb</span>(<span class="dt">queen=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_q)</span>
<span id="cb666-2188"><a href="all-r-code-in-this-book.html#cb666-2188" aria-hidden="true"></a>nb_q</span>
<span id="cb666-2189"><a href="all-r-code-in-this-book.html#cb666-2189" aria-hidden="true"></a>old_use_s2 &lt;-<span class="st"> </span><span class="kw">sf_use_s2</span>()</span>
<span id="cb666-2190"><a href="all-r-code-in-this-book.html#cb666-2190" aria-hidden="true"></a><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</span>
<span id="cb666-2191"><a href="all-r-code-in-this-book.html#cb666-2191" aria-hidden="true"></a>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;OGC:CRS84&quot;</span>) -&gt;<span class="st"> </span>pol_pres15_ll) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2192"><a href="all-r-code-in-this-book.html#cb666-2192" aria-hidden="true"></a><span class="st">    </span><span class="kw">poly2nb</span>(<span class="dt">queen=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_q_s2</span>
<span id="cb666-2193"><a href="all-r-code-in-this-book.html#cb666-2193" aria-hidden="true"></a><span class="kw">all.equal</span>(nb_q, nb_q_s2, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2194"><a href="all-r-code-in-this-book.html#cb666-2194" aria-hidden="true"></a>(nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</span>
<span id="cb666-2195"><a href="all-r-code-in-this-book.html#cb666-2195" aria-hidden="true"></a><span class="kw">library</span>(Matrix, <span class="dt">warn.conflicts=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2196"><a href="all-r-code-in-this-book.html#cb666-2196" aria-hidden="true"></a>nb_q <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2197"><a href="all-r-code-in-this-book.html#cb666-2197" aria-hidden="true"></a><span class="st">    </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2198"><a href="all-r-code-in-this-book.html#cb666-2198" aria-hidden="true"></a><span class="st">    </span><span class="kw">as</span>(<span class="st">&quot;CsparseMatrix&quot;</span>) -&gt;<span class="st"> </span>smat</span>
<span id="cb666-2199"><a href="all-r-code-in-this-book.html#cb666-2199" aria-hidden="true"></a><span class="kw">library</span>(igraph, <span class="dt">warn.conflicts=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2200"><a href="all-r-code-in-this-book.html#cb666-2200" aria-hidden="true"></a>(smat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2201"><a href="all-r-code-in-this-book.html#cb666-2201" aria-hidden="true"></a><span class="st">        </span><span class="kw">graph.adjacency</span>() -&gt;<span class="st"> </span>g1) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2202"><a href="all-r-code-in-this-book.html#cb666-2202" aria-hidden="true"></a><span class="st">    </span><span class="kw">count_components</span>()</span>
<span id="cb666-2203"><a href="all-r-code-in-this-book.html#cb666-2203" aria-hidden="true"></a>tf &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext=</span><span class="st">&quot;.gal&quot;</span>)</span>
<span id="cb666-2204"><a href="all-r-code-in-this-book.html#cb666-2204" aria-hidden="true"></a><span class="kw">write.nb.gal</span>(nb_q, tf)</span>
<span id="cb666-2205"><a href="all-r-code-in-this-book.html#cb666-2205" aria-hidden="true"></a>pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2206"><a href="all-r-code-in-this-book.html#cb666-2206" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2207"><a href="all-r-code-in-this-book.html#cb666-2207" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_centroid</span>(<span class="dt">of_largest_polygon=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>coords </span>
<span id="cb666-2208"><a href="all-r-code-in-this-book.html#cb666-2208" aria-hidden="true"></a>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tri2nb</span>() -&gt;<span class="st"> </span>nb_tri)</span>
<span id="cb666-2209"><a href="all-r-code-in-this-book.html#cb666-2209" aria-hidden="true"></a>nb_tri <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2210"><a href="all-r-code-in-this-book.html#cb666-2210" aria-hidden="true"></a><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2211"><a href="all-r-code-in-this-book.html#cb666-2211" aria-hidden="true"></a><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2212"><a href="all-r-code-in-this-book.html#cb666-2212" aria-hidden="true"></a><span class="st">    </span><span class="kw">summary</span>()</span>
<span id="cb666-2213"><a href="all-r-code-in-this-book.html#cb666-2213" aria-hidden="true"></a>(nb_tri <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</span>
<span id="cb666-2214"><a href="all-r-code-in-this-book.html#cb666-2214" aria-hidden="true"></a>(nb_tri <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2215"><a href="all-r-code-in-this-book.html#cb666-2215" aria-hidden="true"></a><span class="st">        </span><span class="kw">soi.graph</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2216"><a href="all-r-code-in-this-book.html#cb666-2216" aria-hidden="true"></a><span class="st">        </span><span class="kw">graph2nb</span>() -&gt;<span class="st"> </span>nb_soi)</span>
<span id="cb666-2217"><a href="all-r-code-in-this-book.html#cb666-2217" aria-hidden="true"></a>(nb_soi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>() -&gt;<span class="st"> </span>n_comp)<span class="op">$</span>nc</span>
<span id="cb666-2218"><a href="all-r-code-in-this-book.html#cb666-2218" aria-hidden="true"></a><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</span>
<span id="cb666-2219"><a href="all-r-code-in-this-book.html#cb666-2219" aria-hidden="true"></a>opar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)<span class="op">+</span><span class="fl">0.5</span>)</span>
<span id="cb666-2220"><a href="all-r-code-in-this-book.html#cb666-2220" aria-hidden="true"></a>pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2221"><a href="all-r-code-in-this-book.html#cb666-2221" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2222"><a href="all-r-code-in-this-book.html#cb666-2222" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>(<span class="dt">border=</span><span class="st">&quot;grey&quot;</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>)</span>
<span id="cb666-2223"><a href="all-r-code-in-this-book.html#cb666-2223" aria-hidden="true"></a>nb_soi <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2224"><a href="all-r-code-in-this-book.html#cb666-2224" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>(<span class="dt">coords=</span>coords, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">points=</span><span class="ot">FALSE</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>)</span>
<span id="cb666-2225"><a href="all-r-code-in-this-book.html#cb666-2225" aria-hidden="true"></a>nb_tri <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2226"><a href="all-r-code-in-this-book.html#cb666-2226" aria-hidden="true"></a><span class="st">    </span><span class="kw">diffnb</span>(nb_soi) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2227"><a href="all-r-code-in-this-book.html#cb666-2227" aria-hidden="true"></a><span class="st">    </span><span class="kw">plot</span>(<span class="dt">coords=</span>coords, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">points=</span><span class="ot">FALSE</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>)</span>
<span id="cb666-2228"><a href="all-r-code-in-this-book.html#cb666-2228" aria-hidden="true"></a><span class="kw">par</span>(opar)</span>
<span id="cb666-2229"><a href="all-r-code-in-this-book.html#cb666-2229" aria-hidden="true"></a>coords <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2230"><a href="all-r-code-in-this-book.html#cb666-2230" aria-hidden="true"></a><span class="st">    </span><span class="kw">knearneigh</span>(<span class="dt">k=</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2231"><a href="all-r-code-in-this-book.html#cb666-2231" aria-hidden="true"></a><span class="st">    </span><span class="kw">knn2nb</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2232"><a href="all-r-code-in-this-book.html#cb666-2232" aria-hidden="true"></a><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2233"><a href="all-r-code-in-this-book.html#cb666-2233" aria-hidden="true"></a><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2234"><a href="all-r-code-in-this-book.html#cb666-2234" aria-hidden="true"></a><span class="st">    </span><span class="kw">summary</span>()</span>
<span id="cb666-2235"><a href="all-r-code-in-this-book.html#cb666-2235" aria-hidden="true"></a><span class="kw">system.time</span>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>) -&gt;<span class="st"> </span>nb_d18)</span>
<span id="cb666-2236"><a href="all-r-code-in-this-book.html#cb666-2236" aria-hidden="true"></a><span class="kw">system.time</span>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>, <span class="dt">use_kd_tree=</span><span class="ot">FALSE</span>) -&gt;<span class="st"> </span>nb_d18a)</span>
<span id="cb666-2237"><a href="all-r-code-in-this-book.html#cb666-2237" aria-hidden="true"></a><span class="kw">all.equal</span>(nb_d18, nb_d18a, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2238"><a href="all-r-code-in-this-book.html#cb666-2238" aria-hidden="true"></a>nb_d18</span>
<span id="cb666-2239"><a href="all-r-code-in-this-book.html#cb666-2239" aria-hidden="true"></a>(nb_d18 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>() -&gt;<span class="st"> </span>n_comp)<span class="op">$</span>nc</span>
<span id="cb666-2240"><a href="all-r-code-in-this-book.html#cb666-2240" aria-hidden="true"></a><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</span>
<span id="cb666-2241"><a href="all-r-code-in-this-book.html#cb666-2241" aria-hidden="true"></a>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18300</span>) -&gt;<span class="st"> </span>nb_d183)</span>
<span id="cb666-2242"><a href="all-r-code-in-this-book.html#cb666-2242" aria-hidden="true"></a>(nb_d183 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</span>
<span id="cb666-2243"><a href="all-r-code-in-this-book.html#cb666-2243" aria-hidden="true"></a>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">16000</span>) -&gt;<span class="st"> </span>nb_d16)</span>
<span id="cb666-2244"><a href="all-r-code-in-this-book.html#cb666-2244" aria-hidden="true"></a>((coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knearneigh</span>(<span class="dt">k=</span><span class="dv">6</span>) -&gt;<span class="st"> </span>knn_k6) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>() -&gt;<span class="st"> </span>nb_k6)</span>
<span id="cb666-2245"><a href="all-r-code-in-this-book.html#cb666-2245" aria-hidden="true"></a>(knn_k6 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>(<span class="dt">sym=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_k6s)</span>
<span id="cb666-2246"><a href="all-r-code-in-this-book.html#cb666-2246" aria-hidden="true"></a>(nb_k6s <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</span>
<span id="cb666-2247"><a href="all-r-code-in-this-book.html#cb666-2247" aria-hidden="true"></a>old_use_s2 &lt;-<span class="st"> </span><span class="kw">sf_use_s2</span>()</span>
<span id="cb666-2248"><a href="all-r-code-in-this-book.html#cb666-2248" aria-hidden="true"></a><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</span>
<span id="cb666-2249"><a href="all-r-code-in-this-book.html#cb666-2249" aria-hidden="true"></a>pol_pres15_ll <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2250"><a href="all-r-code-in-this-book.html#cb666-2250" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2251"><a href="all-r-code-in-this-book.html#cb666-2251" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_centroid</span>(<span class="dt">of_largest_polygon=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>coords_ll</span>
<span id="cb666-2252"><a href="all-r-code-in-this-book.html#cb666-2252" aria-hidden="true"></a>(coords_ll <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knearneigh</span>(<span class="dt">k=</span><span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>() -&gt;<span class="st"> </span>nb_k6_ll)</span>
<span id="cb666-2253"><a href="all-r-code-in-this-book.html#cb666-2253" aria-hidden="true"></a><span class="kw">isTRUE</span>(<span class="kw">all.equal</span>(nb_k6, nb_k6_ll, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>))</span>
<span id="cb666-2254"><a href="all-r-code-in-this-book.html#cb666-2254" aria-hidden="true"></a>nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nbdists</span>(coords_ll) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summary</span>()</span>
<span id="cb666-2255"><a href="all-r-code-in-this-book.html#cb666-2255" aria-hidden="true"></a>nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summary</span>()</span>
<span id="cb666-2256"><a href="all-r-code-in-this-book.html#cb666-2256" aria-hidden="true"></a><span class="kw">sf_use_s2</span>(old_use_s2)</span>
<span id="cb666-2257"><a href="all-r-code-in-this-book.html#cb666-2257" aria-hidden="true"></a><span class="kw">args</span>(nb2listw)</span>
<span id="cb666-2258"><a href="all-r-code-in-this-book.html#cb666-2258" aria-hidden="true"></a><span class="kw">args</span>(spweights.constants)</span>
<span id="cb666-2259"><a href="all-r-code-in-this-book.html#cb666-2259" aria-hidden="true"></a>(nb_q <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2260"><a href="all-r-code-in-this-book.html#cb666-2260" aria-hidden="true"></a><span class="st">        </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_q_B) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2261"><a href="all-r-code-in-this-book.html#cb666-2261" aria-hidden="true"></a><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2262"><a href="all-r-code-in-this-book.html#cb666-2262" aria-hidden="true"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2263"><a href="all-r-code-in-this-book.html#cb666-2263" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</span>
<span id="cb666-2264"><a href="all-r-code-in-this-book.html#cb666-2264" aria-hidden="true"></a>(nb_q <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2265"><a href="all-r-code-in-this-book.html#cb666-2265" aria-hidden="true"></a><span class="st">        </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;W&quot;</span>) -&gt;<span class="st"> </span>lw_q_W) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2266"><a href="all-r-code-in-this-book.html#cb666-2266" aria-hidden="true"></a><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2267"><a href="all-r-code-in-this-book.html#cb666-2267" aria-hidden="true"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2268"><a href="all-r-code-in-this-book.html#cb666-2268" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</span>
<span id="cb666-2269"><a href="all-r-code-in-this-book.html#cb666-2269" aria-hidden="true"></a>nb_d183 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2270"><a href="all-r-code-in-this-book.html#cb666-2270" aria-hidden="true"></a><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2271"><a href="all-r-code-in-this-book.html#cb666-2271" aria-hidden="true"></a><span class="st">    </span><span class="kw">lapply</span>(<span class="cf">function</span>(x) <span class="dv">1</span><span class="op">/</span>(x<span class="op">/</span><span class="dv">1000</span>)) -&gt;<span class="st"> </span>gwts</span>
<span id="cb666-2272"><a href="all-r-code-in-this-book.html#cb666-2272" aria-hidden="true"></a>(nb_d183 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nb2listw</span>(<span class="dt">glist=</span>gwts, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_d183_idw_B) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2273"><a href="all-r-code-in-this-book.html#cb666-2273" aria-hidden="true"></a><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2274"><a href="all-r-code-in-this-book.html#cb666-2274" aria-hidden="true"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2275"><a href="all-r-code-in-this-book.html#cb666-2275" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</span>
<span id="cb666-2276"><a href="all-r-code-in-this-book.html#cb666-2276" aria-hidden="true"></a><span class="kw">try</span>(nb_d16 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_d16_B)</span>
<span id="cb666-2277"><a href="all-r-code-in-this-book.html#cb666-2277" aria-hidden="true"></a>nb_d16 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2278"><a href="all-r-code-in-this-book.html#cb666-2278" aria-hidden="true"></a><span class="st">    </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2279"><a href="all-r-code-in-this-book.html#cb666-2279" aria-hidden="true"></a><span class="st">    </span><span class="kw">spweights.constants</span>(<span class="dt">zero.policy=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2280"><a href="all-r-code-in-this-book.html#cb666-2280" aria-hidden="true"></a><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2281"><a href="all-r-code-in-this-book.html#cb666-2281" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</span>
<span id="cb666-2282"><a href="all-r-code-in-this-book.html#cb666-2282" aria-hidden="true"></a>nb_q</span>
<span id="cb666-2283"><a href="all-r-code-in-this-book.html#cb666-2283" aria-hidden="true"></a>(nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nblag</span>(<span class="dv">2</span>) -&gt;<span class="st"> </span>nb_q2)[[<span class="dv">2</span>]]</span>
<span id="cb666-2284"><a href="all-r-code-in-this-book.html#cb666-2284" aria-hidden="true"></a><span class="kw">nblag_cumul</span>(nb_q2)</span>
<span id="cb666-2285"><a href="all-r-code-in-this-book.html#cb666-2285" aria-hidden="true"></a><span class="kw">union.nb</span>(nb_q2[[<span class="dv">2</span>]], nb_q2[[<span class="dv">1</span>]])</span>
<span id="cb666-2286"><a href="all-r-code-in-this-book.html#cb666-2286" aria-hidden="true"></a><span class="kw">diameter</span>(g1)</span>
<span id="cb666-2287"><a href="all-r-code-in-this-book.html#cb666-2287" aria-hidden="true"></a>g1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">shortest.paths</span>() -&gt;<span class="st"> </span>sps</span>
<span id="cb666-2288"><a href="all-r-code-in-this-book.html#cb666-2288" aria-hidden="true"></a>(sps <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">apply</span>(<span class="dv">2</span>, max) -&gt;<span class="st"> </span>spmax) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">max</span>()</span>
<span id="cb666-2289"><a href="all-r-code-in-this-book.html#cb666-2289" aria-hidden="true"></a>mr &lt;-<span class="st"> </span><span class="kw">which.max</span>(spmax)</span>
<span id="cb666-2290"><a href="all-r-code-in-this-book.html#cb666-2290" aria-hidden="true"></a>pol_pres15<span class="op">$</span>name0[mr]</span>
<span id="cb666-2291"><a href="all-r-code-in-this-book.html#cb666-2291" aria-hidden="true"></a>pol_pres15<span class="op">$</span>sps1 &lt;-<span class="st"> </span>sps[,mr]</span>
<span id="cb666-2292"><a href="all-r-code-in-this-book.html#cb666-2292" aria-hidden="true"></a>tm1 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;sps1&quot;</span>, <span class="dt">title=</span><span class="st">&quot;Shortest path</span><span class="ch">\n</span><span class="st">count&quot;</span>)</span>
<span id="cb666-2293"><a href="all-r-code-in-this-book.html#cb666-2293" aria-hidden="true"></a>coords[mr] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2294"><a href="all-r-code-in-this-book.html#cb666-2294" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_distance</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2295"><a href="all-r-code-in-this-book.html#cb666-2295" aria-hidden="true"></a><span class="st">    </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2296"><a href="all-r-code-in-this-book.html#cb666-2296" aria-hidden="true"></a><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">/</span><span class="dv">1000</span>)() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2297"><a href="all-r-code-in-this-book.html#cb666-2297" aria-hidden="true"></a><span class="st">    </span>units<span class="op">::</span><span class="kw">set_units</span>(<span class="ot">NULL</span>) -&gt;<span class="st"> </span>pol_pres15<span class="op">$</span>dist_<span class="dv">52</span></span>
<span id="cb666-2298"><a href="all-r-code-in-this-book.html#cb666-2298" aria-hidden="true"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb666-2299"><a href="all-r-code-in-this-book.html#cb666-2299" aria-hidden="true"></a>g1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(pol_pres15, <span class="kw">aes</span>(<span class="dt">x=</span>sps1, <span class="dt">y=</span>dist_<span class="dv">52</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;shortest path count&quot;</span>) <span class="op">+</span><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;km distance&quot;</span>)</span>
<span id="cb666-2300"><a href="all-r-code-in-this-book.html#cb666-2300" aria-hidden="true"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="kw">tmap_grob</span>(tm1), g1, <span class="dt">nrow=</span><span class="dv">1</span>)</span>
<span id="cb666-2301"><a href="all-r-code-in-this-book.html#cb666-2301" aria-hidden="true"></a>glance_htest &lt;-<span class="st"> </span><span class="cf">function</span>(ht) <span class="kw">c</span>(ht<span class="op">$</span>estimate, </span>
<span id="cb666-2302"><a href="all-r-code-in-this-book.html#cb666-2302" aria-hidden="true"></a>    <span class="st">&quot;Std deviate&quot;</span>=<span class="kw">unname</span>(ht<span class="op">$</span>statistic), </span>
<span id="cb666-2303"><a href="all-r-code-in-this-book.html#cb666-2303" aria-hidden="true"></a>    <span class="st">&quot;p.value&quot;</span>=<span class="kw">unname</span>(ht<span class="op">$</span>p.value))</span>
<span id="cb666-2304"><a href="all-r-code-in-this-book.html#cb666-2304" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb666-2305"><a href="all-r-code-in-this-book.html#cb666-2305" aria-hidden="true"></a>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2306"><a href="all-r-code-in-this-book.html#cb666-2306" aria-hidden="true"></a><span class="st">        </span><span class="kw">nrow</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2307"><a href="all-r-code-in-this-book.html#cb666-2307" aria-hidden="true"></a><span class="st">        </span><span class="kw">rnorm</span>() -&gt;<span class="st"> </span>x) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2308"><a href="all-r-code-in-this-book.html#cb666-2308" aria-hidden="true"></a><span class="st">    </span><span class="kw">moran.test</span>(lw_q_B, <span class="dt">randomisation=</span><span class="ot">FALSE</span>, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2309"><a href="all-r-code-in-this-book.html#cb666-2309" aria-hidden="true"></a><span class="st">    </span><span class="kw">glance_htest</span>()</span>
<span id="cb666-2310"><a href="all-r-code-in-this-book.html#cb666-2310" aria-hidden="true"></a>beta &lt;-<span class="st"> </span><span class="fl">0.0015</span></span>
<span id="cb666-2311"><a href="all-r-code-in-this-book.html#cb666-2311" aria-hidden="true"></a>coords <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2312"><a href="all-r-code-in-this-book.html#cb666-2312" aria-hidden="true"></a><span class="st">    </span><span class="kw">st_coordinates</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2313"><a href="all-r-code-in-this-book.html#cb666-2313" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="dv">1</span>, <span class="dt">drop=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2314"><a href="all-r-code-in-this-book.html#cb666-2314" aria-hidden="true"></a><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">/</span><span class="dv">1000</span>)() -&gt;<span class="st"> </span>t</span>
<span id="cb666-2315"><a href="all-r-code-in-this-book.html#cb666-2315" aria-hidden="true"></a>(x <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>t -&gt;<span class="st"> </span>x_t) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2316"><a href="all-r-code-in-this-book.html#cb666-2316" aria-hidden="true"></a><span class="st">    </span><span class="kw">moran.test</span>(lw_q_B, <span class="dt">randomisation=</span><span class="ot">FALSE</span>, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2317"><a href="all-r-code-in-this-book.html#cb666-2317" aria-hidden="true"></a><span class="st">    </span><span class="kw">glance_htest</span>()</span>
<span id="cb666-2318"><a href="all-r-code-in-this-book.html#cb666-2318" aria-hidden="true"></a><span class="kw">lm</span>(x_t <span class="op">~</span><span class="st"> </span>t) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2319"><a href="all-r-code-in-this-book.html#cb666-2319" aria-hidden="true"></a><span class="st">    </span><span class="kw">lm.morantest</span>(lw_q_B, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2320"><a href="all-r-code-in-this-book.html#cb666-2320" aria-hidden="true"></a><span class="st">    </span><span class="kw">glance_htest</span>()</span>
<span id="cb666-2321"><a href="all-r-code-in-this-book.html#cb666-2321" aria-hidden="true"></a><span class="kw">args</span>(joincount.test)</span>
<span id="cb666-2322"><a href="all-r-code-in-this-book.html#cb666-2322" aria-hidden="true"></a>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2323"><a href="all-r-code-in-this-book.html#cb666-2323" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2324"><a href="all-r-code-in-this-book.html#cb666-2324" aria-hidden="true"></a><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select=</span>types, <span class="dt">drop=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>Types) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2325"><a href="all-r-code-in-this-book.html#cb666-2325" aria-hidden="true"></a><span class="st">    </span><span class="kw">table</span>()</span>
<span id="cb666-2326"><a href="all-r-code-in-this-book.html#cb666-2326" aria-hidden="true"></a>Types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">joincount.multi</span>(<span class="dt">listw=</span>lw_q_B)</span>
<span id="cb666-2327"><a href="all-r-code-in-this-book.html#cb666-2327" aria-hidden="true"></a>Types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">joincount.multi</span>(<span class="dt">listw=</span>lw_d183_idw_B)</span>
<span id="cb666-2328"><a href="all-r-code-in-this-book.html#cb666-2328" aria-hidden="true"></a><span class="kw">args</span>(moran.test)</span>
<span id="cb666-2329"><a href="all-r-code-in-this-book.html#cb666-2329" aria-hidden="true"></a>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2330"><a href="all-r-code-in-this-book.html#cb666-2330" aria-hidden="true"></a><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2331"><a href="all-r-code-in-this-book.html#cb666-2331" aria-hidden="true"></a><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select=</span>I_turnout, <span class="dt">drop=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>z) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2332"><a href="all-r-code-in-this-book.html#cb666-2332" aria-hidden="true"></a><span class="st">    </span><span class="kw">moran.test</span>(<span class="dt">listw=</span>lw_q_B, <span class="dt">randomisation=</span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2333"><a href="all-r-code-in-this-book.html#cb666-2333" aria-hidden="true"></a><span class="st">    </span><span class="kw">glance_htest</span>()</span>
<span id="cb666-2334"><a href="all-r-code-in-this-book.html#cb666-2334" aria-hidden="true"></a><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, pol_pres15) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2335"><a href="all-r-code-in-this-book.html#cb666-2335" aria-hidden="true"></a><span class="st">    </span><span class="kw">lm.morantest</span>(<span class="dt">listw=</span>lw_q_B) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2336"><a href="all-r-code-in-this-book.html#cb666-2336" aria-hidden="true"></a><span class="st">    </span><span class="kw">glance_htest</span>()</span>
<span id="cb666-2337"><a href="all-r-code-in-this-book.html#cb666-2337" aria-hidden="true"></a>(z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2338"><a href="all-r-code-in-this-book.html#cb666-2338" aria-hidden="true"></a><span class="st">    </span><span class="kw">moran.test</span>(<span class="dt">listw=</span>lw_q_B) -&gt;<span class="st"> </span>mtr) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2339"><a href="all-r-code-in-this-book.html#cb666-2339" aria-hidden="true"></a><span class="st">    </span><span class="kw">glance_htest</span>()</span>
<span id="cb666-2340"><a href="all-r-code-in-this-book.html#cb666-2340" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb666-2341"><a href="all-r-code-in-this-book.html#cb666-2341" aria-hidden="true"></a>z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2342"><a href="all-r-code-in-this-book.html#cb666-2342" aria-hidden="true"></a><span class="st">    </span><span class="kw">moran.mc</span>(<span class="dt">listw=</span>lw_q_B, <span class="dt">nsim=</span><span class="dv">999</span>, <span class="dt">return_boot =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>mmc</span>
<span id="cb666-2343"><a href="all-r-code-in-this-book.html#cb666-2343" aria-hidden="true"></a><span class="kw">c</span>(<span class="st">&quot;Permutation bootstrap&quot;</span>=<span class="kw">var</span>(mmc<span class="op">$</span>t), </span>
<span id="cb666-2344"><a href="all-r-code-in-this-book.html#cb666-2344" aria-hidden="true"></a>  <span class="st">&quot;Analytical randomisation&quot;</span>=<span class="kw">unname</span>(mtr<span class="op">$</span>estimate[<span class="dv">3</span>]))</span>
<span id="cb666-2345"><a href="all-r-code-in-this-book.html#cb666-2345" aria-hidden="true"></a>z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2346"><a href="all-r-code-in-this-book.html#cb666-2346" aria-hidden="true"></a><span class="st">    </span><span class="kw">moran.plot</span>(<span class="dt">listw=</span>lw_q_W, <span class="dt">labels=</span>pol_pres15<span class="op">$</span>TERYT, <span class="dt">cex=</span><span class="dv">1</span>, <span class="dt">pch=</span><span class="st">&quot;.&quot;</span>,</span>
<span id="cb666-2347"><a href="all-r-code-in-this-book.html#cb666-2347" aria-hidden="true"></a>        <span class="dt">xlab=</span><span class="st">&quot;I round turnout&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;lagged turnout&quot;</span>) -&gt;<span class="st"> </span>infl_W</span>
<span id="cb666-2348"><a href="all-r-code-in-this-book.html#cb666-2348" aria-hidden="true"></a>pol_pres15<span class="op">$</span>hat_value &lt;-<span class="st"> </span>infl_W<span class="op">$</span>hat</span>
<span id="cb666-2349"><a href="all-r-code-in-this-book.html#cb666-2349" aria-hidden="true"></a><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hat_value&quot;</span>)</span>
<span id="cb666-2350"><a href="all-r-code-in-this-book.html#cb666-2350" aria-hidden="true"></a><span class="kw">args</span>(localmoran)</span>
<span id="cb666-2351"><a href="all-r-code-in-this-book.html#cb666-2351" aria-hidden="true"></a>z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2352"><a href="all-r-code-in-this-book.html#cb666-2352" aria-hidden="true"></a><span class="st">    </span><span class="kw">localmoran</span>(<span class="dt">listw=</span>lw_q_W, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>) -&gt;<span class="st"> </span>locm</span>
<span id="cb666-2353"><a href="all-r-code-in-this-book.html#cb666-2353" aria-hidden="true"></a><span class="kw">all.equal</span>(<span class="kw">sum</span>(locm[,<span class="dv">1</span>])<span class="op">/</span><span class="kw">Szero</span>(lw_q_W), <span class="kw">unname</span>(<span class="kw">moran.test</span>(z, lw_q_W)<span class="op">$</span>estimate[<span class="dv">1</span>]))</span>
<span id="cb666-2354"><a href="all-r-code-in-this-book.html#cb666-2354" aria-hidden="true"></a>pva &lt;-<span class="st"> </span><span class="cf">function</span>(pv) <span class="kw">cbind</span>(<span class="st">&quot;none&quot;</span>=pv, <span class="st">&quot;bonferroni&quot;</span>=<span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>),</span>
<span id="cb666-2355"><a href="all-r-code-in-this-book.html#cb666-2355" aria-hidden="true"></a>    <span class="st">&quot;fdr&quot;</span>=<span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), <span class="st">&quot;BY&quot;</span>=<span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</span>
<span id="cb666-2356"><a href="all-r-code-in-this-book.html#cb666-2356" aria-hidden="true"></a>locm <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2357"><a href="all-r-code-in-this-book.html#cb666-2357" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="st">&quot;Pr(z != 0)&quot;</span>, <span class="dt">drop=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2358"><a href="all-r-code-in-this-book.html#cb666-2358" aria-hidden="true"></a><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</span>
<span id="cb666-2359"><a href="all-r-code-in-this-book.html#cb666-2359" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</span>
<span id="cb666-2360"><a href="all-r-code-in-this-book.html#cb666-2360" aria-hidden="true"></a><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb666-2361"><a href="all-r-code-in-this-book.html#cb666-2361" aria-hidden="true"></a><span class="kw">library</span>(parallel)</span>
<span id="cb666-2362"><a href="all-r-code-in-this-book.html#cb666-2362" aria-hidden="true"></a><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L))</span>
<span id="cb666-2363"><a href="all-r-code-in-this-book.html#cb666-2363" aria-hidden="true"></a><span class="kw">system.time</span>(z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2364"><a href="all-r-code-in-this-book.html#cb666-2364" aria-hidden="true"></a><span class="st">        </span><span class="kw">localmoran_perm</span>(<span class="dt">listw=</span>lw_q_W, <span class="dt">nsim=</span><span class="dv">499</span>, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>,</span>
<span id="cb666-2365"><a href="all-r-code-in-this-book.html#cb666-2365" aria-hidden="true"></a>            <span class="dt">iseed=</span><span class="dv">1</span>) -&gt;<span class="st"> </span>locm_p)</span>
<span id="cb666-2366"><a href="all-r-code-in-this-book.html#cb666-2366" aria-hidden="true"></a>locm_p <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2367"><a href="all-r-code-in-this-book.html#cb666-2367" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="st">&quot;Pr(z != 0)&quot;</span>, <span class="dt">drop=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2368"><a href="all-r-code-in-this-book.html#cb666-2368" aria-hidden="true"></a><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</span>
<span id="cb666-2369"><a href="all-r-code-in-this-book.html#cb666-2369" aria-hidden="true"></a><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb666-2370"><a href="all-r-code-in-this-book.html#cb666-2370" aria-hidden="true"></a>brks &lt;-<span class="st"> </span><span class="kw">qnorm</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>, <span class="fl">0.99</span>, <span class="fl">0.999</span>, <span class="fl">0.9999</span>,</span>
<span id="cb666-2371"><a href="all-r-code-in-this-book.html#cb666-2371" aria-hidden="true"></a>    <span class="fl">0.99999</span>, <span class="dv">1</span>))</span>
<span id="cb666-2372"><a href="all-r-code-in-this-book.html#cb666-2372" aria-hidden="true"></a>(locm_p <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2373"><a href="all-r-code-in-this-book.html#cb666-2373" aria-hidden="true"></a><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select=</span>Z.Ii, <span class="dt">drop=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2374"><a href="all-r-code-in-this-book.html#cb666-2374" aria-hidden="true"></a><span class="st">        </span><span class="kw">cut</span>(brks) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2375"><a href="all-r-code-in-this-book.html#cb666-2375" aria-hidden="true"></a><span class="st">        </span><span class="kw">table</span>()-&gt;<span class="st"> </span>tab)</span>
<span id="cb666-2376"><a href="all-r-code-in-this-book.html#cb666-2376" aria-hidden="true"></a><span class="kw">sum</span>(tab[<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">8</span><span class="op">:</span><span class="dv">12</span>)])</span>
<span id="cb666-2377"><a href="all-r-code-in-this-book.html#cb666-2377" aria-hidden="true"></a><span class="kw">sum</span>(tab[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">12</span>)])</span>
<span id="cb666-2378"><a href="all-r-code-in-this-book.html#cb666-2378" aria-hidden="true"></a>z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2379"><a href="all-r-code-in-this-book.html#cb666-2379" aria-hidden="true"></a><span class="st">    </span><span class="kw">localmoran</span>(<span class="dt">listw=</span>lw_q_W, <span class="dt">conditional=</span><span class="ot">TRUE</span>, <span class="dt">alternative=</span><span class="st">&quot;two.sided&quot;</span>) -&gt;<span class="st"> </span>locm_c</span>
<span id="cb666-2380"><a href="all-r-code-in-this-book.html#cb666-2380" aria-hidden="true"></a>locm_c <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2381"><a href="all-r-code-in-this-book.html#cb666-2381" aria-hidden="true"></a><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="st">&quot;Pr(z != 0)&quot;</span>, <span class="dt">drop=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2382"><a href="all-r-code-in-this-book.html#cb666-2382" aria-hidden="true"></a><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</span>
<span id="cb666-2383"><a href="all-r-code-in-this-book.html#cb666-2383" aria-hidden="true"></a><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb666-2384"><a href="all-r-code-in-this-book.html#cb666-2384" aria-hidden="true"></a>pol_pres15<span class="op">$</span>locm_Z &lt;-<span class="st"> </span>locm[, <span class="st">&quot;Z.Ii&quot;</span>]</span>
<span id="cb666-2385"><a href="all-r-code-in-this-book.html#cb666-2385" aria-hidden="true"></a>pol_pres15<span class="op">$</span>locm_c_Z &lt;-<span class="st"> </span>locm_c[, <span class="st">&quot;Z.Ii&quot;</span>]</span>
<span id="cb666-2386"><a href="all-r-code-in-this-book.html#cb666-2386" aria-hidden="true"></a>pol_pres15<span class="op">$</span>locm_p_Z &lt;-<span class="st"> </span>locm_p[, <span class="st">&quot;Z.Ii&quot;</span>]</span>
<span id="cb666-2387"><a href="all-r-code-in-this-book.html#cb666-2387" aria-hidden="true"></a><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locm_Z&quot;</span>, <span class="st">&quot;locm_c_Z&quot;</span>, <span class="st">&quot;locm_p_Z&quot;</span>), <span class="dt">breaks=</span>brks,</span>
<span id="cb666-2388"><a href="all-r-code-in-this-book.html#cb666-2388" aria-hidden="true"></a>    <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;Standard deviates of</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>) <span class="op">+</span></span>
<span id="cb666-2389"><a href="all-r-code-in-this-book.html#cb666-2389" aria-hidden="true"></a><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;Analytical total&quot;</span>,</span>
<span id="cb666-2390"><a href="all-r-code-in-this-book.html#cb666-2390" aria-hidden="true"></a>        <span class="st">&quot;Analytical conditional&quot;</span>, <span class="st">&quot;Conditional permutation&quot;</span>))</span>
<span id="cb666-2391"><a href="all-r-code-in-this-book.html#cb666-2391" aria-hidden="true"></a>quadr &lt;-<span class="st"> </span><span class="kw">interaction</span>(</span>
<span id="cb666-2392"><a href="all-r-code-in-this-book.html#cb666-2392" aria-hidden="true"></a>    <span class="kw">cut</span>(infl_W<span class="op">$</span>x, <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="kw">mean</span>(infl_W<span class="op">$</span>x), <span class="ot">Inf</span>), <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Low X&quot;</span>, <span class="st">&quot;High X&quot;</span>)),</span>
<span id="cb666-2393"><a href="all-r-code-in-this-book.html#cb666-2393" aria-hidden="true"></a>    <span class="kw">cut</span>(infl_W<span class="op">$</span>wx, <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="kw">mean</span>(infl_W<span class="op">$</span>wx), <span class="ot">Inf</span>), <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Low WX&quot;</span>, <span class="st">&quot;High WX&quot;</span>)),</span>
<span id="cb666-2394"><a href="all-r-code-in-this-book.html#cb666-2394" aria-hidden="true"></a>    <span class="dt">sep=</span><span class="st">&quot; : &quot;</span>)</span>
<span id="cb666-2395"><a href="all-r-code-in-this-book.html#cb666-2395" aria-hidden="true"></a>a &lt;-<span class="st"> </span><span class="kw">table</span>(quadr)</span>
<span id="cb666-2396"><a href="all-r-code-in-this-book.html#cb666-2396" aria-hidden="true"></a>pol_pres15<span class="op">$</span>hs_an_q &lt;-<span class="st"> </span>quadr</span>
<span id="cb666-2397"><a href="all-r-code-in-this-book.html#cb666-2397" aria-hidden="true"></a><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_an_q) &lt;-<span class="st"> </span><span class="op">!</span>(pol_pres15<span class="op">$</span>locm_Z <span class="op">&lt;</span><span class="st"> </span>brks[<span class="dv">6</span>] <span class="op">|</span><span class="st"> </span></span>
<span id="cb666-2398"><a href="all-r-code-in-this-book.html#cb666-2398" aria-hidden="true"></a><span class="st">        </span>pol_pres15<span class="op">$</span>locm_Z <span class="op">&gt;</span><span class="st"> </span>brks[<span class="dv">8</span>])</span>
<span id="cb666-2399"><a href="all-r-code-in-this-book.html#cb666-2399" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_an_q)</span>
<span id="cb666-2400"><a href="all-r-code-in-this-book.html#cb666-2400" aria-hidden="true"></a>pol_pres15<span class="op">$</span>hs_ac_q &lt;-<span class="st"> </span>quadr</span>
<span id="cb666-2401"><a href="all-r-code-in-this-book.html#cb666-2401" aria-hidden="true"></a><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_ac_q) &lt;-<span class="st"> </span><span class="op">!</span>(pol_pres15<span class="op">$</span>locm_c_Z <span class="op">&lt;</span><span class="st"> </span>brks[<span class="dv">2</span>] <span class="op">|</span><span class="st"> </span></span>
<span id="cb666-2402"><a href="all-r-code-in-this-book.html#cb666-2402" aria-hidden="true"></a><span class="st">        </span>pol_pres15<span class="op">$</span>locm_c_Z <span class="op">&gt;</span><span class="st"> </span>brks[<span class="dv">12</span>])</span>
<span id="cb666-2403"><a href="all-r-code-in-this-book.html#cb666-2403" aria-hidden="true"></a>c &lt;-<span class="st"> </span><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_ac_q)</span>
<span id="cb666-2404"><a href="all-r-code-in-this-book.html#cb666-2404" aria-hidden="true"></a>pol_pres15<span class="op">$</span>hs_cp_q &lt;-<span class="st"> </span>quadr</span>
<span id="cb666-2405"><a href="all-r-code-in-this-book.html#cb666-2405" aria-hidden="true"></a><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_cp_q) &lt;-<span class="st"> </span><span class="op">!</span>(pol_pres15<span class="op">$</span>locm_p_Z <span class="op">&lt;</span><span class="st"> </span>brks[<span class="dv">2</span>] <span class="op">|</span><span class="st"> </span></span>
<span id="cb666-2406"><a href="all-r-code-in-this-book.html#cb666-2406" aria-hidden="true"></a><span class="st">        </span>pol_pres15<span class="op">$</span>locm_p_Z <span class="op">&gt;</span><span class="st"> </span>brks[<span class="dv">12</span>])</span>
<span id="cb666-2407"><a href="all-r-code-in-this-book.html#cb666-2407" aria-hidden="true"></a>d &lt;-<span class="st"> </span><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_cp_q)</span>
<span id="cb666-2408"><a href="all-r-code-in-this-book.html#cb666-2408" aria-hidden="true"></a><span class="kw">t</span>(<span class="kw">rbind</span>(<span class="st">&quot;Moran plot quadrants&quot;</span>=a, <span class="st">&quot;Unadjusted analytical total&quot;</span>=b, </span>
<span id="cb666-2409"><a href="all-r-code-in-this-book.html#cb666-2409" aria-hidden="true"></a>    <span class="st">&quot;Bonferroni analytical cond.&quot;</span>=c, <span class="st">&quot;Bonferroni cond. perm.&quot;</span>=d))</span>
<span id="cb666-2410"><a href="all-r-code-in-this-book.html#cb666-2410" aria-hidden="true"></a><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;hs_an_q&quot;</span>, <span class="st">&quot;hs_ac_q&quot;</span>, <span class="st">&quot;hs_cp_q&quot;</span>), <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>,</span>
<span id="cb666-2411"><a href="all-r-code-in-this-book.html#cb666-2411" aria-hidden="true"></a>    <span class="dt">textNA=</span><span class="st">&quot;Not significant&quot;</span>, <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>) <span class="op">+</span></span>
<span id="cb666-2412"><a href="all-r-code-in-this-book.html#cb666-2412" aria-hidden="true"></a><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span></span>
<span id="cb666-2413"><a href="all-r-code-in-this-book.html#cb666-2413" aria-hidden="true"></a>            <span class="kw">c</span>(<span class="st">&quot;Unadjusted analytical total&quot;</span>, <span class="st">&quot;Bonferroni analytical cond.&quot;</span>, </span>
<span id="cb666-2414"><a href="all-r-code-in-this-book.html#cb666-2414" aria-hidden="true"></a>              <span class="st">&quot;Cond. perm. with Bonferroni&quot;</span>))</span>
<span id="cb666-2415"><a href="all-r-code-in-this-book.html#cb666-2415" aria-hidden="true"></a><span class="kw">system.time</span>(z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2416"><a href="all-r-code-in-this-book.html#cb666-2416" aria-hidden="true"></a><span class="st">        </span><span class="kw">localG</span>(lw_q_W) -&gt;<span class="st"> </span>locG)</span>
<span id="cb666-2417"><a href="all-r-code-in-this-book.html#cb666-2417" aria-hidden="true"></a><span class="kw">system.time</span>(z <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2418"><a href="all-r-code-in-this-book.html#cb666-2418" aria-hidden="true"></a><span class="st">        </span><span class="kw">localG_perm</span>(lw_q_W, <span class="dt">nsim=</span><span class="dv">499</span>, <span class="dt">iseed=</span><span class="dv">1</span>) -&gt;<span class="st"> </span>locG_p)</span>
<span id="cb666-2419"><a href="all-r-code-in-this-book.html#cb666-2419" aria-hidden="true"></a>locG <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2420"><a href="all-r-code-in-this-book.html#cb666-2420" aria-hidden="true"></a><span class="st">    </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2421"><a href="all-r-code-in-this-book.html#cb666-2421" aria-hidden="true"></a><span class="st">    </span><span class="kw">abs</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2422"><a href="all-r-code-in-this-book.html#cb666-2422" aria-hidden="true"></a><span class="st">    </span><span class="kw">pnorm</span>(<span class="dt">lower.tail =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2423"><a href="all-r-code-in-this-book.html#cb666-2423" aria-hidden="true"></a><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">*</span><span class="dv">2</span>)() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb666-2424"><a href="all-r-code-in-this-book.html#cb666-2424" aria-hidden="true"></a><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</span>
<span id="cb666-2425"><a href="all-r-code-in-this-book.html#cb666-2425" aria-hidden="true"></a><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</span>
<span id="cb666-2426"><a href="all-r-code-in-this-book.html#cb666-2426" aria-hidden="true"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb666-2427"><a href="all-r-code-in-this-book.html#cb666-2427" aria-hidden="true"></a>p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">Zi=</span>locm_c[,<span class="dv">4</span>], <span class="dt">Zi_perm=</span>locm_p[,<span class="dv">4</span>])) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Zi,</span>
<span id="cb666-2428"><a href="all-r-code-in-this-book.html#cb666-2428" aria-hidden="true"></a>    <span class="dt">y=</span>Zi_perm), <span class="dt">alpha=</span><span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Analytical conditional&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2429"><a href="all-r-code-in-this-book.html#cb666-2429" aria-hidden="true"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Bootstrap conditional&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_fixed</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Local Moran&#39;s I&quot;</span>)</span>
<span id="cb666-2430"><a href="all-r-code-in-this-book.html#cb666-2430" aria-hidden="true"></a>p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">Zi=</span><span class="kw">c</span>(locG), <span class="dt">Zi_perm=</span><span class="kw">c</span>(locG_p))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Zi, </span>
<span id="cb666-2431"><a href="all-r-code-in-this-book.html#cb666-2431" aria-hidden="true"></a>    <span class="dt">y=</span>Zi_perm), <span class="dt">alpha=</span><span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Analytical conditional&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2432"><a href="all-r-code-in-this-book.html#cb666-2432" aria-hidden="true"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Bootstrap conditional&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_fixed</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Local G&quot;</span>)</span>
<span id="cb666-2433"><a href="all-r-code-in-this-book.html#cb666-2433" aria-hidden="true"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2, <span class="dt">nrow=</span><span class="dv">1</span>)</span>
<span id="cb666-2434"><a href="all-r-code-in-this-book.html#cb666-2434" aria-hidden="true"></a>pol_pres15<span class="op">$</span>locG_Z &lt;-<span class="st"> </span><span class="kw">c</span>(locG)</span>
<span id="cb666-2435"><a href="all-r-code-in-this-book.html#cb666-2435" aria-hidden="true"></a>pol_pres15<span class="op">$</span>hs_G &lt;-<span class="st"> </span><span class="kw">cut</span>(<span class="kw">c</span>(locG), <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, brks[<span class="dv">2</span>], brks[<span class="dv">12</span>], <span class="ot">Inf</span>), </span>
<span id="cb666-2436"><a href="all-r-code-in-this-book.html#cb666-2436" aria-hidden="true"></a>    <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Low&quot;</span>, <span class="st">&quot;Not significant&quot;</span>, <span class="st">&quot;High&quot;</span>))</span>
<span id="cb666-2437"><a href="all-r-code-in-this-book.html#cb666-2437" aria-hidden="true"></a><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_G)</span>
<span id="cb666-2438"><a href="all-r-code-in-this-book.html#cb666-2438" aria-hidden="true"></a>m1 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locG_Z&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;Standard</span><span class="ch">\n</span><span class="st">deviate&quot;</span>)</span>
<span id="cb666-2439"><a href="all-r-code-in-this-book.html#cb666-2439" aria-hidden="true"></a>m2 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;hs_G&quot;</span>), </span>
<span id="cb666-2440"><a href="all-r-code-in-this-book.html#cb666-2440" aria-hidden="true"></a>    <span class="dt">title=</span><span class="st">&quot;Local G Bonferroni</span><span class="ch">\n</span><span class="st">adjusted hotspot status&quot;</span>)</span>
<span id="cb666-2441"><a href="all-r-code-in-this-book.html#cb666-2441" aria-hidden="true"></a><span class="kw">tmap_arrange</span>(m1, m2, <span class="dt">nrow=</span><span class="dv">1</span>)</span>
<span id="cb666-2442"><a href="all-r-code-in-this-book.html#cb666-2442" aria-hidden="true"></a><span class="kw">library</span>(rgeoda)</span>
<span id="cb666-2443"><a href="all-r-code-in-this-book.html#cb666-2443" aria-hidden="true"></a><span class="kw">system.time</span>(Geoda_w &lt;-<span class="st"> </span><span class="kw">queen_weights</span>(pol_pres15))</span>
<span id="cb666-2444"><a href="all-r-code-in-this-book.html#cb666-2444" aria-hidden="true"></a><span class="kw">summary</span>(Geoda_w)</span>
<span id="cb666-2445"><a href="all-r-code-in-this-book.html#cb666-2445" aria-hidden="true"></a><span class="kw">system.time</span>(lisa &lt;-<span class="st"> </span><span class="kw">local_moran</span>(Geoda_w, pol_pres15[<span class="st">&quot;I_turnout&quot;</span>], </span>
<span id="cb666-2446"><a href="all-r-code-in-this-book.html#cb666-2446" aria-hidden="true"></a>    <span class="dt">cpu_threads=</span><span class="kw">ifelse</span>(parallel<span class="op">::</span><span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, parallel<span class="op">::</span><span class="kw">detectCores</span>()<span class="op">-</span>1L),</span>
<span id="cb666-2447"><a href="all-r-code-in-this-book.html#cb666-2447" aria-hidden="true"></a>    <span class="dt">permutations=</span><span class="dv">499</span>, <span class="dt">seed=</span><span class="dv">1</span>))</span>
<span id="cb666-2448"><a href="all-r-code-in-this-book.html#cb666-2448" aria-hidden="true"></a><span class="kw">all.equal</span>(<span class="kw">card</span>(nb_q), <span class="kw">lisa_num_nbrs</span>(lisa), <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2449"><a href="all-r-code-in-this-book.html#cb666-2449" aria-hidden="true"></a><span class="kw">all.equal</span>(<span class="kw">lisa_values</span>(lisa), <span class="kw">localmoran</span>(pol_pres15<span class="op">$</span>I_turnout, </span>
<span id="cb666-2450"><a href="all-r-code-in-this-book.html#cb666-2450" aria-hidden="true"></a>    <span class="dt">listw=</span>lw_q_W, <span class="dt">mlvar=</span><span class="ot">FALSE</span>)[,<span class="dv">1</span>], <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2451"><a href="all-r-code-in-this-book.html#cb666-2451" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2452"><a href="all-r-code-in-this-book.html#cb666-2452" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2453"><a href="all-r-code-in-this-book.html#cb666-2453" aria-hidden="true"></a></span>
<span id="cb666-2454"><a href="all-r-code-in-this-book.html#cb666-2454" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2455"><a href="all-r-code-in-this-book.html#cb666-2455" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2456"><a href="all-r-code-in-this-book.html#cb666-2456" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2457"><a href="all-r-code-in-this-book.html#cb666-2457" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2458"><a href="all-r-code-in-this-book.html#cb666-2458" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2459"><a href="all-r-code-in-this-book.html#cb666-2459" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2460"><a href="all-r-code-in-this-book.html#cb666-2460" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2461"><a href="all-r-code-in-this-book.html#cb666-2461" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2462"><a href="all-r-code-in-this-book.html#cb666-2462" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2463"><a href="all-r-code-in-this-book.html#cb666-2463" aria-hidden="true"></a>)</span>
<span id="cb666-2464"><a href="all-r-code-in-this-book.html#cb666-2464" aria-hidden="true"></a></span>
<span id="cb666-2465"><a href="all-r-code-in-this-book.html#cb666-2465" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2466"><a href="all-r-code-in-this-book.html#cb666-2466" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2467"><a href="all-r-code-in-this-book.html#cb666-2467" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2468"><a href="all-r-code-in-this-book.html#cb666-2468" aria-hidden="true"></a></span>
<span id="cb666-2469"><a href="all-r-code-in-this-book.html#cb666-2469" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2470"><a href="all-r-code-in-this-book.html#cb666-2470" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2471"><a href="all-r-code-in-this-book.html#cb666-2471" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2472"><a href="all-r-code-in-this-book.html#cb666-2472" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2473"><a href="all-r-code-in-this-book.html#cb666-2473" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-2474"><a href="all-r-code-in-this-book.html#cb666-2474" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">echo =</span> <span class="ot">TRUE</span>, <span class="dt">paged.print=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2475"><a href="all-r-code-in-this-book.html#cb666-2475" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-2476"><a href="all-r-code-in-this-book.html#cb666-2476" aria-hidden="true"></a><span class="kw">library</span>(spData)</span>
<span id="cb666-2477"><a href="all-r-code-in-this-book.html#cb666-2477" aria-hidden="true"></a>boston_<span class="dv">506</span> &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;shapes/boston_tracts.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;spData&quot;</span>)[<span class="dv">1</span>])</span>
<span id="cb666-2478"><a href="all-r-code-in-this-book.html#cb666-2478" aria-hidden="true"></a>nb_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">506</span>)</span>
<span id="cb666-2479"><a href="all-r-code-in-this-book.html#cb666-2479" aria-hidden="true"></a>lw_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</span>
<span id="cb666-2480"><a href="all-r-code-in-this-book.html#cb666-2480" aria-hidden="true"></a><span class="kw">table</span>(boston_<span class="dv">506</span><span class="op">$</span>censored)</span>
<span id="cb666-2481"><a href="all-r-code-in-this-book.html#cb666-2481" aria-hidden="true"></a><span class="kw">summary</span>(boston_<span class="dv">506</span><span class="op">$</span>median)</span>
<span id="cb666-2482"><a href="all-r-code-in-this-book.html#cb666-2482" aria-hidden="true"></a>boston_<span class="dv">506</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)</span>
<span id="cb666-2483"><a href="all-r-code-in-this-book.html#cb666-2483" aria-hidden="true"></a>boston_<span class="dv">489</span> &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</span>
<span id="cb666-2484"><a href="all-r-code-in-this-book.html#cb666-2484" aria-hidden="true"></a>nb_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">489</span>)</span>
<span id="cb666-2485"><a href="all-r-code-in-this-book.html#cb666-2485" aria-hidden="true"></a>lw_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">489</span>, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</span>
<span id="cb666-2486"><a href="all-r-code-in-this-book.html#cb666-2486" aria-hidden="true"></a>agg_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.character</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX_ID))</span>
<span id="cb666-2487"><a href="all-r-code-in-this-book.html#cb666-2487" aria-hidden="true"></a>boston_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="dt">by=</span>agg_<span class="dv">96</span>, unique)</span>
<span id="cb666-2488"><a href="all-r-code-in-this-book.html#cb666-2488" aria-hidden="true"></a>nb_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">96</span>)</span>
<span id="cb666-2489"><a href="all-r-code-in-this-book.html#cb666-2489" aria-hidden="true"></a>lw_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">96</span>)</span>
<span id="cb666-2490"><a href="all-r-code-in-this-book.html#cb666-2490" aria-hidden="true"></a>boston_<span class="dv">96</span><span class="op">$</span>NOX &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX, agg_<span class="dv">96</span>, mean)<span class="op">$</span>x</span>
<span id="cb666-2491"><a href="all-r-code-in-this-book.html#cb666-2491" aria-hidden="true"></a>boston_<span class="dv">96</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">aggregate</span>(<span class="kw">as.integer</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)<span class="op">-</span><span class="dv">1</span>, agg_<span class="dv">96</span>, max)<span class="op">$</span>x</span>
<span id="cb666-2492"><a href="all-r-code-in-this-book.html#cb666-2492" aria-hidden="true"></a>nms &lt;-<span class="st"> </span><span class="kw">names</span>(boston_<span class="dv">506</span>)</span>
<span id="cb666-2493"><a href="all-r-code-in-this-book.html#cb666-2493" aria-hidden="true"></a>ccounts &lt;-<span class="st"> </span><span class="dv">23</span><span class="op">:</span><span class="dv">31</span></span>
<span id="cb666-2494"><a href="all-r-code-in-this-book.html#cb666-2494" aria-hidden="true"></a><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">22</span>, ccounts, <span class="dv">36</span>)]) {</span>
<span id="cb666-2495"><a href="all-r-code-in-this-book.html#cb666-2495" aria-hidden="true"></a>  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[[nm]], agg_<span class="dv">96</span>, sum)<span class="op">$</span>x</span>
<span id="cb666-2496"><a href="all-r-code-in-this-book.html#cb666-2496" aria-hidden="true"></a>}</span>
<span id="cb666-2497"><a href="all-r-code-in-this-book.html#cb666-2497" aria-hidden="true"></a>br2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">3.50</span>,  <span class="fl">6.25</span>,  <span class="fl">8.75</span>, <span class="fl">12.50</span>, <span class="fl">17.50</span>, <span class="fl">22.50</span>, <span class="fl">30.00</span>, <span class="fl">42.50</span>, <span class="fl">60.00</span>)<span class="op">*</span><span class="dv">1000</span></span>
<span id="cb666-2498"><a href="all-r-code-in-this-book.html#cb666-2498" aria-hidden="true"></a>counts &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(boston_<span class="dv">96</span>)[, nms[ccounts]]</span>
<span id="cb666-2499"><a href="all-r-code-in-this-book.html#cb666-2499" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMedian</span>(<span class="dt">x=</span>br2, <span class="dt">w=</span>x, <span class="dt">interpolate=</span><span class="ot">TRUE</span>)</span>
<span id="cb666-2500"><a href="all-r-code-in-this-book.html#cb666-2500" aria-hidden="true"></a>boston_<span class="dv">96</span><span class="op">$</span>median &lt;-<span class="st"> </span><span class="kw">apply</span>(counts, <span class="dv">1</span>, f)</span>
<span id="cb666-2501"><a href="all-r-code-in-this-book.html#cb666-2501" aria-hidden="true"></a><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median) &lt;-<span class="st"> </span>boston_<span class="dv">96</span><span class="op">$</span>median <span class="op">&gt;</span><span class="st"> </span><span class="dv">50000</span></span>
<span id="cb666-2502"><a href="all-r-code-in-this-book.html#cb666-2502" aria-hidden="true"></a><span class="kw">summary</span>(boston_<span class="dv">96</span><span class="op">$</span>median)</span>
<span id="cb666-2503"><a href="all-r-code-in-this-book.html#cb666-2503" aria-hidden="true"></a>POP &lt;-<span class="st"> </span>boston_<span class="dv">506</span><span class="op">$</span>POP</span>
<span id="cb666-2504"><a href="all-r-code-in-this-book.html#cb666-2504" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMean</span>(x[,<span class="dv">1</span>], x[,<span class="dv">2</span>])</span>
<span id="cb666-2505"><a href="all-r-code-in-this-book.html#cb666-2505" aria-hidden="true"></a><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">9</span><span class="op">:</span><span class="dv">11</span>, <span class="dv">14</span><span class="op">:</span><span class="dv">19</span>, <span class="dv">21</span>, <span class="dv">33</span>)]) {</span>
<span id="cb666-2506"><a href="all-r-code-in-this-book.html#cb666-2506" aria-hidden="true"></a>  s0 &lt;-<span class="st"> </span><span class="kw">split</span>(<span class="kw">data.frame</span>(boston_<span class="dv">506</span>[[nm]], POP), agg_<span class="dv">96</span>)</span>
<span id="cb666-2507"><a href="all-r-code-in-this-book.html#cb666-2507" aria-hidden="true"></a>  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">sapply</span>(s0, f)</span>
<span id="cb666-2508"><a href="all-r-code-in-this-book.html#cb666-2508" aria-hidden="true"></a>}</span>
<span id="cb666-2509"><a href="all-r-code-in-this-book.html#cb666-2509" aria-hidden="true"></a>boston_<span class="dv">94</span> &lt;-<span class="st"> </span>boston_<span class="dv">96</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median),]</span>
<span id="cb666-2510"><a href="all-r-code-in-this-book.html#cb666-2510" aria-hidden="true"></a>nb_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">subset.nb</span>(nb_q_<span class="dv">96</span>, <span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median))</span>
<span id="cb666-2511"><a href="all-r-code-in-this-book.html#cb666-2511" aria-hidden="true"></a>lw_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">94</span>, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</span>
<span id="cb666-2512"><a href="all-r-code-in-this-book.html#cb666-2512" aria-hidden="true"></a>boston_94a &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">489</span>[,<span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID), unique)</span>
<span id="cb666-2513"><a href="all-r-code-in-this-book.html#cb666-2513" aria-hidden="true"></a>nb_q_94a &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_94a)</span>
<span id="cb666-2514"><a href="all-r-code-in-this-book.html#cb666-2514" aria-hidden="true"></a>NOX_ID_no_neighs &lt;-<span class="st"> </span>boston_94a<span class="op">$</span>NOX_ID[<span class="kw">which</span>(spdep<span class="op">::</span><span class="kw">card</span>(nb_q_94a) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)]</span>
<span id="cb666-2515"><a href="all-r-code-in-this-book.html#cb666-2515" aria-hidden="true"></a>boston_<span class="dv">487</span> &lt;-<span class="st"> </span>boston_<span class="dv">489</span>[<span class="kw">is.na</span>(<span class="kw">match</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID, NOX_ID_no_neighs)),]</span>
<span id="cb666-2516"><a href="all-r-code-in-this-book.html#cb666-2516" aria-hidden="true"></a>boston_<span class="dv">93</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">487</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(<span class="dt">ids =</span> boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), unique)</span>
<span id="cb666-2517"><a href="all-r-code-in-this-book.html#cb666-2517" aria-hidden="true"></a><span class="kw">row.names</span>(boston_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)</span>
<span id="cb666-2518"><a href="all-r-code-in-this-book.html#cb666-2518" aria-hidden="true"></a>nb_q_<span class="dv">93</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">93</span>, <span class="dt">row.names=</span><span class="kw">unique</span>(<span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)))</span>
<span id="cb666-2519"><a href="all-r-code-in-this-book.html#cb666-2519" aria-hidden="true"></a>form &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="kw">log</span>(median) <span class="op">~</span><span class="st"> </span>CRIM <span class="op">+</span><span class="st"> </span>ZN <span class="op">+</span><span class="st"> </span>INDUS <span class="op">+</span><span class="st"> </span>CHAS <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((NOX<span class="op">*</span><span class="dv">10</span>)<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(RM<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2520"><a href="all-r-code-in-this-book.html#cb666-2520" aria-hidden="true"></a><span class="st">                  </span>AGE <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(DIS) <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(RAD) <span class="op">+</span><span class="st"> </span>TAX <span class="op">+</span><span class="st"> </span>PTRATIO <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(BB<span class="op">/</span><span class="dv">100</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2521"><a href="all-r-code-in-this-book.html#cb666-2521" aria-hidden="true"></a><span class="st">                  </span><span class="kw">log</span>(<span class="kw">I</span>(LSTAT<span class="op">/</span><span class="dv">100</span>)))</span>
<span id="cb666-2522"><a href="all-r-code-in-this-book.html#cb666-2522" aria-hidden="true"></a><span class="kw">library</span>(Matrix)</span>
<span id="cb666-2523"><a href="all-r-code-in-this-book.html#cb666-2523" aria-hidden="true"></a><span class="kw">library</span>(lme4)</span>
<span id="cb666-2524"><a href="all-r-code-in-this-book.html#cb666-2524" aria-hidden="true"></a>MLM &lt;-<span class="st"> </span><span class="kw">lmer</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID)), <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">REML=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2525"><a href="all-r-code-in-this-book.html#cb666-2525" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>MLM_re &lt;-<span class="st"> </span><span class="kw">ranef</span>(MLM)[[<span class="dv">1</span>]][,<span class="dv">1</span>]</span>
<span id="cb666-2526"><a href="all-r-code-in-this-book.html#cb666-2526" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(hglm))</span>
<span id="cb666-2527"><a href="all-r-code-in-this-book.html#cb666-2527" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(HGLM_iid &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">fixed=</span>form, <span class="dt">random=</span> <span class="op">~</span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID, <span class="dt">data=</span>boston_<span class="dv">487</span>,</span>
<span id="cb666-2528"><a href="all-r-code-in-this-book.html#cb666-2528" aria-hidden="true"></a>    <span class="dt">family=</span><span class="kw">gaussian</span>()))</span>
<span id="cb666-2529"><a href="all-r-code-in-this-book.html#cb666-2529" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>HGLM_re &lt;-<span class="st"> </span><span class="kw">unname</span>(HGLM_iid<span class="op">$</span>ranef)</span>
<span id="cb666-2530"><a href="all-r-code-in-this-book.html#cb666-2530" aria-hidden="true"></a>W &lt;-<span class="st"> </span><span class="kw">as</span>(spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">93</span>, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>), <span class="st">&quot;CsparseMatrix&quot;</span>)</span>
<span id="cb666-2531"><a href="all-r-code-in-this-book.html#cb666-2531" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(HGLM_car &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">fixed=</span>form, <span class="dt">random=</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID, <span class="dt">data=</span>boston_<span class="dv">487</span>,</span>
<span id="cb666-2532"><a href="all-r-code-in-this-book.html#cb666-2532" aria-hidden="true"></a>    <span class="dt">family=</span><span class="kw">gaussian</span>(), <span class="dt">rand.family=</span><span class="kw">CAR</span>(<span class="dt">D=</span>W)))</span>
<span id="cb666-2533"><a href="all-r-code-in-this-book.html#cb666-2533" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>HGLM_ss &lt;-<span class="st"> </span>HGLM_car<span class="op">$</span>ranef[,<span class="dv">1</span>]</span>
<span id="cb666-2534"><a href="all-r-code-in-this-book.html#cb666-2534" aria-hidden="true"></a><span class="kw">library</span>(HSAR)</span>
<span id="cb666-2535"><a href="all-r-code-in-this-book.html#cb666-2535" aria-hidden="true"></a><span class="kw">library</span>(MatrixModels, <span class="dt">warn.conflicts=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2536"><a href="all-r-code-in-this-book.html#cb666-2536" aria-hidden="true"></a>Z &lt;-<span class="st"> </span><span class="kw">as</span>(<span class="kw">model.Matrix</span>(<span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span><span class="kw">as.factor</span>(NOX_ID), <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">sparse=</span><span class="ot">TRUE</span>),</span>
<span id="cb666-2537"><a href="all-r-code-in-this-book.html#cb666-2537" aria-hidden="true"></a>    <span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb666-2538"><a href="all-r-code-in-this-book.html#cb666-2538" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb666-2539"><a href="all-r-code-in-this-book.html#cb666-2539" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(HSAR_ss &lt;-<span class="st"> </span><span class="kw">hsar</span>(form, <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">W=</span><span class="ot">NULL</span>, <span class="dt">M=</span>W, <span class="dt">Delta=</span>Z, </span>
<span id="cb666-2540"><a href="all-r-code-in-this-book.html#cb666-2540" aria-hidden="true"></a>                              <span class="dt">burnin=</span><span class="dv">2000</span>, <span class="dt">Nsim=</span><span class="dv">12000</span>, <span class="dt">thinning=</span><span class="dv">2</span>))</span>
<span id="cb666-2541"><a href="all-r-code-in-this-book.html#cb666-2541" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>HSAR_ss &lt;-<span class="st"> </span>HSAR_ss<span class="op">$</span>Mus[<span class="dv">1</span>,]</span>
<span id="cb666-2542"><a href="all-r-code-in-this-book.html#cb666-2542" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(R2BayesX))</span>
<span id="cb666-2543"><a href="all-r-code-in-this-book.html#cb666-2543" aria-hidden="true"></a>BX_iid &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs=</span><span class="st">&quot;re&quot;</span>)), <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb666-2544"><a href="all-r-code-in-this-book.html#cb666-2544" aria-hidden="true"></a>    <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">method=</span><span class="st">&quot;MCMC&quot;</span>, <span class="dt">iterations=</span><span class="dv">12000</span>, <span class="dt">burnin=</span><span class="dv">2000</span>, <span class="dt">step=</span><span class="dv">2</span>, <span class="dt">seed=</span><span class="dv">123</span>)</span>
<span id="cb666-2545"><a href="all-r-code-in-this-book.html#cb666-2545" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>BX_re &lt;-<span class="st"> </span>BX_iid<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):re&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</span>
<span id="cb666-2546"><a href="all-r-code-in-this-book.html#cb666-2546" aria-hidden="true"></a>RBX_gra &lt;-<span class="st"> </span><span class="kw">nb2gra</span>(nb_q_<span class="dv">93</span>)</span>
<span id="cb666-2547"><a href="all-r-code-in-this-book.html#cb666-2547" aria-hidden="true"></a><span class="kw">all.equal</span>(<span class="kw">row.names</span>(RBX_gra), <span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>))</span>
<span id="cb666-2548"><a href="all-r-code-in-this-book.html#cb666-2548" aria-hidden="true"></a><span class="kw">all.equal</span>(<span class="kw">unname</span>(<span class="kw">diag</span>(RBX_gra)), spdep<span class="op">::</span><span class="kw">card</span>(nb_q_<span class="dv">93</span>))</span>
<span id="cb666-2549"><a href="all-r-code-in-this-book.html#cb666-2549" aria-hidden="true"></a>BX_mrf &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs=</span><span class="st">&quot;mrf&quot;</span>, <span class="dt">map=</span>RBX_gra)), </span>
<span id="cb666-2550"><a href="all-r-code-in-this-book.html#cb666-2550" aria-hidden="true"></a>                 <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">method=</span><span class="st">&quot;MCMC&quot;</span>, </span>
<span id="cb666-2551"><a href="all-r-code-in-this-book.html#cb666-2551" aria-hidden="true"></a>                 <span class="dt">iterations=</span><span class="dv">12000</span>, <span class="dt">burnin=</span><span class="dv">2000</span>, <span class="dt">step=</span><span class="dv">2</span>, <span class="dt">seed=</span><span class="dv">123</span>)</span>
<span id="cb666-2552"><a href="all-r-code-in-this-book.html#cb666-2552" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>BX_ss &lt;-<span class="st"> </span>BX_mrf<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):mrf&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</span>
<span id="cb666-2553"><a href="all-r-code-in-this-book.html#cb666-2553" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(INLA))</span>
<span id="cb666-2554"><a href="all-r-code-in-this-book.html#cb666-2554" aria-hidden="true"></a>INLA_iid &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(NOX_ID, <span class="dt">model=</span><span class="st">&quot;iid&quot;</span>)), <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>, </span>
<span id="cb666-2555"><a href="all-r-code-in-this-book.html#cb666-2555" aria-hidden="true"></a>    <span class="dt">data=</span>boston_<span class="dv">487</span>)</span>
<span id="cb666-2556"><a href="all-r-code-in-this-book.html#cb666-2556" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>INLA_re &lt;-<span class="st"> </span>INLA_iid<span class="op">$</span>summary.random<span class="op">$</span>NOX_ID<span class="op">$</span>mean</span>
<span id="cb666-2557"><a href="all-r-code-in-this-book.html#cb666-2557" aria-hidden="true"></a>ID2 &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID))</span>
<span id="cb666-2558"><a href="all-r-code-in-this-book.html#cb666-2558" aria-hidden="true"></a>INLA_ss &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(ID2, <span class="dt">model=</span><span class="st">&quot;besag&quot;</span>, <span class="dt">graph=</span>W)), <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb666-2559"><a href="all-r-code-in-this-book.html#cb666-2559" aria-hidden="true"></a>    <span class="dt">data=</span>boston_<span class="dv">487</span>)</span>
<span id="cb666-2560"><a href="all-r-code-in-this-book.html#cb666-2560" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>INLA_ss &lt;-<span class="st"> </span>INLA_ss<span class="op">$</span>summary.random<span class="op">$</span>ID2<span class="op">$</span>mean</span>
<span id="cb666-2561"><a href="all-r-code-in-this-book.html#cb666-2561" aria-hidden="true"></a>M &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(W), <span class="kw">rowSums</span>(W)) <span class="op">-</span><span class="st"> </span>W</span>
<span id="cb666-2562"><a href="all-r-code-in-this-book.html#cb666-2562" aria-hidden="true"></a>Cmatrix &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(M), <span class="dv">1</span>) <span class="op">-</span><span class="st">  </span>M</span>
<span id="cb666-2563"><a href="all-r-code-in-this-book.html#cb666-2563" aria-hidden="true"></a>INLA_lr &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(ID2, <span class="dt">model =</span> <span class="st">&quot;generic1&quot;</span>, <span class="dt">Cmatrix =</span> Cmatrix)),</span>
<span id="cb666-2564"><a href="all-r-code-in-this-book.html#cb666-2564" aria-hidden="true"></a>    <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="dt">data=</span>boston_<span class="dv">487</span>)</span>
<span id="cb666-2565"><a href="all-r-code-in-this-book.html#cb666-2565" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>INLA_lr &lt;-<span class="st"> </span>INLA_lr<span class="op">$</span>summary.random<span class="op">$</span>ID2<span class="op">$</span>mean</span>
<span id="cb666-2566"><a href="all-r-code-in-this-book.html#cb666-2566" aria-hidden="true"></a><span class="kw">library</span>(mgcv)</span>
<span id="cb666-2567"><a href="all-r-code-in-this-book.html#cb666-2567" aria-hidden="true"></a><span class="kw">names</span>(nb_q_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>)</span>
<span id="cb666-2568"><a href="all-r-code-in-this-book.html#cb666-2568" aria-hidden="true"></a>boston_<span class="dv">487</span><span class="op">$</span>NOX_ID &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID)</span>
<span id="cb666-2569"><a href="all-r-code-in-this-book.html#cb666-2569" aria-hidden="true"></a>GAM_MRF &lt;-<span class="st"> </span><span class="kw">gam</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(NOX_ID, <span class="dt">bs=</span><span class="st">&quot;mrf&quot;</span>, <span class="dt">xt=</span><span class="kw">list</span>(<span class="dt">nb=</span>nb_q_<span class="dv">93</span>))),</span>
<span id="cb666-2570"><a href="all-r-code-in-this-book.html#cb666-2570" aria-hidden="true"></a>               <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">method=</span><span class="st">&quot;REML&quot;</span>)</span>
<span id="cb666-2571"><a href="all-r-code-in-this-book.html#cb666-2571" aria-hidden="true"></a>ssre &lt;-<span class="st"> </span><span class="kw">predict</span>(GAM_MRF, <span class="dt">type=</span><span class="st">&quot;terms&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>)[, <span class="st">&quot;s(NOX_ID)&quot;</span>]</span>
<span id="cb666-2572"><a href="all-r-code-in-this-book.html#cb666-2572" aria-hidden="true"></a><span class="kw">all</span>(<span class="kw">sapply</span>(<span class="kw">tapply</span>(ssre, <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), c), <span class="cf">function</span>(x) <span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb666-2573"><a href="all-r-code-in-this-book.html#cb666-2573" aria-hidden="true"></a>boston_<span class="dv">93</span><span class="op">$</span>GAM_ss &lt;-<span class="st"> </span><span class="kw">aggregate</span>(ssre, <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), head, <span class="dt">n=</span><span class="dv">1</span>)<span class="op">$</span>x</span>
<span id="cb666-2574"><a href="all-r-code-in-this-book.html#cb666-2574" aria-hidden="true"></a><span class="kw">library</span>(tmap, <span class="dt">warn.conflicts=</span><span class="ot">FALSE</span>)</span>
<span id="cb666-2575"><a href="all-r-code-in-this-book.html#cb666-2575" aria-hidden="true"></a><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;MLM_re&quot;</span>, <span class="st">&quot;HGLM_re&quot;</span>, <span class="st">&quot;INLA_re&quot;</span>, <span class="st">&quot;BX_re&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>,</span>
<span id="cb666-2576"><a href="all-r-code-in-this-book.html#cb666-2576" aria-hidden="true"></a>    <span class="dt">title=</span><span class="st">&quot;IID&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2577"><a href="all-r-code-in-this-book.html#cb666-2577" aria-hidden="true"></a><span class="st">    </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;lmer&quot;</span>, <span class="st">&quot;hglm&quot;</span>, <span class="st">&quot;inla&quot;</span>, <span class="st">&quot;bayesx&quot;</span>))</span>
<span id="cb666-2578"><a href="all-r-code-in-this-book.html#cb666-2578" aria-hidden="true"></a><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;HGLM_ss&quot;</span>, <span class="st">&quot;HSAR_ss&quot;</span>, <span class="st">&quot;INLA_lr&quot;</span>, <span class="st">&quot;INLA_ss&quot;</span>, <span class="st">&quot;BX_ss&quot;</span>,</span>
<span id="cb666-2579"><a href="all-r-code-in-this-book.html#cb666-2579" aria-hidden="true"></a>    <span class="st">&quot;GAM_ss&quot;</span>), <span class="dt">midpoint=</span><span class="dv">0</span>, <span class="dt">title=</span><span class="st">&quot;SSRE&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb666-2580"><a href="all-r-code-in-this-book.html#cb666-2580" aria-hidden="true"></a><span class="st">    </span><span class="kw">tm_borders</span>(<span class="dt">lwd=</span><span class="fl">0.3</span>, <span class="dt">alpha=</span><span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span><span class="kw">c</span>(<span class="st">&quot;hglm CAR&quot;</span>, <span class="st">&quot;hsar SAR&quot;</span>,</span>
<span id="cb666-2581"><a href="all-r-code-in-this-book.html#cb666-2581" aria-hidden="true"></a>        <span class="st">&quot;inla Leroux&quot;</span>, <span class="st">&quot;inla ICAR&quot;</span>, <span class="st">&quot;bayesx ICAR&quot;</span>, <span class="st">&quot;gam ICAR&quot;</span>))</span>
<span id="cb666-2582"><a href="all-r-code-in-this-book.html#cb666-2582" aria-hidden="true"></a><span class="kw">library</span>(spatialreg)</span>
<span id="cb666-2583"><a href="all-r-code-in-this-book.html#cb666-2583" aria-hidden="true"></a>eigs_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q_<span class="dv">489</span>)</span>
<span id="cb666-2584"><a href="all-r-code-in-this-book.html#cb666-2584" aria-hidden="true"></a>SDEM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>, </span>
<span id="cb666-2585"><a href="all-r-code-in-this-book.html#cb666-2585" aria-hidden="true"></a>                       <span class="dt">zero.policy=</span><span class="ot">TRUE</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">489</span>))</span>
<span id="cb666-2586"><a href="all-r-code-in-this-book.html#cb666-2586" aria-hidden="true"></a>SEM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, </span>
<span id="cb666-2587"><a href="all-r-code-in-this-book.html#cb666-2587" aria-hidden="true"></a>                      <span class="dt">zero.policy=</span><span class="ot">TRUE</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">489</span>))</span>
<span id="cb666-2588"><a href="all-r-code-in-this-book.html#cb666-2588" aria-hidden="true"></a><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </span>
<span id="cb666-2589"><a href="all-r-code-in-this-book.html#cb666-2589" aria-hidden="true"></a>      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SEM_<span class="dv">489</span>)), </span>
<span id="cb666-2590"><a href="all-r-code-in-this-book.html#cb666-2590" aria-hidden="true"></a>            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SDEM_<span class="dv">489</span>))))[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span>
<span id="cb666-2591"><a href="all-r-code-in-this-book.html#cb666-2591" aria-hidden="true"></a>eigs_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q_<span class="dv">94</span>)</span>
<span id="cb666-2592"><a href="all-r-code-in-this-book.html#cb666-2592" aria-hidden="true"></a>SDEM_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>,</span>
<span id="cb666-2593"><a href="all-r-code-in-this-book.html#cb666-2593" aria-hidden="true"></a>                      <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</span>
<span id="cb666-2594"><a href="all-r-code-in-this-book.html#cb666-2594" aria-hidden="true"></a>SEM_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</span>
<span id="cb666-2595"><a href="all-r-code-in-this-book.html#cb666-2595" aria-hidden="true"></a><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </span>
<span id="cb666-2596"><a href="all-r-code-in-this-book.html#cb666-2596" aria-hidden="true"></a>      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SEM_<span class="dv">94</span>)), </span>
<span id="cb666-2597"><a href="all-r-code-in-this-book.html#cb666-2597" aria-hidden="true"></a>            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SDEM_<span class="dv">94</span>))))[, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span>
<span id="cb666-2598"><a href="all-r-code-in-this-book.html#cb666-2598" aria-hidden="true"></a><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.Sarlm</span>(SEM_<span class="dv">94</span>)),</span>
<span id="cb666-2599"><a href="all-r-code-in-this-book.html#cb666-2599" aria-hidden="true"></a>    broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.Sarlm</span>(SDEM_<span class="dv">94</span>))))[,<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>)]</span>
<span id="cb666-2600"><a href="all-r-code-in-this-book.html#cb666-2600" aria-hidden="true"></a>broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SEM_<span class="dv">489</span>, SDEM_<span class="dv">489</span>))</span>
<span id="cb666-2601"><a href="all-r-code-in-this-book.html#cb666-2601" aria-hidden="true"></a>broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SEM_<span class="dv">94</span>, SDEM_<span class="dv">94</span>))</span>
<span id="cb666-2602"><a href="all-r-code-in-this-book.html#cb666-2602" aria-hidden="true"></a>SLX_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</span>
<span id="cb666-2603"><a href="all-r-code-in-this-book.html#cb666-2603" aria-hidden="true"></a>broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_<span class="dv">489</span>, SDEM_<span class="dv">489</span>))</span>
<span id="cb666-2604"><a href="all-r-code-in-this-book.html#cb666-2604" aria-hidden="true"></a>SLX_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>)</span>
<span id="cb666-2605"><a href="all-r-code-in-this-book.html#cb666-2605" aria-hidden="true"></a>broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_<span class="dv">94</span>, SDEM_<span class="dv">94</span>))</span>
<span id="cb666-2606"><a href="all-r-code-in-this-book.html#cb666-2606" aria-hidden="true"></a>SLX_489w &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">weights=</span>units, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)</span>
<span id="cb666-2607"><a href="all-r-code-in-this-book.html#cb666-2607" aria-hidden="true"></a>SDEM_489w &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">489</span>, <span class="dt">listw=</span>lw_q_<span class="dv">489</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>,</span>
<span id="cb666-2608"><a href="all-r-code-in-this-book.html#cb666-2608" aria-hidden="true"></a>    <span class="dt">weights=</span>units, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">489</span>))</span>
<span id="cb666-2609"><a href="all-r-code-in-this-book.html#cb666-2609" aria-hidden="true"></a>broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_489w, SDEM_489w))</span>
<span id="cb666-2610"><a href="all-r-code-in-this-book.html#cb666-2610" aria-hidden="true"></a>SLX_94w &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">weights=</span>units)</span>
<span id="cb666-2611"><a href="all-r-code-in-this-book.html#cb666-2611" aria-hidden="true"></a>SDEM_94w &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>, <span class="dt">weights=</span>units,</span>
<span id="cb666-2612"><a href="all-r-code-in-this-book.html#cb666-2612" aria-hidden="true"></a>                       <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</span>
<span id="cb666-2613"><a href="all-r-code-in-this-book.html#cb666-2613" aria-hidden="true"></a>broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_94w, SDEM_94w))</span>
<span id="cb666-2614"><a href="all-r-code-in-this-book.html#cb666-2614" aria-hidden="true"></a>sum_imp_<span class="dv">94</span>_SDEM &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SDEM_<span class="dv">94</span>))</span>
<span id="cb666-2615"><a href="all-r-code-in-this-book.html#cb666-2615" aria-hidden="true"></a><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SDEM<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SDEM<span class="op">$</span>semat[<span class="dv">5</span>,])</span>
<span id="cb666-2616"><a href="all-r-code-in-this-book.html#cb666-2616" aria-hidden="true"></a>sum_imp_<span class="dv">94</span>_SLX &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SLX_<span class="dv">94</span>))</span>
<span id="cb666-2617"><a href="all-r-code-in-this-book.html#cb666-2617" aria-hidden="true"></a><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SLX<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SLX<span class="op">$</span>semat[<span class="dv">5</span>,])</span>
<span id="cb666-2618"><a href="all-r-code-in-this-book.html#cb666-2618" aria-hidden="true"></a>sum_imp_<span class="dv">94</span>_SDEMw &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SDEM_94w))</span>
<span id="cb666-2619"><a href="all-r-code-in-this-book.html#cb666-2619" aria-hidden="true"></a><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SDEMw<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SDEMw<span class="op">$</span>semat[<span class="dv">5</span>,])</span>
<span id="cb666-2620"><a href="all-r-code-in-this-book.html#cb666-2620" aria-hidden="true"></a>sum_imp_<span class="dv">94</span>_SLXw &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SLX_94w))</span>
<span id="cb666-2621"><a href="all-r-code-in-this-book.html#cb666-2621" aria-hidden="true"></a><span class="kw">rbind</span>(<span class="dt">Impacts=</span>sum_imp_<span class="dv">94</span>_SLXw<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE=</span>sum_imp_<span class="dv">94</span>_SLXw<span class="op">$</span>semat[<span class="dv">5</span>,])</span>
<span id="cb666-2622"><a href="all-r-code-in-this-book.html#cb666-2622" aria-hidden="true"></a>nd &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</span>
<span id="cb666-2623"><a href="all-r-code-in-this-book.html#cb666-2623" aria-hidden="true"></a>t0 &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd, <span class="dt">listw=</span>lw_q, <span class="dt">pred.type=</span><span class="st">&quot;TS&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>))</span>
<span id="cb666-2624"><a href="all-r-code-in-this-book.html#cb666-2624" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(t1  &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd, <span class="dt">listw=</span>lw_q, <span class="dt">pred.type=</span><span class="st">&quot;KP2&quot;</span>,</span>
<span id="cb666-2625"><a href="all-r-code-in-this-book.html#cb666-2625" aria-hidden="true"></a>                                    <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)))</span>
<span id="cb666-2626"><a href="all-r-code-in-this-book.html#cb666-2626" aria-hidden="true"></a><span class="kw">suppressWarnings</span>(t2  &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata=</span>nd, <span class="dt">listw=</span>lw_q, <span class="dt">pred.type=</span><span class="st">&quot;KP5&quot;</span>,</span>
<span id="cb666-2627"><a href="all-r-code-in-this-book.html#cb666-2627" aria-hidden="true"></a>                                    <span class="dt">zero.policy=</span><span class="ot">TRUE</span>)))</span>
<span id="cb666-2628"><a href="all-r-code-in-this-book.html#cb666-2628" aria-hidden="true"></a><span class="kw">library</span>(INLA)</span>
<span id="cb666-2629"><a href="all-r-code-in-this-book.html#cb666-2629" aria-hidden="true"></a>W &lt;-<span class="st"> </span><span class="kw">as</span>(lw_q, <span class="st">&quot;CsparseMatrix&quot;</span>)</span>
<span id="cb666-2630"><a href="all-r-code-in-this-book.html#cb666-2630" aria-hidden="true"></a>n &lt;-<span class="st"> </span><span class="kw">nrow</span>(W)</span>
<span id="cb666-2631"><a href="all-r-code-in-this-book.html#cb666-2631" aria-hidden="true"></a>e &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q)</span>
<span id="cb666-2632"><a href="all-r-code-in-this-book.html#cb666-2632" aria-hidden="true"></a>re.idx &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">abs</span>(<span class="kw">Im</span>(e)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">1e-6</span>)</span>
<span id="cb666-2633"><a href="all-r-code-in-this-book.html#cb666-2633" aria-hidden="true"></a>rho.max &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="kw">max</span>(<span class="kw">Re</span>(e[re.idx]))</span>
<span id="cb666-2634"><a href="all-r-code-in-this-book.html#cb666-2634" aria-hidden="true"></a>rho.min &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="kw">min</span>(<span class="kw">Re</span>(e[re.idx]))</span>
<span id="cb666-2635"><a href="all-r-code-in-this-book.html#cb666-2635" aria-hidden="true"></a>rho &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">c</span>(rho.min, rho.max))</span>
<span id="cb666-2636"><a href="all-r-code-in-this-book.html#cb666-2636" aria-hidden="true"></a>boston_<span class="dv">506</span><span class="op">$</span>idx &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>n</span>
<span id="cb666-2637"><a href="all-r-code-in-this-book.html#cb666-2637" aria-hidden="true"></a>zero.variance =<span class="st"> </span><span class="kw">list</span>(<span class="dt">prec=</span><span class="kw">list</span>(<span class="dt">initial =</span> <span class="dv">25</span>, <span class="dt">fixed=</span><span class="ot">TRUE</span>))</span>
<span id="cb666-2638"><a href="all-r-code-in-this-book.html#cb666-2638" aria-hidden="true"></a>args.slm &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">rho.min =</span> rho.min, <span class="dt">rho.max =</span> rho.max, <span class="dt">W =</span> W, <span class="dt">X =</span> <span class="kw">matrix</span>(<span class="dv">0</span>, n, <span class="dv">0</span>),</span>
<span id="cb666-2639"><a href="all-r-code-in-this-book.html#cb666-2639" aria-hidden="true"></a>    <span class="dt">Q.beta =</span> <span class="kw">matrix</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb666-2640"><a href="all-r-code-in-this-book.html#cb666-2640" aria-hidden="true"></a>hyper.slm &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">prec =</span> <span class="kw">list</span>(<span class="dt">prior =</span> <span class="st">&quot;loggamma&quot;</span>, <span class="dt">param =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)),</span>
<span id="cb666-2641"><a href="all-r-code-in-this-book.html#cb666-2641" aria-hidden="true"></a>    <span class="dt">rho =</span> <span class="kw">list</span>(<span class="dt">initial=</span><span class="dv">0</span>, <span class="dt">prior =</span> <span class="st">&quot;logitbeta&quot;</span>, <span class="dt">param =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)))</span>
<span id="cb666-2642"><a href="all-r-code-in-this-book.html#cb666-2642" aria-hidden="true"></a>WX &lt;-<span class="st"> </span><span class="kw">create_WX</span>(<span class="kw">model.matrix</span>(<span class="kw">update</span>(form, CMEDV <span class="op">~</span><span class="st"> </span>.), <span class="dt">data=</span>boston_<span class="dv">506</span>), lw_q)</span>
<span id="cb666-2643"><a href="all-r-code-in-this-book.html#cb666-2643" aria-hidden="true"></a>SDEM_<span class="dv">506</span>_slm &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>WX <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(idx, <span class="dt">model=</span><span class="st">&quot;slm&quot;</span>, <span class="dt">args.slm=</span>args.slm,</span>
<span id="cb666-2644"><a href="all-r-code-in-this-book.html#cb666-2644" aria-hidden="true"></a>    <span class="dt">hyper=</span>hyper.slm)), <span class="dt">data=</span>boston_<span class="dv">506</span>, <span class="dt">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="dt">control.family=</span></span>
<span id="cb666-2645"><a href="all-r-code-in-this-book.html#cb666-2645" aria-hidden="true"></a>        <span class="kw">list</span>(<span class="dt">hyper=</span>zero.variance), <span class="dt">control.compute=</span><span class="kw">list</span>(<span class="dt">dic=</span><span class="ot">TRUE</span>, <span class="dt">cpo=</span><span class="ot">TRUE</span>))</span>
<span id="cb666-2646"><a href="all-r-code-in-this-book.html#cb666-2646" aria-hidden="true"></a>mvs &lt;-<span class="st"> </span>SDEM_<span class="dv">506</span>_slm<span class="op">$</span>marginals.fitted.values[<span class="kw">which</span>(<span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median))]</span>
<span id="cb666-2647"><a href="all-r-code-in-this-book.html#cb666-2647" aria-hidden="true"></a>mv_mean &lt;-<span class="st"> </span><span class="kw">sapply</span>(mvs, <span class="cf">function</span>(x) <span class="kw">mean</span>(<span class="kw">exp</span>(x[, <span class="dv">1</span>]), ))</span>
<span id="cb666-2648"><a href="all-r-code-in-this-book.html#cb666-2648" aria-hidden="true"></a>mv_sd &lt;-<span class="st"> </span><span class="kw">sapply</span>(mvs, <span class="cf">function</span>(x) <span class="kw">sd</span>(<span class="kw">exp</span>(x[, <span class="dv">1</span>])))</span>
<span id="cb666-2649"><a href="all-r-code-in-this-book.html#cb666-2649" aria-hidden="true"></a><span class="kw">data.frame</span>(<span class="dt">fit_TS=</span>t0[,<span class="dv">1</span>], <span class="dt">fit_KP2=</span><span class="kw">c</span>(t1), <span class="dt">fit_KP5=</span><span class="kw">c</span>(t2), <span class="dt">INLA_slm=</span>mv_mean,</span>
<span id="cb666-2650"><a href="all-r-code-in-this-book.html#cb666-2650" aria-hidden="true"></a>    <span class="dt">INLA_slm_sd=</span>mv_sd, <span class="dt">censored=</span>boston_<span class="dv">506</span><span class="op">$</span>censored[<span class="kw">as.integer</span>(<span class="kw">attr</span>(t0, <span class="st">&quot;region.id&quot;</span>))])</span>
<span id="cb666-2651"><a href="all-r-code-in-this-book.html#cb666-2651" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2652"><a href="all-r-code-in-this-book.html#cb666-2652" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2653"><a href="all-r-code-in-this-book.html#cb666-2653" aria-hidden="true"></a></span>
<span id="cb666-2654"><a href="all-r-code-in-this-book.html#cb666-2654" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2655"><a href="all-r-code-in-this-book.html#cb666-2655" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2656"><a href="all-r-code-in-this-book.html#cb666-2656" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2657"><a href="all-r-code-in-this-book.html#cb666-2657" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2658"><a href="all-r-code-in-this-book.html#cb666-2658" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2659"><a href="all-r-code-in-this-book.html#cb666-2659" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2660"><a href="all-r-code-in-this-book.html#cb666-2660" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2661"><a href="all-r-code-in-this-book.html#cb666-2661" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2662"><a href="all-r-code-in-this-book.html#cb666-2662" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2663"><a href="all-r-code-in-this-book.html#cb666-2663" aria-hidden="true"></a>)</span>
<span id="cb666-2664"><a href="all-r-code-in-this-book.html#cb666-2664" aria-hidden="true"></a></span>
<span id="cb666-2665"><a href="all-r-code-in-this-book.html#cb666-2665" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2666"><a href="all-r-code-in-this-book.html#cb666-2666" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2667"><a href="all-r-code-in-this-book.html#cb666-2667" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2668"><a href="all-r-code-in-this-book.html#cb666-2668" aria-hidden="true"></a></span>
<span id="cb666-2669"><a href="all-r-code-in-this-book.html#cb666-2669" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2670"><a href="all-r-code-in-this-book.html#cb666-2670" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2671"><a href="all-r-code-in-this-book.html#cb666-2671" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2672"><a href="all-r-code-in-this-book.html#cb666-2672" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2673"><a href="all-r-code-in-this-book.html#cb666-2673" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-2674"><a href="all-r-code-in-this-book.html#cb666-2674" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2675"><a href="all-r-code-in-this-book.html#cb666-2675" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2676"><a href="all-r-code-in-this-book.html#cb666-2676" aria-hidden="true"></a></span>
<span id="cb666-2677"><a href="all-r-code-in-this-book.html#cb666-2677" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2678"><a href="all-r-code-in-this-book.html#cb666-2678" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2679"><a href="all-r-code-in-this-book.html#cb666-2679" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2680"><a href="all-r-code-in-this-book.html#cb666-2680" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2681"><a href="all-r-code-in-this-book.html#cb666-2681" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2682"><a href="all-r-code-in-this-book.html#cb666-2682" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2683"><a href="all-r-code-in-this-book.html#cb666-2683" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2684"><a href="all-r-code-in-this-book.html#cb666-2684" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2685"><a href="all-r-code-in-this-book.html#cb666-2685" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2686"><a href="all-r-code-in-this-book.html#cb666-2686" aria-hidden="true"></a>)</span>
<span id="cb666-2687"><a href="all-r-code-in-this-book.html#cb666-2687" aria-hidden="true"></a></span>
<span id="cb666-2688"><a href="all-r-code-in-this-book.html#cb666-2688" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2689"><a href="all-r-code-in-this-book.html#cb666-2689" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2690"><a href="all-r-code-in-this-book.html#cb666-2690" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2691"><a href="all-r-code-in-this-book.html#cb666-2691" aria-hidden="true"></a></span>
<span id="cb666-2692"><a href="all-r-code-in-this-book.html#cb666-2692" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2693"><a href="all-r-code-in-this-book.html#cb666-2693" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2694"><a href="all-r-code-in-this-book.html#cb666-2694" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2695"><a href="all-r-code-in-this-book.html#cb666-2695" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2696"><a href="all-r-code-in-this-book.html#cb666-2696" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-2697"><a href="all-r-code-in-this-book.html#cb666-2697" aria-hidden="true"></a><span class="co"># All R code in this book {-}</span></span>
<span id="cb666-2698"><a href="all-r-code-in-this-book.html#cb666-2698" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2699"><a href="all-r-code-in-this-book.html#cb666-2699" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2700"><a href="all-r-code-in-this-book.html#cb666-2700" aria-hidden="true"></a></span>
<span id="cb666-2701"><a href="all-r-code-in-this-book.html#cb666-2701" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2702"><a href="all-r-code-in-this-book.html#cb666-2702" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2703"><a href="all-r-code-in-this-book.html#cb666-2703" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2704"><a href="all-r-code-in-this-book.html#cb666-2704" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2705"><a href="all-r-code-in-this-book.html#cb666-2705" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2706"><a href="all-r-code-in-this-book.html#cb666-2706" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2707"><a href="all-r-code-in-this-book.html#cb666-2707" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2708"><a href="all-r-code-in-this-book.html#cb666-2708" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2709"><a href="all-r-code-in-this-book.html#cb666-2709" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2710"><a href="all-r-code-in-this-book.html#cb666-2710" aria-hidden="true"></a>)</span>
<span id="cb666-2711"><a href="all-r-code-in-this-book.html#cb666-2711" aria-hidden="true"></a></span>
<span id="cb666-2712"><a href="all-r-code-in-this-book.html#cb666-2712" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2713"><a href="all-r-code-in-this-book.html#cb666-2713" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2714"><a href="all-r-code-in-this-book.html#cb666-2714" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2715"><a href="all-r-code-in-this-book.html#cb666-2715" aria-hidden="true"></a></span>
<span id="cb666-2716"><a href="all-r-code-in-this-book.html#cb666-2716" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2717"><a href="all-r-code-in-this-book.html#cb666-2717" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2718"><a href="all-r-code-in-this-book.html#cb666-2718" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2719"><a href="all-r-code-in-this-book.html#cb666-2719" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2720"><a href="all-r-code-in-this-book.html#cb666-2720" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span>
<span id="cb666-2721"><a href="all-r-code-in-this-book.html#cb666-2721" aria-hidden="true"></a>a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">b</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">d</span>(<span class="dt">n =</span> <span class="dv">10</span>)</span>
<span id="cb666-2722"><a href="all-r-code-in-this-book.html#cb666-2722" aria-hidden="true"></a><span class="kw">d</span>(<span class="kw">c</span>(<span class="kw">b</span>(a)), <span class="dt">n =</span> <span class="dv">10</span>)</span>
<span id="cb666-2723"><a href="all-r-code-in-this-book.html#cb666-2723" aria-hidden="true"></a>tmp1 &lt;-<span class="st"> </span><span class="kw">b</span>(a)</span>
<span id="cb666-2724"><a href="all-r-code-in-this-book.html#cb666-2724" aria-hidden="true"></a>tmp2 &lt;-<span class="st"> </span><span class="kw">c</span>(tmp1)</span>
<span id="cb666-2725"><a href="all-r-code-in-this-book.html#cb666-2725" aria-hidden="true"></a>tmp3 &lt;-<span class="st"> </span><span class="kw">d</span>(tmp2, <span class="dt">n =</span> <span class="dv">10</span>)</span>
<span id="cb666-2726"><a href="all-r-code-in-this-book.html#cb666-2726" aria-hidden="true"></a><span class="kw">typeof</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span>
<span id="cb666-2727"><a href="all-r-code-in-this-book.html#cb666-2727" aria-hidden="true"></a><span class="kw">length</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span>
<span id="cb666-2728"><a href="all-r-code-in-this-book.html#cb666-2728" aria-hidden="true"></a><span class="kw">typeof</span>(<span class="fl">1.0</span>)</span>
<span id="cb666-2729"><a href="all-r-code-in-this-book.html#cb666-2729" aria-hidden="true"></a><span class="kw">length</span>(<span class="fl">1.0</span>)</span>
<span id="cb666-2730"><a href="all-r-code-in-this-book.html#cb666-2730" aria-hidden="true"></a><span class="kw">typeof</span>(<span class="kw">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>))</span>
<span id="cb666-2731"><a href="all-r-code-in-this-book.html#cb666-2731" aria-hidden="true"></a><span class="kw">length</span>(<span class="kw">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>))</span>
<span id="cb666-2732"><a href="all-r-code-in-this-book.html#cb666-2732" aria-hidden="true"></a><span class="kw">typeof</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</span>
<span id="cb666-2733"><a href="all-r-code-in-this-book.html#cb666-2733" aria-hidden="true"></a>i =<span class="st"> </span><span class="kw">integer</span>(<span class="dv">0</span>)</span>
<span id="cb666-2734"><a href="all-r-code-in-this-book.html#cb666-2734" aria-hidden="true"></a><span class="kw">typeof</span>(i)</span>
<span id="cb666-2735"><a href="all-r-code-in-this-book.html#cb666-2735" aria-hidden="true"></a>i</span>
<span id="cb666-2736"><a href="all-r-code-in-this-book.html#cb666-2736" aria-hidden="true"></a><span class="kw">length</span>(i)</span>
<span id="cb666-2737"><a href="all-r-code-in-this-book.html#cb666-2737" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb666-2738"><a href="all-r-code-in-this-book.html#cb666-2738" aria-hidden="true"></a>a[<span class="dv">2</span>]</span>
<span id="cb666-2739"><a href="all-r-code-in-this-book.html#cb666-2739" aria-hidden="true"></a>a[[<span class="dv">2</span>]]</span>
<span id="cb666-2740"><a href="all-r-code-in-this-book.html#cb666-2740" aria-hidden="true"></a>a[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>]</span>
<span id="cb666-2741"><a href="all-r-code-in-this-book.html#cb666-2741" aria-hidden="true"></a>a[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>] =<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">6</span>)</span>
<span id="cb666-2742"><a href="all-r-code-in-this-book.html#cb666-2742" aria-hidden="true"></a>a</span>
<span id="cb666-2743"><a href="all-r-code-in-this-book.html#cb666-2743" aria-hidden="true"></a>a[[<span class="dv">3</span>]] =<span class="st"> </span><span class="dv">10</span></span>
<span id="cb666-2744"><a href="all-r-code-in-this-book.html#cb666-2744" aria-hidden="true"></a>a</span>
<span id="cb666-2745"><a href="all-r-code-in-this-book.html#cb666-2745" aria-hidden="true"></a>l &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dv">3</span>, <span class="ot">TRUE</span>, <span class="st">&quot;foo&quot;</span>)</span>
<span id="cb666-2746"><a href="all-r-code-in-this-book.html#cb666-2746" aria-hidden="true"></a><span class="kw">typeof</span>(l)</span>
<span id="cb666-2747"><a href="all-r-code-in-this-book.html#cb666-2747" aria-hidden="true"></a><span class="kw">length</span>(l)</span>
<span id="cb666-2748"><a href="all-r-code-in-this-book.html#cb666-2748" aria-hidden="true"></a>l[<span class="dv">1</span>]</span>
<span id="cb666-2749"><a href="all-r-code-in-this-book.html#cb666-2749" aria-hidden="true"></a>l[[<span class="dv">1</span>]]</span>
<span id="cb666-2750"><a href="all-r-code-in-this-book.html#cb666-2750" aria-hidden="true"></a>l[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] =<span class="st"> </span><span class="kw">list</span>(<span class="dv">4</span>, <span class="ot">FALSE</span>)</span>
<span id="cb666-2751"><a href="all-r-code-in-this-book.html#cb666-2751" aria-hidden="true"></a>l</span>
<span id="cb666-2752"><a href="all-r-code-in-this-book.html#cb666-2752" aria-hidden="true"></a>l[[<span class="dv">3</span>]] =<span class="st"> &quot;bar&quot;</span></span>
<span id="cb666-2753"><a href="all-r-code-in-this-book.html#cb666-2753" aria-hidden="true"></a>l</span>
<span id="cb666-2754"><a href="all-r-code-in-this-book.html#cb666-2754" aria-hidden="true"></a>l =<span class="st"> </span><span class="kw">list</span>(<span class="dt">first =</span> <span class="dv">3</span>, <span class="dt">second =</span> <span class="ot">TRUE</span>, <span class="dt">third =</span> <span class="st">&quot;foo&quot;</span>)</span>
<span id="cb666-2755"><a href="all-r-code-in-this-book.html#cb666-2755" aria-hidden="true"></a>l</span>
<span id="cb666-2756"><a href="all-r-code-in-this-book.html#cb666-2756" aria-hidden="true"></a>l<span class="op">$</span>second</span>
<span id="cb666-2757"><a href="all-r-code-in-this-book.html#cb666-2757" aria-hidden="true"></a>l<span class="op">$</span>second =<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb666-2758"><a href="all-r-code-in-this-book.html#cb666-2758" aria-hidden="true"></a>l</span>
<span id="cb666-2759"><a href="all-r-code-in-this-book.html#cb666-2759" aria-hidden="true"></a><span class="dv">3</span> <span class="op">==</span><span class="st"> </span><span class="ot">NULL</span> <span class="co"># not FALSE!</span></span>
<span id="cb666-2760"><a href="all-r-code-in-this-book.html#cb666-2760" aria-hidden="true"></a><span class="ot">NULL</span> <span class="op">==</span><span class="st"> </span><span class="ot">NULL</span> <span class="co"># not even TRUE!</span></span>
<span id="cb666-2761"><a href="all-r-code-in-this-book.html#cb666-2761" aria-hidden="true"></a><span class="kw">is.null</span>(<span class="ot">NULL</span>)</span>
<span id="cb666-2762"><a href="all-r-code-in-this-book.html#cb666-2762" aria-hidden="true"></a>l =<span class="st"> </span>l[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)] <span class="co"># remove second, implicitly</span></span>
<span id="cb666-2763"><a href="all-r-code-in-this-book.html#cb666-2763" aria-hidden="true"></a>l</span>
<span id="cb666-2764"><a href="all-r-code-in-this-book.html#cb666-2764" aria-hidden="true"></a>l<span class="op">$</span>second =<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb666-2765"><a href="all-r-code-in-this-book.html#cb666-2765" aria-hidden="true"></a>l</span>
<span id="cb666-2766"><a href="all-r-code-in-this-book.html#cb666-2766" aria-hidden="true"></a>a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></span>
<span id="cb666-2767"><a href="all-r-code-in-this-book.html#cb666-2767" aria-hidden="true"></a><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>) =<span class="st"> &quot;foo&quot;</span></span>
<span id="cb666-2768"><a href="all-r-code-in-this-book.html#cb666-2768" aria-hidden="true"></a>a</span>
<span id="cb666-2769"><a href="all-r-code-in-this-book.html#cb666-2769" aria-hidden="true"></a><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>)</span>
<span id="cb666-2770"><a href="all-r-code-in-this-book.html#cb666-2770" aria-hidden="true"></a><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>) =<span class="st"> &quot;bar&quot;</span></span>
<span id="cb666-2771"><a href="all-r-code-in-this-book.html#cb666-2771" aria-hidden="true"></a><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>)</span>
<span id="cb666-2772"><a href="all-r-code-in-this-book.html#cb666-2772" aria-hidden="true"></a><span class="kw">attributes</span>(a)</span>
<span id="cb666-2773"><a href="all-r-code-in-this-book.html#cb666-2773" aria-hidden="true"></a><span class="kw">attributes</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">some_meta_data =</span> <span class="st">&quot;foo&quot;</span>)</span>
<span id="cb666-2774"><a href="all-r-code-in-this-book.html#cb666-2774" aria-hidden="true"></a><span class="kw">attributes</span>(a)</span>
<span id="cb666-2775"><a href="all-r-code-in-this-book.html#cb666-2775" aria-hidden="true"></a><span class="kw">class</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</span>
<span id="cb666-2776"><a href="all-r-code-in-this-book.html#cb666-2776" aria-hidden="true"></a><span class="kw">class</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</span>
<span id="cb666-2777"><a href="all-r-code-in-this-book.html#cb666-2777" aria-hidden="true"></a><span class="kw">class</span>(<span class="kw">c</span>(<span class="st">&quot;TRUE&quot;</span>, <span class="st">&quot;FALSE&quot;</span>))</span>
<span id="cb666-2778"><a href="all-r-code-in-this-book.html#cb666-2778" aria-hidden="true"></a>a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></span>
<span id="cb666-2779"><a href="all-r-code-in-this-book.html#cb666-2779" aria-hidden="true"></a><span class="kw">class</span>(a) =<span class="st"> &quot;foo&quot;</span></span>
<span id="cb666-2780"><a href="all-r-code-in-this-book.html#cb666-2780" aria-hidden="true"></a>a</span>
<span id="cb666-2781"><a href="all-r-code-in-this-book.html#cb666-2781" aria-hidden="true"></a><span class="kw">class</span>(a)</span>
<span id="cb666-2782"><a href="all-r-code-in-this-book.html#cb666-2782" aria-hidden="true"></a><span class="kw">attributes</span>(a)</span>
<span id="cb666-2783"><a href="all-r-code-in-this-book.html#cb666-2783" aria-hidden="true"></a>print.foo =<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;an object of class foo with length&quot;</span>, <span class="kw">length</span>(x)))</span>
<span id="cb666-2784"><a href="all-r-code-in-this-book.html#cb666-2784" aria-hidden="true"></a><span class="kw">print</span>(a)</span>
<span id="cb666-2785"><a href="all-r-code-in-this-book.html#cb666-2785" aria-hidden="true"></a><span class="kw">unclass</span>(a)</span>
<span id="cb666-2786"><a href="all-r-code-in-this-book.html#cb666-2786" aria-hidden="true"></a><span class="kw">library</span>(sf)</span>
<span id="cb666-2787"><a href="all-r-code-in-this-book.html#cb666-2787" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))))</span>
<span id="cb666-2788"><a href="all-r-code-in-this-book.html#cb666-2788" aria-hidden="true"></a>p</span>
<span id="cb666-2789"><a href="all-r-code-in-this-book.html#cb666-2789" aria-hidden="true"></a><span class="kw">unclass</span>(p)</span>
<span id="cb666-2790"><a href="all-r-code-in-this-book.html#cb666-2790" aria-hidden="true"></a>a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span></span>
<span id="cb666-2791"><a href="all-r-code-in-this-book.html#cb666-2791" aria-hidden="true"></a><span class="kw">class</span>(a)</span>
<span id="cb666-2792"><a href="all-r-code-in-this-book.html#cb666-2792" aria-hidden="true"></a><span class="kw">attr</span>(a, <span class="st">&quot;dim&quot;</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>) <span class="co"># or: dim(a) = c(2,4)</span></span>
<span id="cb666-2793"><a href="all-r-code-in-this-book.html#cb666-2793" aria-hidden="true"></a><span class="kw">class</span>(a)</span>
<span id="cb666-2794"><a href="all-r-code-in-this-book.html#cb666-2794" aria-hidden="true"></a>a</span>
<span id="cb666-2795"><a href="all-r-code-in-this-book.html#cb666-2795" aria-hidden="true"></a><span class="kw">attr</span>(a, <span class="st">&quot;dim&quot;</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="co"># or: dim(a) = c(2,2,2)</span></span>
<span id="cb666-2796"><a href="all-r-code-in-this-book.html#cb666-2796" aria-hidden="true"></a><span class="kw">class</span>(a)</span>
<span id="cb666-2797"><a href="all-r-code-in-this-book.html#cb666-2797" aria-hidden="true"></a>a</span>
<span id="cb666-2798"><a href="all-r-code-in-this-book.html#cb666-2798" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">c</span>(<span class="dt">first =</span> <span class="dv">3</span>, <span class="dt">second =</span> <span class="dv">4</span>, <span class="dt">last =</span> <span class="dv">5</span>)</span>
<span id="cb666-2799"><a href="all-r-code-in-this-book.html#cb666-2799" aria-hidden="true"></a>a[<span class="st">&quot;second&quot;</span>]</span>
<span id="cb666-2800"><a href="all-r-code-in-this-book.html#cb666-2800" aria-hidden="true"></a><span class="kw">attributes</span>(a)</span>
<span id="cb666-2801"><a href="all-r-code-in-this-book.html#cb666-2801" aria-hidden="true"></a>a =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb666-2802"><a href="all-r-code-in-this-book.html#cb666-2802" aria-hidden="true"></a><span class="kw">dimnames</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">rows =</span> <span class="kw">c</span>(<span class="st">&quot;row1&quot;</span>, <span class="st">&quot;row2&quot;</span>), <span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">&quot;col1&quot;</span>, <span class="st">&quot;col2&quot;</span>))</span>
<span id="cb666-2803"><a href="all-r-code-in-this-book.html#cb666-2803" aria-hidden="true"></a>a</span>
<span id="cb666-2804"><a href="all-r-code-in-this-book.html#cb666-2804" aria-hidden="true"></a><span class="kw">attributes</span>(a)</span>
<span id="cb666-2805"><a href="all-r-code-in-this-book.html#cb666-2805" aria-hidden="true"></a>df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">b =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>))</span>
<span id="cb666-2806"><a href="all-r-code-in-this-book.html#cb666-2806" aria-hidden="true"></a><span class="kw">attributes</span>(df)</span>
<span id="cb666-2807"><a href="all-r-code-in-this-book.html#cb666-2807" aria-hidden="true"></a>f =<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb666-2808"><a href="all-r-code-in-this-book.html#cb666-2808" aria-hidden="true"></a>   a =<span class="st"> </span><span class="kw">create_obj</span>(x) <span class="co"># call some other function</span></span>
<span id="cb666-2809"><a href="all-r-code-in-this-book.html#cb666-2809" aria-hidden="true"></a>   <span class="kw">attributes</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">class =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">meta =</span> <span class="dv">33</span>)</span>
<span id="cb666-2810"><a href="all-r-code-in-this-book.html#cb666-2810" aria-hidden="true"></a>   a</span>
<span id="cb666-2811"><a href="all-r-code-in-this-book.html#cb666-2811" aria-hidden="true"></a>}</span>
<span id="cb666-2812"><a href="all-r-code-in-this-book.html#cb666-2812" aria-hidden="true"></a>f =<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb666-2813"><a href="all-r-code-in-this-book.html#cb666-2813" aria-hidden="true"></a>   a =<span class="st"> </span><span class="kw">create_obj</span>(x) <span class="co"># call some other function</span></span>
<span id="cb666-2814"><a href="all-r-code-in-this-book.html#cb666-2814" aria-hidden="true"></a>   <span class="kw">structure</span>(a, <span class="dt">class =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">meta =</span> <span class="dv">33</span>)</span>
<span id="cb666-2815"><a href="all-r-code-in-this-book.html#cb666-2815" aria-hidden="true"></a>}</span>
<span id="cb666-2816"><a href="all-r-code-in-this-book.html#cb666-2816" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb666-2817"><a href="all-r-code-in-this-book.html#cb666-2817" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span>
<span id="cb666-2818"><a href="all-r-code-in-this-book.html#cb666-2818" aria-hidden="true"></a></span>
<span id="cb666-2819"><a href="all-r-code-in-this-book.html#cb666-2819" aria-hidden="true"></a>knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</span>
<span id="cb666-2820"><a href="all-r-code-in-this-book.html#cb666-2820" aria-hidden="true"></a>  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</span>
<span id="cb666-2821"><a href="all-r-code-in-this-book.html#cb666-2821" aria-hidden="true"></a>  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</span>
<span id="cb666-2822"><a href="all-r-code-in-this-book.html#cb666-2822" aria-hidden="true"></a>  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</span>
<span id="cb666-2823"><a href="all-r-code-in-this-book.html#cb666-2823" aria-hidden="true"></a><span class="co">#  out.width = &quot;70%&quot;,</span></span>
<span id="cb666-2824"><a href="all-r-code-in-this-book.html#cb666-2824" aria-hidden="true"></a>  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></span>
<span id="cb666-2825"><a href="all-r-code-in-this-book.html#cb666-2825" aria-hidden="true"></a><span class="co">#  fig.width = 6,</span></span>
<span id="cb666-2826"><a href="all-r-code-in-this-book.html#cb666-2826" aria-hidden="true"></a><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></span>
<span id="cb666-2827"><a href="all-r-code-in-this-book.html#cb666-2827" aria-hidden="true"></a><span class="co">#  fig.show = &quot;hold&quot;</span></span>
<span id="cb666-2828"><a href="all-r-code-in-this-book.html#cb666-2828" aria-hidden="true"></a>)</span>
<span id="cb666-2829"><a href="all-r-code-in-this-book.html#cb666-2829" aria-hidden="true"></a></span>
<span id="cb666-2830"><a href="all-r-code-in-this-book.html#cb666-2830" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</span>
<span id="cb666-2831"><a href="all-r-code-in-this-book.html#cb666-2831" aria-hidden="true"></a><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</span>
<span id="cb666-2832"><a href="all-r-code-in-this-book.html#cb666-2832" aria-hidden="true"></a>mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</span>
<span id="cb666-2833"><a href="all-r-code-in-this-book.html#cb666-2833" aria-hidden="true"></a></span>
<span id="cb666-2834"><a href="all-r-code-in-this-book.html#cb666-2834" aria-hidden="true"></a><span class="co"># for units: (?)</span></span>
<span id="cb666-2835"><a href="all-r-code-in-this-book.html#cb666-2835" aria-hidden="true"></a><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb666-2836"><a href="all-r-code-in-this-book.html#cb666-2836" aria-hidden="true"></a><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</span>
<span id="cb666-2837"><a href="all-r-code-in-this-book.html#cb666-2837" aria-hidden="true"></a>    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</span>
<span id="cb666-2838"><a href="all-r-code-in-this-book.html#cb666-2838" aria-hidden="true"></a>    <span class="co">#options(width = 72)</span></span></code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="sp-and-raster.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="r-basics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/97-allcode.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
