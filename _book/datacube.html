<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Data Cubes | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Data Cubes | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Data Cubes | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2021-06-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="featureattributes.html"/>
<link rel="next" href="sf.html"/>
<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a>
<ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#proj"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a>
<ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a>
<ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a>
<ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and Summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a>
<ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a>
<ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a>
<ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#maps-with-ggplot2"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a>
<ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#model-based-inference"><i class="fa fa-check"></i><b>10.3</b> Model-based inference</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation</a>
<ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#atpk"><i class="fa fa-check"></i><b>12.8</b> Area-to-point kriging</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics</a>
<ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing-the-air-quality-dataset"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#multivariable-geostatistics"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data</a>
<ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours</a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours</a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours</a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification</a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation</a>
<ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification</a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures</a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a>
<ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#spatecon"><i class="fa fa-check"></i><b>16.1</b> Spatial regression with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#estimators"><i class="fa fa-check"></i><b>16.2</b> Estimators</a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#implementation-details"><i class="fa fa-check"></i><b>16.3</b> Implementation details</a></li>
<li class="chapter" data-level="16.4" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.4</b> Markov random field and multilevel models with spatial weights</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="sp-and-raster.html"><a href="sp-and-raster.html"><i class="fa fa-check"></i><b>17</b> sp and raster</a>
<ul>
<li class="chapter" data-level="17.1" data-path="sp-and-raster.html"><a href="sp-and-raster.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>17.1</b> links and differences between sf and sp</a></li>
<li class="chapter" data-level="17.2" data-path="sp-and-raster.html"><a href="sp-and-raster.html#migration-packages"><i class="fa fa-check"></i><b>17.2</b> migration packages</a></li>
<li class="chapter" data-level="17.3" data-path="sp-and-raster.html"><a href="sp-and-raster.html#raster-stars-and-sf"><i class="fa fa-check"></i><b>17.3</b> raster, stars and sf</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a>
<ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="17.4" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i><b>17.4</b> Data structures</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="datacube" class="section level1" number="6">
<h1><span class="header-section-number">Chapter 6</span> Data Cubes</h1>
<!--
TODO:
refer to
[@appel2019demand]
-->
<p>Data cubes arise naturally when we observe properties of a set of
geometries repeatedly over time. Time information may sometimes be
considered as an attribute of a feature, e.g. when we register the year
of construction of a building, or the date of birth of a person (chapter
<a href="featureattributes.html#featureattributes">5</a>). In other cases it may refer to the time
of observing an attribute, or the time for which a prediction of an
attribute has been made. In these cases, time is on equal footing
with space, and time and space together describe the physical
dimensions over which we observe, model, make predictions or make
forecasts.</p>
<p>One way of considering our world is that of a four-dimensionsal
space, with three space and one time dimension. In that view,
events become “things” or “objects” that have as duration their
size on the time dimension <span class="citation">(Galton <a href="#ref-galton" role="doc-biblioref">2004</a>)</span>. Although such a view does
not align well with how we experience and describe the world,
from a data analytic perspective, four numbers, along with their
reference systems, suffice to describe space and time coordinates
of an observation associated with a point location and time instance.</p>
<p>We define data cubes as array data with one or more array dimensions
associated with space and/or time <span class="citation">(Lu, Appel, and Pebesma <a href="#ref-lu2018multidimensional" role="doc-biblioref">2018</a>)</span>. This
implies that raster data, features with attributes, and time series
data are all special cases of data cubes. Since we don’t restrict
to three-dimensionsal structures, we actually mean <em>hypercubes</em>
rather than cubes, and as the cube extent of the different dimensions
does not have to be identical, or have comparable units, the better
term would be <em>hyperrectangle</em>. For simplicity, we talk about data
cubes instead.</p>
<p>A cannonical form of a data cube is shown in figure <a href="datacube.html#fig:cube">6.1</a>:
it shows in a perspective plot a set of raster layers for the same
region that were collected (observed, or modelled) at different time
steps. The three cube dimensions, longitude, latitude and time are
thought of as being orthogonal. Arbitrary two-dimensional cube
slices are obtained by fixing one of the dimensions at a particular
value, one-dimensional slices are obtained by fixing two of the
dimensions at a particular value, and a scalar is obtained by fixing
three dimensions at a particular value.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="datacube.html#cb87-1" aria-hidden="true"></a><span class="co"># (C) 2019, Edzer Pebesma, CC-BY-SA</span></span>
<span id="cb87-2"><a href="datacube.html#cb87-2" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1331</span>)</span>
<span id="cb87-3"><a href="datacube.html#cb87-3" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(stars))</span>
<span id="cb87-4"><a href="datacube.html#cb87-4" aria-hidden="true"></a><span class="kw">library</span>(colorspace)</span>
<span id="cb87-5"><a href="datacube.html#cb87-5" aria-hidden="true"></a>tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb87-6"><a href="datacube.html#cb87-6" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</span>
<span id="cb87-7"><a href="datacube.html#cb87-7" aria-hidden="true"></a></span>
<span id="cb87-8"><a href="datacube.html#cb87-8" aria-hidden="true"></a>nrow =<span class="st"> </span><span class="dv">5</span></span>
<span id="cb87-9"><a href="datacube.html#cb87-9" aria-hidden="true"></a>ncol =<span class="st"> </span><span class="dv">8</span></span>
<span id="cb87-10"><a href="datacube.html#cb87-10" aria-hidden="true"></a>m =<span class="st"> </span>r[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>nrow,<span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb87-11"><a href="datacube.html#cb87-11" aria-hidden="true"></a><span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb87-12"><a href="datacube.html#cb87-12" aria-hidden="true"></a>s =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</span>
<span id="cb87-13"><a href="datacube.html#cb87-13" aria-hidden="true"></a><span class="co"># s</span></span>
<span id="cb87-14"><a href="datacube.html#cb87-14" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb87-15"><a href="datacube.html#cb87-15" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="fl">-.5</span></span>
<span id="cb87-16"><a href="datacube.html#cb87-16" aria-hidden="true"></a><span class="kw">attr</span>(<span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span>)</span>
<span id="cb87-17"><a href="datacube.html#cb87-17" aria-hidden="true"></a></span>
<span id="cb87-18"><a href="datacube.html#cb87-18" aria-hidden="true"></a>plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb87-19"><a href="datacube.html#cb87-19" aria-hidden="true"></a>    <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset</span>
<span id="cb87-20"><a href="datacube.html#cb87-20" aria-hidden="true"></a>    l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb87-21"><a href="datacube.html#cb87-21" aria-hidden="true"></a>    pal =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>)</span>
<span id="cb87-22"><a href="datacube.html#cb87-22" aria-hidden="true"></a>    <span class="cf">if</span> (li)</span>
<span id="cb87-23"><a href="datacube.html#cb87-23" aria-hidden="true"></a>        pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb87-24"><a href="datacube.html#cb87-24" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</span>
<span id="cb87-25"><a href="datacube.html#cb87-25" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb87-26"><a href="datacube.html#cb87-26" aria-hidden="true"></a>    <span class="cf">else</span></span>
<span id="cb87-27"><a href="datacube.html#cb87-27" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>))</span>
<span id="cb87-28"><a href="datacube.html#cb87-28" aria-hidden="true"></a>    u =<span class="st"> </span><span class="kw">st_union</span>(l)</span>
<span id="cb87-29"><a href="datacube.html#cb87-29" aria-hidden="true"></a>    <span class="co"># print(u)</span></span>
<span id="cb87-30"><a href="datacube.html#cb87-30" aria-hidden="true"></a>    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</span>
<span id="cb87-31"><a href="datacube.html#cb87-31" aria-hidden="true"></a>}</span>
<span id="cb87-32"><a href="datacube.html#cb87-32" aria-hidden="true"></a></span>
<span id="cb87-33"><a href="datacube.html#cb87-33" aria-hidden="true"></a>pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb87-34"><a href="datacube.html#cb87-34" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb87-35"><a href="datacube.html#cb87-35" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb87-36"><a href="datacube.html#cb87-36" aria-hidden="true"></a>  m =<span class="st"> </span>r[[<span class="dv">1</span>]][y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow,x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb87-37"><a href="datacube.html#cb87-37" aria-hidden="true"></a>  <span class="cf">if</span> (randomize)</span>
<span id="cb87-38"><a href="datacube.html#cb87-38" aria-hidden="true"></a>    m =<span class="st"> </span>m[<span class="kw">sample</span>(y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow),x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol]</span>
<span id="cb87-39"><a href="datacube.html#cb87-39" aria-hidden="true"></a>  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb87-40"><a href="datacube.html#cb87-40" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</span>
<span id="cb87-41"><a href="datacube.html#cb87-41" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, add)</span>
<span id="cb87-42"><a href="datacube.html#cb87-42" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-43"><a href="datacube.html#cb87-43" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-44"><a href="datacube.html#cb87-44" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-45"><a href="datacube.html#cb87-45" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">4</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-46"><a href="datacube.html#cb87-46" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">5</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-47"><a href="datacube.html#cb87-47" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">6</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-48"><a href="datacube.html#cb87-48" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">7</span>, <span class="ot">TRUE</span>)</span>
<span id="cb87-49"><a href="datacube.html#cb87-49" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">8</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</span>
<span id="cb87-50"><a href="datacube.html#cb87-50" aria-hidden="true"></a>}</span>
<span id="cb87-51"><a href="datacube.html#cb87-51" aria-hidden="true"></a></span>
<span id="cb87-52"><a href="datacube.html#cb87-52" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb87-53"><a href="datacube.html#cb87-53" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="fl">0.5</span>,<span class="dv">4</span>))</span>
<span id="cb87-54"><a href="datacube.html#cb87-54" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">12</span>,<span class="dv">15</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">5</span>,<span class="dv">10</span>), <span class="dt">asp=</span><span class="dv">1</span>)</span>
<span id="cb87-55"><a href="datacube.html#cb87-55" aria-hidden="true"></a><span class="kw">pl</span>(s, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb87-56"><a href="datacube.html#cb87-56" aria-hidden="true"></a><span class="co"># box()</span></span>
<span id="cb87-57"><a href="datacube.html#cb87-57" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">-90</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb87-58"><a href="datacube.html#cb87-58" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">5</span>,  <span class="fl">6.5</span>, <span class="st">&quot;latitude&quot;</span>, <span class="dt">srt =</span> <span class="dv">25</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb87-59"><a href="datacube.html#cb87-59" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">5</span>,  <span class="fl">8.5</span>, <span class="st">&quot;longitude&quot;</span>, <span class="dt">srt =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube"></span>
<img src="sds_files/figure-html/cube-1.png" alt="Raster data cube with dimensions latitude, longitude and time" width="70%" />
<p class="caption">
Figure 6.1: Raster data cube with dimensions latitude, longitude and time
</p>
</div>
<div id="a-four-dimensional-data-cube" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> A four-dimensional data cube</h2>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="datacube.html#cb88-1" aria-hidden="true"></a><span class="co"># (C) 2021, Jonathan Bahlmann, CC-BY-SA</span></span>
<span id="cb88-2"><a href="datacube.html#cb88-2" aria-hidden="true"></a><span class="co"># https://github.com/Open-EO/openeo.org/tree/master/documentation/1.0/datacubes/.scripts</span></span>
<span id="cb88-3"><a href="datacube.html#cb88-3" aria-hidden="true"></a><span class="co"># based on work by Edzer Pebesma, 2019, here: https://gist.github.com/edzer/5f1b0faa3e93073784e01d5a4bb60eca</span></span>
<span id="cb88-4"><a href="datacube.html#cb88-4" aria-hidden="true"></a></span>
<span id="cb88-5"><a href="datacube.html#cb88-5" aria-hidden="true"></a><span class="co"># plotting runs via a dummy stars object with x, y dimensions (no bands)</span></span>
<span id="cb88-6"><a href="datacube.html#cb88-6" aria-hidden="true"></a><span class="co"># to not be overly dependent on an input image, time steps and bands</span></span>
<span id="cb88-7"><a href="datacube.html#cb88-7" aria-hidden="true"></a><span class="co"># are displayed by replacing the matrix contained in the dummy stars object</span></span>
<span id="cb88-8"><a href="datacube.html#cb88-8" aria-hidden="true"></a><span class="co"># every time something is plotted</span></span>
<span id="cb88-9"><a href="datacube.html#cb88-9" aria-hidden="true"></a></span>
<span id="cb88-10"><a href="datacube.html#cb88-10" aria-hidden="true"></a><span class="co"># packages, read input ----</span></span>
<span id="cb88-11"><a href="datacube.html#cb88-11" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1331</span>)</span>
<span id="cb88-12"><a href="datacube.html#cb88-12" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb88-13"><a href="datacube.html#cb88-13" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(colorspace))</span>
<span id="cb88-14"><a href="datacube.html#cb88-14" aria-hidden="true"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(scales))</span>
<span id="cb88-15"><a href="datacube.html#cb88-15" aria-hidden="true"></a></span>
<span id="cb88-16"><a href="datacube.html#cb88-16" aria-hidden="true"></a><span class="co"># make color palettes ----</span></span>
<span id="cb88-17"><a href="datacube.html#cb88-17" aria-hidden="true"></a>blues &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">211</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb88-18"><a href="datacube.html#cb88-18" aria-hidden="true"></a>greens &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">134</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb88-19"><a href="datacube.html#cb88-19" aria-hidden="true"></a>reds &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">360</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb88-20"><a href="datacube.html#cb88-20" aria-hidden="true"></a>purples &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">299</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb88-21"><a href="datacube.html#cb88-21" aria-hidden="true"></a>greys &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">0</span>, <span class="dt">c1 =</span> <span class="dv">0</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</span>
<span id="cb88-22"><a href="datacube.html#cb88-22" aria-hidden="true"></a></span>
<span id="cb88-23"><a href="datacube.html#cb88-23" aria-hidden="true"></a><span class="co"># matrices from raster ----</span></span>
<span id="cb88-24"><a href="datacube.html#cb88-24" aria-hidden="true"></a><span class="co"># make input matrices from an actual raster image</span></span>
<span id="cb88-25"><a href="datacube.html#cb88-25" aria-hidden="true"></a>input &lt;-<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/iceland_delta_cutout_2.tif&quot;</span>) <span class="co"># this raster needs approx 6x7 format</span></span>
<span id="cb88-26"><a href="datacube.html#cb88-26" aria-hidden="true"></a><span class="co"># if the input raster is changed, every image where a pixel value is written as text needs to be checked and corrected accordingly</span></span>
<span id="cb88-27"><a href="datacube.html#cb88-27" aria-hidden="true"></a>input &lt;-<span class="st"> </span>input[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span>
<span id="cb88-28"><a href="datacube.html#cb88-28" aria-hidden="true"></a>warped &lt;-<span class="st"> </span><span class="kw">st_warp</span>(input, <span class="dt">crs =</span> <span class="kw">st_crs</span>(input), <span class="dt">cellsize =</span> <span class="dv">200</span>) <span class="co"># warp to approx. 6x7 pixel</span></span>
<span id="cb88-29"><a href="datacube.html#cb88-29" aria-hidden="true"></a></span>
<span id="cb88-30"><a href="datacube.html#cb88-30" aria-hidden="true"></a><span class="co"># these are only needed for resampling</span></span>
<span id="cb88-31"><a href="datacube.html#cb88-31" aria-hidden="true"></a>warped_highres &lt;-<span class="st"> </span><span class="kw">st_warp</span>(warped, <span class="dt">crs =</span> <span class="kw">st_crs</span>(warped), <span class="dt">cellsize =</span> <span class="dv">100</span>) <span class="co"># with different input, cellsize must be adapted</span></span>
<span id="cb88-32"><a href="datacube.html#cb88-32" aria-hidden="true"></a><span class="co"># this is a bit of a trick, because 3:4 is different format than 6:7</span></span>
<span id="cb88-33"><a href="datacube.html#cb88-33" aria-hidden="true"></a><span class="co"># when downsampling, the raster of origin isn&#39;t so important anyway</span></span>
<span id="cb88-34"><a href="datacube.html#cb88-34" aria-hidden="true"></a>warped_lowres &lt;-<span class="st"> </span><span class="kw">st_warp</span>(warped_highres[,<span class="dv">1</span><span class="op">:</span><span class="dv">11</span>,,], <span class="dt">crs =</span> <span class="kw">st_crs</span>(warped), <span class="dt">cellsize =</span> <span class="dv">390</span>)</span>
<span id="cb88-35"><a href="datacube.html#cb88-35" aria-hidden="true"></a><span class="co"># plot(warped_lowres)</span></span>
<span id="cb88-36"><a href="datacube.html#cb88-36" aria-hidden="true"></a><span class="co"># image(warped[,,,1], text_values = TRUE)</span></span>
<span id="cb88-37"><a href="datacube.html#cb88-37" aria-hidden="true"></a></span>
<span id="cb88-38"><a href="datacube.html#cb88-38" aria-hidden="true"></a>t1 &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">42</span>, <span class="dv">-30</span>, <span class="dv">150</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)) <span class="co"># create timesteps 2 and 3 randomly</span></span>
<span id="cb88-39"><a href="datacube.html#cb88-39" aria-hidden="true"></a>t2 &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">42</span>, <span class="dv">-250</span>, <span class="dv">50</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb88-40"><a href="datacube.html#cb88-40" aria-hidden="true"></a></span>
<span id="cb88-41"><a href="datacube.html#cb88-41" aria-hidden="true"></a><span class="co"># create dummy stars object ----</span></span>
<span id="cb88-42"><a href="datacube.html#cb88-42" aria-hidden="true"></a>make_dummy_stars &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, d1, d2, aff) {</span>
<span id="cb88-43"><a href="datacube.html#cb88-43" aria-hidden="true"></a>  m =<span class="st"> </span>warped_highres[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>x,<span class="dv">1</span><span class="op">:</span>y,<span class="dv">1</span>] <span class="co"># underlying raster doesn&#39;t matter because it&#39;s just dummy construct</span></span>
<span id="cb88-44"><a href="datacube.html#cb88-44" aria-hidden="true"></a>  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y) <span class="co"># named dim</span></span>
<span id="cb88-45"><a href="datacube.html#cb88-45" aria-hidden="true"></a>  dummy =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</span>
<span id="cb88-46"><a href="datacube.html#cb88-46" aria-hidden="true"></a>  <span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span>d1</span>
<span id="cb88-47"><a href="datacube.html#cb88-47" aria-hidden="true"></a>  <span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span>d2</span>
<span id="cb88-48"><a href="datacube.html#cb88-48" aria-hidden="true"></a>  <span class="kw">attr</span>(<span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(aff, <span class="fl">0.0</span>)</span>
<span id="cb88-49"><a href="datacube.html#cb88-49" aria-hidden="true"></a>  <span class="kw">return</span>(dummy)</span>
<span id="cb88-50"><a href="datacube.html#cb88-50" aria-hidden="true"></a>}</span>
<span id="cb88-51"><a href="datacube.html#cb88-51" aria-hidden="true"></a></span>
<span id="cb88-52"><a href="datacube.html#cb88-52" aria-hidden="true"></a>s &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="fl">2.5</span>, <span class="fl">-.5714286</span>, <span class="fl">-1.14</span>) <span class="co"># mainly used, perspective</span></span>
<span id="cb88-53"><a href="datacube.html#cb88-53" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="co"># flat</span></span>
<span id="cb88-54"><a href="datacube.html#cb88-54" aria-hidden="true"></a>highres &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">12</span>, <span class="dv">14</span>, <span class="fl">1.25</span>, <span class="fl">-.2857143</span>, <span class="fl">-.57</span>) <span class="co"># for resampling</span></span>
<span id="cb88-55"><a href="datacube.html#cb88-55" aria-hidden="true"></a>lowres &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">-1</span>, <span class="dv">-2</span>) <span class="co"># for resampling</span></span>
<span id="cb88-56"><a href="datacube.html#cb88-56" aria-hidden="true"></a></span>
<span id="cb88-57"><a href="datacube.html#cb88-57" aria-hidden="true"></a><span class="co"># matrices from image ----</span></span>
<span id="cb88-58"><a href="datacube.html#cb88-58" aria-hidden="true"></a>make_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(image, band, <span class="dt">n =</span> <span class="dv">42</span>, <span class="dt">ncol =</span> <span class="dv">7</span>, <span class="dt">t =</span> <span class="dv">0</span>) {</span>
<span id="cb88-59"><a href="datacube.html#cb88-59" aria-hidden="true"></a>  <span class="co"># this is based on an input image with &gt;= 4 input bands</span></span>
<span id="cb88-60"><a href="datacube.html#cb88-60" aria-hidden="true"></a>  <span class="co"># n is meant to cut off NAs, ncol is y, t is random matrix for time difference</span></span>
<span id="cb88-61"><a href="datacube.html#cb88-61" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">matrix</span>(image[,,,band][[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>n], <span class="dt">ncol =</span> ncol) <span class="op">-</span><span class="st"> </span>t)</span>
<span id="cb88-62"><a href="datacube.html#cb88-62" aria-hidden="true"></a>  <span class="co"># before: b3 &lt;- matrix(warped[,,,1][[1]][1:42], ncol = 7) - t2</span></span>
<span id="cb88-63"><a href="datacube.html#cb88-63" aria-hidden="true"></a>}</span>
<span id="cb88-64"><a href="datacube.html#cb88-64" aria-hidden="true"></a></span>
<span id="cb88-65"><a href="datacube.html#cb88-65" aria-hidden="true"></a><span class="co"># now use function: </span></span>
<span id="cb88-66"><a href="datacube.html#cb88-66" aria-hidden="true"></a>b1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>)</span>
<span id="cb88-67"><a href="datacube.html#cb88-67" aria-hidden="true"></a>b2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>, <span class="dt">t =</span> t1)</span>
<span id="cb88-68"><a href="datacube.html#cb88-68" aria-hidden="true"></a>b3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>, <span class="dt">t =</span> t2)</span>
<span id="cb88-69"><a href="datacube.html#cb88-69" aria-hidden="true"></a>g1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>)</span>
<span id="cb88-70"><a href="datacube.html#cb88-70" aria-hidden="true"></a>g2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>, <span class="dt">t =</span> t1)</span>
<span id="cb88-71"><a href="datacube.html#cb88-71" aria-hidden="true"></a>g3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>, <span class="dt">t =</span> t2)</span>
<span id="cb88-72"><a href="datacube.html#cb88-72" aria-hidden="true"></a>r1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>)</span>
<span id="cb88-73"><a href="datacube.html#cb88-73" aria-hidden="true"></a>r2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>, <span class="dt">t =</span> t1)</span>
<span id="cb88-74"><a href="datacube.html#cb88-74" aria-hidden="true"></a>r3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>, <span class="dt">t =</span> t2)</span>
<span id="cb88-75"><a href="datacube.html#cb88-75" aria-hidden="true"></a>n1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>)</span>
<span id="cb88-76"><a href="datacube.html#cb88-76" aria-hidden="true"></a>n2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>, <span class="dt">t =</span> t1)</span>
<span id="cb88-77"><a href="datacube.html#cb88-77" aria-hidden="true"></a>n3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>, <span class="dt">t =</span> t2)</span>
<span id="cb88-78"><a href="datacube.html#cb88-78" aria-hidden="true"></a></span>
<span id="cb88-79"><a href="datacube.html#cb88-79" aria-hidden="true"></a><span class="co"># plot functions ----</span></span>
<span id="cb88-80"><a href="datacube.html#cb88-80" aria-hidden="true"></a>plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>, pal, <span class="dt">print_geom =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="fl">.75</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) {</span>
<span id="cb88-81"><a href="datacube.html#cb88-81" aria-hidden="true"></a>  <span class="co"># pal is color palette</span></span>
<span id="cb88-82"><a href="datacube.html#cb88-82" aria-hidden="true"></a>  <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset </span>
<span id="cb88-83"><a href="datacube.html#cb88-83" aria-hidden="true"></a>  l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb88-84"><a href="datacube.html#cb88-84" aria-hidden="true"></a>  <span class="cf">if</span> (li)</span>
<span id="cb88-85"><a href="datacube.html#cb88-85" aria-hidden="true"></a>    pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.2</span>) <span class="co"># + rnorm(1, 0, 0.1))</span></span>
<span id="cb88-86"><a href="datacube.html#cb88-86" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</span>
<span id="cb88-87"><a href="datacube.html#cb88-87" aria-hidden="true"></a>    <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> breaks, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(border), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb88-88"><a href="datacube.html#cb88-88" aria-hidden="true"></a>  <span class="cf">else</span></span>
<span id="cb88-89"><a href="datacube.html#cb88-89" aria-hidden="true"></a>    <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> breaks, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(border))</span>
<span id="cb88-90"><a href="datacube.html#cb88-90" aria-hidden="true"></a>  u =<span class="st"> </span><span class="kw">st_union</span>(l)</span>
<span id="cb88-91"><a href="datacube.html#cb88-91" aria-hidden="true"></a>  <span class="co"># print(u)</span></span>
<span id="cb88-92"><a href="datacube.html#cb88-92" aria-hidden="true"></a>  <span class="cf">if</span>(print_geom) {</span>
<span id="cb88-93"><a href="datacube.html#cb88-93" aria-hidden="true"></a>    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</span>
<span id="cb88-94"><a href="datacube.html#cb88-94" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb88-95"><a href="datacube.html#cb88-95" aria-hidden="true"></a>    <span class="co"># not print geometry</span></span>
<span id="cb88-96"><a href="datacube.html#cb88-96" aria-hidden="true"></a>  }</span>
<span id="cb88-97"><a href="datacube.html#cb88-97" aria-hidden="true"></a>}</span>
<span id="cb88-98"><a href="datacube.html#cb88-98" aria-hidden="true"></a></span>
<span id="cb88-99"><a href="datacube.html#cb88-99" aria-hidden="true"></a>pl_stack =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, nrM, <span class="dt">imgY =</span> <span class="dv">7</span>, <span class="dt">inner =</span> <span class="dv">1</span>) {</span>
<span id="cb88-100"><a href="datacube.html#cb88-100" aria-hidden="true"></a>  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span id="cb88-101"><a href="datacube.html#cb88-101" aria-hidden="true"></a>  <span class="co"># prints all 4 bands at once</span></span>
<span id="cb88-102"><a href="datacube.html#cb88-102" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb88-103"><a href="datacube.html#cb88-103" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb88-104"><a href="datacube.html#cb88-104" aria-hidden="true"></a>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb88-105"><a href="datacube.html#cb88-105" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, nrM)))</span>
<span id="cb88-106"><a href="datacube.html#cb88-106" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)] <span class="co"># turn around to have same orientation as flat plot</span></span>
<span id="cb88-107"><a href="datacube.html#cb88-107" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> purples)</span>
<span id="cb88-108"><a href="datacube.html#cb88-108" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, nrM)))</span>
<span id="cb88-109"><a href="datacube.html#cb88-109" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb88-110"><a href="datacube.html#cb88-110" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> reds)</span>
<span id="cb88-111"><a href="datacube.html#cb88-111" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;g&quot;</span>, nrM)))</span>
<span id="cb88-112"><a href="datacube.html#cb88-112" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb88-113"><a href="datacube.html#cb88-113" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> greens)</span>
<span id="cb88-114"><a href="datacube.html#cb88-114" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;b&quot;</span>, nrM)))</span>
<span id="cb88-115"><a href="datacube.html#cb88-115" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb88-116"><a href="datacube.html#cb88-116" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span><span class="op">*</span>inner, <span class="ot">TRUE</span>, <span class="dt">pal =</span> blues) <span class="co"># li FALSE deleted</span></span>
<span id="cb88-117"><a href="datacube.html#cb88-117" aria-hidden="true"></a>}</span>
<span id="cb88-118"><a href="datacube.html#cb88-118" aria-hidden="true"></a></span>
<span id="cb88-119"><a href="datacube.html#cb88-119" aria-hidden="true"></a><span class="co"># flat plot function</span></span>
<span id="cb88-120"><a href="datacube.html#cb88-120" aria-hidden="true"></a><span class="co"># prints any dummy stars with any single matrix to position</span></span>
<span id="cb88-121"><a href="datacube.html#cb88-121" aria-hidden="true"></a>pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>, pal, m, <span class="dt">print_geom =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="fl">.75</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) {</span>
<span id="cb88-122"><a href="datacube.html#cb88-122" aria-hidden="true"></a>  <span class="co"># m is matrix to replace image with</span></span>
<span id="cb88-123"><a href="datacube.html#cb88-123" aria-hidden="true"></a>  <span class="co"># m &lt;- t(m)</span></span>
<span id="cb88-124"><a href="datacube.html#cb88-124" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb88-125"><a href="datacube.html#cb88-125" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb88-126"><a href="datacube.html#cb88-126" aria-hidden="true"></a>  <span class="co"># print(m)</span></span>
<span id="cb88-127"><a href="datacube.html#cb88-127" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</span>
<span id="cb88-128"><a href="datacube.html#cb88-128" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pal =</span> pal, <span class="dt">print_geom =</span> print_geom, <span class="dt">border =</span> border, <span class="dt">breaks =</span> breaks)</span>
<span id="cb88-129"><a href="datacube.html#cb88-129" aria-hidden="true"></a>  <span class="co">#plot(s, text_values = TRUE)</span></span>
<span id="cb88-130"><a href="datacube.html#cb88-130" aria-hidden="true"></a>}</span>
<span id="cb88-131"><a href="datacube.html#cb88-131" aria-hidden="true"></a></span>
<span id="cb88-132"><a href="datacube.html#cb88-132" aria-hidden="true"></a>print_segments &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, seg, <span class="dt">by =</span> <span class="dv">1</span>, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>) {</span>
<span id="cb88-133"><a href="datacube.html#cb88-133" aria-hidden="true"></a>  seg =<span class="st"> </span>seg <span class="op">*</span><span class="st"> </span>by</span>
<span id="cb88-134"><a href="datacube.html#cb88-134" aria-hidden="true"></a>  seg[,<span class="dv">1</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>x</span>
<span id="cb88-135"><a href="datacube.html#cb88-135" aria-hidden="true"></a>  seg[,<span class="dv">3</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">3</span>] <span class="op">+</span><span class="st"> </span>x</span>
<span id="cb88-136"><a href="datacube.html#cb88-136" aria-hidden="true"></a>  seg[,<span class="dv">2</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb88-137"><a href="datacube.html#cb88-137" aria-hidden="true"></a>  seg[,<span class="dv">4</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">4</span>] <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb88-138"><a href="datacube.html#cb88-138" aria-hidden="true"></a>  <span class="kw">segments</span>(seg[,<span class="dv">1</span>], seg[,<span class="dv">2</span>], seg[,<span class="dv">3</span>], seg[,<span class="dv">4</span>], <span class="dt">lwd =</span> lwd, <span class="dt">col =</span> col)</span>
<span id="cb88-139"><a href="datacube.html#cb88-139" aria-hidden="true"></a>}</span>
<span id="cb88-140"><a href="datacube.html#cb88-140" aria-hidden="true"></a></span>
<span id="cb88-141"><a href="datacube.html#cb88-141" aria-hidden="true"></a><span class="co"># time series ----</span></span>
<span id="cb88-142"><a href="datacube.html#cb88-142" aria-hidden="true"></a></span>
<span id="cb88-143"><a href="datacube.html#cb88-143" aria-hidden="true"></a><span class="co"># from: cube1_ts_6x7_bigger.png</span></span>
<span id="cb88-144"><a href="datacube.html#cb88-144" aria-hidden="true"></a>offset =<span class="st"> </span><span class="dv">26</span></span>
<span id="cb88-145"><a href="datacube.html#cb88-145" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb88-146"><a href="datacube.html#cb88-146" aria-hidden="true"></a><span class="co">#par(mar = c(3, 2, 7, 2))</span></span>
<span id="cb88-147"><a href="datacube.html#cb88-147" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb88-148"><a href="datacube.html#cb88-148" aria-hidden="true"></a><span class="co">#plot.window(xlim = c(10, 50), ylim = c(-3, 10), asp = 1)</span></span>
<span id="cb88-149"><a href="datacube.html#cb88-149" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">15</span>, <span class="dv">75</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">10</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb88-150"><a href="datacube.html#cb88-150" aria-hidden="true"></a><span class="kw">pl_stack</span>(s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">3</span>)</span>
<span id="cb88-151"><a href="datacube.html#cb88-151" aria-hidden="true"></a><span class="kw">pl_stack</span>(s, offset, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">2</span>)</span>
<span id="cb88-152"><a href="datacube.html#cb88-152" aria-hidden="true"></a><span class="kw">pl_stack</span>(s, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>offset, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">1</span>)</span>
<span id="cb88-153"><a href="datacube.html#cb88-153" aria-hidden="true"></a><span class="co"># po &lt;- matrix(c(0,-8,7,0,15,3.5,  0,1,1,5,5,14), ncol = 2)</span></span>
<span id="cb88-154"><a href="datacube.html#cb88-154" aria-hidden="true"></a>heads &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="dv">14</span>,<span class="dv">14</span>,<span class="dv">14</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb88-155"><a href="datacube.html#cb88-155" aria-hidden="true"></a><span class="kw">points</span>(heads, <span class="dt">pch =</span> <span class="dv">16</span>) <span class="co"># 4 or 16</span></span>
<span id="cb88-156"><a href="datacube.html#cb88-156" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span>, <span class="dv">14</span>) <span class="co"># first stack pyramid</span></span>
<span id="cb88-157"><a href="datacube.html#cb88-157" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span>offset, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, <span class="dv">14</span>) <span class="co"># second stack pyramid</span></span>
<span id="cb88-158"><a href="datacube.html#cb88-158" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="dv">14</span>) <span class="co"># third stack pyramid</span></span>
<span id="cb88-159"><a href="datacube.html#cb88-159" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="op">-</span><span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">72</span>, <span class="dv">14</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)  <span class="co"># timeline</span></span>
<span id="cb88-160"><a href="datacube.html#cb88-160" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">7.5</span>, <span class="fl">3.8</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb88-161"><a href="datacube.html#cb88-161" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="fl">-2.5</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb88-162"><a href="datacube.html#cb88-162" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="fl">4.5</span>, <span class="fl">1.8</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">srt =</span> <span class="fl">27.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb88-163"><a href="datacube.html#cb88-163" aria-hidden="true"></a>y =<span class="st"> </span><span class="fl">15.8</span></span>
<span id="cb88-164"><a href="datacube.html#cb88-164" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">69</span>, y, <span class="st">&quot;time&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb88-165"><a href="datacube.html#cb88-165" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.5</span>, y, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb88-166"><a href="datacube.html#cb88-166" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, y, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb88-167"><a href="datacube.html#cb88-167" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, y, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4d"></span>
<img src="sds_files/figure-html/cube4d-1.png" alt="Four-dimensional raster data cube with dimensions x, y, bands and time" width="960" />
<p class="caption">
Figure 6.2: Four-dimensional raster data cube with dimensions x, y, bands and time
</p>
</div>
<p>Figure <a href="datacube.html#fig:cube4d">6.2</a> depicts a four-dimensional raster data
cube, where three-dimensional raster data cubes with a spectral
dimension (“bands”) are organised along a fourth dimension, a time
axis. Color image data always has three bands (Blue, Green, Red),
and this example has a fourth band (near infrared, NIR), which is
commonly found in spectral remote sensing data.</p>
<p>Figure <a href="datacube.html#fig:cube4d2">6.3</a> shows exactly the same data, but layed out
flat as a facet plot (or scatterplot matrix), where two dimensions
(<span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>) are aligned with (or nested within) the dimensions
<em>bands</em> and <em>time</em>, respectively.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="datacube.html#cb89-1" aria-hidden="true"></a><span class="co"># flat ----</span></span>
<span id="cb89-2"><a href="datacube.html#cb89-2" aria-hidden="true"></a>xlabels &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span><span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">length.out =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>to, <span class="dt">by =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta)</span>
<span id="cb89-3"><a href="datacube.html#cb89-3" aria-hidden="true"></a>ylabels &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span><span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">length.out =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>to, <span class="dt">by =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta)</span>
<span id="cb89-4"><a href="datacube.html#cb89-4" aria-hidden="true"></a></span>
<span id="cb89-5"><a href="datacube.html#cb89-5" aria-hidden="true"></a>print_labels &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, off, lab, horizontal, <span class="dt">cex =</span> <span class="dv">1</span>) {</span>
<span id="cb89-6"><a href="datacube.html#cb89-6" aria-hidden="true"></a>  <span class="cf">if</span>(horizontal) { <span class="co"># x</span></span>
<span id="cb89-7"><a href="datacube.html#cb89-7" aria-hidden="true"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(lab)<span class="op">-</span><span class="dv">1</span>)) {</span>
<span id="cb89-8"><a href="datacube.html#cb89-8" aria-hidden="true"></a>      <span class="kw">text</span>(x <span class="op">+</span><span class="st"> </span>i<span class="op">*</span>off, y, lab[i<span class="op">+</span><span class="dv">1</span>], <span class="dt">cex =</span> cex, <span class="dt">srt =</span> <span class="dv">90</span>)</span>
<span id="cb89-9"><a href="datacube.html#cb89-9" aria-hidden="true"></a>    }</span>
<span id="cb89-10"><a href="datacube.html#cb89-10" aria-hidden="true"></a>  } <span class="cf">else</span> { <span class="co"># y</span></span>
<span id="cb89-11"><a href="datacube.html#cb89-11" aria-hidden="true"></a>    lab &lt;-<span class="st"> </span>lab[<span class="kw">length</span>(lab)<span class="op">:</span><span class="dv">0</span>]</span>
<span id="cb89-12"><a href="datacube.html#cb89-12" aria-hidden="true"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(lab)<span class="op">-</span><span class="dv">1</span>)) {</span>
<span id="cb89-13"><a href="datacube.html#cb89-13" aria-hidden="true"></a>      <span class="kw">text</span>(x, y <span class="op">+</span><span class="st"> </span>i<span class="op">*</span>off, lab[i<span class="op">+</span><span class="dv">1</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb89-14"><a href="datacube.html#cb89-14" aria-hidden="true"></a>    }</span>
<span id="cb89-15"><a href="datacube.html#cb89-15" aria-hidden="true"></a>  }</span>
<span id="cb89-16"><a href="datacube.html#cb89-16" aria-hidden="true"></a>}</span>
<span id="cb89-17"><a href="datacube.html#cb89-17" aria-hidden="true"></a></span>
<span id="cb89-18"><a href="datacube.html#cb89-18" aria-hidden="true"></a><span class="co"># before: width=1000, xlim(-2, 33), date labels x=31</span></span>
<span id="cb89-19"><a href="datacube.html#cb89-19" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb89-20"><a href="datacube.html#cb89-20" aria-hidden="true"></a><span class="co"># par(mar = c(0,0,0,0))</span></span>
<span id="cb89-21"><a href="datacube.html#cb89-21" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb89-22"><a href="datacube.html#cb89-22" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">40</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">25</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb89-23"><a href="datacube.html#cb89-23" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</span>
<span id="cb89-24"><a href="datacube.html#cb89-24" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">10</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</span>
<span id="cb89-25"><a href="datacube.html#cb89-25" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">20</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb89-26"><a href="datacube.html#cb89-26" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">0</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</span>
<span id="cb89-27"><a href="datacube.html#cb89-27" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">10</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</span>
<span id="cb89-28"><a href="datacube.html#cb89-28" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">20</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb89-29"><a href="datacube.html#cb89-29" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">0</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</span>
<span id="cb89-30"><a href="datacube.html#cb89-30" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">10</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</span>
<span id="cb89-31"><a href="datacube.html#cb89-31" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">20</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb89-32"><a href="datacube.html#cb89-32" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">0</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</span>
<span id="cb89-33"><a href="datacube.html#cb89-33" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">10</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</span>
<span id="cb89-34"><a href="datacube.html#cb89-34" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">20</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb89-35"><a href="datacube.html#cb89-35" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="fl">28.5</span>, <span class="dv">-2</span>, <span class="dv">1</span>, xlabels, <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb89-36"><a href="datacube.html#cb89-36" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dv">36</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, ylabels, <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb89-37"><a href="datacube.html#cb89-37" aria-hidden="true"></a><span class="co"># arrows(6, 27, 6, 0, angle = 20, lwd = 2)</span></span>
<span id="cb89-38"><a href="datacube.html#cb89-38" aria-hidden="true"></a><span class="co"># text(5, 14, &quot;time&quot;, srt = 90, col = &quot;black&quot;)</span></span>
<span id="cb89-39"><a href="datacube.html#cb89-39" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">10</span>, <span class="dv">28</span>, <span class="st">&quot;blue&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb89-40"><a href="datacube.html#cb89-40" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">17</span>, <span class="dv">28</span>, <span class="st">&quot;green&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb89-41"><a href="datacube.html#cb89-41" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">24</span>, <span class="dv">28</span>, <span class="st">&quot;red&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb89-42"><a href="datacube.html#cb89-42" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">31</span>, <span class="dv">28</span>, <span class="st">&quot;nir&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb89-43"><a href="datacube.html#cb89-43" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">23.5</span>, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb89-44"><a href="datacube.html#cb89-44" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span>, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb89-45"><a href="datacube.html#cb89-45" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">3.5</span>, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4d2"></span>
<img src="sds_files/figure-html/cube4d2-1.png" alt="Four-dimensional raster data cube layed out flat over two dimensions" width="960" />
<p class="caption">
Figure 6.3: Four-dimensional raster data cube layed out flat over two dimensions
</p>
</div>
</div>
<div id="dimensions-attributes-and-support" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Dimensions, attributes, and support</h2>
<p>Phenomena in space and time can be thought of as functions
with domain space and time, and with range one or more observed
attributes. For clearly identifiable discrete events or objects,
the range is typically discrete, and precise delineation involves
describing the precise coordinates where a thing starts or stops,
which is best suited by vector geometries. For continuous phenomena,
variables that take on a value everywhere such as air temperature
or land use type, there are infinitely many values to represent and
a common approach is to discretize space and time <em>regularly</em> over
the spatiotemporal domain (extent) of interest. This leads to a
number of familiar data structures:</p>
<ul>
<li>time series, depicted as time lines for functions of time,</li>
<li>image or raster data for two-dimensional spatial data, and</li>
<li>time sequences of images for dynamic spatial data.</li>
</ul>
<p>The third form of this, where a variable <span class="math inline">\(Z\)</span> depends on <span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>
and <span class="math inline">\(t\)</span>, as in</p>
<p><span class="math display">\[Z = f(x, y, t)\]</span></p>
<p>is the archetype of a spatiotemporal array or <em>data cube</em>: the shape
of the volume where points regularly discretizing the domain forms a
cube. We call the variables that form the range (here: <span class="math inline">\(x, y, t\)</span>) the
cube <em>dimensions</em>. Data cubes may have multiple attributes, as in</p>
<p><span class="math display">\[\{Z_1,Z_2,...,Z_p\} = f(x, y, t)\]</span></p>
<p>and if <span class="math inline">\(Z\)</span> is functional, e.g. reflectance values measured over
the electromagnetic spectrum, the spectral wavelengths <span class="math inline">\(\lambda\)</span>
may form an additional dimension, as in <span class="math inline">\(Z = f(x,y,t,\lambda)\)</span>;
section <a href="datacube.html#switching">6.5</a> discusses the alternative of representing
color bands as attributes.</p>
<p>Multiple time dimensions arise for instance when making forecasts for
different times in the future <span class="math inline">\(t&#39;\)</span> at different times <span class="math inline">\(t\)</span>, or when
time is split into multiple dimensions (e.g. year, day-of-year,
hour-of-day). The most general definition of a data cube is a
functional mapping from <span class="math inline">\(n\)</span> dimensions to <span class="math inline">\(p\)</span> attributes:</p>
<p><span class="math display">\[\{Z_1,Z_2,...,Z_p\} = f(D_1,D_2,...,D_n)\]</span></p>
<p>Here, we will consider any dataset with one or more space dimensions
and zero or more time dimensions as data cubes. That includes</p>
<ul>
<li>simple features (section <a href="geometries.html#simplefeatures">3.1</a>),</li>
<li>time series for sets of features,</li>
<li>raster data,</li>
<li>multi-spectral raster data (images), or</li>
<li>time series of multi-spectral raster data (video).</li>
</ul>
<div id="regular-dimensions-gdals-geotransform" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Regular dimensions, GDAL’s geotransform</h3>
<p>Data cubes are usually stored in multi-dimensional arrays, and the
usual relationship between 1-based array index <span class="math inline">\(i\)</span> and an associated
regularly discretized dimension variable <span class="math inline">\(x\)</span> is</p>
<p><span class="math display">\[x = o_x + (i-1) d_x\]</span></p>
<p>with <span class="math inline">\(o_x\)</span> the origin, and <span class="math inline">\(d_x\)</span> the grid spacing for this dimension.</p>
<p>For more general cases like those in figure
<a href="intro.html#fig:rastertypes01">1.5</a>b-c, the relation between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>
and array indexes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> is</p>
<p><span class="math display">\[x = o_x + (i-1) d_x + (j-1) a_1\]</span></p>
<p><span class="math display">\[y = o_y + (i-1) a_2 + (j-1) d_y\]</span></p>
<p>With two affine parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(a_2\)</span>; this is the so-called
<em>geotransform</em> as used in GDAL. When <span class="math inline">\(a_1=a_2=0\)</span>, this
reduces to the regular raster of figure <a href="intro.html#fig:rastertypes01">1.5</a>a
with square cells if <span class="math inline">\(d_x = d_y\)</span>.
For integer indexes, the coordinates are that of the starting <em>edge</em>
of a grid cell, and the cell area (pixel) spans a range corresponding to
index values ranging from <span class="math inline">\(i\)</span> (inclusive) to <span class="math inline">\(i+1\)</span> (exclusive).
For most common imagery formats, <span class="math inline">\(d_y\)</span> is negative,
indicating that image row index increases with decreasing <span class="math inline">\(y\)</span>
values (southward). To get the <span class="math inline">\(x\)</span>- and <span class="math inline">\(y\)</span>-coordinate of the grid
cell <em>center</em> of the top left grid cell (in case of a negative <span class="math inline">\(d_y\)</span>),
we use <span class="math inline">\(i=1.5\)</span> and <span class="math inline">\(j=1.5\)</span>.</p>
<p>For rectilinear rasters, a table that maps array index to dimension
values is needed. NetCDF files for instance always stores all values
of spatial dimension variables that correspond to the center of
spatial grid cells, and may in addition store grid cell boundaries
(which is needed to define rectlinear dimensions unambiguously).</p>
<p>For curvilinear rasters an array that maps every combination of <span class="math inline">\(i,j\)</span>
into <span class="math inline">\(x,y\)</span> pairs is needed, or a parametric function that does this
(e.g. an projection or its inverse). NetCDF files often provide both,
when available.</p>
</div>
<div id="support-along-cube-dimensions" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Support along cube dimensions</h3>
<p>Section <a href="featureattributes.html#agr">5.1</a> defined <em>spatial</em> support of an attribute variable
as the size (length, area, volume) of a geometry a particular
observation or prediction is associated with. The same notion
applies to temporal support. Although time is rarely reported by
explicit time periods having a start- and end-time, in many cases
either the time stamp implies a period (e.g. ISO-8601 indications
like “2021” for a full year, “2021-01” for full month) or the time
period is taken as the period from the time stamp of the current
record up to but not including the time stamp of the next record.</p>
<p>An example is MODIS satellite imagery, where vegetation indexes (NDVI
and EVI) are available as 16-day composites, meaning that over 16-day
periods all available imagery is aggregated into a single image; such
composites have temporal “block support”. Sentinel-2 or Landsat-8
data on the other hand are “snapshot” images and have temporal
“point support”. When temporally aggregating data with temporal
point support e.g. to monthly values one would select all images
falling in the target time interval. when aggregating temporal block
support imagery such as the MODIS 16-day composite, one might
weigh images, e.g. according to the amount of overlap of the 16-day
composite period and the target period, similar to area-weighted
interpolation but over the time dimension.</p>
</div>
</div>
<div id="dcoperations" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Operations on data cubes</h2>
<div id="slicing-a-cube-filter" class="section level3" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> slicing a cube: filter</h3>
<p>Data cubes can be sliced into subcubes by fixing a dimension at a
particular value. Figure <a href="datacube.html#fig:cube4filter">6.4</a> shows the sub-cubes
obtained by doing with each of the dimensions. In this figure,
the spatial filtering does not happen by fixing a single spatial
dimension at a particular value, but by selecting a particular
subregion, which is a more common operation. Fixing <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span> would
give a sub-cube along a transect of constant <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span>, which can
be used to show a Hovmöller diagram, where an attribute is plotted
(colored) in the space of one space and one time dimension.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="datacube.html#cb90-1" aria-hidden="true"></a><span class="co"># filter ----</span></span>
<span id="cb90-2"><a href="datacube.html#cb90-2" aria-hidden="true"></a><span class="co"># mask &lt;- matrix(c(rep(NA, 26), 1,NA,1,NA,1,1,1, rep(NA, 9)), ncol = 7)</span></span>
<span id="cb90-3"><a href="datacube.html#cb90-3" aria-hidden="true"></a>mask &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb90-4"><a href="datacube.html#cb90-4" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb90-5"><a href="datacube.html#cb90-5" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb90-6"><a href="datacube.html#cb90-6" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb90-7"><a href="datacube.html#cb90-7" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb90-8"><a href="datacube.html#cb90-8" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb90-9"><a href="datacube.html#cb90-9" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb90-10"><a href="datacube.html#cb90-10" aria-hidden="true"></a></span>
<span id="cb90-11"><a href="datacube.html#cb90-11" aria-hidden="true"></a>print_grid &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb90-12"><a href="datacube.html#cb90-12" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</span>
<span id="cb90-13"><a href="datacube.html#cb90-13" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</span>
<span id="cb90-14"><a href="datacube.html#cb90-14" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb90-15"><a href="datacube.html#cb90-15" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</span>
<span id="cb90-16"><a href="datacube.html#cb90-16" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</span>
<span id="cb90-17"><a href="datacube.html#cb90-17" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb90-18"><a href="datacube.html#cb90-18" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</span>
<span id="cb90-19"><a href="datacube.html#cb90-19" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</span>
<span id="cb90-20"><a href="datacube.html#cb90-20" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb90-21"><a href="datacube.html#cb90-21" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</span>
<span id="cb90-22"><a href="datacube.html#cb90-22" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</span>
<span id="cb90-23"><a href="datacube.html#cb90-23" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb90-24"><a href="datacube.html#cb90-24" aria-hidden="true"></a>}</span>
<span id="cb90-25"><a href="datacube.html#cb90-25" aria-hidden="true"></a>print_alpha_grid &lt;-<span class="st"> </span><span class="cf">function</span>(x,y, <span class="dt">alp =</span> <span class="fl">0.2</span>, <span class="dt">geom =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb90-26"><a href="datacube.html#cb90-26" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-27"><a href="datacube.html#cb90-27" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-28"><a href="datacube.html#cb90-28" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b3, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-29"><a href="datacube.html#cb90-29" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-30"><a href="datacube.html#cb90-30" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-31"><a href="datacube.html#cb90-31" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g3, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-32"><a href="datacube.html#cb90-32" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-33"><a href="datacube.html#cb90-33" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-34"><a href="datacube.html#cb90-34" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r3, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-35"><a href="datacube.html#cb90-35" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n1, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-36"><a href="datacube.html#cb90-36" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n2, <span class="dt">border =</span> <span class="dv">1</span>)</span>
<span id="cb90-37"><a href="datacube.html#cb90-37" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n3, <span class="dt">border =</span> <span class="dv">1</span>))</span>
<span id="cb90-38"><a href="datacube.html#cb90-38" aria-hidden="true"></a>}</span>
<span id="cb90-39"><a href="datacube.html#cb90-39" aria-hidden="true"></a></span>
<span id="cb90-40"><a href="datacube.html#cb90-40" aria-hidden="true"></a>print_grid_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb90-41"><a href="datacube.html#cb90-41" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-42"><a href="datacube.html#cb90-42" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-43"><a href="datacube.html#cb90-43" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-44"><a href="datacube.html#cb90-44" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-45"><a href="datacube.html#cb90-45" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-46"><a href="datacube.html#cb90-46" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-47"><a href="datacube.html#cb90-47" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-48"><a href="datacube.html#cb90-48" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-49"><a href="datacube.html#cb90-49" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-50"><a href="datacube.html#cb90-50" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-51"><a href="datacube.html#cb90-51" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-52"><a href="datacube.html#cb90-52" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb90-53"><a href="datacube.html#cb90-53" aria-hidden="true"></a>}</span>
<span id="cb90-54"><a href="datacube.html#cb90-54" aria-hidden="true"></a></span>
<span id="cb90-55"><a href="datacube.html#cb90-55" aria-hidden="true"></a>print_grid_time_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) { <span class="co"># 3x1, 28x7</span></span>
<span id="cb90-56"><a href="datacube.html#cb90-56" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb90-57"><a href="datacube.html#cb90-57" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb90-58"><a href="datacube.html#cb90-58" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb90-59"><a href="datacube.html#cb90-59" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb90-60"><a href="datacube.html#cb90-60" aria-hidden="true"></a>}</span>
<span id="cb90-61"><a href="datacube.html#cb90-61" aria-hidden="true"></a></span>
<span id="cb90-62"><a href="datacube.html#cb90-62" aria-hidden="true"></a>print_grid_bands_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">pal =</span> greys) { <span class="co"># 1x3 6x27</span></span>
<span id="cb90-63"><a href="datacube.html#cb90-63" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n1)</span>
<span id="cb90-64"><a href="datacube.html#cb90-64" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n2)</span>
<span id="cb90-65"><a href="datacube.html#cb90-65" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n3)</span>
<span id="cb90-66"><a href="datacube.html#cb90-66" aria-hidden="true"></a>}</span>
<span id="cb90-67"><a href="datacube.html#cb90-67" aria-hidden="true"></a></span>
<span id="cb90-68"><a href="datacube.html#cb90-68" aria-hidden="true"></a><span class="co"># build exactly like reduce</span></span>
<span id="cb90-69"><a href="datacube.html#cb90-69" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb90-70"><a href="datacube.html#cb90-70" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb90-71"><a href="datacube.html#cb90-71" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">120</span></span>
<span id="cb90-72"><a href="datacube.html#cb90-72" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb90-73"><a href="datacube.html#cb90-73" aria-hidden="true"></a>down =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb90-74"><a href="datacube.html#cb90-74" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb90-75"><a href="datacube.html#cb90-75" aria-hidden="true"></a><span class="kw">print_grid</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-27</span>)</span>
<span id="cb90-76"><a href="datacube.html#cb90-76" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></span>
<span id="cb90-77"><a href="datacube.html#cb90-77" aria-hidden="true"></a><span class="kw">print_grid_time_filter</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">-10</span><span class="op">-</span>down) <span class="co"># select 3rd</span></span>
<span id="cb90-78"><a href="datacube.html#cb90-78" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3-6</span>)<span class="op">/</span><span class="dv">2</span>) <span class="fl">-10.5</span>, <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></span>
<span id="cb90-79"><a href="datacube.html#cb90-79" aria-hidden="true"></a><span class="kw">print_grid_bands_filter</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3</span><span class="fl">-12.4</span>)), <span class="dv">0</span><span class="op">-</span>down, <span class="dt">pal =</span> purples)</span>
<span id="cb90-80"><a href="datacube.html#cb90-80" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></span>
<span id="cb90-81"><a href="datacube.html#cb90-81" aria-hidden="true"></a><span class="kw">print_grid_filter</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span><span class="op">-</span>down)</span>
<span id="cb90-82"><a href="datacube.html#cb90-82" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb90-83"><a href="datacube.html#cb90-83" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">43</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb90-84"><a href="datacube.html#cb90-84" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">83</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb90-85"><a href="datacube.html#cb90-85" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">20</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb90-86"><a href="datacube.html#cb90-86" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb90-87"><a href="datacube.html#cb90-87" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">100</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb90-88"><a href="datacube.html#cb90-88" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">6</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb90-89"><a href="datacube.html#cb90-89" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">2</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb90-90"><a href="datacube.html#cb90-90" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, <span class="dv">100</span>, <span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb90-91"><a href="datacube.html#cb90-91" aria-hidden="true"></a><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span id="cb90-92"><a href="datacube.html#cb90-92" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">28.5</span>,<span class="dv">49</span>, <span class="st">&quot;filter temporally&quot;</span>, <span class="dt">srt =</span> <span class="fl">55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb90-93"><a href="datacube.html#cb90-93" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>,<span class="dv">49</span>, <span class="st">&quot;filter bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb90-94"><a href="datacube.html#cb90-94" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">91.5</span>,<span class="dv">49</span>, <span class="st">&quot;filter spatially&quot;</span>, <span class="dt">srt =</span> <span class="fl">-55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb90-95"><a href="datacube.html#cb90-95" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">y =</span> y<span class="op">+</span><span class="dv">4</span>, <span class="dt">off =</span> <span class="dv">7</span>, <span class="dt">lab =</span> <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;nir&quot;</span>),</span>
<span id="cb90-96"><a href="datacube.html#cb90-96" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb90-97"><a href="datacube.html#cb90-97" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">9</span>, <span class="dt">y =</span> y<span class="dv">-23</span>, <span class="dt">off =</span> <span class="dv">10</span>, <span class="dt">lab =</span> <span class="kw">c</span>(<span class="st">&quot;2020-10-01&quot;</span>, <span class="st">&quot;2020-10-13&quot;</span>, <span class="st">&quot;2020-10-25&quot;</span>),</span>
<span id="cb90-98"><a href="datacube.html#cb90-98" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb90-99"><a href="datacube.html#cb90-99" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="fl">21.5</span>, <span class="dt">y =</span> y<span class="dv">-30</span>, <span class="dt">off =</span> <span class="dv">1</span>, <span class="dt">lab =</span> xlabels,</span>
<span id="cb90-100"><a href="datacube.html#cb90-100" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>)</span>
<span id="cb90-101"><a href="datacube.html#cb90-101" aria-hidden="true"></a><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">30</span>, <span class="dt">y =</span> y<span class="fl">-26.5</span>, <span class="dt">off =</span> <span class="dv">1</span>, <span class="dt">lab =</span> ylabels,</span>
<span id="cb90-102"><a href="datacube.html#cb90-102" aria-hidden="true"></a>             <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4filter"></span>
<img src="sds_files/figure-html/cube4filter-1.png" alt="Data cube filtering by time, band or spatially" width="960" />
<p class="caption">
Figure 6.4: Data cube filtering by time, band or spatially
</p>
</div>
</div>
<div id="applydimension" class="section level3" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Applying functions to dimensions</h3>
<p>A common analysis involves applying a function over one or more
cube dimensions. Simple cases arise where a function such as <code>abs</code>,
<code>sin</code> or <code>sqrt</code> is applied to all values in the cube, or when a function
takes all values in the cube and returns a single scalar, e.g. when
one computes the mean or maximum value over the entire cube. Other
options include applying the function to selected dimensions,
e.g. applying a temporal low-pass filter to every individual
(pixel/band) time series as shown in figure <a href="datacube.html#fig:cube4apply1">6.6</a>,
or applying a <em>spatial</em> low-pass filter to every spatial
slice (i.e. every band/time combination), shown in figure
<a href="datacube.html#fig:cube4apply2">6.5</a>.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="datacube.html#cb91-1" aria-hidden="true"></a><span class="co"># apply ----</span></span>
<span id="cb91-2"><a href="datacube.html#cb91-2" aria-hidden="true"></a>print_text =<span class="st"> </span><span class="cf">function</span>(s, x, y, m) {</span>
<span id="cb91-3"><a href="datacube.html#cb91-3" aria-hidden="true"></a>  <span class="co"># m &lt;- t(m) # transverse for correct order</span></span>
<span id="cb91-4"><a href="datacube.html#cb91-4" aria-hidden="true"></a>  <span class="co"># print(m)</span></span>
<span id="cb91-5"><a href="datacube.html#cb91-5" aria-hidden="true"></a>  r &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">5.5</span>, <span class="dv">1</span>), <span class="dv">7</span>)</span>
<span id="cb91-6"><a href="datacube.html#cb91-6" aria-hidden="true"></a>  r &lt;-<span class="st"> </span>r <span class="op">+</span><span class="st"> </span>x <span class="co"># consider offsets</span></span>
<span id="cb91-7"><a href="datacube.html#cb91-7" aria-hidden="true"></a>  u &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="fl">0.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">1.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">2.5</span>, <span class="dv">6</span>), </span>
<span id="cb91-8"><a href="datacube.html#cb91-8" aria-hidden="true"></a>         <span class="kw">rep</span>(<span class="fl">3.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">4.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">5.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">6.5</span>, <span class="dv">6</span>))</span>
<span id="cb91-9"><a href="datacube.html#cb91-9" aria-hidden="true"></a>  u &lt;-<span class="st"> </span>u <span class="op">+</span><span class="st"> </span>y <span class="co"># offset</span></span>
<span id="cb91-10"><a href="datacube.html#cb91-10" aria-hidden="true"></a>  tab &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(r,u), <span class="dt">nrow =</span> <span class="dv">42</span>, <span class="dt">byrow =</span> <span class="ot">FALSE</span>) <span class="co"># make point table</span></span>
<span id="cb91-11"><a href="datacube.html#cb91-11" aria-hidden="true"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">42</span>) {</span>
<span id="cb91-12"><a href="datacube.html#cb91-12" aria-hidden="true"></a>    <span class="co">#text(tab[i, 1], tab[i, 2], labels = paste0(&quot;&quot;, m[i]), cex = 1.1)</span></span>
<span id="cb91-13"><a href="datacube.html#cb91-13" aria-hidden="true"></a>    <span class="kw">text</span>(tab[i, <span class="dv">1</span>], tab[i, <span class="dv">2</span>], <span class="dt">labels =</span> <span class="kw">paste0</span>(<span class="st">&quot;&quot;</span>, m[i]), <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb91-14"><a href="datacube.html#cb91-14" aria-hidden="true"></a>    }</span>
<span id="cb91-15"><a href="datacube.html#cb91-15" aria-hidden="true"></a>}</span>
<span id="cb91-16"><a href="datacube.html#cb91-16" aria-hidden="true"></a></span>
<span id="cb91-17"><a href="datacube.html#cb91-17" aria-hidden="true"></a>abs_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">500</span>,<span class="dv">500</span>, <span class="dv">50</span>)</span>
<span id="cb91-18"><a href="datacube.html#cb91-18" aria-hidden="true"></a>abs_pal &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">211</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">30</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="fl">1.2</span>)</span>
<span id="cb91-19"><a href="datacube.html#cb91-19" aria-hidden="true"></a></span>
<span id="cb91-20"><a href="datacube.html#cb91-20" aria-hidden="true"></a><span class="co">#png(&quot;exp_apply_unary.png&quot;, width = 2400, height = 1000, pointsize = 24)</span></span>
<span id="cb91-21"><a href="datacube.html#cb91-21" aria-hidden="true"></a><span class="co">#plot.new()</span></span>
<span id="cb91-22"><a href="datacube.html#cb91-22" aria-hidden="true"></a><span class="co">#par(mar = c(2,2,2,2))</span></span>
<span id="cb91-23"><a href="datacube.html#cb91-23" aria-hidden="true"></a><span class="co">#x = 30</span></span>
<span id="cb91-24"><a href="datacube.html#cb91-24" aria-hidden="true"></a><span class="co">#y = 7.5</span></span>
<span id="cb91-25"><a href="datacube.html#cb91-25" aria-hidden="true"></a><span class="co">#plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></span>
<span id="cb91-26"><a href="datacube.html#cb91-26" aria-hidden="true"></a><span class="co">#pl(f, 3, 2, pal = abs_pal, m = b3 - 200, breaks = abs_brks)</span></span>
<span id="cb91-27"><a href="datacube.html#cb91-27" aria-hidden="true"></a><span class="co">#pl(f, 1.5, .5, pal = abs_pal, m = b2 - 200, breaks = abs_brks)</span></span>
<span id="cb91-28"><a href="datacube.html#cb91-28" aria-hidden="true"></a><span class="co">#pl(f, 0, -1, pal = abs_pal, m = b1 - 200, breaks = abs_brks)</span></span>
<span id="cb91-29"><a href="datacube.html#cb91-29" aria-hidden="true"></a><span class="co">#print_text(s, 0, -1, m = b1 - 200)</span></span>
<span id="cb91-30"><a href="datacube.html#cb91-30" aria-hidden="true"></a><span class="co">#pl(f, 23, 2, pal = abs_pal, m = abs(b3 - 200), breaks = abs_brks)</span></span>
<span id="cb91-31"><a href="datacube.html#cb91-31" aria-hidden="true"></a><span class="co">#pl(f, 21.5, 0.5, pal = abs_pal, m = abs(b2 - 200), breaks = abs_brks)</span></span>
<span id="cb91-32"><a href="datacube.html#cb91-32" aria-hidden="true"></a><span class="co">#pl(f, 20, -1, pal = abs_pal, m = abs(b1 - 200), breaks = abs_brks)</span></span>
<span id="cb91-33"><a href="datacube.html#cb91-33" aria-hidden="true"></a><span class="co">#print_text(s, 20, -1, m = abs(b1 - 200))</span></span>
<span id="cb91-34"><a href="datacube.html#cb91-34" aria-hidden="true"></a><span class="co">#arrows(11, 4, 17.5, 4, lwd = 3)</span></span>
<span id="cb91-35"><a href="datacube.html#cb91-35" aria-hidden="true"></a><span class="co">#text(14.3, 3.5, &quot;absolute()&quot;, cex = 1.4)</span></span>
<span id="cb91-36"><a href="datacube.html#cb91-36" aria-hidden="true"></a><span class="co">#dev.off()</span></span>
<span id="cb91-37"><a href="datacube.html#cb91-37" aria-hidden="true"></a></span>
<span id="cb91-38"><a href="datacube.html#cb91-38" aria-hidden="true"></a>vNeumann_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb91-39"><a href="datacube.html#cb91-39" aria-hidden="true"></a>                         <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb91-40"><a href="datacube.html#cb91-40" aria-hidden="true"></a></span>
<span id="cb91-41"><a href="datacube.html#cb91-41" aria-hidden="true"></a>apply_filter &lt;-<span class="st"> </span><span class="cf">function</span>(input, <span class="dt">pad =</span> <span class="ot">TRUE</span>, <span class="dt">padValue =</span> <span class="dv">1</span>) {</span>
<span id="cb91-42"><a href="datacube.html#cb91-42" aria-hidden="true"></a>  ras &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">focal</span>(raster<span class="op">::</span><span class="kw">raster</span>(input), <span class="dt">w =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.2</span>,<span class="dv">0</span>, <span class="fl">0.2</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>, <span class="dv">0</span>,<span class="fl">0.2</span>,<span class="dv">0</span>), <span class="dt">ncol =</span> <span class="dv">3</span>), <span class="dt">pad =</span> pad, <span class="dt">padValue =</span> padValue)</span>
<span id="cb91-43"><a href="datacube.html#cb91-43" aria-hidden="true"></a>  ras &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">as.matrix</span>(ras)</span>
<span id="cb91-44"><a href="datacube.html#cb91-44" aria-hidden="true"></a>  ras[ras <span class="op">==</span><span class="st"> &quot;NaN&quot;</span>] &lt;-<span class="st"> </span><span class="dv">-999</span></span>
<span id="cb91-45"><a href="datacube.html#cb91-45" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">floor</span>(ras))</span>
<span id="cb91-46"><a href="datacube.html#cb91-46" aria-hidden="true"></a>}</span>
<span id="cb91-47"><a href="datacube.html#cb91-47" aria-hidden="true"></a></span>
<span id="cb91-48"><a href="datacube.html#cb91-48" aria-hidden="true"></a>brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1000</span>, <span class="dv">50</span>)</span>
<span id="cb91-49"><a href="datacube.html#cb91-49" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb91-50"><a href="datacube.html#cb91-50" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb91-51"><a href="datacube.html#cb91-51" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">30</span></span>
<span id="cb91-52"><a href="datacube.html#cb91-52" aria-hidden="true"></a>y =<span class="st"> </span><span class="fl">7.5</span></span>
<span id="cb91-53"><a href="datacube.html#cb91-53" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb91-54"><a href="datacube.html#cb91-54" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3, <span class="dt">breaks =</span> brks)</span>
<span id="cb91-55"><a href="datacube.html#cb91-55" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">1.5</span>, <span class="fl">.5</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2, <span class="dt">breaks =</span> brks)</span>
<span id="cb91-56"><a href="datacube.html#cb91-56" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1, <span class="dt">breaks =</span> brks)</span>
<span id="cb91-57"><a href="datacube.html#cb91-57" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">m =</span> b1) <span class="co"># print text on left first stack</span></span>
<span id="cb91-58"><a href="datacube.html#cb91-58" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb91-59"><a href="datacube.html#cb91-59" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">23</span>, <span class="dv">2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b3), <span class="dt">breaks =</span> brks)</span>
<span id="cb91-60"><a href="datacube.html#cb91-60" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">21.5</span>, <span class="fl">0.5</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b2), <span class="dt">breaks =</span> brks)</span>
<span id="cb91-61"><a href="datacube.html#cb91-61" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b1), <span class="dt">breaks =</span> brks)</span>
<span id="cb91-62"><a href="datacube.html#cb91-62" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b1)) <span class="co"># set pad = FALSE for -99</span></span>
<span id="cb91-63"><a href="datacube.html#cb91-63" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="dv">22</span>, <span class="dv">3</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb91-64"><a href="datacube.html#cb91-64" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="dv">11</span>, <span class="dv">4</span>, <span class="fl">17.5</span>, <span class="dv">4</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb91-65"><a href="datacube.html#cb91-65" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">3.5</span>, <span class="st">&quot;apply_kernel()&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.4</span>)</span>
<span id="cb91-66"><a href="datacube.html#cb91-66" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">13.8</span>, <span class="dv">1</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb91-67"><a href="datacube.html#cb91-67" aria-hidden="true"></a>cex =<span class="st"> </span><span class="fl">.8</span></span>
<span id="cb91-68"><a href="datacube.html#cb91-68" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb91-69"><a href="datacube.html#cb91-69" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">13.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb91-70"><a href="datacube.html#cb91-70" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">15.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb91-71"><a href="datacube.html#cb91-71" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">2.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb91-72"><a href="datacube.html#cb91-72" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4apply2"></span>
<img src="sds_files/figure-html/cube4apply2-1.png" alt="Low pass filtering of spatial slices" width="960" />
<p class="caption">
Figure 6.5: Low pass filtering of spatial slices
</p>
</div>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="datacube.html#cb92-1" aria-hidden="true"></a>time_arrow_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span>),</span>
<span id="cb92-2"><a href="datacube.html#cb92-2" aria-hidden="true"></a>                           <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb92-3"><a href="datacube.html#cb92-3" aria-hidden="true"></a>time_arrow_flag_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>),</span>
<span id="cb92-4"><a href="datacube.html#cb92-4" aria-hidden="true"></a>                                <span class="kw">c</span>(<span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span>), <span class="kw">c</span>(<span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb92-5"><a href="datacube.html#cb92-5" aria-hidden="true"></a></span>
<span id="cb92-6"><a href="datacube.html#cb92-6" aria-hidden="true"></a>b11 &lt;-<span class="st"> </span>b2 <span class="op">-</span><span class="st"> </span>t1</span>
<span id="cb92-7"><a href="datacube.html#cb92-7" aria-hidden="true"></a>b12 &lt;-<span class="st"> </span>b1 <span class="op">-</span><span class="st"> </span>t2 <span class="op">+</span><span class="st"> </span>t1</span>
<span id="cb92-8"><a href="datacube.html#cb92-8" aria-hidden="true"></a></span>
<span id="cb92-9"><a href="datacube.html#cb92-9" aria-hidden="true"></a><span class="co"># png(&quot;exp_apply_ts.png&quot;, width = 2400, height = 1000, pointsize = 24)</span></span>
<span id="cb92-10"><a href="datacube.html#cb92-10" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb92-11"><a href="datacube.html#cb92-11" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb92-12"><a href="datacube.html#cb92-12" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">30</span></span>
<span id="cb92-13"><a href="datacube.html#cb92-13" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">10</span> <span class="co"># 7.5</span></span>
<span id="cb92-14"><a href="datacube.html#cb92-14" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb92-15"><a href="datacube.html#cb92-15" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">4.8</span>, <span class="fl">3.8</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-16"><a href="datacube.html#cb92-16" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">4.8</span>, <span class="fl">3.8</span>, <span class="dt">m =</span> b3)</span>
<span id="cb92-17"><a href="datacube.html#cb92-17" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">3.6</span>, <span class="fl">2.6</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b11, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-18"><a href="datacube.html#cb92-18" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">3.6</span>, <span class="fl">2.6</span>, <span class="dt">m =</span> b11)</span>
<span id="cb92-19"><a href="datacube.html#cb92-19" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">2.4</span>, <span class="fl">1.4</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b12, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-20"><a href="datacube.html#cb92-20" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">2.4</span>, <span class="fl">1.4</span>, <span class="dt">m =</span> b12)</span>
<span id="cb92-21"><a href="datacube.html#cb92-21" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">1.2</span>, <span class="fl">.2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-22"><a href="datacube.html#cb92-22" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">1.2</span>, <span class="fl">.2</span>, <span class="dt">m =</span> b2)</span>
<span id="cb92-23"><a href="datacube.html#cb92-23" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-24"><a href="datacube.html#cb92-24" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">m =</span> b1) <span class="co"># print text on left first stack</span></span>
<span id="cb92-25"><a href="datacube.html#cb92-25" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">24.8</span>, <span class="fl">3.8</span>, <span class="dt">pal =</span> <span class="kw">alpha</span>(greys, <span class="fl">0.1</span>), <span class="dt">m =</span> <span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">42</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb92-26"><a href="datacube.html#cb92-26" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">23.6</span>, <span class="fl">2.6</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b12 <span class="op">+</span><span class="st"> </span>b11 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-27"><a href="datacube.html#cb92-27" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">23.6</span>, <span class="fl">2.6</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b12 <span class="op">+</span><span class="st"> </span>b11 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb92-28"><a href="datacube.html#cb92-28" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">22.4</span>, <span class="fl">1.4</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b2 <span class="op">+</span><span class="st"> </span>b12 <span class="op">+</span><span class="st"> </span>b11) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-29"><a href="datacube.html#cb92-29" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">22.4</span>, <span class="fl">1.4</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b2 <span class="op">+</span><span class="st"> </span>b12 <span class="op">+</span><span class="st"> </span>b11) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb92-30"><a href="datacube.html#cb92-30" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="fl">21.2</span>, <span class="fl">.2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b12) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</span>
<span id="cb92-31"><a href="datacube.html#cb92-31" aria-hidden="true"></a><span class="kw">print_text</span>(s, <span class="fl">21.2</span>, <span class="fl">.2</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b12) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</span>
<span id="cb92-32"><a href="datacube.html#cb92-32" aria-hidden="true"></a><span class="kw">pl</span>(f, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> <span class="kw">alpha</span>(greys, <span class="fl">0.1</span>), <span class="dt">m =</span> <span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">42</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</span>
<span id="cb92-33"><a href="datacube.html#cb92-33" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">5.7</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>)</span>
<span id="cb92-34"><a href="datacube.html#cb92-34" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="fl">12.5</span>, <span class="dv">9</span>, <span class="dv">20</span>, <span class="dv">9</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb92-35"><a href="datacube.html#cb92-35" aria-hidden="true"></a>cex =<span class="st"> </span><span class="fl">.9</span></span>
<span id="cb92-36"><a href="datacube.html#cb92-36" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">16.3</span>, <span class="fl">8.3</span>, <span class="st">&quot;apply_dimension(dimension = &#39;t&#39;)&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-37"><a href="datacube.html#cb92-37" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">9.7</span>, <span class="fl">1.7</span>, time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>) <span class="co"># draw ma explanation</span></span>
<span id="cb92-38"><a href="datacube.html#cb92-38" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">-0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;496&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-39"><a href="datacube.html#cb92-39" aria-hidden="true"></a><span class="kw">text</span>(.<span class="dv">7</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">.7</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;363&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-40"><a href="datacube.html#cb92-40" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;658&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-41"><a href="datacube.html#cb92-41" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;230&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-42"><a href="datacube.html#cb92-42" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;525&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-43"><a href="datacube.html#cb92-43" aria-hidden="true"></a>t_formula &lt;-<span class="st"> </span><span class="kw">expression</span>(<span class="st">&quot;t&quot;</span>[n]<span class="op">*</span><span class="st">&quot; = (t&quot;</span>[n<span class="dv">-1</span>]<span class="op">*</span><span class="st">&quot; + t&quot;</span>[n]<span class="op">*</span><span class="st">&quot; + t&quot;</span>[n<span class="op">+</span><span class="dv">1</span>]<span class="op">*</span><span class="st">&quot;) / 3&quot;</span>)</span>
<span id="cb92-44"><a href="datacube.html#cb92-44" aria-hidden="true"></a><span class="co"># text(13.8, 3, t_formula, srt = 45, cex = 1.2)</span></span>
<span id="cb92-45"><a href="datacube.html#cb92-45" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">14.4</span>, <span class="fl">3.6</span>, <span class="st">&quot;calculate moving average&quot;</span>, <span class="dt">srt =</span> <span class="dv">45</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-46"><a href="datacube.html#cb92-46" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="dv">15</span>, <span class="fl">5.7</span>, <span class="dv">18</span>, <span class="fl">5.7</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb92-47"><a href="datacube.html#cb92-47" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">15.4</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>) <span class="co"># draw ma explanation</span></span>
<span id="cb92-48"><a href="datacube.html#cb92-48" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">-0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;NA&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-49"><a href="datacube.html#cb92-49" aria-hidden="true"></a><span class="kw">text</span>(.<span class="dv">7</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">.7</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;505&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-50"><a href="datacube.html#cb92-50" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;417&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-51"><a href="datacube.html#cb92-51" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;471&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-52"><a href="datacube.html#cb92-52" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;NA&quot;</span>, <span class="dt">cex =</span> cex)</span>
<span id="cb92-53"><a href="datacube.html#cb92-53" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">25.7</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4apply1"></span>
<img src="sds_files/figure-html/cube4apply1-1.png" alt="Low pass filtering of time series" width="960" />
<p class="caption">
Figure 6.6: Low pass filtering of time series
</p>
</div>
</div>
<div id="reducedimension" class="section level3" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Reducing dimensions</h3>
<p>When applying function <code>mean</code> to an entire data cube, all dimensions
vanish: the resulting “data cube” has dimensionality zero. We
can also apply functions to a limited set of dimensions such that
selected dimensions vanish, or are <em>reduced</em>. We already saw that
filtering is a special case of this, but more in general we could
for instance compute the maximum of every time series, the mean over
every spatial slice, or a band index such as NDVI that summarizes
different spectral values into a single new “band” with the index
value. Figure <a href="datacube.html#fig:cube4reduce">6.7</a> illustrates these options.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="datacube.html#cb93-1" aria-hidden="true"></a><span class="co"># reduce ----</span></span>
<span id="cb93-2"><a href="datacube.html#cb93-2" aria-hidden="true"></a></span>
<span id="cb93-3"><a href="datacube.html#cb93-3" aria-hidden="true"></a><span class="co"># calc mean over time</span></span>
<span id="cb93-4"><a href="datacube.html#cb93-4" aria-hidden="true"></a>timeB &lt;-<span class="st"> </span>(b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb93-5"><a href="datacube.html#cb93-5" aria-hidden="true"></a>timeG &lt;-<span class="st"> </span>(g1 <span class="op">+</span><span class="st"> </span>g2 <span class="op">+</span><span class="st"> </span>g3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb93-6"><a href="datacube.html#cb93-6" aria-hidden="true"></a>timeR &lt;-<span class="st"> </span>(r1 <span class="op">+</span><span class="st"> </span>r2 <span class="op">+</span><span class="st"> </span>r3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb93-7"><a href="datacube.html#cb93-7" aria-hidden="true"></a>timeN &lt;-<span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>n2 <span class="op">+</span><span class="st"> </span>n3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb93-8"><a href="datacube.html#cb93-8" aria-hidden="true"></a></span>
<span id="cb93-9"><a href="datacube.html#cb93-9" aria-hidden="true"></a>print_grid_time &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) { <span class="co"># 3x1, 28x7</span></span>
<span id="cb93-10"><a href="datacube.html#cb93-10" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> timeB)</span>
<span id="cb93-11"><a href="datacube.html#cb93-11" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> timeG)</span>
<span id="cb93-12"><a href="datacube.html#cb93-12" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> timeR)</span>
<span id="cb93-13"><a href="datacube.html#cb93-13" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> timeN)</span>
<span id="cb93-14"><a href="datacube.html#cb93-14" aria-hidden="true"></a>}</span>
<span id="cb93-15"><a href="datacube.html#cb93-15" aria-hidden="true"></a></span>
<span id="cb93-16"><a href="datacube.html#cb93-16" aria-hidden="true"></a><span class="co"># calc ndvi</span></span>
<span id="cb93-17"><a href="datacube.html#cb93-17" aria-hidden="true"></a>ndvi1 &lt;-<span class="st"> </span>(n1 <span class="op">-</span><span class="st"> </span>r1) <span class="op">/</span><span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>r1)</span>
<span id="cb93-18"><a href="datacube.html#cb93-18" aria-hidden="true"></a>ndvi2 &lt;-<span class="st"> </span>(n2 <span class="op">-</span><span class="st"> </span>r2) <span class="op">/</span><span class="st"> </span>(n2 <span class="op">+</span><span class="st"> </span>r2)</span>
<span id="cb93-19"><a href="datacube.html#cb93-19" aria-hidden="true"></a>ndvi3 &lt;-<span class="st"> </span>(n3 <span class="op">-</span><span class="st"> </span>r3) <span class="op">/</span><span class="st"> </span>(n3 <span class="op">+</span><span class="st"> </span>r3)</span>
<span id="cb93-20"><a href="datacube.html#cb93-20" aria-hidden="true"></a></span>
<span id="cb93-21"><a href="datacube.html#cb93-21" aria-hidden="true"></a>print_grid_bands &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">pal =</span> greys) { <span class="co"># 1x3 6x27</span></span>
<span id="cb93-22"><a href="datacube.html#cb93-22" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi1)</span>
<span id="cb93-23"><a href="datacube.html#cb93-23" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi2)</span>
<span id="cb93-24"><a href="datacube.html#cb93-24" aria-hidden="true"></a>  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi3)</span>
<span id="cb93-25"><a href="datacube.html#cb93-25" aria-hidden="true"></a>}</span>
<span id="cb93-26"><a href="datacube.html#cb93-26" aria-hidden="true"></a></span>
<span id="cb93-27"><a href="datacube.html#cb93-27" aria-hidden="true"></a>plte =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>, pal, m) {</span>
<span id="cb93-28"><a href="datacube.html#cb93-28" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb93-29"><a href="datacube.html#cb93-29" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb93-30"><a href="datacube.html#cb93-30" aria-hidden="true"></a>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb93-31"><a href="datacube.html#cb93-31" aria-hidden="true"></a>  <span class="co"># dim(m) = c(x = nrow, y = ncol) # named dim</span></span>
<span id="cb93-32"><a href="datacube.html#cb93-32" aria-hidden="true"></a>  <span class="co"># s[[1]] = m</span></span>
<span id="cb93-33"><a href="datacube.html#cb93-33" aria-hidden="true"></a>  <span class="co"># me &lt;- floor(mean(s[[1]]))</span></span>
<span id="cb93-34"><a href="datacube.html#cb93-34" aria-hidden="true"></a>  me &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">mean</span>(m))</span>
<span id="cb93-35"><a href="datacube.html#cb93-35" aria-hidden="true"></a>  <span class="cf">if</span> (me[<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>) { <span class="co"># in case non-artificial grids with very high</span></span>
<span id="cb93-36"><a href="datacube.html#cb93-36" aria-hidden="true"></a>    me &lt;-<span class="st"> </span>m <span class="op">/</span><span class="st"> </span><span class="dv">10</span>     <span class="co"># numbers are used, make them smaller</span></span>
<span id="cb93-37"><a href="datacube.html#cb93-37" aria-hidden="true"></a>    me &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">mean</span>(me))</span>
<span id="cb93-38"><a href="datacube.html#cb93-38" aria-hidden="true"></a>  }</span>
<span id="cb93-39"><a href="datacube.html#cb93-39" aria-hidden="true"></a>  <span class="kw">text</span>(x,y,me,<span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb93-40"><a href="datacube.html#cb93-40" aria-hidden="true"></a>}</span>
<span id="cb93-41"><a href="datacube.html#cb93-41" aria-hidden="true"></a></span>
<span id="cb93-42"><a href="datacube.html#cb93-42" aria-hidden="true"></a>print_grid_spat &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb93-43"><a href="datacube.html#cb93-43" aria-hidden="true"></a>  x =<span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb93-44"><a href="datacube.html#cb93-44" aria-hidden="true"></a>  y =<span class="st"> </span>y <span class="op">+</span><span class="st"> </span><span class="fl">3.5</span></span>
<span id="cb93-45"><a href="datacube.html#cb93-45" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</span>
<span id="cb93-46"><a href="datacube.html#cb93-46" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</span>
<span id="cb93-47"><a href="datacube.html#cb93-47" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</span>
<span id="cb93-48"><a href="datacube.html#cb93-48" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</span>
<span id="cb93-49"><a href="datacube.html#cb93-49" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</span>
<span id="cb93-50"><a href="datacube.html#cb93-50" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</span>
<span id="cb93-51"><a href="datacube.html#cb93-51" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</span>
<span id="cb93-52"><a href="datacube.html#cb93-52" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</span>
<span id="cb93-53"><a href="datacube.html#cb93-53" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</span>
<span id="cb93-54"><a href="datacube.html#cb93-54" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</span>
<span id="cb93-55"><a href="datacube.html#cb93-55" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</span>
<span id="cb93-56"><a href="datacube.html#cb93-56" aria-hidden="true"></a>  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</span>
<span id="cb93-57"><a href="datacube.html#cb93-57" aria-hidden="true"></a>}</span>
<span id="cb93-58"><a href="datacube.html#cb93-58" aria-hidden="true"></a></span>
<span id="cb93-59"><a href="datacube.html#cb93-59" aria-hidden="true"></a><span class="co"># png(&quot;exp_reduce.png&quot;, width = 1200, height = 1000, pointsize = 32)</span></span>
<span id="cb93-60"><a href="datacube.html#cb93-60" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb93-61"><a href="datacube.html#cb93-61" aria-hidden="true"></a><span class="co">#par(mar = c(3,3,3,3))</span></span>
<span id="cb93-62"><a href="datacube.html#cb93-62" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb93-63"><a href="datacube.html#cb93-63" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">120</span></span>
<span id="cb93-64"><a href="datacube.html#cb93-64" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb93-65"><a href="datacube.html#cb93-65" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb93-66"><a href="datacube.html#cb93-66" aria-hidden="true"></a><span class="kw">print_grid</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-27</span>)</span>
<span id="cb93-67"><a href="datacube.html#cb93-67" aria-hidden="true"></a><span class="co"># print_alpha_grid((x/3-28)/2, 0) # alpha grid</span></span>
<span id="cb93-68"><a href="datacube.html#cb93-68" aria-hidden="true"></a><span class="kw">print_grid_time</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>) <span class="co"># off = 5.5</span></span>
<span id="cb93-69"><a href="datacube.html#cb93-69" aria-hidden="true"></a><span class="co"># print_alpha_grid(x/3+((x/3-6)/2) -10.5, 0) # alpha grid</span></span>
<span id="cb93-70"><a href="datacube.html#cb93-70" aria-hidden="true"></a><span class="kw">print_grid_bands</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3-6</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>)</span>
<span id="cb93-71"><a href="datacube.html#cb93-71" aria-hidden="true"></a><span class="kw">print_alpha_grid</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dt">alp =</span> <span class="dv">0</span>, <span class="dt">geom =</span> <span class="ot">TRUE</span>) <span class="co"># alpha grid</span></span>
<span id="cb93-72"><a href="datacube.html#cb93-72" aria-hidden="true"></a><span class="kw">print_grid_spat</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>)</span>
<span id="cb93-73"><a href="datacube.html#cb93-73" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-74"><a href="datacube.html#cb93-74" aria-hidden="true"></a><span class="co">#segments(3.6, 8, 3.7, 19, col = &quot;red&quot;, lwd=3)</span></span>
<span id="cb93-75"><a href="datacube.html#cb93-75" aria-hidden="true"></a><span class="kw">segments</span>(<span class="fl">3.4</span>, <span class="dv">8</span>, <span class="fl">3.4</span>, <span class="dv">19</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb93-76"><a href="datacube.html#cb93-76" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">43</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-77"><a href="datacube.html#cb93-77" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">83</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-78"><a href="datacube.html#cb93-78" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">20</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-79"><a href="datacube.html#cb93-79" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-80"><a href="datacube.html#cb93-80" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">53</span>,<span class="fl">29.8</span>, <span class="dv">67</span>,<span class="fl">29.8</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb93-81"><a href="datacube.html#cb93-81" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">100</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-82"><a href="datacube.html#cb93-82" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">30</span>, <span class="dv">7</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-83"><a href="datacube.html#cb93-83" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">36</span>, <span class="dv">13</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-84"><a href="datacube.html#cb93-84" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">-3</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-85"><a href="datacube.html#cb93-85" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">66</span>, <span class="dv">3</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-86"><a href="datacube.html#cb93-86" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">110</span>, <span class="dv">-3</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-87"><a href="datacube.html#cb93-87" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">116</span>, <span class="dv">3</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-88"><a href="datacube.html#cb93-88" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">108</span>,<span class="op">-</span><span class="fl">2.4</span>, <span class="dv">112</span>,<span class="op">-</span><span class="fl">3.2</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb93-89"><a href="datacube.html#cb93-89" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">114</span>,<span class="fl">3.2</span>, <span class="dv">118</span>,<span class="fl">2.4</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</span>
<span id="cb93-90"><a href="datacube.html#cb93-90" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">60</span>, y<span class="op">+</span><span class="dv">4</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># dim names on main</span></span>
<span id="cb93-91"><a href="datacube.html#cb93-91" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">43</span>, y<span class="dv">-14</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-92"><a href="datacube.html#cb93-92" aria-hidden="true"></a><span class="kw">text</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span>, y<span class="dv">-30</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-93"><a href="datacube.html#cb93-93" aria-hidden="true"></a><span class="kw">text</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">30</span>, y<span class="dv">-24</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb93-94"><a href="datacube.html#cb93-94" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">6</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb93-95"><a href="datacube.html#cb93-95" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">2</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb93-96"><a href="datacube.html#cb93-96" aria-hidden="true"></a><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, <span class="dv">100</span>, <span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb93-97"><a href="datacube.html#cb93-97" aria-hidden="true"></a><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></span>
<span id="cb93-98"><a href="datacube.html#cb93-98" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">28.5</span>,<span class="dv">49</span>, <span class="st">&quot;reduce temporally&quot;</span>, <span class="dt">srt =</span> <span class="fl">55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb93-99"><a href="datacube.html#cb93-99" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>,<span class="dv">49</span>, <span class="st">&quot;reduce bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb93-100"><a href="datacube.html#cb93-100" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">91.5</span>,<span class="dv">49</span>, <span class="st">&quot;reduce spatially&quot;</span>, <span class="dt">srt =</span> <span class="fl">-55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4reduce"></span>
<img src="sds_files/figure-html/cube4reduce-1.png" alt="Reducing data cube dimensions" width="960" />
<p class="caption">
Figure 6.7: Reducing data cube dimensions
</p>
</div>
</div>
</div>
<div id="vectordatacubes" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> Aggregating raster to vector cubes</h2>
<p>Figure <a href="datacube.html#fig:cube4agg">6.8</a> illustrates how a four-dimensional raster
data cube can be aggregated to a three-dimensional <em>vector data
cube</em>. Pixels in the raster are grouped by spatial intersection
with a set of vector geometries, and each group is then reduced
to a single value by an aggregation function such as <code>mean</code> or
<code>max</code>. In the example, the <em>two</em> spatial dimensions <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>
reduce to a single dimension, the one-dimensional sequence of feature
geometries, with geometries that are defined in the space of <span class="math inline">\(x\)</span>
and <span class="math inline">\(y\)</span>. Grouping geometries can also be <code>POINT</code> geometries, in
which case the aggregation function is obsolete as single values
at the <code>POINT</code> locations are <em>extracted</em>, e.g. by querying a pixels
value or by interpolating from the nearest pixels.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="datacube.html#cb94-1" aria-hidden="true"></a><span class="co"># aggregate ----</span></span>
<span id="cb94-2"><a href="datacube.html#cb94-2" aria-hidden="true"></a></span>
<span id="cb94-3"><a href="datacube.html#cb94-3" aria-hidden="true"></a>mask_agg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb94-4"><a href="datacube.html#cb94-4" aria-hidden="true"></a>                 <span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</span>
<span id="cb94-5"><a href="datacube.html#cb94-5" aria-hidden="true"></a>                  <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb94-6"><a href="datacube.html#cb94-6" aria-hidden="true"></a>                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb94-7"><a href="datacube.html#cb94-7" aria-hidden="true"></a>                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb94-8"><a href="datacube.html#cb94-8" aria-hidden="true"></a>                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</span>
<span id="cb94-9"><a href="datacube.html#cb94-9" aria-hidden="true"></a>                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb94-10"><a href="datacube.html#cb94-10" aria-hidden="true"></a></span>
<span id="cb94-11"><a href="datacube.html#cb94-11" aria-hidden="true"></a>pl_stack_agg =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, nrM, <span class="dt">imgY =</span> <span class="dv">7</span>, <span class="dt">inner =</span> <span class="dv">1</span>) {</span>
<span id="cb94-12"><a href="datacube.html#cb94-12" aria-hidden="true"></a>  <span class="co"># pl_stack that masks the added matrices</span></span>
<span id="cb94-13"><a href="datacube.html#cb94-13" aria-hidden="true"></a>  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></span>
<span id="cb94-14"><a href="datacube.html#cb94-14" aria-hidden="true"></a>  <span class="co"># prints all 4 bands at once</span></span>
<span id="cb94-15"><a href="datacube.html#cb94-15" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb94-16"><a href="datacube.html#cb94-16" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb94-17"><a href="datacube.html#cb94-17" aria-hidden="true"></a>  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></span>
<span id="cb94-18"><a href="datacube.html#cb94-18" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, nrM)))</span>
<span id="cb94-19"><a href="datacube.html#cb94-19" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb94-20"><a href="datacube.html#cb94-20" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)] <span class="co"># turn around to have same orientation as flat plot</span></span>
<span id="cb94-21"><a href="datacube.html#cb94-21" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> purples)</span>
<span id="cb94-22"><a href="datacube.html#cb94-22" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, nrM)))</span>
<span id="cb94-23"><a href="datacube.html#cb94-23" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb94-24"><a href="datacube.html#cb94-24" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb94-25"><a href="datacube.html#cb94-25" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> reds)</span>
<span id="cb94-26"><a href="datacube.html#cb94-26" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;g&quot;</span>, nrM)))</span>
<span id="cb94-27"><a href="datacube.html#cb94-27" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb94-28"><a href="datacube.html#cb94-28" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb94-29"><a href="datacube.html#cb94-29" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> greens)</span>
<span id="cb94-30"><a href="datacube.html#cb94-30" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;b&quot;</span>, nrM)))</span>
<span id="cb94-31"><a href="datacube.html#cb94-31" aria-hidden="true"></a>  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</span>
<span id="cb94-32"><a href="datacube.html#cb94-32" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</span>
<span id="cb94-33"><a href="datacube.html#cb94-33" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span><span class="op">*</span>inner, <span class="ot">TRUE</span>, <span class="dt">pal =</span> blues) <span class="co"># li FALSE</span></span>
<span id="cb94-34"><a href="datacube.html#cb94-34" aria-hidden="true"></a>}</span>
<span id="cb94-35"><a href="datacube.html#cb94-35" aria-hidden="true"></a></span>
<span id="cb94-36"><a href="datacube.html#cb94-36" aria-hidden="true"></a>polygon_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>), <span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>),</span>
<span id="cb94-37"><a href="datacube.html#cb94-37" aria-hidden="true"></a>                      <span class="kw">c</span>(<span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>, <span class="fl">0.0</span>), <span class="kw">c</span>(<span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>, <span class="fl">0.0</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb94-38"><a href="datacube.html#cb94-38" aria-hidden="true"></a></span>
<span id="cb94-39"><a href="datacube.html#cb94-39" aria-hidden="true"></a>a &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>, <span class="fl">-1.14</span>, <span class="fl">-2.28</span>)</span>
<span id="cb94-40"><a href="datacube.html#cb94-40" aria-hidden="true"></a></span>
<span id="cb94-41"><a href="datacube.html#cb94-41" aria-hidden="true"></a>print_vector_content &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">cex =</span> <span class="fl">0.8</span>) {</span>
<span id="cb94-42"><a href="datacube.html#cb94-42" aria-hidden="true"></a>  vec &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">rnorm</span>(<span class="dv">8</span>, <span class="dv">250</span>, <span class="dv">100</span>))</span>
<span id="cb94-43"><a href="datacube.html#cb94-43" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x,<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">1</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-44"><a href="datacube.html#cb94-44" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">8</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">2</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-45"><a href="datacube.html#cb94-45" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">4</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">3</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-46"><a href="datacube.html#cb94-46" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">4</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-47"><a href="datacube.html#cb94-47" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x,<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">5</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-48"><a href="datacube.html#cb94-48" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">8</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">6</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-49"><a href="datacube.html#cb94-49" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">4</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">7</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-50"><a href="datacube.html#cb94-50" aria-hidden="true"></a>  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">8</span>], <span class="dt">cex =</span> cex)</span>
<span id="cb94-51"><a href="datacube.html#cb94-51" aria-hidden="true"></a>}</span>
<span id="cb94-52"><a href="datacube.html#cb94-52" aria-hidden="true"></a></span>
<span id="cb94-53"><a href="datacube.html#cb94-53" aria-hidden="true"></a>print_ts &lt;-<span class="st"> </span><span class="cf">function</span>(off2, yoff2) {</span>
<span id="cb94-54"><a href="datacube.html#cb94-54" aria-hidden="true"></a>  <span class="kw">pl_stack</span>(s, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">3</span>) <span class="co"># input 2</span></span>
<span id="cb94-55"><a href="datacube.html#cb94-55" aria-hidden="true"></a>  <span class="kw">pl_stack</span>(s, off <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">2</span>)</span>
<span id="cb94-56"><a href="datacube.html#cb94-56" aria-hidden="true"></a>  <span class="kw">pl_stack</span>(s, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">1</span>)</span>
<span id="cb94-57"><a href="datacube.html#cb94-57" aria-hidden="true"></a>  <span class="kw">arrows</span>(<span class="op">-</span><span class="dv">13</span> <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span> <span class="op">+</span><span class="st"> </span>yoff2, <span class="dv">72</span> <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span> <span class="op">+</span><span class="st"> </span>yoff2, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)  <span class="co"># timeline</span></span>
<span id="cb94-58"><a href="datacube.html#cb94-58" aria-hidden="true"></a>  heads &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">3.5</span><span class="op">+</span>off2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2,<span class="dv">14</span><span class="op">+</span>yoff2,<span class="dv">14</span><span class="op">+</span>yoff2), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb94-59"><a href="datacube.html#cb94-59" aria-hidden="true"></a>  <span class="kw">points</span>(heads, <span class="dt">pch =</span> <span class="dv">16</span>) <span class="co"># 4 or 16</span></span>
<span id="cb94-60"><a href="datacube.html#cb94-60" aria-hidden="true"></a>  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>)<span class="op">+</span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span><span class="op">+</span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># first stack pyramid</span></span>
<span id="cb94-61"><a href="datacube.html#cb94-61" aria-hidden="true"></a>  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># second stack pyramid</span></span>
<span id="cb94-62"><a href="datacube.html#cb94-62" aria-hidden="true"></a>  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># third stack pyramid</span></span>
<span id="cb94-63"><a href="datacube.html#cb94-63" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">7.5</span><span class="op">+</span>off2, <span class="fl">4.3</span><span class="op">+</span>yoff2, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</span>
<span id="cb94-64"><a href="datacube.html#cb94-64" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="op">-</span><span class="fl">9.5</span><span class="op">+</span>off2, <span class="fl">-2.5</span><span class="op">+</span>yoff2, <span class="st">&quot;bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</span>
<span id="cb94-65"><a href="datacube.html#cb94-65" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="op">-</span><span class="fl">4.5</span><span class="op">+</span>off2, <span class="dv">2</span><span class="op">+</span>yoff2, <span class="st">&quot;y&quot;</span>, <span class="dt">srt =</span> <span class="fl">27.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</span>
<span id="cb94-66"><a href="datacube.html#cb94-66" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="dv">69</span><span class="op">+</span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2<span class="op">+</span><span class="dv">1</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb94-67"><a href="datacube.html#cb94-67" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">3.5</span><span class="op">+</span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb94-68"><a href="datacube.html#cb94-68" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb94-69"><a href="datacube.html#cb94-69" aria-hidden="true"></a>  <span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb94-70"><a href="datacube.html#cb94-70" aria-hidden="true"></a>}</span>
<span id="cb94-71"><a href="datacube.html#cb94-71" aria-hidden="true"></a></span>
<span id="cb94-72"><a href="datacube.html#cb94-72" aria-hidden="true"></a>secText =<span class="st"> </span><span class="fl">0.8</span> <span class="co"># secondary text size (dimension naming)</span></span>
<span id="cb94-73"><a href="datacube.html#cb94-73" aria-hidden="true"></a>off =<span class="st"> </span><span class="dv">26</span> <span class="co"># image stacks are always 26 apart</span></span>
<span id="cb94-74"><a href="datacube.html#cb94-74" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">72</span> <span class="co"># png X</span></span>
<span id="cb94-75"><a href="datacube.html#cb94-75" aria-hidden="true"></a>y =<span class="st"> </span><span class="dv">48</span> <span class="co"># png Y</span></span>
<span id="cb94-76"><a href="datacube.html#cb94-76" aria-hidden="true"></a>yoff =<span class="st"> </span><span class="dv">30</span></span>
<span id="cb94-77"><a href="datacube.html#cb94-77" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb94-78"><a href="datacube.html#cb94-78" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb94-79"><a href="datacube.html#cb94-79" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb94-80"><a href="datacube.html#cb94-80" aria-hidden="true"></a><span class="kw">print_ts</span>(<span class="dv">5</span>, yoff)</span>
<span id="cb94-81"><a href="datacube.html#cb94-81" aria-hidden="true"></a>col =<span class="st"> &#39;#ff5555&#39;</span></span>
<span id="cb94-82"><a href="datacube.html#cb94-82" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">10.57</span>, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-83"><a href="datacube.html#cb94-83" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb94-84"><a href="datacube.html#cb94-84" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-85"><a href="datacube.html#cb94-85" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">10.57</span><span class="op">+</span>off, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-86"><a href="datacube.html#cb94-86" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span>off</span>
<span id="cb94-87"><a href="datacube.html#cb94-87" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-88"><a href="datacube.html#cb94-88" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">10.57</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>off, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-89"><a href="datacube.html#cb94-89" aria-hidden="true"></a>x =<span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>off</span>
<span id="cb94-90"><a href="datacube.html#cb94-90" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-91"><a href="datacube.html#cb94-91" aria-hidden="true"></a><span class="co"># old 75 28 poly 86.25, 27.15</span></span>
<span id="cb94-92"><a href="datacube.html#cb94-92" aria-hidden="true"></a><span class="kw">pl_stack_agg</span>(a, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">nrM =</span> <span class="dv">1</span>, <span class="dt">inner =</span> <span class="dv">3</span>) <span class="co"># print masked enlargement</span></span>
<span id="cb94-93"><a href="datacube.html#cb94-93" aria-hidden="true"></a><span class="kw">print_segments</span>(<span class="fl">16.25</span>, <span class="fl">7.15</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">by =</span> <span class="dv">2</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-94"><a href="datacube.html#cb94-94" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb94-95"><a href="datacube.html#cb94-95" aria-hidden="true"></a>y &lt;-<span class="st"> </span><span class="dv">8</span></span>
<span id="cb94-96"><a href="datacube.html#cb94-96" aria-hidden="true"></a><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="fl">-2.6</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">2</span>)<span class="op">+</span>y, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-2.6</span>, <span class="dv">2</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>)<span class="op">+</span>y, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col) <span class="co"># line in large</span></span>
<span id="cb94-97"><a href="datacube.html#cb94-97" aria-hidden="true"></a><span class="kw">segments</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">25</span>, <span class="dv">-7</span>, <span class="dv">9</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb94-98"><a href="datacube.html#cb94-98" aria-hidden="true"></a><span class="kw">segments</span>(<span class="dv">21</span>, <span class="dv">29</span>, <span class="fl">27.5</span>, <span class="dv">14</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span>
<span id="cb94-99"><a href="datacube.html#cb94-99" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="st">&quot;1. Group by geometry&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</span>
<span id="cb94-100"><a href="datacube.html#cb94-100" aria-hidden="true"></a>vecM &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">8</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb94-101"><a href="datacube.html#cb94-101" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>, <span class="dv">21</span>, <span class="st">&quot;2. Reduce to vector cube&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</span>
<span id="cb94-102"><a href="datacube.html#cb94-102" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">4</span>, <span class="dv">0</span>)</span>
<span id="cb94-103"><a href="datacube.html#cb94-103" aria-hidden="true"></a><span class="kw">pl</span>(b, <span class="dv">48</span>, <span class="dv">-5</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</span>
<span id="cb94-104"><a href="datacube.html#cb94-104" aria-hidden="true"></a><span class="kw">print_vector_content</span>(<span class="dv">54</span>, <span class="dv">-3</span>)</span>
<span id="cb94-105"><a href="datacube.html#cb94-105" aria-hidden="true"></a><span class="kw">pl</span>(b, <span class="fl">46.5</span>, <span class="fl">-3.5</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</span>
<span id="cb94-106"><a href="datacube.html#cb94-106" aria-hidden="true"></a><span class="kw">print_vector_content</span>(<span class="fl">52.5</span>, <span class="fl">-1.5</span>)</span>
<span id="cb94-107"><a href="datacube.html#cb94-107" aria-hidden="true"></a><span class="kw">pl</span>(b, <span class="dv">45</span>, <span class="dv">-2</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</span>
<span id="cb94-108"><a href="datacube.html#cb94-108" aria-hidden="true"></a><span class="kw">print_vector_content</span>(<span class="dv">51</span>, <span class="dv">0</span>)</span>
<span id="cb94-109"><a href="datacube.html#cb94-109" aria-hidden="true"></a><span class="kw">text</span>(<span class="fl">51.5</span>, <span class="dv">15</span>, <span class="st">&quot;Line_1&quot;</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-110"><a href="datacube.html#cb94-110" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">63</span>, <span class="dv">15</span>, <span class="st">&quot;Polygon_1&quot;</span>, <span class="dt">col =</span> col)</span>
<span id="cb94-111"><a href="datacube.html#cb94-111" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">57</span>, <span class="fl">17.5</span>, <span class="st">&quot;Geometries&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb94-112"><a href="datacube.html#cb94-112" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>, <span class="dv">12</span>, <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb94-113"><a href="datacube.html#cb94-113" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">8</span>, <span class="st">&quot;green&quot;</span>)</span>
<span id="cb94-114"><a href="datacube.html#cb94-114" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">4</span>, <span class="st">&quot;red&quot;</span>)</span>
<span id="cb94-115"><a href="datacube.html#cb94-115" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">0</span>, <span class="st">&quot;nir&quot;</span>)</span>
<span id="cb94-116"><a href="datacube.html#cb94-116" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">38</span>, <span class="dv">6</span>, <span class="st">&quot;Bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb94-117"><a href="datacube.html#cb94-117" aria-hidden="true"></a><span class="co"># arrows(13.5, -2, 13.5, -6, angle = 20, lwd = 3)</span></span>
<span id="cb94-118"><a href="datacube.html#cb94-118" aria-hidden="true"></a><span class="kw">text</span>(<span class="dv">72</span>, <span class="fl">15.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">315</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</span>
<span id="cb94-119"><a href="datacube.html#cb94-119" aria-hidden="true"></a><span class="kw">arrows</span>(<span class="fl">69.5</span>, <span class="dv">15</span>, <span class="fl">72.5</span>, <span class="dv">12</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cube4agg"></span>
<img src="sds_files/figure-html/cube4agg-1.png" alt="Aggregating a raster data cube to a vector data cube" width="960" />
<p class="caption">
Figure 6.8: Aggregating a raster data cube to a vector data cube
</p>
</div>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="datacube.html#cb95-1" aria-hidden="true"></a><span class="co"># print_segments(30, 35, seg = arrow_seg)</span></span></code></pre></div>
<p>Further examples of vector data cubes include air quality data,
where we could have <span class="math inline">\(PM_{10}\)</span> measurements over two dimensions:</p>
<ul>
<li>a sequence of monitoring stations, and</li>
<li>a sequence of time intervals</li>
</ul>
<p>or where we consider time series of demographic or epidemiological
data, consisting of (population, disease) counts, with number
of persons</p>
<ul>
<li>by region, for a sequence of <span class="math inline">\(n\)</span> regions</li>
<li>by age class, for <span class="math inline">\(m\)</span> age classes, and</li>
<li>by year, for <span class="math inline">\(p\)</span> years.</li>
</ul>
<p>which forms an array with <span class="math inline">\(n m p\)</span> elements.</p>
<p>For spatial data science, support of vector and raster data cubes
is extremely useful, because many variables are both spatially
and temporaly varying, and because we often want to either change
dimensions or aggregate them out, but in a fully flexible manner
and order. Examples of changing dimensions are</p>
<ul>
<li>interpolating air quality measurements to values on a regular grid (raster; chapter <a href="interpolation.html#interpolation">12</a>)</li>
<li>estimating density maps from points or lines, e.g. with the number of flights passing by per week within a range of 1 km (chapter <a href="pointpatterns.html#pointpatterns">11</a>)</li>
<li>aggregating climate model predictions to summary indicators for administrative regions</li>
<li>combining Earth observation data from different sensors, e.g. Modis (250 m pixels, every 16 days) with Sentinel-2 (10 m, every 5 days).</li>
</ul>
<p>Examples of aggregating one ore more full dimensions are assessments of</p>
<ul>
<li>which air quality monitoring stations indicate unhealthy conditions (time),</li>
<li>which region has the highest increase in disease incidence (space, time),</li>
<li>global warming (e.g. in degrees per year).</li>
</ul>
</div>
<div id="switching" class="section level2" number="6.5">
<h2><span class="header-section-number">6.5</span> Switching dimension with attributes</h2>
<p>When we accept that a dimension can also reflect an unordered,
categorical variable, then one can easily swap a set of attributes
for a single dimension, by replacing</p>
<p><span class="math display">\[\{Z_1,Z_2,...,Z_p\} = f(D_1,D_2,...,D_n)\]</span></p>
<p>with</p>
<p><span class="math display">\[Z = f(D_1,D_2,...,D_n, D_{n+1})\]</span></p>
<p>where <span class="math inline">\(D_{n+1}\)</span> has cardinality <span class="math inline">\(p\)</span> and has as labels (the names
of) <span class="math inline">\(Z_1,Z_2,...,Z_p\)</span>. Figure <a href="datacube.html#fig:aqdc">6.9</a> shows a vector data
cube for air quality stations where one cube dimension reflects
air quality parameters. When the <span class="math inline">\(Z_i\)</span> have incompatible measurement
units, as in figure <a href="datacube.html#fig:aqdc">6.9</a>, one would have to take care
when reducing the “parameter” dimension <span class="math inline">\(D_{n+1}\)</span>: numeric functions
like <code>mean</code> or <code>max</code> would be meaningless. Counting the number of
variables that exceed their respective threshold values may however
be meaningful.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="datacube.html#cb96-1" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1331</span>)</span>
<span id="cb96-2"><a href="datacube.html#cb96-2" aria-hidden="true"></a><span class="kw">library</span>(stars)</span>
<span id="cb96-3"><a href="datacube.html#cb96-3" aria-hidden="true"></a><span class="kw">library</span>(colorspace)</span>
<span id="cb96-4"><a href="datacube.html#cb96-4" aria-hidden="true"></a>tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</span>
<span id="cb96-5"><a href="datacube.html#cb96-5" aria-hidden="true"></a>r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</span>
<span id="cb96-6"><a href="datacube.html#cb96-6" aria-hidden="true"></a></span>
<span id="cb96-7"><a href="datacube.html#cb96-7" aria-hidden="true"></a>nrow =<span class="st"> </span><span class="dv">5</span></span>
<span id="cb96-8"><a href="datacube.html#cb96-8" aria-hidden="true"></a>ncol =<span class="st"> </span><span class="dv">8</span></span>
<span id="cb96-9"><a href="datacube.html#cb96-9" aria-hidden="true"></a><span class="co">#m = matrix(runif(nrow * ncol), nrow = nrow, ncol = ncol)</span></span>
<span id="cb96-10"><a href="datacube.html#cb96-10" aria-hidden="true"></a>m =<span class="st"> </span>r[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>nrow,<span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb96-11"><a href="datacube.html#cb96-11" aria-hidden="true"></a><span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb96-12"><a href="datacube.html#cb96-12" aria-hidden="true"></a>s =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</span>
<span id="cb96-13"><a href="datacube.html#cb96-13" aria-hidden="true"></a><span class="co"># s</span></span>
<span id="cb96-14"><a href="datacube.html#cb96-14" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="dv">3</span> </span>
<span id="cb96-15"><a href="datacube.html#cb96-15" aria-hidden="true"></a><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="fl">-.5</span></span>
<span id="cb96-16"><a href="datacube.html#cb96-16" aria-hidden="true"></a><span class="kw">attr</span>(<span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span>)</span>
<span id="cb96-17"><a href="datacube.html#cb96-17" aria-hidden="true"></a></span>
<span id="cb96-18"><a href="datacube.html#cb96-18" aria-hidden="true"></a>plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb96-19"><a href="datacube.html#cb96-19" aria-hidden="true"></a>    <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset </span>
<span id="cb96-20"><a href="datacube.html#cb96-20" aria-hidden="true"></a>    l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</span>
<span id="cb96-21"><a href="datacube.html#cb96-21" aria-hidden="true"></a>    pal =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>)</span>
<span id="cb96-22"><a href="datacube.html#cb96-22" aria-hidden="true"></a>    <span class="cf">if</span> (li)</span>
<span id="cb96-23"><a href="datacube.html#cb96-23" aria-hidden="true"></a>        pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb96-24"><a href="datacube.html#cb96-24" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</span>
<span id="cb96-25"><a href="datacube.html#cb96-25" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</span>
<span id="cb96-26"><a href="datacube.html#cb96-26" aria-hidden="true"></a>    <span class="cf">else</span></span>
<span id="cb96-27"><a href="datacube.html#cb96-27" aria-hidden="true"></a>        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>))</span>
<span id="cb96-28"><a href="datacube.html#cb96-28" aria-hidden="true"></a>    u =<span class="st"> </span><span class="kw">st_union</span>(l)</span>
<span id="cb96-29"><a href="datacube.html#cb96-29" aria-hidden="true"></a>    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</span>
<span id="cb96-30"><a href="datacube.html#cb96-30" aria-hidden="true"></a>}</span>
<span id="cb96-31"><a href="datacube.html#cb96-31" aria-hidden="true"></a></span>
<span id="cb96-32"><a href="datacube.html#cb96-32" aria-hidden="true"></a>pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb96-33"><a href="datacube.html#cb96-33" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</span>
<span id="cb96-34"><a href="datacube.html#cb96-34" aria-hidden="true"></a>  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</span>
<span id="cb96-35"><a href="datacube.html#cb96-35" aria-hidden="true"></a>  m =<span class="st"> </span>r[[<span class="dv">1</span>]][y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow,x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</span>
<span id="cb96-36"><a href="datacube.html#cb96-36" aria-hidden="true"></a>  <span class="cf">if</span> (randomize)</span>
<span id="cb96-37"><a href="datacube.html#cb96-37" aria-hidden="true"></a>    m =<span class="st"> </span>m[<span class="kw">sample</span>(y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow),x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol]</span>
<span id="cb96-38"><a href="datacube.html#cb96-38" aria-hidden="true"></a>  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></span>
<span id="cb96-39"><a href="datacube.html#cb96-39" aria-hidden="true"></a>  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</span>
<span id="cb96-40"><a href="datacube.html#cb96-40" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">0</span>, add)</span>
<span id="cb96-41"><a href="datacube.html#cb96-41" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">1</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-42"><a href="datacube.html#cb96-42" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">2</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-43"><a href="datacube.html#cb96-43" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">3</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-44"><a href="datacube.html#cb96-44" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">4</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-45"><a href="datacube.html#cb96-45" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">5</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-46"><a href="datacube.html#cb96-46" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">6</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-47"><a href="datacube.html#cb96-47" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">7</span>, <span class="ot">TRUE</span>)</span>
<span id="cb96-48"><a href="datacube.html#cb96-48" aria-hidden="true"></a>  <span class="kw">plt</span>(s, <span class="dv">8</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</span>
<span id="cb96-49"><a href="datacube.html#cb96-49" aria-hidden="true"></a>}</span>
<span id="cb96-50"><a href="datacube.html#cb96-50" aria-hidden="true"></a></span>
<span id="cb96-51"><a href="datacube.html#cb96-51" aria-hidden="true"></a><span class="co"># point vector data cube:</span></span>
<span id="cb96-52"><a href="datacube.html#cb96-52" aria-hidden="true"></a><span class="kw">plot.new</span>()</span>
<span id="cb96-53"><a href="datacube.html#cb96-53" aria-hidden="true"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">0</span>))</span>
<span id="cb96-54"><a href="datacube.html#cb96-54" aria-hidden="true"></a><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">16</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>,<span class="dv">12</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</span>
<span id="cb96-55"><a href="datacube.html#cb96-55" aria-hidden="true"></a><span class="kw">library</span>(spacetime)</span>
<span id="cb96-56"><a href="datacube.html#cb96-56" aria-hidden="true"></a><span class="kw">data</span>(air)</span>
<span id="cb96-57"><a href="datacube.html#cb96-57" aria-hidden="true"></a>de =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">st_normalize</span>(<span class="kw">st_as_sf</span>(DE)))</span>
<span id="cb96-58"><a href="datacube.html#cb96-58" aria-hidden="true"></a><span class="co"># </span></span>
<span id="cb96-59"><a href="datacube.html#cb96-59" aria-hidden="true"></a><span class="kw">pl</span>(s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">TRUE</span>)</span>
<span id="cb96-60"><a href="datacube.html#cb96-60" aria-hidden="true"></a>de =<span class="st"> </span>de <span class="op">*</span><span class="st"> </span><span class="dv">6</span> <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>, <span class="dv">9</span>)</span>
<span id="cb96-61"><a href="datacube.html#cb96-61" aria-hidden="true"></a><span class="kw">plot</span>(de, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">5</span>))</span>
<span id="cb96-62"><a href="datacube.html#cb96-62" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">-90</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb96-63"><a href="datacube.html#cb96-63" aria-hidden="true"></a><span class="kw">text</span>(<span class="op">-</span><span class="dv">5</span>,  <span class="fl">7.5</span>, <span class="st">&quot;sensor location&quot;</span>, <span class="dt">srt =</span> <span class="dv">25</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb96-64"><a href="datacube.html#cb96-64" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">7</span>,  <span class="fl">10.5</span>, <span class="st">&quot;air quality parameter&quot;</span>, <span class="dt">srt =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</span>
<span id="cb96-65"><a href="datacube.html#cb96-65" aria-hidden="true"></a><span class="kw">text</span>( <span class="fl">1.5</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(PM[<span class="dv">10</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb96-66"><a href="datacube.html#cb96-66" aria-hidden="true"></a><span class="kw">text</span>( <span class="fl">4.5</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(NO[x]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb96-67"><a href="datacube.html#cb96-67" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">8</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(SO[<span class="dv">4</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb96-68"><a href="datacube.html#cb96-68" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">11</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(O[<span class="dv">3</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb96-69"><a href="datacube.html#cb96-69" aria-hidden="true"></a><span class="kw">text</span>( <span class="dv">14</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(CO), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</span>
<span id="cb96-70"><a href="datacube.html#cb96-70" aria-hidden="true"></a><span class="co"># location points:</span></span>
<span id="cb96-71"><a href="datacube.html#cb96-71" aria-hidden="true"></a>p =<span class="st"> </span><span class="kw">st_coordinates</span>(s[,<span class="dv">1</span>])</span>
<span id="cb96-72"><a href="datacube.html#cb96-72" aria-hidden="true"></a>p[,<span class="dv">1</span>] =<span class="st"> </span>p[,<span class="dv">1</span>]<span class="op">-</span><span class="fl">1.4</span></span>
<span id="cb96-73"><a href="datacube.html#cb96-73" aria-hidden="true"></a>p[,<span class="dv">2</span>] =<span class="st"> </span>p[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="fl">8.2</span></span>
<span id="cb96-74"><a href="datacube.html#cb96-74" aria-hidden="true"></a><span class="kw">points</span>(p, <span class="dt">col =</span> <span class="kw">grey</span>(.<span class="dv">7</span>), <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb96-75"><a href="datacube.html#cb96-75" aria-hidden="true"></a><span class="co"># centroids:</span></span>
<span id="cb96-76"><a href="datacube.html#cb96-76" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">131</span>)</span>
<span id="cb96-77"><a href="datacube.html#cb96-77" aria-hidden="true"></a>cent =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_sample</span>(de, <span class="dv">8</span>))</span>
<span id="cb96-78"><a href="datacube.html#cb96-78" aria-hidden="true"></a><span class="kw">points</span>(cent, <span class="dt">col =</span> <span class="kw">grey</span>(.<span class="dv">7</span>), <span class="dt">pch =</span> <span class="dv">16</span>)</span>
<span id="cb96-79"><a href="datacube.html#cb96-79" aria-hidden="true"></a>cent =<span class="st"> </span>cent[<span class="kw">rev</span>(<span class="kw">order</span>(cent[,<span class="dv">1</span>])),]</span>
<span id="cb96-80"><a href="datacube.html#cb96-80" aria-hidden="true"></a>seg =<span class="st"> </span><span class="kw">cbind</span>(p, cent[<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>,])</span>
<span id="cb96-81"><a href="datacube.html#cb96-81" aria-hidden="true"></a><span class="kw">segments</span>(seg[,<span class="dv">1</span>], seg[,<span class="dv">2</span>], seg[,<span class="dv">3</span>], seg[,<span class="dv">4</span>], <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:aqdc"></span>
<img src="sds_files/figure-html/aqdc-1.png" alt="Vector data cube with air quality time series" width="70%" />
<p class="caption">
Figure 6.9: Vector data cube with air quality time series
</p>
</div>
<p>Being able to swap dimensions to attributes flexibly and vice-versa
leads to extremely flexible analysis possibilities, as e.g. shown
by the array database SciDB <span class="citation">(Brown <a href="#ref-brown2010overview" role="doc-biblioref">2010</a>)</span>.</p>
</div>
<div id="otherdynamic" class="section level2" number="6.6">
<h2><span class="header-section-number">6.6</span> Other dynamic spatial data</h2>
<p>We have seen several dynamic raster and vector data examples
that match the data cube structure well. Other data examples
do less so: in particular spatiotemporal point patterns (chapter
<a href="pointpatterns.html#pointpatterns">11</a>) and trajectories (movement data) are often more
straightforward to not handle as a data cube. Spatiotemporal point
patterns are the sets of spatiotemporal coordinates of events or
objects: accidents, disease cases, traffic jams, lightning strikes,
and so on. Trajectory data are time sequences of spatial locations of
moving objects (persons, cars, satellites, animals). For such data,
the primary information is in the coordinates, and shifting these
to a limited set of regularly discretized grid cells covering the
space may help some analysis, e.g. to quickly explore patterns in
areas of higher densities, but the loss of the exact coordinates
also hinders a number of analysis approaches involving distance,
direction or speed calculations. Nevertheless, for such data often
the first computational steps involves generation of data cube
representations by aggregating to a time-fixed spatial and/or
space-fixed temporal discretization.</p>
<p>Using sparse array representations of data cubes to represent
point pattern or trajectory data, as e.g. offered by SciDB
<span class="citation">(Brown <a href="#ref-brown2010overview" role="doc-biblioref">2010</a>)</span> or TileDB <span class="citation">(Papadopoulos et al. <a href="#ref-tiledb" role="doc-biblioref">2016</a>)</span>, may strongly limit the
loss of coordinate accuracy by choosing dimensions that represent
an extremely dense grid, and storing only those grid cell that
contain data points. For trajectory data, such represenations
would need to add a grouping dimension to identify individuals,
or individual sequences of consecutive movement observations.</p>
</div>
<div id="exercises-5" class="section level2" number="6.7">
<h2><span class="header-section-number">6.7</span> Exercises</h2>
<p>Use words to solve the following exercises, if needed or relevant
use R code to illustrate the argument(s).</p>
<ol style="list-style-type: decimal">
<li><p>Why is it difficult to represent trajectories, sequences of
<span class="math inline">\((x,y,t)\)</span> obtained by tracking moving objects, by data cubes as
described in this chapter?</p></li>
<li><p>In a socio-economic vector data cube with variables population,
life expectancy, and gross domestic product ordered by dimensions country and
year, which variables have block support for the spatial dimension,
and which have block support for the temporal dimension?</p></li>
<li><p>The Sentinel-2 satellites collect images in 12 spectral bands;
list advantages and disadvantages to represent them as (i) different
data cubes, (ii) a data cube with 12 attributes, one for each band,
and (iii) a single attribute data cube with a spectral dimension.</p></li>
<li><p>Explain why a curvilinear raster as shown in figure
<a href="intro.html#fig:rastertypes01">1.5</a> can be considered a special case of a
data cube.</p></li>
<li><p>Explain how the following problems can be solved with data cube
operations <code>filter</code>, <code>apply</code>, <code>reduce</code> and/or <code>aggregate</code>, and
in which order. Also mention for each which function is applied,
and what the dimensionality of the resulting data cube is (if any):</p>
<ul>
<li>from hourly <span class="math inline">\(PM_{10}\)</span> measurements for a set of air quality
monitoring stations, compute per station the amount of days
per year that the average daily <span class="math inline">\(PM_{10}\)</span> value exceeds
50 <span class="math inline">\(\mu g/m^3\)</span></li>
<li>for a sequence of aerial images of an oil spill, find the
time at which the oil spill had its largest extent, and the
corresponding extent</li>
<li>from a 10-year period with global daily sea surface temperature
(SST) raster maps, find the area with the 10% largest and 10%
smallest temporal trends in SST values.</li>
</ul></li>
</ol>

</div>
</div>



<h3>References</h3>
<div id="refs" class="references hanging-indent">
<div id="ref-brown2010overview">
<p>Brown, Paul G. 2010. “Overview of SciDB: Large Scale Array Storage, Processing and Analysis.” In <em>Proceedings of the 2010 ACM SIGMOD International Conference on Management of Data</em>, 963–68. ACM.</p>
</div>
<div id="ref-galton">
<p>Galton, A. 2004. “Fields and Objects in Space, Time and Space-Time.” <em>Spatial Cognition and Computation</em> 4.</p>
</div>
<div id="ref-lu2018multidimensional">
<p>Lu, Meng, Marius Appel, and Edzer Pebesma. 2018. “Multidimensional Arrays for Analysing Geoscientific Data.” <em>ISPRS International Journal of Geo-Information</em> 7 (8): 313.</p>
</div>
<div id="ref-tiledb">
<p>Papadopoulos, Stavros, Kushal Datta, Samuel Madden, and Timothy Mattson. 2016. “The Tiledb Array Data Storage Manager.” <em>Proceedings of the VLDB Endowment</em> 10 (4): 349–60.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="featureattributes.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sf.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/06-Cubes.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
